<!doctype html><html lang=en><head><meta charset=utf-8><title>Multi-Cluster Kubernetes with Headless Services | Linkerd</title>
<link rel="shortcut icon" href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="We'll discuss two Linkerd features eagerly awaited by the community: support
for headless services and StatefulSets in multi-cluster environments."><meta property="og:url" content="https://travisbeckham.github.io/2021/06/24/multi-cluster-kubernetes-with-headless-services/"><meta property="og:site_name" content="Linkerd"><meta property="og:title" content="Multi-Cluster Kubernetes with Headless Services"><meta property="og:description" content="We'll discuss two Linkerd features eagerly awaited by the community: support
for headless services and StatefulSets in multi-cluster environments."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-06-24T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-24T00:00:00+00:00"><meta property="og:image" content="https://travisbeckham.github.io/2021/06/24/multi-cluster-kubernetes-with-headless-services/cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://travisbeckham.github.io/2021/06/24/multi-cluster-kubernetes-with-headless-services/cover.png"><meta name=twitter:title content="Multi-Cluster Kubernetes with Headless Services"><meta name=twitter:description content="We'll discuss two Linkerd features eagerly awaited by the community: support
for headless services and StatefulSets in multi-cluster environments."><meta name=twitter:site content="@Linkerd"><link rel=canonical href=https://travisbeckham.github.io/2021/06/24/multi-cluster-kubernetes-with-headless-services/><link rel=stylesheet href=/css/main.css><script src=/js/main.js></script><script async defer src=https://buttons.github.io/buttons.js></script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","author":"Matei David","datePublished":"2021-06-24T00:00:00Z","dateModified":"2021-06-24T00:00:00Z","headline":"Multi-Cluster Kubernetes with Headless Services","image":"https://travisbeckham.github.io/2021/06/24/multi-cluster-kubernetes-with-headless-services/cover.png","publisher":{"@type":"Organization","name":"linkerd.io","logo":{"@type":"ImageObject","url":"https://travisbeckham.github.io/logos/linkerd.png","width":472,"height":100}}}</script></head><body><header class=main-header><div class=main-header__container><div class=main-header__logo><a href=/><img src=/logos/linkerd.png alt=Linkerd></a></div><input class=main-header__toggle-checkbox type=checkbox id=main-header-toggle>
<label class=main-header__toggle for=main-header-toggle><span class=main-header__toggle-icon><span class=main-header__toggle-icon--open><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3 6H21V8H3V6m0 5H21v2H3V11m0 5H21v2H3V16z"/></svg>
</span><span class=main-header__toggle-icon--close><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span></span></label><div class=main-header__nav><nav class=main-nav><ul class=main-nav__menu><li><a href=/docs>Docs</a></li><li><a href=#>Community<svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6L7.41 8.58z"/></svg></a><ul><li><a href=/community/get-involved/>Get Involved</a></li><li><a href=/community/adopters/>Adopters</a></li><li><a href=/community/ambassadors/>Linkerd Ambassadors</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Buoyant's Linkerd Forum</a></li></ul></li><li class=main-nav__menu--selected><a href=/blog/>Blog</a></li><li><a href=/faq/>FAQ</a></li><li><a href=/enterprise/>Enterprise</a></li></ul><div class=main-nav__search><form action=/search method=get><div class="search-input search-input--sm"><svg class="icon" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5.0 0116 9.5c0 1.61-.59 3.09-1.56 4.23L14.71 14H15.5l5 5L19 20.5l-5-5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5.0 013 9.5 6.5 6.5.0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
<input type=text name=q placeholder=Search></div></form></div><div class=main-nav__github><a class=github-button href=https://github.com/linkerd/linkerd2 data-icon=octicon-star data-size=large data-show-count=true aria-label="Star linkerd/linkerd2 on GitHub">Star</a></div><div class=main-nav__forum><a href=https://linkerd.buoyant.io class="button button--primary button--sm" target=_blank rel=noopener>Join Forum</a></div></nav></div></div></header><div class=main-announcement>Service Mesh 101: Get Service Mesh-Certified
<span class=main-announcement__link><a href=https://buoyant.io/courses/service-mesh-101 target=_blank rel=noopener>Enroll now</a></span></div><main class=main-content><div class="blog blog--single"><div class="blog__container container"><div class=blog-post><div class=blog-post__header><h1>Multi-Cluster Kubernetes with Headless Services</h1><div class=blog-post-meta><div class=blog-post-meta__media><img src=/authors/matei-david.jpg alt="Matei David" class="img img--48 img--round"></div><div class=blog-post-meta__body><div class=blog-post-meta__name>Matei David</div><div class=blog-post-meta__date>Jun 24, 2021 • 4 min read</div></div></div></div><div class=blog-post__cover></div><div class="blog-post__content prose"><p>In part two of our May Community Meeting recap blog, we&rsquo;ll focus on the
presentation I delivered on two Linkerd features eagerly awaited by the
community: support for headless services and StatefulSets in multi-cluster
environments.</p><p>I received great feedback and was asked to summarize it in this blog post. I
hope you enjoy it too.</p><h2 id=headless-services-in-the-kubernetes-context>Headless services in the Kubernetes context</h2><p>Before we get into the problem we are trying to solve with these new features,
we need to understand headless services as a Kubernetes construct.</p><p>In Kubernetes, a normal service object represents a virtual IP address that may
live in a cluster for a long time. It&rsquo;s virtual because the IP address is not
associated with a particular machine or endpoint. That&rsquo;s because pods change so
frequently in Kubernetes, that we can&rsquo;t rely on IP addresses. Instead, we use
services. These are virtual entry points that never change; they route requests
to short-lived IPs associated with pods — an IP proxy so to speak.</p><p>A headless service is a service without an IP. But, if it has no IP, what is it
used for? Well, their sole purpose is to represent a group of pods and that
allows us to build network identities (and DNS entries) for this group.</p><h2 id=headless-services-and-statefulset-pods>Headless services and StatefulSet pods</h2><p>Headless services are generally used with StatefulSet pods — a special class of
pods that are long-lived and unlikely to terminate. Since a long lived pod may
retain its IP address over longer periods, there is no need for a virtual IP.
But there is still a need for grouping and DNS entries. And this is where
headless services shine.</p><p>With its multi-cluster extension, Linkerd enables applications to communicate
across clusters. In such an environment, there is always a source cluster from
where the traffic originates and a target cluster where the traffic is going.
To achieve this cross-cluster call, we replicate a target cluster service in
the source cluster. Where it differs from the original service, is that this
source cluster service won&rsquo;t point to the server accepting the traffic, but to
the target cluster gateway. When a request arrives at the gateway, Linkerd’s
proxies intelligently forward the request to the server.</p><p>This is represented in Fig 1.1.: From a source cluster East, we can see the
traffic originating from an application. It flows through the replicated
service which points to the gateway in target cluster West. Once the traffic
arrives at the gateway, it is sent to the destination.</p><p><img alt="fig 1.1" class="img img--max-fill img--center img--rounded" src=/2021/06/24/multi-cluster-kubernetes-with-headless-services/sset-blog-11.png> <em>(Fig 1.1: Visual representation of the life of a
request in multi-cluster)</em></p><p>Service replication is a big part of enabling multi-cluster communication. But
how do we replicate a service without an IP address so it can point to the
gateway?</p><h2 id=multi-cluster-statefulset-communication>Multi-cluster StatefulSet communication</h2><p>Enabling a client in a source cluster to talk to a StatefulSet server in the
target is easier said than done. Essentially, we want a pod to talk to another
pod in a different cluster and do so efficiently and in a way that is scalable.
The traditional way of replicating services no longer works. After all, we need
to replicate a group that may grow or shrink at any given time.</p><p>Here&rsquo;s our approach: Linkerd replicates the headless service and, for each pod
in that group, also creates a new virtual entry point in the source cluster
pointing to the gateway. We&rsquo;ve now created a group and each member of the group
can act as a synthetic pod that will lead to the gateway. Because we offload
the management of replicated services to the multi-cluster component, this
solution is not only scalable but also highly efficient. Traffic is handled the
same way it was before but through this service indirection. Since we leverage
Kubernetes primitives, we can still rely on Kubernetes to create DNS entries
and assign IP addresses.</p><p><img alt="fig 1.2" class="img img--max-fill img--center img--rounded" src=/2021/06/24/multi-cluster-kubernetes-with-headless-services/sset-blog-12.png> <em>(Fig 1.2: The structure of a replicated headless
service)</em></p><p>Admittedly not the simplest solution, this approach does allow us to extend
Linkerd&rsquo;s multi-cluster support to cover even more scenarios, especially for
operators that run complex datastores and network topologies.</p><p>This concludes the May community meeting recap. Don&rsquo;t wait for the next recap
and <a href=https://community.cncf.io/events/details/cncf-linkerd-community-presents-july-linkerd-online-community-meetup/ target=_blank rel=noopener>join our meetup live on Thursday, July 29 at 9 AM,
PT.</a></p></div></div><div class=blog-post-related><h2>Suggested Blog Posts</h2><div class=blog-post-related__pages><div class="card card--horz card--center"><div class=card__media><img src=/2019/02/02/debugging-ruby-services-in-kubernetes-with-linkerd/cover.png alt=Cover class="img img--128 img--rounded"></div><div class=card__body><div class=card__header><h4><a href=/2019/02/02/debugging-ruby-services-in-kubernetes-with-linkerd/>Debugging Ruby Services in Kubernetes With Linkerd</a></h4><div class=blog-post-meta><div class=blog-post-meta__date>Feb 2, 2019 • 9 min read</div></div></div></div></div><div class="card card--horz card--center"><div class=card__media><img src=/2018/12/08/service-profiles-for-per-route-metrics/cover.png alt=Cover class="img img--128 img--rounded"></div><div class=card__body><div class=card__header><h4><a href=/2018/12/08/service-profiles-for-per-route-metrics/>Service Profiles for Per-Route Metrics</a></h4><div class=blog-post-meta><div class=blog-post-meta__date>Dec 8, 2018 • 7 min read</div></div></div></div></div><div class="card card--horz card--center"><div class=card__media><img src=/2018/11/14/grpc-load-balancing-on-kubernetes-without-tears/cover.png alt=Cover class="img img--128 img--rounded"></div><div class=card__body><div class=card__header><h4><a href=/2018/11/14/grpc-load-balancing-on-kubernetes-without-tears/>gRPC Load Balancing on Kubernetes without Tears</a></h4><div class=blog-post-meta><div class=blog-post-meta__date>Nov 14, 2018 • 6 min read</div></div></div></div></div></div></div></div></div></main><footer class=main-footer><div class=main-footer__top><div class="main-footer__container container"><div class=main-footer__info><p><img src=/logos/linkerd.png alt=Linkerd></p><p>Linkerd was originally created by <a href=https://buoyant.io/ target=_blank rel=noopener>Buoyant</a></p><p>View <a href=https://github.com/linkerd/linkerd/wiki/Linkerd-code-of-conduct target=_blank rel=noopener>Code of Conduct</a></p></div><div class=main-footer__links><div class=main-footer__community><h4>Community</h4><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener>GitHub</a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Linkerd Forum</a></li></ul></div><div class=main-footer__follow><h4>Follow</h4><ul><li><a href=https://www.linkedin.com/company/linkerd/ target=_blank rel=noopener>Linkedin</a></li><li><a href=https://www.youtube.com/buoyantio target=_blank rel=noopener>YouTube</a></li><li><a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a></li></ul></div></div></div></div><div class=main-footer__bottom><div class="main-footer__container container"><p><a href=https://github.com/linkerd/website/tree/main/linkerd.io/content target=_blank rel=noopener>Edit This Site</a></p><p>Copyright © 2024 Linkerd Authors. All rights reserved.</p></div></div></footer></body></html>