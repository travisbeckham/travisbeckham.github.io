<!doctype html><html lang=en><head><meta charset=utf-8><title>Configuring Per-Route Authorization Policy | Linkerd</title>
<link rel="shortcut icon" href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Fine-grained authorization policies can be configured for individual HTTP routes."><meta property="og:url" content="https://travisbeckham.github.io/2.15/tasks/configuring-per-route-policy/"><meta property="og:site_name" content="Linkerd"><meta property="og:title" content="Configuring Per-Route Authorization Policy"><meta property="og:description" content="Fine-grained authorization policies can be configured for individual HTTP routes."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="2.15"><meta property="og:image" content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:title content="Configuring Per-Route Authorization Policy"><meta name=twitter:description content="Fine-grained authorization policies can be configured for individual HTTP routes."><meta name=twitter:site content="@Linkerd"><link rel=canonical href=https://travisbeckham.github.io/2.15/tasks/configuring-per-route-policy/><link rel=stylesheet href=/css/main.css><script src=/js/main.js></script><script async defer src=https://buttons.github.io/buttons.js></script></head><body><header class=main-header><div class=main-header__container><div class=main-header__logo><a href=/><img src=/logos/linkerd.png alt=Linkerd></a></div><input class=main-header__toggle-checkbox type=checkbox id=main-header-toggle>
<label class=main-header__toggle for=main-header-toggle><span class=main-header__toggle-icon><span class=main-header__toggle-icon--open><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3 6H21V8H3V6m0 5H21v2H3V11m0 5H21v2H3V16z"/></svg>
</span><span class=main-header__toggle-icon--close><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span></span></label><div class=main-header__nav><nav class=main-nav><ul class=main-nav__menu><li class=main-nav__menu--selected><a href=/docs>Docs</a></li><li><a href=#>Community<svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6L7.41 8.58z"/></svg></a><ul><li><a href=/community/get-involved/>Get Involved</a></li><li><a href=/community/adopters/>Adopters</a></li><li><a href=/community/ambassadors/>Linkerd Ambassadors</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Buoyant's Linkerd Forum</a></li></ul></li><li><a href=/blog/>Blog</a></li><li><a href=/faq/>FAQ</a></li><li><a href=/enterprise/>Enterprise</a></li></ul><div class=main-nav__search><form action=/search method=get><div class="search-input search-input--sm"><svg class="icon" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5.0 0116 9.5c0 1.61-.59 3.09-1.56 4.23L14.71 14H15.5l5 5L19 20.5l-5-5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5.0 013 9.5 6.5 6.5.0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
<input type=text name=q placeholder=Search></div></form></div><div class=main-nav__github><a class=github-button href=https://github.com/linkerd/linkerd2 data-icon=octicon-star data-size=large data-show-count=true aria-label="Star linkerd/linkerd2 on GitHub">Star</a></div><div class=main-nav__forum><a href=https://linkerd.buoyant.io class="button button--primary button--sm" target=_blank rel=noopener>Join Forum</a></div></nav></div></div></header><div class=main-announcement>Service Mesh 101: Get Service Mesh-Certified
<span class=main-announcement__link><a href=https://buoyant.io/courses/service-mesh-101 target=_blank rel=noopener>Enroll now</a></span></div><main class=main-content><div class="alert alert--warning alert--condensed alert--center docs__deprecated-alert"><div class=alert__content>You are viewing docs for an older version of Linkerd.
<a href=/2.16/>View the latest docs</a>.</div></div><div class=docs><div class=docs__container><div class=docs__sidebar><div class=docs__nav><div class=docs__versions><select onchange="window.location.href=this.value"><option value=/2-edge/>Linkerd edge</option><option value=/2.16/>Linkerd 2.16</option><option value=/2.15/ selected>Linkerd 2.15</option><option value=/2.14/>Linkerd 2.14</option><option value=/2.13/>Linkerd 2.13</option><option value=/2.12/>Linkerd 2.12</option><option value=/2.11/>Linkerd 2.11</option><option value=/2.10/>Linkerd 2.10</option></select></div><nav><ul><li><a href=/2.15/overview/>Overview</a></li><li><a href=/2.15/getting-started/>Getting Started</a></li><li><a href=/2.15/features/>Features
</a><input class=toggle__input type=checkbox id=toggle-9502176e66310dde847fdf0e0179df48>
<label class=toggle__label for=toggle-9502176e66310dde847fdf0e0179df48><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.15/features/http-grpc/>HTTP, HTTP/2, and gRPC Proxying</a></li><li><a href=/2.15/features/protocol-detection/>TCP Proxying and Protocol Detection</a></li><li><a href=/2.15/features/retries-and-timeouts/>Retries and Timeouts</a></li><li><a href=/2.15/features/automatic-mtls/>Automatic mTLS</a></li><li><a href=/2.15/features/ingress/>Ingress</a></li><li><a href=/2.15/features/telemetry/>Telemetry and Monitoring</a></li><li><a href=/2.15/features/load-balancing/>Load Balancing</a></li><li><a href=/2.15/features/server-policy/>Authorization Policy</a></li><li><a href=/2.15/features/proxy-injection/>Automatic Proxy Injection</a></li><li><a href=/2.15/features/cni/>CNI Plugin</a></li><li><a href=/2.15/features/dashboard/>Dashboard and on-cluster metrics stack</a></li><li><a href=/2.15/features/distributed-tracing/>Distributed Tracing</a></li><li><a href=/2.15/features/request-routing/>Dynamic Request Routing</a></li><li><a href=/2.15/features/fault-injection/>Fault Injection</a></li><li><a href=/2.15/features/ha/>High Availability</a></li><li><a href=/2.15/features/access-logging/>HTTP Access Logging</a></li><li><a href=/2.15/features/httproute/>HTTPRoutes</a></li><li><a href=/2.15/features/nft/>Iptables-nft Support</a></li><li><a href=/2.15/features/multicluster/>Multi-cluster communication</a></li><li><a href=/2.15/features/non-kubernetes-workloads/>Non-Kubernetes workloads (mesh expansion)</a></li><li><a href=/2.15/features/service-profiles/>Service Profiles</a></li><li><a href=/2.15/features/traffic-split/>Traffic Split (canaries, blue/green deploys)</a></li></ul></li><li class=docs__nav--selected><a href=/2.15/tasks/>Tasks
</a><input class=toggle__input type=checkbox id=toggle-d3491daa3401b9d2bd77587482630419 checked>
<label class=toggle__label for=toggle-d3491daa3401b9d2bd77587482630419><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.15/tasks/adding-non-kubernetes-workloads/>Adding non-Kubernetes workloads to your mesh</a></li><li><a href=/2.15/tasks/adding-your-service/>Adding your services to Linkerd</a></li><li><a href=/2.15/tasks/automatic-failover/>Automatic Multicluster Failover</a></li><li><a href=/2.15/tasks/automatically-rotating-control-plane-tls-credentials/>Automatically Rotating Control Plane TLS Credentials</a></li><li><a href=/2.15/tasks/automatically-rotating-webhook-tls-credentials/>Automatically Rotating Webhook TLS Credentials</a></li><li><a href=/2.15/tasks/external-prometheus/>Bringing your own Prometheus</a></li><li><a href=/2.15/tasks/circuit-breakers/>Circuit Breakers</a></li><li><a href=/2.15/tasks/configuring-dynamic-request-routing/>Configuring Dynamic Request Routing</a></li><li class=docs__nav--selected><a href=/2.15/tasks/configuring-per-route-policy/>Configuring Per-Route Authorization Policy</a></li><li><a href=/2.15/tasks/configuring-proxy-concurrency/>Configuring Proxy Concurrency</a></li><li><a href=/2.15/tasks/configuring-proxy-discovery-cache/>Configuring Proxy Discovery Cache</a></li><li><a href=/2.15/tasks/configuring-retries/>Configuring Retries</a></li><li><a href=/2.15/tasks/configuring-timeouts/>Configuring Timeouts</a></li><li><a href=/2.15/tasks/using-debug-endpoints/>Control Plane Debug Endpoints</a></li><li><a href=/2.15/tasks/customize-install/>Customizing Linkerd's Configuration with Kustomize</a></li><li><a href=/2.15/tasks/debugging-502s/>Debugging 502s</a></li><li><a href=/2.15/tasks/debugging-your-service/>Debugging gRPC applications with request tracing</a></li><li><a href=/2.15/tasks/books/>Debugging HTTP applications with per-route metrics</a></li><li><a href=/2.15/tasks/distributed-tracing/>Distributed tracing with Linkerd</a></li><li><a href=/2.15/tasks/exporting-metrics/>Exporting Metrics</a></li><li><a href=/2.15/tasks/exposing-dashboard/>Exposing the Dashboard</a></li><li><a href=/2.15/tasks/generate-certificates/>Generating your own mTLS root certificates</a></li><li><a href=/2.15/tasks/getting-per-route-metrics/>Getting Per-Route Metrics</a></li><li><a href=/2.15/tasks/linkerd-smi/>Getting started with Linkerd SMI extension</a></li><li><a href=/2.15/tasks/graceful-shutdown/>Graceful Pod Shutdown</a></li><li><a href=/2.15/tasks/grafana/>Grafana</a></li><li><a href=/2.15/tasks/using-ingress/>Handling ingress traffic</a></li><li><a href=/2.15/tasks/fault-injection/>Injecting Faults</a></li><li><a href=/2.15/tasks/install/>Installing Linkerd</a></li><li><a href=/2.15/tasks/install-helm/>Installing Linkerd with Helm</a></li><li><a href=/2.15/tasks/installing-multicluster/>Installing Multi-cluster Components</a></li><li><a href=/2.15/tasks/using-psp/>Linkerd and Pod Security Policies (PSP)</a></li><li><a href=/2.15/tasks/manually-rotating-control-plane-tls-credentials/>Manually Rotating Control Plane TLS Credentials</a></li><li><a href=/2.15/tasks/modifying-proxy-log-level/>Modifying the Proxy Log Level</a></li><li><a href=/2.15/tasks/multicluster/>Multi-cluster communication</a></li><li><a href=/2.15/tasks/multicluster-using-statefulsets/>Multi-cluster communication with StatefulSets</a></li><li><a href=/2.15/tasks/pod-to-pod-multicluster/>Pod-to-Pod Multi-cluster communication</a></li><li><a href=/2.15/tasks/flagger/>Progressive Delivery</a></li><li><a href=/2.15/tasks/replacing_expired_certificates/>Replacing expired certificates</a></li><li><a href=/2.15/tasks/restricting-access/>Restricting Access To Services</a></li><li><a href=/2.15/tasks/rotating_webhooks_certificates/>Rotating webhooks certificates</a></li><li><a href=/2.15/tasks/securing-linkerd-tap/>Securing Linkerd Tap</a></li><li><a href=/2.15/tasks/setting-up-service-profiles/>Setting Up Service Profiles</a></li><li><a href=/2.15/tasks/traffic-shifting/>Traffic Shifting</a></li><li><a href=/2.15/tasks/troubleshooting/>Troubleshooting</a></li><li><a href=/2.15/tasks/uninstall/>Uninstalling Linkerd</a></li><li><a href=/2.15/tasks/uninstall-multicluster/>Uninstalling Multicluster</a></li><li><a href=/2.15/tasks/upgrade/>Upgrading Linkerd</a></li><li><a href=/2.15/tasks/using-custom-domain/>Using a Custom Cluster Domain</a></li><li><a href=/2.15/tasks/extensions/>Using extensions</a></li><li><a href=/2.15/tasks/gitops/>Using GitOps with Linkerd with Argo CD</a></li><li><a href=/2.15/tasks/using-the-debug-container/>Using the Debug Sidecar</a></li><li><a href=/2.15/tasks/validating-your-traffic/>Validating your mTLS traffic</a></li></ul></li><li><a href=/2.15/reference/>Reference
</a><input class=toggle__input type=checkbox id=toggle-6c1ed631a095b70fc00aeb5c380a1fe3>
<label class=toggle__label for=toggle-6c1ed631a095b70fc00aeb5c380a1fe3><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.15/reference/architecture/>Architecture</a></li><li><a href=/2.15/reference/authorization-policy/>Authorization Policy</a></li><li><a href=/2.15/reference/circuit-breaking/>Circuit Breaking</a></li><li><a href=/2.15/reference/cli/>CLI
</a><input class=toggle__input type=checkbox id=toggle-bc91c7f240985a01728bf733237a9d0d>
<label class=toggle__label for=toggle-bc91c7f240985a01728bf733237a9d0d><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.15/reference/cli/authz/>authz</a></li><li><a href=/2.15/reference/cli/check/>check</a></li><li><a href=/2.15/reference/cli/completion/>completion</a></li><li><a href=/2.15/reference/cli/diagnostics/>diagnostics</a></li><li><a href=/2.15/reference/cli/identity/>identity</a></li><li><a href=/2.15/reference/cli/inject/>inject</a></li><li><a href=/2.15/reference/cli/install/>install</a></li><li><a href=/2.15/reference/cli/install-cni/>install-cni</a></li><li><a href=/2.15/reference/cli/jaeger/>jaeger</a></li><li><a href=/2.15/reference/cli/multicluster/>multicluster</a></li><li><a href=/2.15/reference/cli/profile/>profile</a></li><li><a href=/2.15/reference/cli/prune/>prune</a></li><li><a href=/2.15/reference/cli/uninject/>uninject</a></li><li><a href=/2.15/reference/cli/uninstall/>uninstall</a></li><li><a href=/2.15/reference/cli/upgrade/>upgrade</a></li><li><a href=/2.15/reference/cli/version/>version</a></li><li><a href=/2.15/reference/cli/viz/>viz</a></li></ul></li><li><a href=/2.15/reference/cluster-configuration/>Cluster Configuration</a></li><li><a href=/2.15/reference/extension-list/>Extensions List</a></li><li><a href=/2.15/reference/external-workload/>ExternalWorkload</a></li><li><a href=/2.15/reference/httproute/>HTTPRoute</a></li><li><a href=/2.15/reference/iptables/>IPTables Reference</a></li><li><a href=/2.15/reference/multicluster/>Multi-cluster communication</a></li><li><a href=/2.15/reference/proxy-configuration/>Proxy Configuration</a></li><li><a href=/2.15/reference/proxy-log-level/>Proxy Log Level</a></li><li><a href=/2.15/reference/proxy-metrics/>Proxy Metrics</a></li><li><a href=/2.15/reference/service-profiles/>Service Profiles</a></li><li><a href=/2.15/reference/k8s-versions/>Supported Kubernetes Versions</a></li></ul></li><li><a href=/2.15/common-errors/>Common Errors
</a><input class=toggle__input type=checkbox id=toggle-70fc38683e3d1aadd6c9fc9f3235e04b>
<label class=toggle__label for=toggle-70fc38683e3d1aadd6c9fc9f3235e04b><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.15/common-errors/failfast/>Failfast</a></li><li><a href=/2.15/common-errors/http-502/>HTTP 502 Errors</a></li><li><a href=/2.15/common-errors/http-503-504/>HTTP 503 and 504 Errors</a></li><li><a href=/2.15/common-errors/protocol-detection/>Protocol Detection Errors</a></li></ul></li></ul><ul><li><a href=/what-is-a-service-mesh/>What is a service mesh?</a></li><li><a href=/faq/>Frequently Asked Questions</a></li><li><a href=/releases/>Releases and Versions</a></li><li><a href=/design-principles/>Design Principles</a></li><li><a href=/going-to-production/>Going to Production</a></li><li><a href=/service-mesh-glossary/>Service Mesh Glossary</a></li></ul></nav><div class=docs__community><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener><img src=/logos/github.svg alt=GitHub class=img></a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener><img src=/logos/slack.svg alt=Slack class=img></a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener><img src=/logos/forum.png alt="Linkerd Forum" class=img></a></li></ul></div></div></div><div class=docs__main><div class=docs__body><div class=docs__header><h1>Configuring Per-Route Authorization Policy</h1></div><div class="docs__content prose"><p>In addition to <a href=../restricting-access/>enforcing authorization at the service
level</a>, finer-grained authorization policies can also be
configured for individual HTTP routes. In this example, we&rsquo;ll use the Books demo
app to demonstrate how to control which clients can access particular routes on
a service.</p><p>This is an advanced example that demonstrates more complex policy configuration.
For a basic introduction to Linkerd authorization policy, start with the
<a href=../restricting-access/>Restricting Access to Services</a> example. For more
comprehensive documentation of the policy resources, see the
<a href=../../reference/authorization-policy/>Authorization policy reference</a>.</p><h2 id=prerequisites class=anchor>Prerequisites
<a href=#prerequisites class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>To use this guide, you&rsquo;ll need to have Linkerd installed on your cluster, along
with its Viz extension. Follow the <a href=../install/>Installing Linkerd Guide</a>
if you haven&rsquo;t already done this.</p><h2 id=install-the-books-demo-application class=anchor>Install the Books demo application
<a href=#install-the-books-demo-application class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Inject and install the Books demo application:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl create ns booksapp <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  curl --proto <span style=color:#a5d6ff>&#39;=https&#39;</span> --tlsv1.2 -sSfL https://run.linkerd.io/booksapp.yml <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  | linkerd inject - <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  | kubectl -n booksapp apply -f -
</span></span></code></pre></div><p>This command creates a namespace for the demo, downloads its Kubernetes
resource manifest, injects Linkerd into the application, and uses <code>kubectl</code> to
apply it to your cluster. The app comprises the Kubernetes deployments and
services that run in the <code>booksapp</code> namespace.</p><p>Confirm that the Linkerd data plane was injected successfully:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ linkerd check -n booksapp --proxy -o short
</span></span></code></pre></div><p>You can take a quick look at all the components that were added to your
cluster by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n booksapp get all
</span></span></code></pre></div><p>Once the rollout has completed successfully, you can access the app itself by
port-forwarding <code>webapp</code> locally:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n booksapp port-forward svc/webapp <span style=color:#a5d6ff>7000</span> &amp;
</span></span></code></pre></div><p>Open <a href=http://localhost:7000/ target=_blank rel=noopener>http://localhost:7000/</a> in your browser to see the
frontend.</p><figure><img alt=Frontend class="img img--max-fill img--center img--rounded" src=/docs/images/books/frontend.png><figcaption>Frontend</figcaption></figure><h2 id=creating-a-server-resource class=anchor>Creating a Server resource
<a href=#creating-a-server-resource class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Both the <code>books</code> service and the <code>webapp</code> service in the demo application are
clients of the <code>authors</code> service.</p><p>However, these services send different requests to the <code>authors</code> service. The
<code>books</code> service should only send <code>GET</code>
requests to the <code>/authors/:id.json</code> route, to get the author associated with a
particular book. Meanwhile, the <code>webapp</code> service may also send <code>DELETE</code> and
<code>PUT</code> requests to <code>/authors</code>, and <code>POST</code> requests to <code>/authors.json</code>, as it
allows the user to create and delete authors.</p><p>Since the <code>books</code> service should never need to create or delete authors, we will
create separate authorization policies for the <code>webapp</code> and <code>books</code> services,
restricting which services can access individual routes of the <code>authors</code>
service.</p><p>First, let&rsquo;s run the <code>linkerd viz authz</code> command to list the authorization
resources that currently exist for the <code>authors</code> deployment:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ linkerd viz authz -n booksapp deploy/authors
</span></span><span style=display:flex><span>ROUTE    SERVER                       AUTHORIZATION                UNAUTHORIZED  SUCCESS     RPS  LATENCY_P50  LATENCY_P95  LATENCY_P99
</span></span><span style=display:flex><span>default  default:all-unauthenticated  default/all-unauthenticated        0.0rps   70.31%  8.1rps          1ms         43ms         49ms
</span></span><span style=display:flex><span>probe    default:all-unauthenticated  default/probe                      0.0rps  100.00%  0.3rps          1ms          1ms          1ms
</span></span></code></pre></div><p>By default, the <code>authors</code> deployment uses the cluster&rsquo;s default authorization
policy, &ldquo;all-unauthenticated&rdquo;. In addition, a separate authorization is
generated to allow liveness and readiness probes from the kubelet.</p><p>First, we&rsquo;ll create a <a href=../../reference/authorization-policy/#server><code>Server</code></a> resource for the <code>authors</code> deployment&rsquo;s service
port. For details on <a href=../../reference/authorization-policy/#server><code>Server</code></a> resources, see
<a href=../restricting-access/#creating-a-server-resource>here</a>.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f - <span style=color:#a5d6ff>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: policy.linkerd.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: Server
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: authors-server
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: booksapp
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  podSelector:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      app: authors
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      project: booksapp
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  port: service
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span></code></pre></div><p>Now that we&rsquo;ve defined a <a href=../../reference/authorization-policy/#server><code>Server</code></a> for the authors <code>Deployment</code>, we can run the
<code>linkerd viz authz</code> command again, and see that all traffic to <code>authors</code> is
currently unauthorized:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ linkerd viz authz -n booksapp deploy/authors
</span></span><span style=display:flex><span>ROUTE    SERVER                       AUTHORIZATION                UNAUTHORIZED  SUCCESS     RPS  LATENCY_P50  LATENCY_P95  LATENCY_P99
</span></span><span style=display:flex><span>default  authors-server                                                  9.5rps    0.00%  0.0rps          0ms          0ms          0ms
</span></span><span style=display:flex><span>probe    authors-server               default/probe                      0.0rps  100.00%  0.1rps          1ms          1ms          1ms
</span></span><span style=display:flex><span>default  default:all-unauthenticated  default/all-unauthenticated        0.0rps  100.00%  0.1rps          1ms          1ms          1ms
</span></span><span style=display:flex><span>probe    default:all-unauthenticated  default/probe                      0.0rps  100.00%  0.2rps          1ms          1ms          1ms
</span></span></code></pre></div><p>Next, we&rsquo;ll create per-route policy resources to authorize traffic to the
<code>authors</code> deployment.</p><h2 id=creating-per-route-policy-resources class=anchor>Creating per-route policy resources
<a href=#creating-per-route-policy-resources class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>The <a href=../../reference/authorization-policy/#httproute><code>HTTPRoute</code></a> resource is used to configure policy for individual HTTP routes,
by defining how to match a request for a given route. We will now create
<a href=../../reference/authorization-policy/#httproute><code>HTTPRoute</code></a> resources for the <code>authors</code> service.</p><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>Routes configured in service profiles are different from <a href=../../reference/authorization-policy/#httproute><code>HTTPRoute</code></a> resources.
Service profile routes allow you to collect per-route metrics and configure
client-side behavior such as retries and timeouts. <a href=../../reference/authorization-policy/#httproute><code>HTTPRoute</code></a> resources, on the
other hand, can be the target of <a href=../../reference/authorization-policy/#authorizationpolicy><code>AuthorizationPolicies</code></a> and allow you to specify
per-route authorization.</div></div><p>First, let&rsquo;s create an <a href=../../reference/authorization-policy/#httproute><code>HTTPRoute</code></a> that matches <code>GET</code> requests to the <code>authors</code>
service&rsquo;s API:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f - <span style=color:#a5d6ff>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: policy.linkerd.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: authors-get-route
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: booksapp
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    - name: authors-server
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      kind: Server
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      group: policy.linkerd.io
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  rules:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      - path:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          value: &#34;/authors.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        method: GET
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      - path:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          value: &#34;/authors/&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          type: &#34;PathPrefix&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        method: GET
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span></code></pre></div><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content><p>Two versions of the HTTPRoute resource may be used with Linkerd:</p><ul><li>The upstream version provided by the Gateway API, with the
<code>gateway.networking.k8s.io</code> API group</li><li>A Linkerd-specific CRD provided by Linkerd, with the <code>policy.linkerd.io</code> API
group</li></ul><p>The two HTTPRoute resource definitions are similar, but the Linkerd version
implements experimental features not yet available with the upstream Gateway API
resource definition. See <a href=../../reference/httproute/#linkerd-and-gateway-api-httproutes>the HTTPRoute reference
documentation</a>
for details.</p></div></div><p>This will create an <a href=../../reference/authorization-policy/#httproute><code>HTTPRoute</code></a> targeting the <code>authors-server</code> <a href=../../reference/authorization-policy/#server><code>Server</code></a> resource
we defined previously. The <code>rules</code> section defines a list of matches, which
determine which requests match the <a href=../../reference/authorization-policy/#httproute><code>HTTPRoute</code></a>. Here, we &rsquo;ve defined a match
rule that matches <code>GET</code> requests to the path <code>/authors.json</code>, and a second match
rule that matches <code>GET</code> requests to paths starting with the path segment
<code>/authors</code>.</p><p>Now that we&rsquo;ve created a route, we can associate policy with that route. We&rsquo;ll
create an <a href=../../reference/authorization-policy/#authorizationpolicy><code>AuthorizationPolicy</code></a> resource that defines policy for our
<a href=../../reference/authorization-policy/#httproute><code>HTTPRoute</code></a>:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f - <span style=color:#a5d6ff>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: policy.linkerd.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: AuthorizationPolicy
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: authors-get-policy
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: booksapp
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    group: policy.linkerd.io
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    name: authors-get-route
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  requiredAuthenticationRefs:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    - name: authors-get-authn
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      kind: MeshTLSAuthentication
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      group: policy.linkerd.io
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: policy.linkerd.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: MeshTLSAuthentication
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: authors-get-authn
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: booksapp
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  identities:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    - &#34;books.booksapp.serviceaccount.identity.linkerd.cluster.local&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    - &#34;webapp.booksapp.serviceaccount.identity.linkerd.cluster.local&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span></code></pre></div><p>This command creates an <a href=../../reference/authorization-policy/#authorizationpolicy><code>AuthorizationPolicy</code></a> whose <code>targetRef</code> selects the
<code>authors-get-route</code> <a href=../../reference/authorization-policy/#httproute><code>HTTPRoute</code></a> resource we just created. An
<a href=../../reference/authorization-policy/#authorizationpolicy><code>AuthorizationPolicy</code></a> resource can require a a variety of forms of
authentication. In this case, we we&rsquo;ve defined a <a href=../../reference/authorization-policy/#meshtlsauthentication><code>MeshTLSAuthentication</code></a>
resource, named <code>authors-get-authn</code>, that requires the TLS identity of the
client to match the <code>ServiceAccount</code> of either the <code>books</code> service or the
<code>webapp</code> service.</p><p>Additionally, because we have created an <a href=../../reference/authorization-policy/#httproute><code>HTTPRoute</code></a> referencing the <code>authors</code>
service, the default route for liveness and readiness probes will no longer be
used, and the <code>authors</code> service will become unready.</p><p>Therefore, we must also create a <a href=../../reference/authorization-policy/#httproute><code>HTTPRoute</code></a> and <a href=../../reference/authorization-policy/#authorizationpolicy><code>AuthorizationPolicy</code></a> so
that probes from the Kubelet are still authorized:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f - <span style=color:#a5d6ff>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: policy.linkerd.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: authors-probe-route
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: booksapp
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    - name: authors-server
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      kind: Server
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      group: policy.linkerd.io
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  rules:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      - path:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          value: &#34;/ping&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        method: GET
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: policy.linkerd.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: NetworkAuthentication
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: authors-probe-authn
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: booksapp
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  networks:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  - cidr: 0.0.0.0/0
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  - cidr: ::/0
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: policy.linkerd.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: AuthorizationPolicy
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: authors-probe-policy
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: booksapp
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    group: policy.linkerd.io
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    name: authors-probe-route
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  requiredAuthenticationRefs:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    - name: authors-probe-authn
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      kind: NetworkAuthentication
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      group: policy.linkerd.io
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span></code></pre></div><p>Here, we use the <a href=../../reference/authorization-policy/#networkauthentication><code>NetworkAuthentication</code></a> resource (rather than
<a href=../../reference/authorization-policy/#meshtlsauthentication><code>MeshTLSAuthentication</code></a>) to authenticate only probes
coming from the local network (0.0.0.0).</p><p>Running <code>linkerd viz authz</code> again, we can now see that our new policies exist:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ linkerd viz authz -n booksapp deploy/authors
</span></span><span style=display:flex><span>ROUTE                SERVER                       AUTHORIZATION                             UNAUTHORIZED  SUCCESS     RPS  LATENCY_P50  LATENCY_P95  LATENCY_P99
</span></span><span style=display:flex><span>authors-get-route    authors-server               authorizationpolicy/authors-get-policy          0.0rps  100.00%  0.1rps          2ms          2ms          2ms
</span></span><span style=display:flex><span>authors-probe-route  authors-server               authorizationpolicy/authors-probe-policy        0.0rps  100.00%  0.1rps          1ms          1ms          1ms
</span></span><span style=display:flex><span>default              default:all-unauthenticated  default/all-unauthenticated                     0.0rps  100.00%  0.1rps          2ms          2ms          2ms
</span></span><span style=display:flex><span>probe                default:all-unauthenticated  default/probe                                   0.0rps  100.00%  0.2rps          1ms          1ms          1ms
</span></span></code></pre></div><p>And, if we open <a href=http://localhost:7000/ target=_blank rel=noopener>http://localhost:7000/</a> and interact
with the frontend, the lists of authors and books are still displayed correctly.</p><h2 id=authorizing-additional-routes class=anchor>Authorizing additional routes
<a href=#authorizing-additional-routes class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>However, if we try to create a new author or delete an existing author in the
web UI, we may notice that something is amiss.</p><p>Attempting to delete an author results in a &ldquo;not found&rdquo; error in the web UI:</p><figure><img alt="Not found" class="img img--max-fill img--center img--rounded" src=/docs/images/books/delete-404.png><figcaption>Not found</figcaption></figure><p>and similarly, adding a new author takes us to an error page.</p><p>This is because creating or deleting an author will send a <code>PUT</code> or <code>DELETE</code>
request, respectively, from <code>webapp</code> to <code>authors</code>. The route we created to
authorize <code>GET</code> requests does not match <code>PUT</code> or <code>DELETE</code> requests, so the
<code>authors</code> proxy rejects those requests with a 404 error.</p><p>To resolve this, we&rsquo;ll create an additional <a href=../../reference/authorization-policy/#httproute><code>HTTPRoute</code></a> resource that matches
<code>PUT</code>, <code>POST</code>, and <code>DELETE</code> requests:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f - <span style=color:#a5d6ff>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: policy.linkerd.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: authors-modify-route
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: booksapp
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    - name: authors-server
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      kind: Server
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      group: policy.linkerd.io
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  rules:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      - path:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          value: &#34;/authors/&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          type: &#34;PathPrefix&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        method: DELETE
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      - path:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          value: &#34;/authors/&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          type: &#34;PathPrefix&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        method: PUT
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      - path:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          value: &#34;/authors.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        method: POST
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span></code></pre></div><p>What happens if we try to delete an author <em>now</em>? We still see a failure, but a
different one:</p><figure><img alt="Internal server error" class="img img--max-fill img--center img--rounded" src=/docs/images/books/delete-503.png><figcaption>Internal server error</figcaption></figure><p>This is because we have created a <em>route</em> matching <code>DELETE</code>, <code>PUT</code>, and <code>POST</code>
requests, but we haven&rsquo;t <em>authorized</em> requests to that route. Running the
<code>linkerd viz authz</code> command again confirms this â€” note the unauthorized
requests to <code>authors-modify-route</code>:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ linkerd viz authz -n booksapp deploy/authors
</span></span><span style=display:flex><span>ROUTE                 SERVER                       AUTHORIZATION                             UNAUTHORIZED  SUCCESS     RPS  LATENCY_P50  LATENCY_P95  LATENCY_P99
</span></span><span style=display:flex><span>authors-get-route     authors-server               authorizationpolicy/authors-get-policy               -        -       -            -            -            -
</span></span><span style=display:flex><span>authors-modify-route  authors-server                                                               9.7rps    0.00%  0.0rps          0ms          0ms          0ms
</span></span><span style=display:flex><span>authors-probe-route   authors-server               authorizationpolicy/authors-probe-policy        0.0rps  100.00%  0.1rps          1ms          1ms          1ms
</span></span><span style=display:flex><span>default               default:all-unauthenticated  default/all-unauthenticated                     0.0rps  100.00%  0.1rps          1ms          1ms          1ms
</span></span><span style=display:flex><span>probe                 default:all-unauthenticated  default/probe                                   0.0rps  100.00%  0.2rps          1ms          1ms          1ms
</span></span></code></pre></div><p>Now, let&rsquo;s create authorization and authentication policy resources to authorize
this route:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f - <span style=color:#a5d6ff>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: policy.linkerd.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: AuthorizationPolicy
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: authors-modify-policy
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: booksapp
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    group: policy.linkerd.io
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    name: authors-modify-route
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  requiredAuthenticationRefs:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    - name: authors-modify-authn
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      kind: MeshTLSAuthentication
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      group: policy.linkerd.io
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: policy.linkerd.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: MeshTLSAuthentication
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: authors-modify-authn
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: booksapp
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  identities:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    - &#34;webapp.booksapp.serviceaccount.identity.linkerd.cluster.local&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span></code></pre></div><p>These configurations are very similar to the <a href=../../reference/authorization-policy/#authorizationpolicy><code>AuthorizationPolicy</code></a> and
<a href=../../reference/authorization-policy/#meshtlsauthentication><code>MeshTLSAuthentication</code></a> resources we created in the previous section. However,
in this case, we only authenticate the <code>webapp</code> deployment&rsquo;s <code>ServiceAccount</code>
(and <em>not</em> the <code>books</code> deployment) to access this route.</p><p>Now, if we attempt to delete an author in the frontend once again, we can:</p><figure><img alt="Author deleted" class="img img--max-fill img--center img--rounded" src=/docs/images/books/delete-ok.png><figcaption>Author deleted</figcaption></figure><p>Similarly, we can now create a new author successfully, as well:</p><figure><img alt="Author created" class="img img--max-fill img--center img--rounded" src=/docs/images/books/create-ok.png><figcaption>Author created</figcaption></figure><p>Running the <code>linkerd viz authz</code> command one last time, we now see that all
traffic is authorized:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ linkerd viz authz -n booksapp deploy/authors
</span></span><span style=display:flex><span>ROUTE                 SERVER                       AUTHORIZATION                              UNAUTHORIZED  SUCCESS     RPS  LATENCY_P50  LATENCY_P95  LATENCY_P99
</span></span><span style=display:flex><span>authors-get-route     authors-server               authorizationpolicy/authors-get-policy           0.0rps  100.00%  0.1rps          0ms          0ms          0ms
</span></span><span style=display:flex><span>authors-modify-route  authors-server               authorizationpolicy/authors-modify-policy        0.0rps  100.00%  0.0rps          0ms          0ms          0ms
</span></span><span style=display:flex><span>authors-probe-route   authors-server               authorizationpolicy/authors-probe-policy         0.0rps  100.00%  0.1rps          1ms          1ms          1ms
</span></span><span style=display:flex><span>default               default:all-unauthenticated  default/all-unauthenticated                      0.0rps  100.00%  0.1rps          1ms          1ms          1ms
</span></span><span style=display:flex><span>probe                 default:all-unauthenticated  default/probe                                    0.0rps  100.00%  0.2rps          1ms          1ms          1ms
</span></span></code></pre></div><h2 id=next-steps class=anchor>Next Steps
<a href=#next-steps class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>We&rsquo;ve now covered the basics of configuring per-route authorization policies
with Linkerd. For more practice, try creating additional policies to restrict
access to the <code>books</code> service as well. Or, to learn more about Linkerd
authorization policy in general, and the various configurations that are
available, see the <a href=../../reference/authorization-policy/>Policy reference
docs</a>.</p></div></div></div></div></div></main><footer class=main-footer><div class=main-footer__top><div class="main-footer__container container"><div class=main-footer__info><p><img src=/logos/linkerd.png alt=Linkerd></p><p>Linkerd was originally created by <a href=https://buoyant.io/ target=_blank rel=noopener>Buoyant</a></p><p>View <a href=https://github.com/linkerd/linkerd/wiki/Linkerd-code-of-conduct target=_blank rel=noopener>Code of Conduct</a></p></div><div class=main-footer__links><div class=main-footer__community><h4>Community</h4><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener>GitHub</a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Linkerd Forum</a></li></ul></div><div class=main-footer__follow><h4>Follow</h4><ul><li><a href=https://www.linkedin.com/company/linkerd/ target=_blank rel=noopener>Linkedin</a></li><li><a href=https://www.youtube.com/buoyantio target=_blank rel=noopener>YouTube</a></li><li><a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a></li></ul></div></div></div></div><div class=main-footer__bottom><div class="main-footer__container container"><p><a href=https://github.com/linkerd/website/tree/main/linkerd.io/content target=_blank rel=noopener>Edit This Site</a></p><p>Copyright Â© 2024 Linkerd Authors. All rights reserved.</p></div></div></footer></body></html>