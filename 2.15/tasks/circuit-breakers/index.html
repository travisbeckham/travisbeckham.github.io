<!doctype html><html lang=en><head><meta charset=utf-8><title>Circuit Breakers | Linkerd</title>
<link rel="shortcut icon" href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Protect against service failures using circuit breakers"><meta property="og:url" content="https://travisbeckham.github.io/2.15/tasks/circuit-breakers/"><meta property="og:site_name" content="Linkerd"><meta property="og:title" content="Circuit Breakers"><meta property="og:description" content="Protect against service failures using circuit breakers"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="2.15"><meta property="og:image" content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:title content="Circuit Breakers"><meta name=twitter:description content="Protect against service failures using circuit breakers"><meta name=twitter:site content="@Linkerd"><link rel=canonical href=https://travisbeckham.github.io/2.15/tasks/circuit-breakers/><link rel=stylesheet href=/css/main.css><script src=/js/main.js></script><script async defer src=https://buttons.github.io/buttons.js></script></head><body><header class=main-header><div class=main-header__container><div class=main-header__logo><a href=/><img src=/logos/linkerd.png alt=Linkerd></a></div><input class=main-header__toggle-checkbox type=checkbox id=main-header-toggle>
<label class=main-header__toggle for=main-header-toggle><span class=main-header__toggle-icon><span class=main-header__toggle-icon--open><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3 6H21V8H3V6m0 5H21v2H3V11m0 5H21v2H3V16z"/></svg>
</span><span class=main-header__toggle-icon--close><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span></span></label><div class=main-header__nav><nav class=main-nav><ul class=main-nav__menu><li class=main-nav__menu--selected><a href=/docs>Docs</a></li><li><a href=#>Community<svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6L7.41 8.58z"/></svg></a><ul><li><a href=/community/get-involved/>Get Involved</a></li><li><a href=/community/adopters/>Adopters</a></li><li><a href=/community/ambassadors/>Linkerd Ambassadors</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Buoyant's Linkerd Forum</a></li></ul></li><li><a href=/blog/>Blog</a></li><li><a href=/faq/>FAQ</a></li><li><a href=/enterprise/>Enterprise</a></li></ul><div class=main-nav__search><form action=/search method=get><div class="search-input search-input--sm"><svg class="icon" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5.0 0116 9.5c0 1.61-.59 3.09-1.56 4.23L14.71 14H15.5l5 5L19 20.5l-5-5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5.0 013 9.5 6.5 6.5.0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
<input type=text name=q placeholder=Search></div></form></div><div class=main-nav__github><a class=github-button href=https://github.com/linkerd/linkerd2 data-icon=octicon-star data-size=large data-show-count=true aria-label="Star linkerd/linkerd2 on GitHub">Star</a></div><div class=main-nav__forum><a href=https://linkerd.buoyant.io class="button button--primary button--sm" target=_blank rel=noopener>Join Forum</a></div></nav></div></div></header><div class=main-announcement>Service Mesh 101: Get Service Mesh-Certified
<span class=main-announcement__link><a href=https://buoyant.io/courses/service-mesh-101 target=_blank rel=noopener>Enroll now</a></span></div><main class=main-content><div class="alert alert--warning alert--condensed alert--center docs__deprecated-alert"><div class=alert__content>You are viewing docs for an older version of Linkerd.
<a href=/2.16/>View the latest docs</a>.</div></div><div class=docs><div class=docs__container><div class=docs__sidebar><div class=docs__nav><div class=docs__versions><select onchange="window.location.href=this.value"><option value=/2-edge/>Linkerd edge</option><option value=/2.16/>Linkerd 2.16</option><option value=/2.15/ selected>Linkerd 2.15</option><option value=/2.14/>Linkerd 2.14</option><option value=/2.13/>Linkerd 2.13</option><option value=/2.12/>Linkerd 2.12</option><option value=/2.11/>Linkerd 2.11</option><option value=/2.10/>Linkerd 2.10</option></select></div><nav><ul><li><a href=/2.15/overview/>Overview</a></li><li><a href=/2.15/getting-started/>Getting Started</a></li><li><a href=/2.15/features/>Features
</a><input class=toggle__input type=checkbox id=toggle-9502176e66310dde847fdf0e0179df48>
<label class=toggle__label for=toggle-9502176e66310dde847fdf0e0179df48><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.15/features/http-grpc/>HTTP, HTTP/2, and gRPC Proxying</a></li><li><a href=/2.15/features/protocol-detection/>TCP Proxying and Protocol Detection</a></li><li><a href=/2.15/features/retries-and-timeouts/>Retries and Timeouts</a></li><li><a href=/2.15/features/automatic-mtls/>Automatic mTLS</a></li><li><a href=/2.15/features/ingress/>Ingress</a></li><li><a href=/2.15/features/telemetry/>Telemetry and Monitoring</a></li><li><a href=/2.15/features/load-balancing/>Load Balancing</a></li><li><a href=/2.15/features/server-policy/>Authorization Policy</a></li><li><a href=/2.15/features/proxy-injection/>Automatic Proxy Injection</a></li><li><a href=/2.15/features/cni/>CNI Plugin</a></li><li><a href=/2.15/features/dashboard/>Dashboard and on-cluster metrics stack</a></li><li><a href=/2.15/features/distributed-tracing/>Distributed Tracing</a></li><li><a href=/2.15/features/request-routing/>Dynamic Request Routing</a></li><li><a href=/2.15/features/fault-injection/>Fault Injection</a></li><li><a href=/2.15/features/ha/>High Availability</a></li><li><a href=/2.15/features/access-logging/>HTTP Access Logging</a></li><li><a href=/2.15/features/httproute/>HTTPRoutes</a></li><li><a href=/2.15/features/nft/>Iptables-nft Support</a></li><li><a href=/2.15/features/multicluster/>Multi-cluster communication</a></li><li><a href=/2.15/features/non-kubernetes-workloads/>Non-Kubernetes workloads (mesh expansion)</a></li><li><a href=/2.15/features/service-profiles/>Service Profiles</a></li><li><a href=/2.15/features/traffic-split/>Traffic Split (canaries, blue/green deploys)</a></li></ul></li><li class=docs__nav--selected><a href=/2.15/tasks/>Tasks
</a><input class=toggle__input type=checkbox id=toggle-d3491daa3401b9d2bd77587482630419 checked>
<label class=toggle__label for=toggle-d3491daa3401b9d2bd77587482630419><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.15/tasks/adding-non-kubernetes-workloads/>Adding non-Kubernetes workloads to your mesh</a></li><li><a href=/2.15/tasks/adding-your-service/>Adding your services to Linkerd</a></li><li><a href=/2.15/tasks/automatic-failover/>Automatic Multicluster Failover</a></li><li><a href=/2.15/tasks/automatically-rotating-control-plane-tls-credentials/>Automatically Rotating Control Plane TLS Credentials</a></li><li><a href=/2.15/tasks/automatically-rotating-webhook-tls-credentials/>Automatically Rotating Webhook TLS Credentials</a></li><li><a href=/2.15/tasks/external-prometheus/>Bringing your own Prometheus</a></li><li class=docs__nav--selected><a href=/2.15/tasks/circuit-breakers/>Circuit Breakers</a></li><li><a href=/2.15/tasks/configuring-dynamic-request-routing/>Configuring Dynamic Request Routing</a></li><li><a href=/2.15/tasks/configuring-per-route-policy/>Configuring Per-Route Authorization Policy</a></li><li><a href=/2.15/tasks/configuring-proxy-concurrency/>Configuring Proxy Concurrency</a></li><li><a href=/2.15/tasks/configuring-proxy-discovery-cache/>Configuring Proxy Discovery Cache</a></li><li><a href=/2.15/tasks/configuring-retries/>Configuring Retries</a></li><li><a href=/2.15/tasks/configuring-timeouts/>Configuring Timeouts</a></li><li><a href=/2.15/tasks/using-debug-endpoints/>Control Plane Debug Endpoints</a></li><li><a href=/2.15/tasks/customize-install/>Customizing Linkerd's Configuration with Kustomize</a></li><li><a href=/2.15/tasks/debugging-502s/>Debugging 502s</a></li><li><a href=/2.15/tasks/debugging-your-service/>Debugging gRPC applications with request tracing</a></li><li><a href=/2.15/tasks/books/>Debugging HTTP applications with per-route metrics</a></li><li><a href=/2.15/tasks/distributed-tracing/>Distributed tracing with Linkerd</a></li><li><a href=/2.15/tasks/exporting-metrics/>Exporting Metrics</a></li><li><a href=/2.15/tasks/exposing-dashboard/>Exposing the Dashboard</a></li><li><a href=/2.15/tasks/generate-certificates/>Generating your own mTLS root certificates</a></li><li><a href=/2.15/tasks/getting-per-route-metrics/>Getting Per-Route Metrics</a></li><li><a href=/2.15/tasks/linkerd-smi/>Getting started with Linkerd SMI extension</a></li><li><a href=/2.15/tasks/graceful-shutdown/>Graceful Pod Shutdown</a></li><li><a href=/2.15/tasks/grafana/>Grafana</a></li><li><a href=/2.15/tasks/using-ingress/>Handling ingress traffic</a></li><li><a href=/2.15/tasks/fault-injection/>Injecting Faults</a></li><li><a href=/2.15/tasks/install/>Installing Linkerd</a></li><li><a href=/2.15/tasks/install-helm/>Installing Linkerd with Helm</a></li><li><a href=/2.15/tasks/installing-multicluster/>Installing Multi-cluster Components</a></li><li><a href=/2.15/tasks/using-psp/>Linkerd and Pod Security Policies (PSP)</a></li><li><a href=/2.15/tasks/manually-rotating-control-plane-tls-credentials/>Manually Rotating Control Plane TLS Credentials</a></li><li><a href=/2.15/tasks/modifying-proxy-log-level/>Modifying the Proxy Log Level</a></li><li><a href=/2.15/tasks/multicluster/>Multi-cluster communication</a></li><li><a href=/2.15/tasks/multicluster-using-statefulsets/>Multi-cluster communication with StatefulSets</a></li><li><a href=/2.15/tasks/pod-to-pod-multicluster/>Pod-to-Pod Multi-cluster communication</a></li><li><a href=/2.15/tasks/flagger/>Progressive Delivery</a></li><li><a href=/2.15/tasks/replacing_expired_certificates/>Replacing expired certificates</a></li><li><a href=/2.15/tasks/restricting-access/>Restricting Access To Services</a></li><li><a href=/2.15/tasks/rotating_webhooks_certificates/>Rotating webhooks certificates</a></li><li><a href=/2.15/tasks/securing-linkerd-tap/>Securing Linkerd Tap</a></li><li><a href=/2.15/tasks/setting-up-service-profiles/>Setting Up Service Profiles</a></li><li><a href=/2.15/tasks/traffic-shifting/>Traffic Shifting</a></li><li><a href=/2.15/tasks/troubleshooting/>Troubleshooting</a></li><li><a href=/2.15/tasks/uninstall/>Uninstalling Linkerd</a></li><li><a href=/2.15/tasks/uninstall-multicluster/>Uninstalling Multicluster</a></li><li><a href=/2.15/tasks/upgrade/>Upgrading Linkerd</a></li><li><a href=/2.15/tasks/using-custom-domain/>Using a Custom Cluster Domain</a></li><li><a href=/2.15/tasks/extensions/>Using extensions</a></li><li><a href=/2.15/tasks/gitops/>Using GitOps with Linkerd with Argo CD</a></li><li><a href=/2.15/tasks/using-the-debug-container/>Using the Debug Sidecar</a></li><li><a href=/2.15/tasks/validating-your-traffic/>Validating your mTLS traffic</a></li></ul></li><li><a href=/2.15/reference/>Reference
</a><input class=toggle__input type=checkbox id=toggle-6c1ed631a095b70fc00aeb5c380a1fe3>
<label class=toggle__label for=toggle-6c1ed631a095b70fc00aeb5c380a1fe3><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.15/reference/architecture/>Architecture</a></li><li><a href=/2.15/reference/authorization-policy/>Authorization Policy</a></li><li><a href=/2.15/reference/circuit-breaking/>Circuit Breaking</a></li><li><a href=/2.15/reference/cli/>CLI
</a><input class=toggle__input type=checkbox id=toggle-bc91c7f240985a01728bf733237a9d0d>
<label class=toggle__label for=toggle-bc91c7f240985a01728bf733237a9d0d><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.15/reference/cli/authz/>authz</a></li><li><a href=/2.15/reference/cli/check/>check</a></li><li><a href=/2.15/reference/cli/completion/>completion</a></li><li><a href=/2.15/reference/cli/diagnostics/>diagnostics</a></li><li><a href=/2.15/reference/cli/identity/>identity</a></li><li><a href=/2.15/reference/cli/inject/>inject</a></li><li><a href=/2.15/reference/cli/install/>install</a></li><li><a href=/2.15/reference/cli/install-cni/>install-cni</a></li><li><a href=/2.15/reference/cli/jaeger/>jaeger</a></li><li><a href=/2.15/reference/cli/multicluster/>multicluster</a></li><li><a href=/2.15/reference/cli/profile/>profile</a></li><li><a href=/2.15/reference/cli/prune/>prune</a></li><li><a href=/2.15/reference/cli/uninject/>uninject</a></li><li><a href=/2.15/reference/cli/uninstall/>uninstall</a></li><li><a href=/2.15/reference/cli/upgrade/>upgrade</a></li><li><a href=/2.15/reference/cli/version/>version</a></li><li><a href=/2.15/reference/cli/viz/>viz</a></li></ul></li><li><a href=/2.15/reference/cluster-configuration/>Cluster Configuration</a></li><li><a href=/2.15/reference/extension-list/>Extensions List</a></li><li><a href=/2.15/reference/external-workload/>ExternalWorkload</a></li><li><a href=/2.15/reference/httproute/>HTTPRoute</a></li><li><a href=/2.15/reference/iptables/>IPTables Reference</a></li><li><a href=/2.15/reference/multicluster/>Multi-cluster communication</a></li><li><a href=/2.15/reference/proxy-configuration/>Proxy Configuration</a></li><li><a href=/2.15/reference/proxy-log-level/>Proxy Log Level</a></li><li><a href=/2.15/reference/proxy-metrics/>Proxy Metrics</a></li><li><a href=/2.15/reference/service-profiles/>Service Profiles</a></li><li><a href=/2.15/reference/k8s-versions/>Supported Kubernetes Versions</a></li></ul></li><li><a href=/2.15/common-errors/>Common Errors
</a><input class=toggle__input type=checkbox id=toggle-70fc38683e3d1aadd6c9fc9f3235e04b>
<label class=toggle__label for=toggle-70fc38683e3d1aadd6c9fc9f3235e04b><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.15/common-errors/failfast/>Failfast</a></li><li><a href=/2.15/common-errors/http-502/>HTTP 502 Errors</a></li><li><a href=/2.15/common-errors/http-503-504/>HTTP 503 and 504 Errors</a></li><li><a href=/2.15/common-errors/protocol-detection/>Protocol Detection Errors</a></li></ul></li></ul><ul><li><a href=/what-is-a-service-mesh/>What is a service mesh?</a></li><li><a href=/faq/>Frequently Asked Questions</a></li><li><a href=/releases/>Releases and Versions</a></li><li><a href=/design-principles/>Design Principles</a></li><li><a href=/going-to-production/>Going to Production</a></li><li><a href=/service-mesh-glossary/>Service Mesh Glossary</a></li></ul></nav><div class=docs__community><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener><img src=/logos/github.svg alt=GitHub class=img></a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener><img src=/logos/slack.svg alt=Slack class=img></a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener><img src=/logos/forum.png alt="Linkerd Forum" class=img></a></li></ul></div></div></div><div class=docs__main><div class=docs__body><div class=docs__header><h1>Circuit Breakers</h1></div><div class="docs__content prose"><p>Circuit breaking is a powerful feature where Linkerd will temporarily stop
routing requests to an endpoint if that endpoint is deemed to be unhealthy,
instead routing that request to other replicas in the Service.</p><p>In this tutoral, we&rsquo;ll see how to enable circuit breaking on a Service to
improve client success rate when a backend replica is unhealthy.</p><p>See the <a href=../../reference/circuit-breaking/>reference documentation</a> for more
details on how Linkerd implements circuit breaking.</p><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Linkerd Production Tip</h4></div><div class=alert__content>This page contains best-effort instructions by the open source community. Production users with mission-critical applications should familiarize themselves with <a href=/going-to-production/>Linkerd production resources</a> and/or connect with a commercial <a href=/support-training/>Linkerd provider</a>.</div></div><h2 id=prerequisites class=anchor>Prerequisites
<a href=#prerequisites class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>To use this guide, you&rsquo;ll need a Kubernetes cluster running:</p><ul><li>Linkerd and Linkerd-Viz. If you haven&rsquo;t installed these yet, follow the
<a href=../install/>Installing Linkerd Guide</a>.</li></ul><h2 id=set-up-the-demo class=anchor>Set up the demo
<a href=#set-up-the-demo class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Remember those puzzles where one guard always tells the truth and one guard
always lies? This demo involves one pod (named <code>good</code>) which always returns an
HTTP 200 and one pod (named <code>bad</code>) which always returns an HTTP 500. We&rsquo;ll also
create a load generator to send traffic to a Service which includes these two
pods.</p><p>For load generation we&rsquo;ll use
<a href=https://github.com/BuoyantIO/slow_cooker target=_blank rel=noopener>Slow-Cooker</a>
and for the backend pods we&rsquo;ll use <a href=https://github.com/BuoyantIO/bb target=_blank rel=noopener>BB</a>.</p><p>To add these components to your cluster and include them in the Linkerd
<a href=../../reference/architecture/#data-plane>data plane</a>, run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#a5d6ff>&lt;&lt;EOF | linkerd inject - | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: Namespace
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: circuit-breaking-demo
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: good
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: circuit-breaking-demo
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  selector:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      class: good
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  template:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      labels:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        class: good
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        app: bb
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      containers:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      - name: terminus
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        image: buoyantio/bb:v0.0.6
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        args:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        - terminus
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        - &#34;--h1-server-port=8080&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        ports:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        - containerPort: 8080
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: bad
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: circuit-breaking-demo
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  selector:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      class: bad
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  template:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      labels:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        class: bad
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        app: bb
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      containers:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      - name: terminus
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        image: buoyantio/bb:v0.0.6
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        args:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        - terminus
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        - &#34;--h1-server-port=8080&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        - &#34;--percent-failure=100&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        ports:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        - containerPort: 8080
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: bb
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: circuit-breaking-demo
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  ports:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  - name: http
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    port: 8080
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    targetPort: 8080
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  selector:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    app: bb
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: slow-cooker
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: circuit-breaking-demo
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  selector:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      app: slow-cooker
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  template:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      labels:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        app: slow-cooker
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      containers:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      - args:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        - -c
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        - |
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          sleep 5 # wait for pods to start
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          /slow_cooker/slow_cooker --qps 10 http://bb:8080
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        command:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        - /bin/sh
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        image: buoyantio/slow_cooker:1.3.0
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        name: slow-cooker
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span></code></pre></div><p>We can now look at the success rate of the <code>good</code> and <code>bad</code> pods:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8b949e>&gt;</span> linkerd viz -n circuit-breaking-demo stat deploy
</span></span><span style=display:flex><span><span style=color:#8b949e>NAME          MESHED   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99   TCP_CONN
</span></span></span><span style=display:flex><span><span style=color:#8b949e>bad              1/1     6.43%   4.7rps           1ms           1ms           4ms          2
</span></span></span><span style=display:flex><span><span style=color:#8b949e>good             1/1   100.00%   5.9rps           1ms           1ms           1ms          3
</span></span></span><span style=display:flex><span><span style=color:#8b949e>slow-cooker      1/1   100.00%   0.3rps           1ms           1ms           1ms          1
</span></span></span></code></pre></div><p>Here we can see that <code>good</code> and <code>bad</code> deployments are each receiving similar
amounts of traffic, but <code>good</code> has a success rate of 100% while the success
rate of <code>bad</code> is very low (only healthcheck probes are succeeding). We can also
see how this looks from the perspective of the traffic generator:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8b949e>&gt;</span> linkerd viz -n circuit-breaking-demo stat deploy/slow-cooker --to svc/bb
</span></span><span style=display:flex><span><span style=color:#8b949e>NAME          MESHED   SUCCESS       RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99   TCP_CONN
</span></span></span><span style=display:flex><span><span style=color:#8b949e>slow-cooker      1/1    51.00%   10.0rps           1ms           1ms           2ms          2
</span></span></span></code></pre></div><p>From <code>slow-cooker</code>&rsquo;s perspective, roughly 50% of requests that it sends to the
Service are failing. We can use circuit breaking to improve this by cutting off
traffic to the <code>bad</code> pod.</p><h2 id=breaking-the-circuit class=anchor>Breaking the circuit
<a href=#breaking-the-circuit class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Linkerd supports a type of circuit breaking called <a href=../../reference/circuit-breaking/#consecutive-failures><em>consecutive failure
accrual</em></a>.
This works by tracking consecutive failures from each endpoint in Linkerd&rsquo;s
internal load balancer. If there are ever too many failures in a row, that
endpoint is temporarily ignored and Linkerd will only load balance among the
remaining endpoints. After a <a href=../../reference/circuit-breaking/#probation-and-backoffs>backoff
period</a>, the endpoint
is re-introduced so that we can determine if it has become healthy.</p><p>Let&rsquo;s enable consecutive failure accrual on the <code>bb</code> Service by adding an
annotation:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl annotate -n circuit-breaking-demo svc/bb balancer.linkerd.io/failure-accrual<span style=color:#ff7b72;font-weight:700>=</span>consecutive
</span></span></code></pre></div><div class="alert alert--warning alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 14H11V9h2m0 9H11V16h2M1 21H23L12 2 1 21z"/></svg><h4>Warning</h4></div><div class=alert__content>Circuit breaking is <strong>incompatible with ServiceProfiles</strong>. If a
<a href=../../features/service-profiles/>ServiceProfile</a> is defined for the annotated
Service, proxies will not perform circuit breaking as long as the ServiceProfile
exists.</div></div><p>We can check that failure accrual was configured correctly by using a Linkerd
diagnostics command. The <code>linkerd diagnostics policy</code> command prints the policy
that Linkerd will use when sending traffic to a Service. We&rsquo;ll use the
<a href=https://stedolan.github.io/jq/ target=_blank rel=noopener>jq</a> utility to filter the output to focus on
failure accrual:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8b949e>&gt;</span> linkerd diagnostics policy -n circuit-breaking-demo svc/bb <span style=color:#a5d6ff>8080</span> -o json | jq <span style=color:#a5d6ff>&#39;.protocol.Kind.Detect.http1.failure_accrual&#39;</span>
</span></span><span style=display:flex><span><span style=color:#8b949e>{
</span></span></span><span style=display:flex><span><span style=color:#8b949e>  &#34;Kind&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#8b949e>    &#34;ConsecutiveFailures&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#8b949e>      &#34;max_failures&#34;: 7,
</span></span></span><span style=display:flex><span><span style=color:#8b949e>      &#34;backoff&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#8b949e>        &#34;min_backoff&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#8b949e>          &#34;seconds&#34;: 1
</span></span></span><span style=display:flex><span><span style=color:#8b949e>        },
</span></span></span><span style=display:flex><span><span style=color:#8b949e>        &#34;max_backoff&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#8b949e>          &#34;seconds&#34;: 60
</span></span></span><span style=display:flex><span><span style=color:#8b949e>        },
</span></span></span><span style=display:flex><span><span style=color:#8b949e>        &#34;jitter_ratio&#34;: 0.5
</span></span></span><span style=display:flex><span><span style=color:#8b949e>      }
</span></span></span><span style=display:flex><span><span style=color:#8b949e>    }
</span></span></span><span style=display:flex><span><span style=color:#8b949e>  }
</span></span></span><span style=display:flex><span><span style=color:#8b949e>}
</span></span></span></code></pre></div><p>This tells us that Linkerd will use <code>ConsecutiveFailures</code> failure accrual
when talking to the <code>bb</code> Service. It also tells us that the <code>max_failures</code> is
7, meaning that it will trip the circuit breaker once it observes 7 consective
failures. We&rsquo;ll talk more about each of the parameters here at the end of this
article.</p><p>Let&rsquo;s look at how much traffic each pod is getting now that the circuit breaker
is in place:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8b949e>&gt;</span> linkerd viz -n circuit-breaking-demo stat deploy
</span></span><span style=display:flex><span><span style=color:#8b949e>NAME          MESHED   SUCCESS       RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99   TCP_CONN
</span></span></span><span style=display:flex><span><span style=color:#8b949e>bad              1/1    94.74%    0.3rps           1ms           1ms           1ms          3
</span></span></span><span style=display:flex><span><span style=color:#8b949e>good             1/1   100.00%   10.3rps           1ms           1ms           4ms          4
</span></span></span><span style=display:flex><span><span style=color:#8b949e>slow-cooker      1/1   100.00%    0.3rps           1ms           1ms           1ms          1
</span></span></span></code></pre></div><p>Notice that the <code>bad</code> pod&rsquo;s RPS is significantly lower now. The circuit breaker
has stopped nearly all of the traffic from <code>slow-cooker</code> to <code>bad</code>.</p><p>We can also see how this has affected <code>slow-cooker</code>:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8b949e>&gt;</span> linkerd viz -n circuit-breaking-demo stat deploy/slow-cooker --to svc/bb
</span></span><span style=display:flex><span><span style=color:#8b949e>NAME          MESHED   SUCCESS       RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99   TCP_CONN
</span></span></span><span style=display:flex><span><span style=color:#8b949e>slow-cooker      1/1    99.83%   10.0rps           1ms           1ms           1ms          4
</span></span></span></code></pre></div><p>Nearly all of <code>slow-cooker</code>&rsquo;s requests are now getting routed to the <code>good</code> pod
and succeeding!</p><h2 id=tuning-circuit-breaking class=anchor>Tuning circuit breaking
<a href=#tuning-circuit-breaking class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>As we saw when we ran the <code>linkerd diagnostics policy</code> command, consecutive
failure accrual is controlled by a number of parameters. Each of these
parameters has a default, but can be manually configured using annotations:</p><ul><li><code>balancer.linkerd.io/failure-accrual-consecutive-max-failures</code><ul><li>The number of consecutive failures that Linkerd must observe before
tripping the circuit breaker (default: 7). Consider setting a lower value
if you want circuit breaks to trip more easily which can lead to better
success rate at the expense of less evenly distributed traffic. Consider
setting a higher value if you find circuit breakers are tripping too easily,
causing traffic to be cut off from healthy endpoints.</li></ul></li><li><code>balancer.linkerd.io/failure-accrual-consecutive-max-penalty</code><ul><li>The maximum amount of time a circuit breaker will remain tripped
before the endpoint is restored (default: 60s). Consider setting a longer
duration if you want to reduce the amount of traffic to endpoints which have
tripped the circuit breaker. Consider setting a shorter duration if you&rsquo;d
like tripped circuit breakers to recover faster after an endpoint becomes
healthy again.</li></ul></li><li><code>balancer.linkerd.io/failure-accrual-consecutive-min-penalty</code><ul><li>The minimum amount of time a circuit breaker will remain tripped
before the endpoints is restored (default: 1s). Consider tuning this in a
similar way to <code>failure-accrual-consecutive-max-penalty</code>.</li></ul></li><li><code>balancer.linkerd.io/failure-accrual-consecutive-jitter-ratio</code><ul><li>The amount of jitter to introduce to circuit breaker backoffs (default: 0.5).
You are unlikely to need to tune this but might consider increasing it if
you notice many clients are sending requests to a circuit broken endpoint
at the same time, leading to spiky traffic patterns.</li></ul></li></ul><p>See the <a href=../../reference/circuit-breaking/#configuring-failure-accrual>reference
documentation</a>
for details on failure accrual configuration.</p></div></div></div></div></div></main><footer class=main-footer><div class=main-footer__top><div class="main-footer__container container"><div class=main-footer__info><p><img src=/logos/linkerd.png alt=Linkerd></p><p>Linkerd was originally created by <a href=https://buoyant.io/ target=_blank rel=noopener>Buoyant</a></p><p>View <a href=https://github.com/linkerd/linkerd/wiki/Linkerd-code-of-conduct target=_blank rel=noopener>Code of Conduct</a></p></div><div class=main-footer__links><div class=main-footer__community><h4>Community</h4><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener>GitHub</a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Linkerd Forum</a></li></ul></div><div class=main-footer__follow><h4>Follow</h4><ul><li><a href=https://www.linkedin.com/company/linkerd/ target=_blank rel=noopener>Linkedin</a></li><li><a href=https://www.youtube.com/buoyantio target=_blank rel=noopener>YouTube</a></li><li><a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a></li></ul></div></div></div></div><div class=main-footer__bottom><div class="main-footer__container container"><p><a href=https://github.com/linkerd/website/tree/main/linkerd.io/content target=_blank rel=noopener>Edit This Site</a></p><p>Copyright Â© 2024 Linkerd Authors. All rights reserved.</p></div></div></footer></body></html>