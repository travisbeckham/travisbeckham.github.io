<!doctype html><html lang=en><head><meta charset=utf-8><title>Handling ingress traffic | Linkerd</title>
<link rel="shortcut icon" href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Linkerd can work alongside your ingress controller of choice."><meta property="og:url" content="https://travisbeckham.github.io/2-edge/tasks/using-ingress/"><meta property="og:site_name" content="Linkerd"><meta property="og:title" content="Handling ingress traffic"><meta property="og:description" content="Linkerd can work alongside your ingress controller of choice."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="2-edge"><meta property="og:image" content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:title content="Handling ingress traffic"><meta name=twitter:description content="Linkerd can work alongside your ingress controller of choice."><meta name=twitter:site content="@Linkerd"><link rel=canonical href=https://travisbeckham.github.io/2-edge/tasks/using-ingress/><link rel=stylesheet href=/css/main.css><script src=/js/main.js></script><script async defer src=https://buttons.github.io/buttons.js></script></head><body><header class=main-header><div class=main-header__container><div class=main-header__logo><a href=/><img src=/logos/linkerd.png alt=Linkerd></a></div><input class=main-header__toggle-checkbox type=checkbox id=main-header-toggle>
<label class=main-header__toggle for=main-header-toggle><span class=main-header__toggle-icon><span class=main-header__toggle-icon--open><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3 6H21V8H3V6m0 5H21v2H3V11m0 5H21v2H3V16z"/></svg>
</span><span class=main-header__toggle-icon--close><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span></span></label><div class=main-header__nav><nav class=main-nav><ul class=main-nav__menu><li class=main-nav__menu--selected><a href=/docs>Docs</a></li><li><a href>Community<svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6L7.41 8.58z"/></svg></a><ul><li><a href=/community/get-involved/>Get Involved</a></li><li><a href=/community/adopters/>Adopters</a></li><li><a href=/community/ambassadors/>Linkerd Ambassadors</a></li><li><a href=/community/heroes/>Linkerd Heroes</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Buoyant's Linkerd Forum</a></li></ul></li><li><a href=/blog/>Blog</a></li><li><a href=/faq/>FAQ</a></li><li><a href=/enterprise/>Enterprise</a></li></ul><div class=main-nav__search><form action=/search method=get><div class="search-input search-input--sm"><svg class="icon" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5.0 0116 9.5c0 1.61-.59 3.09-1.56 4.23L14.71 14H15.5l5 5L19 20.5l-5-5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5.0 013 9.5 6.5 6.5.0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
<input type=text name=q placeholder=Search></div></form></div><div class=main-nav__github><a class=github-button href=https://github.com/linkerd/linkerd2 data-icon=octicon-star data-size=large data-show-count=true aria-label="Star linkerd/linkerd2 on GitHub">Star</a></div><div class=main-nav__forum><a href=https://linkerd.buoyant.io class="button button--primary button--sm" target=_blank rel=noopener>Join Forum</a></div></nav></div></div></header><div class=main-announcement>Service Mesh 101: Get Service Mesh-Certified
<span class=main-announcement__link><a href=https://buoyant.io/courses/service-mesh-101 target=_blank rel=noopener>Enroll now</a></span></div><main class=main-content><div class=docs><div class=docs__container><div class=docs__sidebar><div class=docs__nav><div class=docs__versions><select onchange="window.location.href=this.value"><option value=/2-edge/ selected>Linkerd edge</option><option value=/2.16/>Linkerd 2.16</option><option value=/2.15/>Linkerd 2.15</option><option value=/2.14/>Linkerd 2.14</option><option value=/2.13/>Linkerd 2.13</option><option value=/2.12/>Linkerd 2.12</option><option value=/2.11/>Linkerd 2.11</option><option value=/2.10/>Linkerd 2.10</option><option value=/2.9/>Linkerd 2.9</option></select></div><nav><ul><li><a href=/2-edge/overview/>Overview</a></li><li><a href=/2-edge/getting-started/>Getting Started</a></li><li><a href=/2-edge/features/>Features
</a><input class=toggle__input type=checkbox id=toggle-f524806733d51ea4f7c2504b44379f32>
<label class=toggle__label for=toggle-f524806733d51ea4f7c2504b44379f32><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2-edge/features/http-grpc/>HTTP, HTTP/2, and gRPC Proxying</a></li><li><a href=/2-edge/features/protocol-detection/>TCP Proxying and Protocol Detection</a></li><li><a href=/2-edge/features/retries-and-timeouts/>Retries and Timeouts</a></li><li><a href=/2-edge/features/automatic-mtls/>Automatic mTLS</a></li><li><a href=/2-edge/features/ingress/>Ingress</a></li><li><a href=/2-edge/features/telemetry/>Telemetry and Monitoring</a></li><li><a href=/2-edge/features/load-balancing/>Load Balancing</a></li><li><a href=/2-edge/features/server-policy/>Authorization Policy</a></li><li><a href=/2-edge/features/proxy-injection/>Automatic Proxy Injection</a></li><li><a href=/2-edge/features/cni/>CNI Plugin</a></li><li><a href=/2-edge/features/dashboard/>Dashboard and on-cluster metrics stack</a></li><li><a href=/2-edge/features/distributed-tracing/>Distributed Tracing</a></li><li><a href=/2-edge/features/request-routing/>Dynamic Request Routing</a></li><li><a href=/2-edge/features/fault-injection/>Fault Injection</a></li><li><a href=/2-edge/features/ha/>High Availability</a></li><li><a href=/2-edge/features/access-logging/>HTTP Access Logging</a></li><li><a href=/2-edge/features/httproute/>HTTPRoutes</a></li><li><a href=/2-edge/features/nft/>Iptables-nft Support</a></li><li><a href=/2-edge/features/ipv6/>IPv6 Support</a></li><li><a href=/2-edge/features/multicluster/>Multi-cluster communication</a></li><li><a href=/2-edge/features/non-kubernetes-workloads/>Non-Kubernetes workloads (mesh expansion)</a></li><li><a href=/2-edge/features/service-profiles/>Service Profiles</a></li><li><a href=/2-edge/features/traffic-split/>Traffic Split (canaries, blue/green deploys)</a></li></ul></li><li class=docs__nav--selected><a href=/2-edge/tasks/>Tasks
</a><input class=toggle__input type=checkbox id=toggle-eb66af6ff84f9fce506d3a9073494489 checked>
<label class=toggle__label for=toggle-eb66af6ff84f9fce506d3a9073494489><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2-edge/tasks/adding-non-kubernetes-workloads/>Adding non-Kubernetes workloads to your mesh</a></li><li><a href=/2-edge/tasks/adding-your-service/>Adding your services to Linkerd</a></li><li><a href=/2-edge/tasks/automatic-failover/>Automatic Multicluster Failover</a></li><li><a href=/2-edge/tasks/automatically-rotating-control-plane-tls-credentials/>Automatically Rotating Control Plane TLS Credentials</a></li><li><a href=/2-edge/tasks/automatically-rotating-webhook-tls-credentials/>Automatically Rotating Webhook TLS Credentials</a></li><li><a href=/2-edge/tasks/external-prometheus/>Bringing your own Prometheus</a></li><li><a href=/2-edge/tasks/circuit-breakers/>Circuit Breakers</a></li><li><a href=/2-edge/tasks/configuring-dynamic-request-routing/>Configuring Dynamic Request Routing</a></li><li><a href=/2-edge/tasks/configuring-per-route-policy/>Configuring Per-Route Authorization Policy</a></li><li><a href=/2-edge/tasks/configuring-proxy-concurrency/>Configuring Proxy Concurrency</a></li><li><a href=/2-edge/tasks/configuring-proxy-discovery-cache/>Configuring Proxy Discovery Cache</a></li><li><a href=/2-edge/tasks/configuring-retries/>Configuring Retries</a></li><li><a href=/2-edge/tasks/configuring-timeouts/>Configuring Timeouts</a></li><li><a href=/2-edge/tasks/using-debug-endpoints/>Control Plane Debug Endpoints</a></li><li><a href=/2-edge/tasks/customize-install/>Customizing Linkerd's Configuration with Kustomize</a></li><li><a href=/2-edge/tasks/debugging-502s/>Debugging 502s</a></li><li><a href=/2-edge/tasks/debugging-your-service/>Debugging gRPC applications with request tracing</a></li><li><a href=/2-edge/tasks/books/>Debugging HTTP applications with per-route metrics</a></li><li><a href=/2-edge/tasks/distributed-tracing/>Distributed tracing with Linkerd</a></li><li><a href=/2-edge/tasks/exporting-metrics/>Exporting Metrics</a></li><li><a href=/2-edge/tasks/exposing-dashboard/>Exposing the Dashboard</a></li><li><a href=/2-edge/tasks/generate-certificates/>Generating your own mTLS root certificates</a></li><li><a href=/2-edge/tasks/getting-per-route-metrics/>Getting Per-Route Metrics</a></li><li><a href=/2-edge/tasks/linkerd-smi/>Getting started with Linkerd SMI extension</a></li><li><a href=/2-edge/tasks/graceful-shutdown/>Graceful Pod Shutdown</a></li><li><a href=/2-edge/tasks/grafana/>Grafana</a></li><li class=docs__nav--selected><a href=/2-edge/tasks/using-ingress/>Handling ingress traffic</a></li><li><a href=/2-edge/tasks/fault-injection/>Injecting Faults</a></li><li><a href=/2-edge/tasks/install/>Installing Linkerd</a></li><li><a href=/2-edge/tasks/install-helm/>Installing Linkerd with Helm</a></li><li><a href=/2-edge/tasks/installing-multicluster/>Installing Multi-cluster Components</a></li><li><a href=/2-edge/tasks/using-psp/>Linkerd and Pod Security Policies (PSP)</a></li><li><a href=/2-edge/tasks/manually-rotating-control-plane-tls-credentials/>Manually Rotating Control Plane TLS Credentials</a></li><li><a href=/2-edge/tasks/modifying-proxy-log-level/>Modifying the Proxy Log Level</a></li><li><a href=/2-edge/tasks/multicluster/>Multi-cluster communication</a></li><li><a href=/2-edge/tasks/multicluster-using-statefulsets/>Multi-cluster communication with StatefulSets</a></li><li><a href=/2-edge/tasks/per-request-policy/>Per-Request Policy</a></li><li><a href=/2-edge/tasks/pod-to-pod-multicluster/>Pod-to-Pod Multi-cluster communication</a></li><li><a href=/2-edge/tasks/flagger/>Progressive Delivery</a></li><li><a href=/2-edge/tasks/replacing_expired_certificates/>Replacing expired certificates</a></li><li><a href=/2-edge/tasks/restricting-access/>Restricting Access To Services</a></li><li><a href=/2-edge/tasks/rotating_webhooks_certificates/>Rotating webhooks certificates</a></li><li><a href=/2-edge/tasks/securing-linkerd-tap/>Securing Linkerd Tap</a></li><li><a href=/2-edge/tasks/setting-up-service-profiles/>Setting Up Service Profiles</a></li><li><a href=/2-edge/tasks/traffic-shifting/>Traffic Shifting</a></li><li><a href=/2-edge/tasks/troubleshooting/>Troubleshooting</a></li><li><a href=/2-edge/tasks/uninstall/>Uninstalling Linkerd</a></li><li><a href=/2-edge/tasks/uninstall-multicluster/>Uninstalling Multicluster</a></li><li><a href=/2-edge/tasks/upgrade/>Upgrading Linkerd</a></li><li><a href=/2-edge/tasks/using-custom-domain/>Using a Custom Cluster Domain</a></li><li><a href=/2-edge/tasks/extensions/>Using extensions</a></li><li><a href=/2-edge/tasks/gitops/>Using GitOps with Linkerd with Argo CD</a></li><li><a href=/2-edge/tasks/using-the-debug-container/>Using the Debug Sidecar</a></li><li><a href=/2-edge/tasks/validating-your-traffic/>Validating your mTLS traffic</a></li></ul></li><li><a href=/2-edge/reference/>Reference
</a><input class=toggle__input type=checkbox id=toggle-c5cd1c9c50e40c408453dcf4eae5468f>
<label class=toggle__label for=toggle-c5cd1c9c50e40c408453dcf4eae5468f><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2-edge/reference/architecture/>Architecture</a></li><li><a href=/2-edge/reference/authorization-policy/>Authorization Policy</a></li><li><a href=/2-edge/reference/circuit-breaking/>Circuit Breaking</a></li><li><a href=/2-edge/reference/cli/>CLI
</a><input class=toggle__input type=checkbox id=toggle-3670a1706f943ec7fd577cd3725efcef>
<label class=toggle__label for=toggle-3670a1706f943ec7fd577cd3725efcef><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2-edge/reference/cli/authz/>authz</a></li><li><a href=/2-edge/reference/cli/check/>check</a></li><li><a href=/2-edge/reference/cli/completion/>completion</a></li><li><a href=/2-edge/reference/cli/diagnostics/>diagnostics</a></li><li><a href=/2-edge/reference/cli/identity/>identity</a></li><li><a href=/2-edge/reference/cli/inject/>inject</a></li><li><a href=/2-edge/reference/cli/install/>install</a></li><li><a href=/2-edge/reference/cli/install-cni/>install-cni</a></li><li><a href=/2-edge/reference/cli/jaeger/>jaeger</a></li><li><a href=/2-edge/reference/cli/multicluster/>multicluster</a></li><li><a href=/2-edge/reference/cli/profile/>profile</a></li><li><a href=/2-edge/reference/cli/prune/>prune</a></li><li><a href=/2-edge/reference/cli/uninject/>uninject</a></li><li><a href=/2-edge/reference/cli/uninstall/>uninstall</a></li><li><a href=/2-edge/reference/cli/upgrade/>upgrade</a></li><li><a href=/2-edge/reference/cli/version/>version</a></li><li><a href=/2-edge/reference/cli/viz/>viz</a></li></ul></li><li><a href=/2-edge/reference/cluster-configuration/>Cluster Configuration</a></li><li><a href=/2-edge/reference/extension-list/>Extensions List</a></li><li><a href=/2-edge/reference/external-workload/>ExternalWorkload</a></li><li><a href=/2-edge/reference/httproute/>HTTPRoute</a></li><li><a href=/2-edge/reference/iptables/>IPTables Reference</a></li><li><a href=/2-edge/reference/multicluster/>Multi-cluster communication</a></li><li><a href=/2-edge/reference/proxy-configuration/>Proxy Configuration</a></li><li><a href=/2-edge/reference/proxy-log-level/>Proxy Log Level</a></li><li><a href=/2-edge/reference/proxy-metrics/>Proxy Metrics</a></li><li><a href=/2-edge/reference/retries/>Retries</a></li><li><a href=/2-edge/reference/service-profiles/>Service Profiles</a></li><li><a href=/2-edge/reference/k8s-versions/>Supported Kubernetes Versions</a></li><li><a href=/2-edge/reference/timeouts/>Timeouts</a></li></ul></li><li><a href=/2-edge/common-errors/>Common Errors
</a><input class=toggle__input type=checkbox id=toggle-de403e5bf3db4733165f05741364f350>
<label class=toggle__label for=toggle-de403e5bf3db4733165f05741364f350><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2-edge/common-errors/failfast/>Failfast</a></li><li><a href=/2-edge/common-errors/http-502/>HTTP 502 Errors</a></li><li><a href=/2-edge/common-errors/http-503-504/>HTTP 503 and 504 Errors</a></li><li><a href=/2-edge/common-errors/protocol-detection/>Protocol Detection Errors</a></li></ul></li></ul><ul><li><a href=/what-is-a-service-mesh/>What is a service mesh?</a></li><li><a href=/faq/>Frequently Asked Questions</a></li><li><a href=/releases/>Releases and Versions</a></li><li><a href=/design-principles/>Design Principles</a></li><li><a href=/going-to-production/>Going to Production</a></li><li><a href=/service-mesh-glossary/>Service Mesh Glossary</a></li></ul></nav><div class=docs__community><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener><img src=/logos/github.svg alt=GitHub class=img></a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener><img src=/logos/slack.svg alt=Slack class=img></a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener><img src=/logos/forum.png alt="Linkerd Forum" class=img></a></li></ul></div></div></div><div class=docs__main><div class=docs__body><div class=docs__header><h1>Handling ingress traffic</h1></div><div class="docs__content prose"><p>Ingress traffic refers to traffic that comes into your cluster from outside the
cluster. For reasons of simplicity and composability, Linkerd itself doesn&rsquo;t
provide a built-in ingress solution for handling traffic coming into the
cluster. Instead, Linkerd is designed to work with the many existing Kubernetes
ingress options.</p><p>Combining Linkerd and your ingress solution of choice requires two things:</p><ol><li>Configuring your ingress to support Linkerd (if necessary).</li><li>Meshing your ingress pods.</li></ol><p>Strictly speaking, meshing your ingress pods is not required to allow traffic
into the cluster. However, it is recommended, as it allows Linkerd to provide
features like L7 metrics and mutual TLS the moment the traffic enters the
cluster.</p><h2 id=handling-external-tls class=anchor>Handling external TLS
<a href=#handling-external-tls class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>One common job for ingress controllers is to terminate TLS from the outside
world, e.g. HTTPS calls.</p><p>Like all pods, traffic to a meshed ingress has both an inbound and an outbound
component. If your ingress terminates TLS, Linkerd will treat this inbound TLS
traffic as an opaque TCP stream, and will only be able to provide byte-level
metrics for this side of the connection.</p><p>Once the ingress controller terminates the TLS connection and issues the
corresponding HTTP or gRPC traffic to internal services, these outbound calls
will have the full set of metrics and mTLS support.</p><h2 id=ingress-mode class=anchor>Ingress mode
<a href=#ingress-mode class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Most ingress controllers can be meshed like any other service, i.e. by
applying the <code>linkerd.io/inject: enabled</code> annotation at the appropriate level.
(See <a href=../adding-your-service/>Adding your services to Linkerd</a> for more.)</p><p>However, some ingress options need to be meshed in a special &ldquo;ingress&rdquo; mode,
using the <code>linkerd.io/inject: ingress</code> annotation.</p><p>The instructions below will describe, for each ingress, whether it requires this
mode of operation.</p><p>If you&rsquo;re using &ldquo;ingress&rdquo; mode, we recommend that you set this ingress
annotation at the workload level rather than at the namespace level, so that
other resources in the ingress namespace are be meshed normally.</p><div class="alert alert--warning alert--callout" id=open-relay-warning><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 14H11V9h2m0 9H11V16h2M1 21H23L12 2 1 21z"/></svg><h4>Warning</h4></div><div class=alert__content>When an ingress is meshed in ingress mode, you <em>must</em> configure it to remove
the <code>l5d-dst-override</code> header to avoid creating an open relay to cluster-local
and external endpoints.</div></div><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>Linkerd versions 2.13.0 through 2.13.4 had a bug whereby the <code>l5d-dst-override</code>
header was <em>required</em> in ingress mode, or the request would fail. This bug was
fixed in 2.13.5, and was not present prior to 2.13.0.</div></div><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>Be sure to not deploy the ingress controller in the <code>kube-system</code> or <code>cert-manager</code>
namespace, as Linkerd <a href=https://linkerd.io/2-edge/features/proxy-injection/#exclusions target=_blank rel=noopener>ignores these namespaces by default for injection</a>.</div></div><p>For more on ingress mode and why it&rsquo;s necessary, see <a href=#ingress-details>Ingress
details</a> below.</p><h2 id=common-ingress-options-for-linkerd class=anchor>Common ingress options for Linkerd
<a href=#common-ingress-options-for-linkerd class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Common ingress options that Linkerd has been used with include:</p><ul><li><a href=#ambassador>Ambassador (aka Emissary)</a></li><li><a href=#nginx-community-version>Nginx (community version)</a></li><li><a href=#nginx-f5-nginx-version>Nginx (F5 NGINX version)</a></li><li><a href=#traefik>Traefik</a><ul><li><a href=#traefik-1x>Traefik 1.x</a></li><li><a href=#traefik-2x>Traefik 2.x</a></li></ul></li><li><a href=#gce>GCE</a></li><li><a href=#gloo>Gloo</a></li><li><a href=#contour>Contour</a></li><li><a href=#kong>Kong</a></li><li><a href=#haproxy>Haproxy</a></li><li><a href=#enroute>EnRoute</a></li><li><a href=#ngrok>ngrok</a></li></ul><p>For a quick start guide to using a particular ingress, please visit the section
for that ingress below. If your ingress is not on that list, never fearâ€”it
likely works anyways. See <a href=#ingress-details>Ingress details</a> below.</p><h2 id=ambassador class=anchor>Emissary-Ingress (aka Ambassador)
<a href=#ambassador class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Emissary-Ingress can be meshed normally: it does not require the <a href=#ingress-mode>ingress
mode</a> annotation. An example manifest for configuring
Ambassador / Emissary is as follows:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>getambassador.io/v3alpha1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Mapping</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web-ambassador-mapping</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>emojivoto</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>hostname</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;*&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>prefix</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>service</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>http://web-svc.emojivoto.svc.cluster.local:80</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>For a more detailed guide, we recommend reading <a href=https://buoyant.io/2021/05/24/emissary-and-linkerd-the-best-of-both-worlds/ target=_blank rel=noopener>Installing the Emissary ingress
with the Linkerd service
mesh</a>.</p><h2 id=nginx-community-version class=anchor>Nginx (community version)
<a href=#nginx-community-version class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>This section refers to the Kubernetes community version
of the Nginx ingress controller
<a href=https://github.com/kubernetes/ingress-nginx target=_blank rel=noopener>kubernetes/ingress-nginx</a>.</p><p>Nginx can be meshed normally: it does not require the <a href=#ingress-mode>ingress
mode</a> annotation.</p><p>The
<a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#service-upstream target=_blank rel=noopener><code>nginx.ingress.kubernetes.io/service-upstream</code></a>
annotation should be set to <code>"true"</code>. For example:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8b949e;font-style:italic># apiVersion: networking.k8s.io/v1beta1 # for k8s &lt; v1.19</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>networking.k8s.io/v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Ingress</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>emojivoto-web-ingress</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>emojivoto</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>annotations</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>nginx.ingress.kubernetes.io/service-upstream</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;true&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>ingressClassName</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>nginx</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>defaultBackend</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>service</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web-svc</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>port</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>number</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>80</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>If using <a href=https://artifacthub.io/packages/helm/ingress-nginx/ingress-nginx target=_blank rel=noopener>the ingress-nginx Helm
chart</a>, note
that the namespace containing the ingress controller should NOT be annotated
with <code>linkerd.io/inject: enabled</code>. Instead, you should annotate the <code>kind: Deployment</code> (<code>.spec.template.metadata.annotations</code>). For example:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>controller</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>podAnnotations</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>linkerd.io/inject</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>enabled</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>...</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>The reason is because this Helm chart defines (among other things) two
Kubernetes resources:</p><ol><li><p><code>kind: ValidatingWebhookConfiguration</code>. This creates a short-lived pod named
something like <code>ingress-nginx-admission-create-XXXXX</code> which quickly terminates.</p></li><li><p><code>kind: Deployment</code>. This creates a long-running pod named something like
<code>ingress-nginx-controller-XXXX</code> which contains the Nginx docker
container.</p></li></ol><p>Setting the injection annotation at the namespace level would mesh the
short-lived pod, which would prevent it from terminating as designed.</p><h2 id=nginx-f5-nginx-version class=anchor>Nginx (F5 NGINX version)
<a href=#nginx-f5-nginx-version class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>This section refers to the Nginx ingress controller
developed and maintained by F5 NGINX
<a href=https://github.com/nginxinc/kubernetes-ingress target=_blank rel=noopener>nginxinc/kubernetes-ingress</a>.</p><p>This version of Nginx can also be meshed normally
and does not require the <a href=#ingress-mode>ingress mode</a> annotation.</p><p>The <a href=https://docs.nginx.com/nginx-ingress-controller/configuration/virtualserver-and-virtualserverroute-resources/#virtualserverroute target=_blank rel=noopener>VirtualServer/VirtualServerRoute CRD resource</a>
should be used in favor of the <code>ingress</code> resource (see
<a href=https://github.com/nginxinc/kubernetes-ingress/issues/2529 target=_blank rel=noopener>this Github issue</a>
for more information).</p><p>The <code>use-cluster-ip</code> field should be set to <code>true</code>. For example:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>k8s.nginx.org/v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>VirtualServer</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>emojivoto-web-ingress</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>emojivoto</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>ingressClassName</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>nginx</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>upstreams</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>service</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web-svc</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>port</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>80</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>use-cluster-ip</span>:<span style=color:#6e7681> </span><span style=color:#79c0ff>true</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>routes</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>path</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>action</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>pass</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web</span><span style=color:#6e7681>
</span></span></span></code></pre></div><h2 id=traefik class=anchor>Traefik
<a href=#traefik class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Traefik should be meshed with <a href=#ingress-mode>ingress mode enabled</a>, i.e. with
the <code>linkerd.io/inject: ingress</code> annotation rather than the default <code>enabled</code>.</p><p>Instructions differ for 1.x and 2.x versions of Traefik.</p><h3 id=traefik-1x class=anchor>Traefik 1.x
<a href=#traefik-1x class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>The simplest way to use Traefik 1.x as an ingress for Linkerd is to configure a
Kubernetes <code>Ingress</code> resource with the
<code>ingress.kubernetes.io/custom-request-headers</code> like this:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8b949e;font-style:italic># apiVersion: networking.k8s.io/v1beta1 # for k8s &lt; v1.19</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>networking.k8s.io/v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Ingress</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web-ingress</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>emojivoto</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>annotations</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>ingress.kubernetes.io/custom-request-headers</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>l5d-dst-override:web-svc.emojivoto.svc.cluster.local:80</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>ingressClassName</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>traefik</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>rules</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>host</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>example.com</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>http</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>paths</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>path</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>pathType</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Prefix</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>backend</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>service</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web-svc</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>port</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>number</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>80</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>The important annotation here is:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>ingress.kubernetes.io/custom-request-headers</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>l5d-dst-override:web-svc.emojivoto.svc.cluster.local:80</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>Traefik will add a <code>l5d-dst-override</code> header to instruct Linkerd what service
the request is destined for. You&rsquo;ll want to include both the Kubernetes service
FQDN (<code>web-svc.emojivoto.svc.cluster.local</code>) <em>and</em> the destination
<code>servicePort</code>.</p><p>To test this, you&rsquo;ll want to get the external IP address for your controller. If
you installed Traefik via Helm, you can get that IP address by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get svc --all-namespaces <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  -l <span style=color:#79c0ff>app</span><span style=color:#ff7b72;font-weight:700>=</span>traefik <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  -o<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;custom-columns=EXTERNAL-IP:.status.loadBalancer.ingress[0].ip&#39;</span>
</span></span></code></pre></div><p>You can then use this IP with curl:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -H <span style=color:#a5d6ff>&#34;Host: example.com&#34;</span> http://external-ip
</span></span></code></pre></div><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>This solution won&rsquo;t work if you&rsquo;re using Traefik&rsquo;s service weights as
Linkerd will always send requests to the service name in <code>l5d-dst-override</code>. A
workaround is to use <code>traefik.frontend.passHostHeader: "false"</code> instead.</div></div><h3 id=traefik-2x class=anchor>Traefik 2.x
<a href=#traefik-2x class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>Traefik 2.x adds support for path based request routing with a Custom Resource
Definition (CRD) called
<a href=https://docs.traefik.io/providers/kubernetes-crd/ target=_blank rel=noopener><code>IngressRoute</code></a>.</p><p>If you choose to use <code>IngressRoute</code> instead of the default Kubernetes <code>Ingress</code>
resource, then you&rsquo;ll also need to use the Traefik&rsquo;s
<a href=https://docs.traefik.io/middlewares/headers/ target=_blank rel=noopener><code>Middleware</code></a> Custom Resource
Definition to add the <code>l5d-dst-override</code> header.</p><p>The YAML below uses the Traefik CRDs to produce the same results for the
<code>emojivoto</code> application, as described above.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>traefik.containo.us/v1alpha1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Middleware</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>l5d-header-middleware</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>traefik</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>headers</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>customRequestHeaders</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>l5d-dst-override</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;web-svc.emojivoto.svc.cluster.local:80&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>---</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>traefik.containo.us/v1alpha1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>IngressRoute</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>annotations</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>kubernetes.io/ingress.class</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>traefik</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>creationTimestamp</span>:<span style=color:#6e7681> </span><span style=color:#79c0ff>null</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>emojivoto-web-ingress-route</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>emojivoto</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>entryPoints</span>:<span style=color:#6e7681> </span>[]<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>routes</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Rule</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>match</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>PathPrefix(`/`)</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>priority</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>0</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>middlewares</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>l5d-header-middleware</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>services</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Service</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web-svc</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>port</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>80</span><span style=color:#6e7681>
</span></span></span></code></pre></div><h2 id=gce class=anchor>GCE
<a href=#gce class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>The GCE ingress should be meshed with with <a href=#ingress-mode>ingress mode
enabled</a>, , i.e. with the <code>linkerd.io/inject: ingress</code>
annotation rather than the default <code>enabled</code>.</p><p>This example shows how to use a <a href=https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address target=_blank rel=noopener>Google Cloud Static External IP
Address</a>
and TLS with a <a href=https://cloud.google.com/load-balancing/docs/ssl-certificates#managed-certs target=_blank rel=noopener>Google-managed
certificate</a>.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8b949e;font-style:italic># apiVersion: networking.k8s.io/v1beta1 # for k8s &lt; v1.19</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>networking.k8s.io/v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Ingress</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web-ingress</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>emojivoto</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>annotations</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>ingress.kubernetes.io/custom-request-headers</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;l5d-dst-override: web-svc.emojivoto.svc.cluster.local:80&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>ingress.gcp.kubernetes.io/pre-shared-cert</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;managed-cert-name&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>kubernetes.io/ingress.global-static-ip-name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;static-ip-name&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>ingressClassName</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>gce</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>rules</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>host</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>example.com</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>http</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>paths</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>path</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>pathType</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Prefix</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>backend</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>service</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web-svc</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>port</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>number</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>80</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>To use this example definition, substitute <code>managed-cert-name</code> and
<code>static-ip-name</code> with the short names defined in your project (n.b. use the name
for the IP address, not the address itself).</p><p>The managed certificate will take about 30-60 minutes to provision, but the
status of the ingress should be healthy within a few minutes. Once the managed
certificate is provisioned, the ingress should be visible to the Internet.</p><h2 id=gloo class=anchor>Gloo
<a href=#gloo class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Gloo should be meshed with <a href=#ingress-mode>ingress mode enabled</a>, i.e. with the
<code>linkerd.io/inject: ingress</code> annotation rather than the default <code>enabled</code>.</p><p>As of Gloo v0.13.20, Gloo has native integration with Linkerd, so that the
required Linkerd headers are added automatically. Assuming you installed Gloo
to the default location, you can enable the native integration by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl patch settings -n gloo-system default <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  -p <span style=color:#a5d6ff>&#39;{&#34;spec&#34;:{&#34;linkerd&#34;:true}}&#39;</span> --type<span style=color:#ff7b72;font-weight:700>=</span>merge
</span></span></code></pre></div><p>Gloo will now automatically add the <code>l5d-dst-override</code> header to every
Kubernetes upstream.</p><p>Now simply add a route to the upstream, e.g.:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>glooctl add route --path-prefix<span style=color:#ff7b72;font-weight:700>=</span>/ --dest-name booksapp-webapp-7000
</span></span></code></pre></div><h2 id=contour class=anchor>Contour
<a href=#contour class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Contour should be meshed with <a href=#ingress-mode>ingress mode enabled</a>, i.e. with
the <code>linkerd.io/inject: ingress</code> annotation rather than the default <code>enabled</code>.</p><p>The following example uses the
<a href=https://projectcontour.io/getting-started/ target=_blank rel=noopener>Contour getting started</a> documentation
to demonstrate how to set the required header manually.</p><p>Contour&rsquo;s Envoy DaemonSet doesn&rsquo;t auto-mount the service account token, which
is required for the Linkerd proxy to do mTLS between pods. So first we need to
install Contour uninjected, patch the DaemonSet with
<code>automountServiceAccountToken: true</code>, and then inject it. Optionally you can
create a dedicated service account to avoid using the <code>default</code> one.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8b949e;font-style:italic># install Contour</span>
</span></span><span style=display:flex><span>kubectl apply -f https://projectcontour.io/quickstart/contour.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># create a service account (optional)</span>
</span></span><span style=display:flex><span>kubectl apply -f - <span style=color:#a5d6ff>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: ServiceAccount
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: envoy
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: projectcontour
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># add service account to envoy (optional)</span>
</span></span><span style=display:flex><span>kubectl patch daemonset envoy -n projectcontour --type json -p<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;[{&#34;op&#34;: &#34;add&#34;, &#34;path&#34;: &#34;/spec/template/spec/serviceAccount&#34;, &#34;value&#34;: &#34;envoy&#34;}]&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># auto mount the service account token (required)</span>
</span></span><span style=display:flex><span>kubectl patch daemonset envoy -n projectcontour --type json -p<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/spec/template/spec/automountServiceAccountToken&#34;, &#34;value&#34;: true}]&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># inject linkerd first into the DaemonSet</span>
</span></span><span style=display:flex><span>kubectl -n projectcontour get daemonset -oyaml | linkerd inject - | kubectl apply -f -
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># inject linkerd into the Deployment</span>
</span></span><span style=display:flex><span>kubectl -n projectcontour get deployment -oyaml | linkerd inject - | kubectl apply -f -
</span></span></code></pre></div><p>Verify your Contour and Envoy installation has a running Linkerd sidecar.</p><p>Next we&rsquo;ll deploy a demo service:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd inject https://projectcontour.io/examples/kuard.yaml | kubectl apply -f -
</span></span></code></pre></div><p>To route external traffic to your service you&rsquo;ll need to provide a HTTPProxy:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>projectcontour.io/v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>HTTPProxy</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>kuard</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>default</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>routes</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>requestHeadersPolicy</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>set</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>l5d-dst-override</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>kuard.default.svc.cluster.local:80</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>services</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>kuard</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>port</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>80</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>virtualhost</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>fqdn</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>127.0.0.1</span><span style=color:#a5d6ff>.nip.io</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>Notice the <code>l5d-dst-override</code> header is explicitly set to the target <code>service</code>.</p><p>Finally, you can test your working service mesh:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl port-forward svc/envoy -n projectcontour 3200:80
</span></span><span style=display:flex><span>http://127.0.0.1.nip.io:3200
</span></span></code></pre></div><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>You should annotate the pod spec with <code>config.linkerd.io/skip-outbound-ports: 8001</code>. The Envoy pod will try to connect to the Contour pod at port 8001
through TLS, which is not supported under this ingress mode, so you need to
have the proxy skip that outbound port.</div></div><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>If you are using Contour with <a href=https://github.com/weaveworks/flagger target=_blank rel=noopener>flagger</a>
the <code>l5d-dst-override</code> headers will be set automatically.</div></div><h3 id=kong class=anchor>Kong
<a href=#kong class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>Kong should be meshed with <a href=#ingress-mode>ingress mode enabled</a>, i.e. with the
<code>linkerd.io/inject: ingress</code> annotation rather than the default <code>enabled</code>.</p><p>This example will use the following elements:</p><ul><li>The <a href=https://github.com/Kong/charts target=_blank rel=noopener>Kong chart</a></li><li>The <a href=../../getting-started/>emojivoto</a> example application</li></ul><p>Before installing emojivoto, install Linkerd and Kong on your cluster. When
injecting the Kong deployment, use the <code>--ingress</code> flag (or annotation).</p><p>We need to declare KongPlugin (a Kong CRD) and Ingress resources as well.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>configuration.konghq.com/v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>KongPlugin</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>set-l5d-header</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>emojivoto</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>plugin</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>request-transformer</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>config</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>remove</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>headers</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#a5d6ff>l5d-dst-override</span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic># Prevents open relay</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>add</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>headers</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#a5d6ff>l5d-dst-override:$(headers.host).svc.cluster.local</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>---</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic># apiVersion: networking.k8s.io/v1beta1 # for k8s &lt; v1.19</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>networking.k8s.io/v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Ingress</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web-ingress</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>emojivoto</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>annotations</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>konghq.com/plugins</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>set-l5d-header</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>ingressClassName</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>kong</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>rules</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>http</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>paths</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>path</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/api/vote</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>pathType</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Prefix</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>backend</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>service</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web-svc</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>port</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>http</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>path</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/api/list</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>pathType</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Prefix</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>backend</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>service</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web-svc</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>port</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>http</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>Here we are explicitly setting the <code>l5d-dst-override</code> in the <code>KongPlugin</code>.
Using <a href=https://docs.konghq.com/hub/kong-inc/request-transformer/#template-as-value target=_blank rel=noopener>templates as
values</a>,
we can use the <code>host</code> header from requests and set the <code>l5d-dst-override</code> value
based off that.</p><p>Finally, install emojivoto so that it&rsquo;s <code>deploy/vote-bot</code> targets the
ingress and includes a <code>host</code> header value for the <code>web-svc.emojivoto</code> service.</p><p>Before applying the injected emojivoto application, make the following changes
to the <code>vote-bot</code> Deployment:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>env</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic># Target the Kong ingress instead of the Emojivoto web service</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>WEB_HOST</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>kong-proxy.kong:80</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic># Override the host header on requests so that it can be used to set the l5d-dst-override header</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>HOST_OVERRIDE</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web-svc.emojivoto</span><span style=color:#6e7681>
</span></span></span></code></pre></div><h3 id=haproxy class=anchor>Haproxy
<a href=#haproxy class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>There are two different haproxy-based ingress controllers. This example is for
the <a href=https://www.haproxy.com/documentation/kubernetes/latest/ target=_blank rel=noopener>kubernetes-ingress controller by
haproxytech</a> and not
the <a href=https://haproxy-ingress.github.io/ target=_blank rel=noopener>haproxy-ingress controller</a>.</div></div><p>Haproxy should be meshed with <a href=#ingress-mode>ingress mode enabled</a>, i.e. with
the <code>linkerd.io/inject: ingress</code> annotation rather than the default <code>enabled</code>.</p><p>The simplest way to use Haproxy as an ingress for Linkerd is to configure a
Kubernetes <code>Ingress</code> resource with the
<code>haproxy.org/request-set-header</code> annotation like this:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>networking.k8s.io/v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Ingress</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web-ingress</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>emojivoto</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>annotations</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>kubernetes.io/ingress.class</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>haproxy</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>haproxy.org/request-set-header</span>:<span style=color:#6e7681> </span>|<span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      l5d-dst-override web-svc.emojivoto.svc.cluster.local:80</span><span style=color:#6e7681>      
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>rules</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>host</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>example.com</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>http</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>paths</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>path</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>pathType</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Prefix</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>backend</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>service</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web-svc</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>port</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>number</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>80</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>Unfortunately,Â thereÂ isÂ currentlyÂ noÂ supportÂ toÂ doÂ thisÂ dynamically in
aÂ globalÂ configÂ mapÂ byÂ usingÂ theÂ service name,Â namespaceÂ andÂ portÂ as variable.
ThisÂ alsoÂ means,Â thatÂ youÂ can&rsquo;tÂ combineÂ moreÂ thanÂ one serviceÂ ingressÂ rule
inÂ anÂ ingressÂ manifestÂ asÂ eachÂ oneÂ needsÂ their own
<code>haproxy.org/request-set-header</code>Â annotationÂ withÂ hardÂ codedÂ value.</p><h2 id=enroute class=anchor>EnRoute OneStep
<a href=#enroute class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Meshing EnRoute with Linkerd involves only setting one flag globally:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>enroute.saaras.io/v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>GlobalConfig</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>enable-linkerd</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>default</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>linkerd-global-config</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>type</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>globalconfig_globals</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>config</span>:<span style=color:#6e7681> </span>|<span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          &#34;linkerd_enabled&#34;: true
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        }</span><span style=color:#6e7681>        
</span></span></span></code></pre></div><p>EnRoute can now be meshed by injecting Linkerd proxy in EnRoute pods.
Using the <code>linkerd</code> utility, we can update the EnRoute deployment
to inject Linkerd proxy.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get -n enroute-demo deploy -o yaml | linkerd inject - | kubectl apply -f -
</span></span></code></pre></div><p>The <code>linkerd_enabled</code> flag automatically sets <code>l5d-dst-override</code> header.
The flag also delegates endpoint selection for routing to linkerd.</p><p>More details and customization can be found in,
<a href=https://getenroute.io/blog/end-to-end-encryption-mtls-linkerd-enroute/ target=_blank rel=noopener>End to End encryption using EnRoute with
Linkerd</a></p><h2 id=ngrok class=anchor>ngrok
<a href=#ngrok class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>ngrok can be meshed normally: it does not require the
<a href=#ingress-mode>ingress mode</a> annotation.</p><p>After signing up for a <a href=https://ngrok.com/signup target=_blank rel=noopener>free ngrok account</a>, and
running through the <a href=https://github.com/ngrok/kubernetes-ingress-controller#installation target=_blank rel=noopener>installation steps for the ngrok Ingress controller
</a>,
you can add ingress by configuring an ingress object for your service and
applying it with <code>kubectl apply -f ingress.yaml</code>.</p><p>This is an example for the emojivoto app used in the Linkerd getting started
guide. You will need to replace the <code>host</code> value with your
<a href=https://dashboard.ngrok.com/cloud-edge/domains target=_blank rel=noopener>free static domain</a> available
in your ngrok account. If you have a paid ngrok account, you can configure this
the same way you would use the <a href=https://ngrok.com/docs/secure-tunnels/ngrok-agent/reference/ngrok/ target=_blank rel=noopener><code>--domain</code>
flag</a> on
the ngrok agent.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>networking.k8s.io/v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Ingress</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>emojivoto-ingress</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>emojivoto</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>ingressClassName</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>ngrok</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>rules</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>host</span>:<span style=color:#6e7681> </span>[<span style=color:#a5d6ff>YOUR STATIC DOMAIN.ngrok-free.app]</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>http</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>paths</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>path</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>pathType</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Prefix</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>backend</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>service</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web-svc</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>port</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>number</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>80</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>Your emojivoto app should be available to anyone in the world at your static
domain.</p><h2 id=ingress-details class=anchor>Ingress details
<a href=#ingress-details class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>In this section we cover how Linkerd interacts with ingress controllers in
general.</p><p>In order for Linkerd to properly apply L7 features such as route-based metrics
and dynamic traffic routing, Linkerd needs the ingress controller to connect
to the IP/port of the destination Kubernetes Service. However, by default,
many ingresses do their own endpoint selection and connect directly to the
IP/port of the destination Pod, rather than the Service.</p><p>Thus, combining an ingress with Linkerd takes one of two forms:</p><ol><li><p>Configure the ingress to connect to the IP and port of the Service as the
destination, i.e. to skip its own endpoint selection. (E.g. see
<a href=#nginx>Nginx</a> above.)</p></li><li><p>Alternatively, configure the ingress to pass the Service IP/port in a
header such as <code>l5d-dst-override</code>, <code>Host</code>, or <code>:authority</code>, and configure
Linkerd in <em>ingress</em> mode. In this mode, it will read from one of those
headers instead.</p></li></ol><p>The most common approach in form #2 is to use the explicit <code>l5d-dst-override</code> header.</p><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>Some ingress controllers support sticky sessions. For session stickiness, the
ingress controller has to do its own endpoint selection. This means that
Linkerd will not be able to connect to the IP/port of the Kubernetes Service,
and will instead establish a direct connection to a pod. Therefore, sticky
sessions and <code>ServiceProfiles</code> are mutually exclusive.</div></div><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>If requests experience a 2-3 second delay after injecting your ingress
controller, it is likely that this is because the service of <code>type: LoadBalancer</code> is obscuring the client source IP. You can fix this by setting
<code>externalTrafficPolicy: Local</code> in the ingress&rsquo; service definition.</div></div><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>While the Kubernetes Ingress API definition allows a <code>backend</code>&rsquo;s <code>servicePort</code>
to be a string value, only numeric <code>servicePort</code> values can be used with
Linkerd. If a string value is encountered, Linkerd will default to using port
80.</div></div></div></div></div></div></div></main><footer class=main-footer><div class=main-footer__top><div class="main-footer__container container"><div class=main-footer__info><p><img src=/logos/linkerd.png alt=Linkerd></p><p>Linkerd was originally created by <a href=https://buoyant.io/ target=_blank rel=noopener>Buoyant</a></p><p>View <a href=https://github.com/linkerd/linkerd/wiki/Linkerd-code-of-conduct target=_blank rel=noopener>Code of Conduct</a></p></div><div class=main-footer__links><div class=main-footer__community><h4>Community</h4><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener>GitHub</a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Linkerd Forum</a></li></ul></div><div class=main-footer__follow><h4>Follow</h4><ul><li><a href=https://www.linkedin.com/company/linkerd/ target=_blank rel=noopener>Linkedin</a></li><li><a href=https://www.youtube.com/buoyantio target=_blank rel=noopener>YouTube</a></li><li><a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a></li></ul></div></div></div></div><div class=main-footer__bottom><div class="main-footer__container container"><p><a href=https://github.com/linkerd/website/tree/main/linkerd.io/content target=_blank rel=noopener>Edit This Site</a></p><p>Copyright Â© 2024 Linkerd Authors. All rights reserved.</p></div></div></footer></body></html>