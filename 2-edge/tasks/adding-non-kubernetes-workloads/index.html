<!doctype html><html lang=en><head><meta charset=utf-8><title>Adding non-Kubernetes workloads to your mesh | Linkerd</title>
<link rel="shortcut icon" href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In this guide, we&rsquo;ll walk you through an example of mesh expansion: setting up and configuring an
example non-Kubernetes workload and adding it to your Linkerd mesh.


  Overall flow
  
    
  

  

In this guide, we&rsquo;ll take you through how to:

Install the Linkerd proxy onto a virtual or physical machine outside the
Kubernetes cluster.
Configure network rules so traffic is routed through the proxy.
Register the external workload in the mesh.
Exercise traffic patterns and apply authorization policies that affect the
external workload.

We&rsquo;ll be using SPIRE as our identity
mechanism to generate a workload identity."><meta property="og:url" content="https://travisbeckham.github.io/2-edge/tasks/adding-non-kubernetes-workloads/"><meta property="og:site_name" content="Linkerd"><meta property="og:title" content="Adding non-Kubernetes workloads to your mesh"><meta property="og:description" content="In this guide, we’ll walk you through an example of mesh expansion: setting up and configuring an example non-Kubernetes workload and adding it to your Linkerd mesh.
Overall flow In this guide, we’ll take you through how to:
Install the Linkerd proxy onto a virtual or physical machine outside the Kubernetes cluster. Configure network rules so traffic is routed through the proxy. Register the external workload in the mesh. Exercise traffic patterns and apply authorization policies that affect the external workload. We’ll be using SPIRE as our identity mechanism to generate a workload identity."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="2-edge"><meta property="og:image" content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:title content="Adding non-Kubernetes workloads to your mesh"><meta name=twitter:description content="In this guide, we’ll walk you through an example of mesh expansion: setting up and configuring an example non-Kubernetes workload and adding it to your Linkerd mesh.
Overall flow In this guide, we’ll take you through how to:
Install the Linkerd proxy onto a virtual or physical machine outside the Kubernetes cluster. Configure network rules so traffic is routed through the proxy. Register the external workload in the mesh. Exercise traffic patterns and apply authorization policies that affect the external workload. We’ll be using SPIRE as our identity mechanism to generate a workload identity."><meta name=twitter:site content="@Linkerd"><link rel=canonical href=https://travisbeckham.github.io/2-edge/tasks/adding-non-kubernetes-workloads/><link rel=stylesheet href=/css/main.css><script src=/js/main.js></script><script async defer src=https://buttons.github.io/buttons.js></script></head><body><header class=main-header><div class=main-header__container><div class=main-header__logo><a href=/><img src=/logos/linkerd.png alt=Linkerd></a></div><input class=main-header__toggle-checkbox type=checkbox id=main-header-toggle>
<label class=main-header__toggle for=main-header-toggle><span class=main-header__toggle-icon><span class=main-header__toggle-icon--open><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3 6H21V8H3V6m0 5H21v2H3V11m0 5H21v2H3V16z"/></svg>
</span><span class=main-header__toggle-icon--close><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span></span></label><div class=main-header__nav><nav class=main-nav><ul class=main-nav__menu><li class=main-nav__menu--selected><a href=/docs>Docs</a></li><li><a href=#>Community<svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6L7.41 8.58z"/></svg></a><ul><li><a href=/community/get-involved/>Get Involved</a></li><li><a href=/community/adopters/>Adopters</a></li><li><a href=/community/ambassadors/>Linkerd Ambassadors</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Buoyant's Linkerd Forum</a></li></ul></li><li><a href=/blog/>Blog</a></li><li><a href=/faq/>FAQ</a></li><li><a href=/enterprise/>Enterprise</a></li></ul><div class=main-nav__search><form action=/search method=get><div class="search-input search-input--sm"><svg class="icon" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5.0 0116 9.5c0 1.61-.59 3.09-1.56 4.23L14.71 14H15.5l5 5L19 20.5l-5-5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5.0 013 9.5 6.5 6.5.0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
<input type=text name=q placeholder=Search></div></form></div><div class=main-nav__github><a class=github-button href=https://github.com/linkerd/linkerd2 data-icon=octicon-star data-size=large data-show-count=true aria-label="Star linkerd/linkerd2 on GitHub">Star</a></div><div class=main-nav__forum><a href=https://linkerd.buoyant.io class="button button--primary button--sm" target=_blank rel=noopener>Join Forum</a></div></nav></div></div></header><div class=main-announcement>Service Mesh 101: Get Service Mesh-Certified
<span class=main-announcement__link><a href=https://buoyant.io/courses/service-mesh-101 target=_blank rel=noopener>Enroll now</a></span></div><main class=main-content><div class=docs><div class=docs__container><div class=docs__sidebar><div class=docs__nav><div class=docs__versions><select onchange="window.location.href=this.value"><option value=/2-edge/ selected>Linkerd edge</option><option value=/2.16/>Linkerd 2.16</option><option value=/2.15/>Linkerd 2.15</option><option value=/2.14/>Linkerd 2.14</option><option value=/2.13/>Linkerd 2.13</option><option value=/2.12/>Linkerd 2.12</option><option value=/2.11/>Linkerd 2.11</option><option value=/2.10/>Linkerd 2.10</option></select></div><nav><ul><li><a href=/2-edge/overview/>Overview</a></li><li><a href=/2-edge/getting-started/>Getting Started</a></li><li><a href=/2-edge/features/>Features
</a><input class=toggle__input type=checkbox id=toggle-f524806733d51ea4f7c2504b44379f32>
<label class=toggle__label for=toggle-f524806733d51ea4f7c2504b44379f32><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2-edge/features/http-grpc/>HTTP, HTTP/2, and gRPC Proxying</a></li><li><a href=/2-edge/features/protocol-detection/>TCP Proxying and Protocol Detection</a></li><li><a href=/2-edge/features/retries-and-timeouts/>Retries and Timeouts</a></li><li><a href=/2-edge/features/automatic-mtls/>Automatic mTLS</a></li><li><a href=/2-edge/features/ingress/>Ingress</a></li><li><a href=/2-edge/features/telemetry/>Telemetry and Monitoring</a></li><li><a href=/2-edge/features/load-balancing/>Load Balancing</a></li><li><a href=/2-edge/features/server-policy/>Authorization Policy</a></li><li><a href=/2-edge/features/proxy-injection/>Automatic Proxy Injection</a></li><li><a href=/2-edge/features/cni/>CNI Plugin</a></li><li><a href=/2-edge/features/dashboard/>Dashboard and on-cluster metrics stack</a></li><li><a href=/2-edge/features/distributed-tracing/>Distributed Tracing</a></li><li><a href=/2-edge/features/request-routing/>Dynamic Request Routing</a></li><li><a href=/2-edge/features/fault-injection/>Fault Injection</a></li><li><a href=/2-edge/features/ha/>High Availability</a></li><li><a href=/2-edge/features/access-logging/>HTTP Access Logging</a></li><li><a href=/2-edge/features/httproute/>HTTPRoutes</a></li><li><a href=/2-edge/features/nft/>Iptables-nft Support</a></li><li><a href=/2-edge/features/ipv6/>IPv6 Support</a></li><li><a href=/2-edge/features/multicluster/>Multi-cluster communication</a></li><li><a href=/2-edge/features/non-kubernetes-workloads/>Non-Kubernetes workloads (mesh expansion)</a></li><li><a href=/2-edge/features/service-profiles/>Service Profiles</a></li><li><a href=/2-edge/features/traffic-split/>Traffic Split (canaries, blue/green deploys)</a></li></ul></li><li class=docs__nav--selected><a href=/2-edge/tasks/>Tasks
</a><input class=toggle__input type=checkbox id=toggle-eb66af6ff84f9fce506d3a9073494489 checked>
<label class=toggle__label for=toggle-eb66af6ff84f9fce506d3a9073494489><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li class=docs__nav--selected><a href=/2-edge/tasks/adding-non-kubernetes-workloads/>Adding non-Kubernetes workloads to your mesh</a></li><li><a href=/2-edge/tasks/adding-your-service/>Adding your services to Linkerd</a></li><li><a href=/2-edge/tasks/automatic-failover/>Automatic Multicluster Failover</a></li><li><a href=/2-edge/tasks/automatically-rotating-control-plane-tls-credentials/>Automatically Rotating Control Plane TLS Credentials</a></li><li><a href=/2-edge/tasks/automatically-rotating-webhook-tls-credentials/>Automatically Rotating Webhook TLS Credentials</a></li><li><a href=/2-edge/tasks/external-prometheus/>Bringing your own Prometheus</a></li><li><a href=/2-edge/tasks/circuit-breakers/>Circuit Breakers</a></li><li><a href=/2-edge/tasks/configuring-dynamic-request-routing/>Configuring Dynamic Request Routing</a></li><li><a href=/2-edge/tasks/configuring-per-route-policy/>Configuring Per-Route Authorization Policy</a></li><li><a href=/2-edge/tasks/configuring-proxy-concurrency/>Configuring Proxy Concurrency</a></li><li><a href=/2-edge/tasks/configuring-proxy-discovery-cache/>Configuring Proxy Discovery Cache</a></li><li><a href=/2-edge/tasks/configuring-retries/>Configuring Retries</a></li><li><a href=/2-edge/tasks/configuring-timeouts/>Configuring Timeouts</a></li><li><a href=/2-edge/tasks/using-debug-endpoints/>Control Plane Debug Endpoints</a></li><li><a href=/2-edge/tasks/customize-install/>Customizing Linkerd's Configuration with Kustomize</a></li><li><a href=/2-edge/tasks/debugging-502s/>Debugging 502s</a></li><li><a href=/2-edge/tasks/debugging-your-service/>Debugging gRPC applications with request tracing</a></li><li><a href=/2-edge/tasks/books/>Debugging HTTP applications with per-route metrics</a></li><li><a href=/2-edge/tasks/distributed-tracing/>Distributed tracing with Linkerd</a></li><li><a href=/2-edge/tasks/exporting-metrics/>Exporting Metrics</a></li><li><a href=/2-edge/tasks/exposing-dashboard/>Exposing the Dashboard</a></li><li><a href=/2-edge/tasks/generate-certificates/>Generating your own mTLS root certificates</a></li><li><a href=/2-edge/tasks/getting-per-route-metrics/>Getting Per-Route Metrics</a></li><li><a href=/2-edge/tasks/linkerd-smi/>Getting started with Linkerd SMI extension</a></li><li><a href=/2-edge/tasks/graceful-shutdown/>Graceful Pod Shutdown</a></li><li><a href=/2-edge/tasks/grafana/>Grafana</a></li><li><a href=/2-edge/tasks/using-ingress/>Handling ingress traffic</a></li><li><a href=/2-edge/tasks/fault-injection/>Injecting Faults</a></li><li><a href=/2-edge/tasks/install/>Installing Linkerd</a></li><li><a href=/2-edge/tasks/install-helm/>Installing Linkerd with Helm</a></li><li><a href=/2-edge/tasks/installing-multicluster/>Installing Multi-cluster Components</a></li><li><a href=/2-edge/tasks/using-psp/>Linkerd and Pod Security Policies (PSP)</a></li><li><a href=/2-edge/tasks/manually-rotating-control-plane-tls-credentials/>Manually Rotating Control Plane TLS Credentials</a></li><li><a href=/2-edge/tasks/modifying-proxy-log-level/>Modifying the Proxy Log Level</a></li><li><a href=/2-edge/tasks/multicluster/>Multi-cluster communication</a></li><li><a href=/2-edge/tasks/multicluster-using-statefulsets/>Multi-cluster communication with StatefulSets</a></li><li><a href=/2-edge/tasks/per-request-policy/>Per-Request Policy</a></li><li><a href=/2-edge/tasks/pod-to-pod-multicluster/>Pod-to-Pod Multi-cluster communication</a></li><li><a href=/2-edge/tasks/flagger/>Progressive Delivery</a></li><li><a href=/2-edge/tasks/replacing_expired_certificates/>Replacing expired certificates</a></li><li><a href=/2-edge/tasks/restricting-access/>Restricting Access To Services</a></li><li><a href=/2-edge/tasks/rotating_webhooks_certificates/>Rotating webhooks certificates</a></li><li><a href=/2-edge/tasks/securing-linkerd-tap/>Securing Linkerd Tap</a></li><li><a href=/2-edge/tasks/setting-up-service-profiles/>Setting Up Service Profiles</a></li><li><a href=/2-edge/tasks/traffic-shifting/>Traffic Shifting</a></li><li><a href=/2-edge/tasks/troubleshooting/>Troubleshooting</a></li><li><a href=/2-edge/tasks/uninstall/>Uninstalling Linkerd</a></li><li><a href=/2-edge/tasks/uninstall-multicluster/>Uninstalling Multicluster</a></li><li><a href=/2-edge/tasks/upgrade/>Upgrading Linkerd</a></li><li><a href=/2-edge/tasks/using-custom-domain/>Using a Custom Cluster Domain</a></li><li><a href=/2-edge/tasks/extensions/>Using extensions</a></li><li><a href=/2-edge/tasks/gitops/>Using GitOps with Linkerd with Argo CD</a></li><li><a href=/2-edge/tasks/using-the-debug-container/>Using the Debug Sidecar</a></li><li><a href=/2-edge/tasks/validating-your-traffic/>Validating your mTLS traffic</a></li></ul></li><li><a href=/2-edge/reference/>Reference
</a><input class=toggle__input type=checkbox id=toggle-c5cd1c9c50e40c408453dcf4eae5468f>
<label class=toggle__label for=toggle-c5cd1c9c50e40c408453dcf4eae5468f><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2-edge/reference/architecture/>Architecture</a></li><li><a href=/2-edge/reference/authorization-policy/>Authorization Policy</a></li><li><a href=/2-edge/reference/circuit-breaking/>Circuit Breaking</a></li><li><a href=/2-edge/reference/cli/>CLI
</a><input class=toggle__input type=checkbox id=toggle-3670a1706f943ec7fd577cd3725efcef>
<label class=toggle__label for=toggle-3670a1706f943ec7fd577cd3725efcef><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2-edge/reference/cli/authz/>authz</a></li><li><a href=/2-edge/reference/cli/check/>check</a></li><li><a href=/2-edge/reference/cli/completion/>completion</a></li><li><a href=/2-edge/reference/cli/diagnostics/>diagnostics</a></li><li><a href=/2-edge/reference/cli/identity/>identity</a></li><li><a href=/2-edge/reference/cli/inject/>inject</a></li><li><a href=/2-edge/reference/cli/install/>install</a></li><li><a href=/2-edge/reference/cli/install-cni/>install-cni</a></li><li><a href=/2-edge/reference/cli/jaeger/>jaeger</a></li><li><a href=/2-edge/reference/cli/multicluster/>multicluster</a></li><li><a href=/2-edge/reference/cli/profile/>profile</a></li><li><a href=/2-edge/reference/cli/prune/>prune</a></li><li><a href=/2-edge/reference/cli/uninject/>uninject</a></li><li><a href=/2-edge/reference/cli/uninstall/>uninstall</a></li><li><a href=/2-edge/reference/cli/upgrade/>upgrade</a></li><li><a href=/2-edge/reference/cli/version/>version</a></li><li><a href=/2-edge/reference/cli/viz/>viz</a></li></ul></li><li><a href=/2-edge/reference/cluster-configuration/>Cluster Configuration</a></li><li><a href=/2-edge/reference/extension-list/>Extensions List</a></li><li><a href=/2-edge/reference/external-workload/>ExternalWorkload</a></li><li><a href=/2-edge/reference/httproute/>HTTPRoute</a></li><li><a href=/2-edge/reference/iptables/>IPTables Reference</a></li><li><a href=/2-edge/reference/multicluster/>Multi-cluster communication</a></li><li><a href=/2-edge/reference/proxy-configuration/>Proxy Configuration</a></li><li><a href=/2-edge/reference/proxy-log-level/>Proxy Log Level</a></li><li><a href=/2-edge/reference/proxy-metrics/>Proxy Metrics</a></li><li><a href=/2-edge/reference/retries/>Retries</a></li><li><a href=/2-edge/reference/service-profiles/>Service Profiles</a></li><li><a href=/2-edge/reference/k8s-versions/>Supported Kubernetes Versions</a></li><li><a href=/2-edge/reference/timeouts/>Timeouts</a></li></ul></li><li><a href=/2-edge/common-errors/>Common Errors
</a><input class=toggle__input type=checkbox id=toggle-de403e5bf3db4733165f05741364f350>
<label class=toggle__label for=toggle-de403e5bf3db4733165f05741364f350><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2-edge/common-errors/failfast/>Failfast</a></li><li><a href=/2-edge/common-errors/http-502/>HTTP 502 Errors</a></li><li><a href=/2-edge/common-errors/http-503-504/>HTTP 503 and 504 Errors</a></li><li><a href=/2-edge/common-errors/protocol-detection/>Protocol Detection Errors</a></li></ul></li></ul><ul><li><a href=/what-is-a-service-mesh/>What is a service mesh?</a></li><li><a href=/faq/>Frequently Asked Questions</a></li><li><a href=/releases/>Releases and Versions</a></li><li><a href=/design-principles/>Design Principles</a></li><li><a href=/going-to-production/>Going to Production</a></li><li><a href=/service-mesh-glossary/>Service Mesh Glossary</a></li></ul></nav><div class=docs__community><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener><img src=/logos/github.svg alt=GitHub class=img></a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener><img src=/logos/slack.svg alt=Slack class=img></a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener><img src=/logos/forum.png alt="Linkerd Forum" class=img></a></li></ul></div></div></div><div class=docs__main><div class=docs__body><div class=docs__header><h1>Adding non-Kubernetes workloads to your mesh</h1></div><div class="docs__content prose"><p>In this guide, we&rsquo;ll walk you through an example of <a href=/2-edge/features/non-kubernetes-workloads/>mesh expansion</a>: setting up and configuring an
example non-Kubernetes workload and adding it to your Linkerd mesh.</p><h2 id=overall-flow class=anchor>Overall flow
<a href=#overall-flow class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>In this guide, we&rsquo;ll take you through how to:</p><ol><li>Install the Linkerd proxy onto a virtual or physical machine outside the
Kubernetes cluster.</li><li>Configure network rules so traffic is routed through the proxy.</li><li>Register the external workload in the mesh.</li><li>Exercise traffic patterns and apply authorization policies that affect the
external workload.</li></ol><p>We&rsquo;ll be using <a href=https://github.com/spiffe/spire target=_blank rel=noopener>SPIRE</a> as our identity
mechanism to generate a workload identity.</p><h2 id=prerequisites class=anchor>Prerequisites
<a href=#prerequisites class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>You will need:</p><ul><li>A functioning Linkerd installation and its trust anchor.</li><li>A cluster that you have elevated privileges to. For local development, you can
use <a href=https://kind.sigs.k8s.io/ target=_blank rel=noopener>kind</a> or <a href=https://k3d.io/ target=_blank rel=noopener>k3d</a>.</li><li>A physical or virtual machine.</li><li><code>NET_CAP</code> privileges on the machine, so iptables rules can be modified.</li><li>IP connectivity from the machine to every pod in the mesh.</li><li>A working DNS setup such that the machine is able to resolve DNS names for
in-cluster Kubernetes workloads.</li></ul><h2 id=getting-the-current-trust-anchor-and-key class=anchor>Getting the current trust anchor and key
<a href=#getting-the-current-trust-anchor-and-key class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>To be able to use mutual TLS across cluster boundaries, the off-cluster machine
and the cluster need to have a shared trust anchor. For the purposes of this
tutorial, we will assume that you have access to the trust anchor certificate
and secret key for your Linkerd deployment and placed it in files called
<code>ca.key</code> and <code>ca.crt</code>.</p><h2 id=install-spire-on-your-machine class=anchor>Install SPIRE on your machine
<a href=#install-spire-on-your-machine class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Linkerd&rsquo;s proxies normally obtain TLS certificates from the identity component
of Linkerd&rsquo;s control plane. In order to attest their identity, they use the
Kubernetes Service Account token that is provided to each Pod.</p><p>Since our external workload lives outside of Kubernetes, the concept of Service
Account tokens does not exist. Instead, we turn to the <a href=https://spiffee.io target=_blank rel=noopener>SPIFFE
framework</a> and its SPIRE implementation to create identities
for off-cluster resources. Thus, for mesh expansion, we configure the Linkerd
proxy to obtain its certificates directly from SPIRE instead of the Linkerd&rsquo;s
identity service. The magic of SPIFFE is that these certificates are compatible
with those generated by Linkerd on the cluster.</p><p>In production, you may already have your own identity infrastructure built on
top of SPIFFE that can be used by the proxies on external machines. For this
tutorial however, we can take you through installing and setting up a minimal
SPIRE environment on your machine. To begin with you need to install SPIRE by
downloading it from the <a href=https://github.com/spiffe/spire/releases target=_blank rel=noopener>SPIRE GitHub releases
page</a>. For example:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://github.com/spiffe/SPIRE/releases/download/v1.8.2/SPIRE-1.8.2-linux-amd64-musl.tar.gz
</span></span><span style=display:flex><span>tar zvxf SPIRE-1.8.2-linux-amd64-musl.tar.gz
</span></span><span style=display:flex><span>cp -r SPIRE-1.8.2/. /opt/SPIRE/
</span></span></code></pre></div><p>Then you need to configure the SPIRE server on your machine:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt;/opt/SPIRE/server.cfg <span style=color:#a5d6ff>&lt;&lt;EOL
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>server {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    bind_address = &#34;127.0.0.1&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    bind_port = &#34;8081&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    trust_domain = &#34;root.linkerd.cluster.local&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    data_dir = &#34;/opt/SPIRE/data/server&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    log_level = &#34;DEBUG&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    ca_ttl = &#34;168h&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    default_x509_svid_ttl = &#34;48h&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>}
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>plugins {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    DataStore &#34;sql&#34; {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        plugin_data {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            database_type = &#34;sqlite3&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            connection_string = &#34;/opt/SPIRE/data/server/datastore.sqlite3&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        }
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    }
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    KeyManager &#34;disk&#34; {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        plugin_data {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            keys_path = &#34;/opt/SPIRE/data/server/keys.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        }
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    }
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    NodeAttestor &#34;join_token&#34; {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        plugin_data {}
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    }
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    UpstreamAuthority &#34;disk&#34; {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        plugin_data {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            cert_file_path = &#34;/opt/SPIRE/certs/ca.crt&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            key_file_path = &#34;/opt/SPIRE/certs/ca.key&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            }
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    }
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>}
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOL</span>
</span></span></code></pre></div><p>This file configures the SPIRE server. It assumes that your root cert and key
that you have installed Linkerd with are placed in the <code>/opt/SPIRE/certs</code>
directory.</p><p>Additionally, you need will need to configure the SPIRE agent:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt;/opt/SPIRE/agent.cfg <span style=color:#a5d6ff>&lt;&lt;EOL
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>agent {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    data_dir = &#34;/opt/SPIRE/data/agent&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    log_level = &#34;DEBUG&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    trust_domain = &#34;root.linkerd.cluster.local&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    server_address = &#34;localhost&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    server_port = 8081
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    # Insecure bootstrap is NOT appropriate for production use but is ok for
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    # simple testing/evaluation purposes.
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    insecure_bootstrap = true
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>}
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>plugins {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>   KeyManager &#34;disk&#34; {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        plugin_data {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            directory = &#34;/opt/SPIRE/data/agent&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        }
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    }
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    NodeAttestor &#34;join_token&#34; {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        plugin_data {}
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    }
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    WorkloadAttestor &#34;unix&#34; {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        plugin_data {}
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    }
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>}
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOL</span>
</span></span></code></pre></div><p>Now you need to start the server and provide a registration policy for your
workload. The server is the component that issues certificates. To begin with,
start the SPIRE server and verify that it is healthy:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SPIRE-server run -config ./server.cfg <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span>
</span></span><span style=display:flex><span>SPIRE-server healthcheck
</span></span></code></pre></div><p>Now you need to register the agent and run it. The agent queries the SPIRE
server to attest (authenticate) workloads.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#79c0ff>AGENT_TOKEN</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>$(</span>SPIRE-server token generate -spiffeID spiffe://root.linkerd.cluster.local/agent -output json | jq -r <span style=color:#a5d6ff>&#39;.value&#39;</span><span style=color:#ff7b72>)</span>
</span></span><span style=display:flex><span>SPIRE-agent run -config ./agent.cfg -joinToken <span style=color:#a5d6ff>&#34;</span><span style=color:#79c0ff>$AGENT_TOKEN</span><span style=color:#a5d6ff>&#34;</span> &amp;
</span></span><span style=display:flex><span>SPIRE-agent healthcheck
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Agent is healthy.
</span></span></code></pre></div><p>After both the server and agent are running, you need to provide a registration
policy for your workload. For the sake of simplicity, we can put together a
simple registration policy that hands out a predefined SPIFFE identity to any
process that runs under the root UID.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SPIRE-server entry create -parentID spiffe://root.linkerd.cluster.local/agent  <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    -spiffeID spiffe://root.linkerd.cluster.local/external-workload -selector unix:uid:<span style=color:#ff7b72>$(</span>id -u root<span style=color:#ff7b72>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Entry ID      : ac5e2354-596a-4059-85f7-5b76e3bb53b3
</span></span><span style=display:flex><span>SPIFFE ID     : spiffe://root.linkerd.cluster.local/external-workload
</span></span><span style=display:flex><span>Parent ID     : spiffe://root.linkerd.cluster.local/agent
</span></span><span style=display:flex><span>TTL           : <span style=color:#a5d6ff>3600</span>
</span></span><span style=display:flex><span>Selector      : unix:uid:0
</span></span></code></pre></div><h2 id=registering-the-external-workload-with-the-mesh class=anchor>Registering the external workload with the mesh
<a href=#registering-the-external-workload-with-the-mesh class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>For Linkerd to know about the external workload and be able to route traffic to
it, we need to supply some information. This is done via an <code>ExternalWorkload</code>
CRD that needs to be present in the cluster. Create one now:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#a5d6ff>machine_IP=&lt;the ip address of your machine&gt;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#a5d6ff>kubectl --context=west apply -f - &lt;&lt;EOF</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>workload.linkerd.io/v1alpha1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>ExternalWorkload</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>external-workload</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>mixed-env</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>location</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>vm</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>legacy-app</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>workload_name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>external-workload</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>meshTls</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>identity</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;spiffe://root.linkerd.cluster.local/external-workload&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>serverName</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;external-workload.cluster.local&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>workloadIPs</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>ip</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>$machine_IP</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>ports</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>port</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>80</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>http</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>status</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>conditions</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>type</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Ready</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>status</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;True&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>lastTransitionTime</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;2024-01-24T11:53:43Z&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#a5d6ff>EOF</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>This will create an <code>ExternalWorkload</code> resource that will be used to discover
workloads that live outside of Kubernetes. A Service object can select over
these resources the same way it selects over Pods, but more on that later.</p><h2 id=installing-the-linkerd-proxy-on-the-machine class=anchor>Installing the Linkerd proxy on the machine
<a href=#installing-the-linkerd-proxy-on-the-machine class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>We need to install and run the Linkerd proxy on the machine. Typically the proxy
runs as a container in Kubernetes. The container itself has some additional
machinery that is specific to bootstrapping identity in Kubernetes environments.
When in a foreign environment, we do not need this functionality, so we can
simply get the proxy binary:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#79c0ff>LINKERD_VERSION</span><span style=color:#ff7b72;font-weight:700>=</span>enterprise-2.15.0
</span></span><span style=display:flex><span>mkdir /opt/linkerd-proxy <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> cs /opt/linkerd-proxy
</span></span><span style=display:flex><span><span style=color:#79c0ff>id</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>$(</span>docker create cr.l5d.io/linkerd/proxy:<span style=color:#79c0ff>$LINKERD_VERSION</span><span style=color:#ff7b72>)</span>
</span></span><span style=display:flex><span>docker cp <span style=color:#79c0ff>$id</span>:/usr/lib/linkerd/linkerd2-proxy ./linkerd-proxy
</span></span><span style=display:flex><span>docker rm -v <span style=color:#79c0ff>$id</span>
</span></span></code></pre></div><h2 id=configuring-and-running-the-proxy class=anchor>Configuring and running the proxy
<a href=#configuring-and-running-the-proxy class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>The machine network configuration needs to be set up for traffic to be steered
through the proxy. This could be done by adding the following iptables rules:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#79c0ff>PROXY_INBOUND_PORT</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>4143</span>
</span></span><span style=display:flex><span><span style=color:#79c0ff>PROXY_OUTBOUND_PORT</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>4140</span>
</span></span><span style=display:flex><span><span style=color:#79c0ff>PROXY_USER_UID</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>$(</span>id -u root<span style=color:#ff7b72>)</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># default inbound and outbound ports to ignore</span>
</span></span><span style=display:flex><span><span style=color:#79c0ff>INBOUND_PORTS_TO_IGNORE</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;4190,4191,4567,4568&#34;</span>
</span></span><span style=display:flex><span><span style=color:#79c0ff>OUTBOUND_PORTS_TO_IGNORE</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;4567,4568&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>iptables -t nat -N PROXY_INIT_REDIRECT
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ignore inbound ports</span>
</span></span><span style=display:flex><span>iptables -t nat -A PROXY_INIT_REDIRECT -p tcp --match multiport --dports <span style=color:#79c0ff>$INBOUND_PORTS_TO_IGNORE</span> -j RETURN
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># redirect all incoming traffic to proxy&#39;s inbound port</span>
</span></span><span style=display:flex><span>iptables -t nat -A PROXY_INIT_REDIRECT -p tcp -j REDIRECT --to-port <span style=color:#79c0ff>$PROXY_INBOUND_PORT</span>
</span></span><span style=display:flex><span>iptables -t nat -A PREROUTING -j PROXY_INIT_REDIRECT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># outbound rules</span>
</span></span><span style=display:flex><span>iptables -t nat -N PROXY_INIT_OUTPUT
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ignore proxy user</span>
</span></span><span style=display:flex><span>iptables -t nat -A PROXY_INIT_OUTPUT -m owner --uid-owner <span style=color:#79c0ff>$PROXY_USER_UID</span> -j RETURN
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ignore loopback</span>
</span></span><span style=display:flex><span>iptables -t nat -A PROXY_INIT_OUTPUT -o lo -j RETURN
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ignore outbound ports</span>
</span></span><span style=display:flex><span>iptables -t nat -A PROXY_INIT_OUTPUT -p tcp --match multiport --dports <span style=color:#79c0ff>$OUTBOUND_PORTS_TO_IGNORE</span> -j RETURN
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># redirect all outgoing traffic proxy&#39;s outbound port</span>
</span></span><span style=display:flex><span>iptables -t nat -A PROXY_INIT_OUTPUT -p tcp -j REDIRECT --to-port <span style=color:#79c0ff>$PROXY_OUTBOUND_PORT</span>
</span></span><span style=display:flex><span>iptables -t nat -A OUTPUT -j PROXY_INIT_OUTPUT
</span></span><span style=display:flex><span>iptables-save -t nat
</span></span></code></pre></div><p>These rules ensure that traffic is correctly routed through the proxy. Now that
this is done, we need to run the proxy with the correct environment variables
set up:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export <span style=color:#79c0ff>LINKERD2_PROXY_IDENTITY_SERVER_ID</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;spiffe://root.linkerd.cluster.local/external-workload&#34;</span>
</span></span><span style=display:flex><span>export <span style=color:#79c0ff>LINKERD2_PROXY_IDENTITY_SERVER_NAME</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;external-workload.cluster.local&#34;</span>
</span></span><span style=display:flex><span>export <span style=color:#79c0ff>LINKERD2_PROXY_POLICY_WORKLOAD</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;{\&#34;ns\&#34;:\&#34;mixed-env\&#34;, \&#34;external_workload\&#34;:\&#34;external-workload\&#34;}&#34;</span>
</span></span><span style=display:flex><span>export <span style=color:#79c0ff>LINKERD2_PROXY_DESTINATION_CONTEXT</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;{\&#34;ns\&#34;:\&#34;mixed-env\&#34;, \&#34;nodeName\&#34;:\&#34;my-vm\&#34;, \&#34;external_workload\&#34;:\&#34;external-workload\&#34;}&#34;</span>
</span></span><span style=display:flex><span>export <span style=color:#79c0ff>LINKERD2_PROXY_DESTINATION_SVC_ADDR</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;linkerd-dst-headless.linkerd.svc.cluster.local.:8086&#34;</span>
</span></span><span style=display:flex><span>export <span style=color:#79c0ff>LINKERD2_PROXY_DESTINATION_SVC_NAME</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;linkerd-destination.linkerd.serviceaccount.identity.linkerd.cluster.local&#34;</span>
</span></span><span style=display:flex><span>export <span style=color:#79c0ff>LINKERD2_PROXY_POLICY_SVC_NAME</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;linkerd-destination.linkerd.serviceaccount.identity.linkerd.cluster.local&#34;</span>
</span></span><span style=display:flex><span>export <span style=color:#79c0ff>LINKERD2_PROXY_POLICY_SVC_ADDR</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;linkerd-policy.linkerd.svc.cluster.local.:8090&#34;</span>
</span></span><span style=display:flex><span>export <span style=color:#79c0ff>LINKERD2_PROXY_IDENTITY_SPIRE_SOCKET</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;unix:///tmp/spire-agent/public/api.sock&#34;</span>
</span></span><span style=display:flex><span>export <span style=color:#79c0ff>LINKERD2_PROXY_IDENTITY_TRUST_ANCHORS</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>`</span>cat /opt/SPIRE/crts/ca.crt<span style=color:#a5d6ff>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./linkerd-proxy
</span></span></code></pre></div><h2 id=start-an-application-workload-on-the-machine class=anchor>Start an application workload on the machine
<a href=#start-an-application-workload-on-the-machine class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Now that the proxy is running on the machine, you can start another workload on
it that will be reachable from within the cluster. Make sure that you run this
application under a user account different than the one the proxy is using.
Let&rsquo;s use the <code>bb</code> utility to mimic a workload:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -p 80:80 buoyantio/bb:v0.0.5 terminus <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    --h1-server-port <span style=color:#a5d6ff>80</span> <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    --response-text hello-from-external-vm
</span></span></code></pre></div><h2 id=send-encrypted-traffic-from-and-to-the-machine class=anchor>Send encrypted traffic from and to the machine
<a href=#send-encrypted-traffic-from-and-to-the-machine class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Now that everything is running, you can send traffic from an in-cluster workload
to the machine. Let&rsquo;s start by creating our client as a workload in the cluster:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#a5d6ff>kubectl apply -f - &lt;&lt;EOF</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>ServiceAccount</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>client</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>mixed-env</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>---</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Pod</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>client</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>mixed-env</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>annotations</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>linkerd.io/inject</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>enabled</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>volumes</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>shared-data</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>emptyDir</span>:<span style=color:#6e7681> </span>{}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>containers</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>client</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>image</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>cr.l5d.io/linkerd/client:current</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>command</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#a5d6ff>&#34;sh&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#a5d6ff>&#34;-c&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- &gt;<span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        while true; do
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          sleep 3600;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        done</span><span style=color:#6e7681>        
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>serviceAccountName</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>client</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#a5d6ff>EOF</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>You can also create a service that selects over both the machine as well as an
in-cluster workload:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#a5d6ff>kubectl apply -f - &lt;&lt;EOF</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Service</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>legacy-app</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>mixed-env</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>type</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>ClusterIP</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>selector</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>legacy-app</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>ports</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>port</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>80</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>protocol</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>TCP</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>one</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>---</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Service</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>legacy-app-cluster</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>mixed-env</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>type</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>ClusterIP</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>selector</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>legacy-app</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>location</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>cluster</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>ports</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>port</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>80</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>protocol</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>TCP</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>one</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>---</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>apps/v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Deployment</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>mixed-env</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>legacy-app</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>replicas</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>selector</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>matchLabels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>legacy-app</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>template</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>legacy-app</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>location</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>cluster</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>annotations</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>linkerd.io/inject</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>enabled</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>containers</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>legacy-app</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>image</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>buoyantio/bb:v0.0.5</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>command</span>:<span style=color:#6e7681> </span>[<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;sh&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;-c&#34;</span>]<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>args</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span>- <span style=color:#a5d6ff>&#34;/out/bb terminus --h1-server-port 80 --response-text hello-from-$POD_NAME --fire-and-forget&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>ports</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>http-port</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>containerPort</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>80</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>env</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>POD_NAME</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>valueFrom</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span><span style=color:#7ee787>fieldRef</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                  </span><span style=color:#7ee787>fieldPath</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>metadata.name</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#a5d6ff>EOF</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>Now you can ssh into the client pod and observe traffic being load-balanced
between both the in-cluster workload and the machine:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl exec -c client --stdin --tty client -n mixed-env -- bash
</span></span><span style=display:flex><span><span style=color:#ff7b72>while</span> sleep 1; <span style=color:#ff7b72>do</span> curl -s http://legacy-app.mixed-env.svc.cluster.local:80/who-am-i| jq .; <span style=color:#ff7b72>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;requestUID&#34;</span>: <span style=color:#a5d6ff>&#34;in:http-sid:terminus-grpc:-1-h1:80-571813026&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;payload&#34;</span>: <span style=color:#a5d6ff>&#34;hello-from-external-workload&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;requestUID&#34;</span>: <span style=color:#a5d6ff>&#34;in:http-sid:terminus-grpc:-1-h1:80-599832807&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;payload&#34;</span>: <span style=color:#a5d6ff>&#34;hello-from-legacy-app-d4446455b-2fgcr&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;requestUID&#34;</span>: <span style=color:#a5d6ff>&#34;in:http-sid:terminus-grpc:-1-h1:80-634437030&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;payload&#34;</span>: <span style=color:#a5d6ff>&#34;hello-from-external-workload&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;requestUID&#34;</span>: <span style=color:#a5d6ff>&#34;in:http-sid:terminus-grpc:-1-h1:80-667578518&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;payload&#34;</span>: <span style=color:#a5d6ff>&#34;hello-from-external-workload&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>Similarly, you can send traffic from the machine to the cluster:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff7b72>while</span> sleep 1; <span style=color:#ff7b72>do</span> curl -s http://legacy-app-cluster.mixed-env.svc.cluster.local:80/who-am-i| jq .; <span style=color:#ff7b72>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># You should start seeing responses from the in-cluster workload.</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;requestUID&#34;</span>: <span style=color:#a5d6ff>&#34;in:http-sid:terminus-grpc:-1-h1:80-824112662&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;payload&#34;</span>: <span style=color:#a5d6ff>&#34;hello-from-legacy-app-6bb4854789-x4wbw&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;requestUID&#34;</span>: <span style=color:#a5d6ff>&#34;in:http-sid:terminus-grpc:-1-h1:80-858574572&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;payload&#34;</span>: <span style=color:#a5d6ff>&#34;hello-from-legacy-app-6bb4854789-x4wbw&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;requestUID&#34;</span>: <span style=color:#a5d6ff>&#34;in:http-sid:terminus-grpc:-1-h1:80-895218927&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;payload&#34;</span>: <span style=color:#a5d6ff>&#34;hello-from-legacy-app-6bb4854789-x4wbw&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=use-authorization-policies-with-machines class=anchor>Use authorization policies with machines
<a href=#use-authorization-policies-with-machines class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Although the identity of the proxy running on the machine is not tied to a
Kubernetes service account, there is still an attested identity that can be used
to define authorization policies. Let&rsquo;s limit the kind of traffic that can reach
our in-cluster workload. Create a <code>Server</code> resource now:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#a5d6ff>kubectl apply -f - &lt;&lt;EOF</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>policy.linkerd.io/v1beta2</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Server</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>in-cluster-endpoint</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>mixed-env</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>annotations</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>config.linkerd.io/default-inbound-policy</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;deny&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>podSelector</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>matchLabels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>legacy-app</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>port</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>http</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>proxyProtocol</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>HTTP/1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#a5d6ff>EOF</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>You can observe that we no longer get responses when we try and target the
in-cluster workload from the machine. This is because our default policy is
<code>deny</code>. We can fix that by explicitly allowing traffic from the machine
by creating a policy that allows its SPIFFE id:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f - <span style=color:#a5d6ff>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: policy.linkerd.io/v1beta2
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: Server
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: in-cluster-endpoint
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: mixed-env
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    config.linkerd.io/default-inbound-policy: &#34;deny&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  podSelector:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      app: legacy-app
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  port: http
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  proxyProtocol: HTTP/1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: policy.linkerd.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: AuthorizationPolicy
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: in-cluster-endpoint-authn
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: mixed-env
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    group: policy.linkerd.io
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    kind: Server
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    name: in-cluster-endpoint
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  requiredAuthenticationRefs:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  - name: in-cluster-endpoint-mtls
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    kind: MeshTLSAuthentication
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    group: policy.linkerd.io
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: policy.linkerd.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: MeshTLSAuthentication
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: in-cluster-endpoint-mtls
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: mixed-env
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  identities:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    - &#34;spiffe://root.linkerd.cluster.local/external-workload&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span></code></pre></div><p>When this policy is applied, you can observe that traffic is allowed from the
machine to the in-cluster workload. Similarly, you can attach policies to an
external workload object by using the <code>externalWorkloadSelector</code> field of the
<code>Server</code> object.</p><h2 id=thats-it class=anchor>That&rsquo;s it
<a href=#thats-it class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Congrats! You have successfully meshed a non-Kubernetes workload with Linkerd
and demonstrated secure, reliable communication between it and the meshed pods
on your cluster.</p></div></div></div></div></div></main><footer class=main-footer><div class=main-footer__top><div class="main-footer__container container"><div class=main-footer__info><p><img src=/logos/linkerd.png alt=Linkerd></p><p>Linkerd was originally created by <a href=https://buoyant.io/ target=_blank rel=noopener>Buoyant</a></p><p>View <a href=https://github.com/linkerd/linkerd/wiki/Linkerd-code-of-conduct target=_blank rel=noopener>Code of Conduct</a></p></div><div class=main-footer__links><div class=main-footer__community><h4>Community</h4><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener>GitHub</a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Linkerd Forum</a></li></ul></div><div class=main-footer__follow><h4>Follow</h4><ul><li><a href=https://www.linkedin.com/company/linkerd/ target=_blank rel=noopener>Linkedin</a></li><li><a href=https://www.youtube.com/buoyantio target=_blank rel=noopener>YouTube</a></li><li><a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a></li></ul></div></div></div></div><div class=main-footer__bottom><div class="main-footer__container container"><p><a href=https://github.com/linkerd/website/tree/main/linkerd.io/content target=_blank rel=noopener>Edit This Site</a></p><p>Copyright © 2024 Linkerd Authors. All rights reserved.</p></div></div></footer></body></html>