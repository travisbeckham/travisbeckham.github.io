<!doctype html><html lang=en><head><meta charset=utf-8><title>Workshop Recap: A closer look at flat-network multicluster and HTTPRoute timeouts with Linkerd 2.14 | Linkerd</title>
<link rel="shortcut icon" href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This blog post is based on a workshop that I recently delivered at Buoyant’s
Service Mesh Academy. If this seems
interesting, check out the
full recording!
Linkerd 2.14 introduces several new features, including flat-network
multicluster, workload identity across clusters, Gateway API conformance,
timeout support in HTTPRoute, and (of course) many bugfixes. Let&rsquo;s take a closer
look at some of the highlights.
Flat-Network Multicluster
In Linkerd 2.13 and earlier, Linkerd&rsquo;s multicluster functionality worked by
channeling traffic through multicluster gateways."><meta property="og:url" content="https://travisbeckham.github.io/2023/09/12/linkerd-214/"><meta property="og:site_name" content="Linkerd"><meta property="og:title" content="Workshop Recap: A closer look at flat-network multicluster and HTTPRoute timeouts with Linkerd 2.14"><meta property="og:description" content="This blog post is based on a workshop that I recently delivered at Buoyant’s Service Mesh Academy. If this seems interesting, check out the full recording!
Linkerd 2.14 introduces several new features, including flat-network multicluster, workload identity across clusters, Gateway API conformance, timeout support in HTTPRoute, and (of course) many bugfixes. Let’s take a closer look at some of the highlights.
Flat-Network Multicluster In Linkerd 2.13 and earlier, Linkerd’s multicluster functionality worked by channeling traffic through multicluster gateways."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-09-12T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-12T00:00:00+00:00"><meta property="og:image" content="https://travisbeckham.github.io/2023/09/12/linkerd-214/cover.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://travisbeckham.github.io/2023/09/12/linkerd-214/cover.jpg"><meta name=twitter:title content="Workshop Recap: A closer look at flat-network multicluster and HTTPRoute timeouts with Linkerd 2.14"><meta name=twitter:description content="This blog post is based on a workshop that I recently delivered at Buoyant’s Service Mesh Academy. If this seems interesting, check out the full recording!
Linkerd 2.14 introduces several new features, including flat-network multicluster, workload identity across clusters, Gateway API conformance, timeout support in HTTPRoute, and (of course) many bugfixes. Let’s take a closer look at some of the highlights.
Flat-Network Multicluster In Linkerd 2.13 and earlier, Linkerd’s multicluster functionality worked by channeling traffic through multicluster gateways."><meta name=twitter:site content="@Linkerd"><link rel=canonical href=https://travisbeckham.github.io/2023/09/12/linkerd-214/><link rel=stylesheet href=/css/main.css><script src=/js/main.js></script><script async defer src=https://buttons.github.io/buttons.js></script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","author":"Flynn","datePublished":"2023-09-12T00:00:00Z","dateModified":"2023-09-12T00:00:00Z","headline":"Workshop Recap: A closer look at flat-network multicluster and HTTPRoute timeouts with Linkerd 2.14","image":"https://travisbeckham.github.io/2023/09/12/linkerd-214/cover.jpg","publisher":{"@type":"Organization","name":"linkerd.io","logo":{"@type":"ImageObject","url":"https://travisbeckham.github.io/logos/linkerd.png","width":472,"height":100}}}</script></head><body><header class=main-header><div class=main-header__container><div class=main-header__logo><a href=/><img src=/logos/linkerd.png alt=Linkerd></a></div><input class=main-header__toggle-checkbox type=checkbox id=main-header-toggle>
<label class=main-header__toggle for=main-header-toggle><span class=main-header__toggle-icon><span class=main-header__toggle-icon--open><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3 6H21V8H3V6m0 5H21v2H3V11m0 5H21v2H3V16z"/></svg>
</span><span class=main-header__toggle-icon--close><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span></span></label><div class=main-header__nav><nav class=main-nav><ul class=main-nav__menu><li><a href=/docs>Docs</a></li><li><a href>Community<svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6L7.41 8.58z"/></svg></a><ul><li><a href=/community/get-involved/>Get Involved</a></li><li><a href=/community/adopters/>Adopters</a></li><li><a href=/community/ambassadors/>Linkerd Ambassadors</a></li><li><a href=/community/heroes/>Linkerd Heroes</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Buoyant's Linkerd Forum</a></li></ul></li><li class=main-nav__menu--selected><a href=/blog/>Blog</a></li><li><a href=/faq/>FAQ</a></li><li><a href=/enterprise/>Enterprise</a></li></ul><div class=main-nav__search><form action=/search method=get><div class="search-input search-input--sm"><svg class="icon" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5.0 0116 9.5c0 1.61-.59 3.09-1.56 4.23L14.71 14H15.5l5 5L19 20.5l-5-5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5.0 013 9.5 6.5 6.5.0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
<input type=text name=q placeholder=Search></div></form></div><div class=main-nav__github><a class=github-button href=https://github.com/linkerd/linkerd2 data-icon=octicon-star data-size=large data-show-count=true aria-label="Star linkerd/linkerd2 on GitHub">Star</a></div><div class=main-nav__forum><a href=https://linkerd.buoyant.io class="button button--primary button--sm" target=_blank rel=noopener>Join Forum</a></div></nav></div></div></header><div class=main-announcement>Service Mesh 101: Get Service Mesh-Certified
<span class=main-announcement__link><a href=https://buoyant.io/courses/service-mesh-101 target=_blank rel=noopener>Enroll now</a></span></div><main class=main-content><div class="blog blog--single"><div class="blog__container container"><div class=blog-post><div class=blog-post__header><h1>Workshop Recap: A closer look at flat-network multicluster and HTTPRoute timeouts with Linkerd 2.14</h1><div class=blog-post-meta><div class=blog-post-meta__media><img src=/authors/flynn.png alt=Flynn class="img img--48 img--round"></div><div class=blog-post-meta__body><div class=blog-post-meta__name>Flynn</div><div class=blog-post-meta__date>Sep 12, 2023 • 6 min read</div></div></div></div><div class=blog-post__cover><img src=/2023/09/12/linkerd-214/cover.jpg alt=Cover class="img img--fill img--rounded"></div><div class="blog-post__content prose"><p><em>This blog post is based on a workshop that I recently delivered at Buoyant’s
<a href=https://buoyant.io/service-mesh-academy target=_blank rel=noopener>Service Mesh Academy</a>. If this seems
interesting, check out the
<a href=https://buoyant.io/service-mesh-academy/whats-coming-in-linkerd-2-14/ target=_blank rel=noopener>full recording</a>!</em></p><p>Linkerd 2.14 introduces several new features, including flat-network
multicluster, workload identity across clusters, Gateway API conformance,
timeout support in HTTPRoute, and (of course) many bugfixes. Let&rsquo;s take a closer
look at some of the highlights.</p><h2 id=flat-network-multicluster>Flat-Network Multicluster</h2><p>In Linkerd 2.13 and earlier, Linkerd&rsquo;s multicluster functionality worked by
channeling traffic through multicluster gateways.</p><figure><img alt="Linkerd 2.13 Gateways" class="img img--max-fill img--center img--rounded" src=/2023/09/12/linkerd-214/gateways.png><figcaption>Linkerd 2.13 multicluster gateways</figcaption></figure><p>This mechanism is simple and functions very well as long as the gateways have IP
connectivity, but it has two significant caveats:</p><ol><li><p><strong>Added Cost:</strong> Funnelling traffic through the gateways adds latency (though
not very much in Linkerd&rsquo;s case). Additionally, the gateways themselves often
require network load balancers, which can add expense.</p></li><li><p><strong>Lost Identity:</strong> When a workload in one cluster calls a workload in a
different cluster, the workload in the second cluster sees the request
originating from its gateway, not from the workload in the first cluster.
This makes it impossible to properly implement authorization policy across
clusters.</p></li></ol><figure><img alt="Linkerd 2.13 Lost Identity" class="img img--max-fill img--center img--rounded" src=/2023/09/12/linkerd-214/lost-identity.png><figcaption>Linkerd 2.13 multicluster lost identity</figcaption></figure><p>The solution in 2.14? <em>Completely bypass the gateways</em>.</p><figure><img alt="Linkerd 2.14 Flat-network Multicluster" class="img img--max-fill img--center img--rounded" src=/2023/09/12/linkerd-214/flat-multicluster.png><figcaption>Linkerd 2.14 flat-network multicluster</figcaption></figure><p>This new approach brings some real benefits to the table, all stemming from the
fact that now workload 1 is simply making a normal mTLS connection directly to
workload 2. This means that workload identity <em>is</em> preserved across cluster
boundaries, since the request to workload 2 comes directly from workload 1. In
turn, this means that authorization policy just works across cluster boundaries,
as does all the rest of Linkerd&rsquo;s functionality related to mTLS and identity.</p><p>Additionally, this direct pod-to-pod communication reduces latency and also
means that there are fewer components to fail in the network path. There&rsquo;s also
no need for load balancers, which can directly cut costs.</p><p>To use this new capability, you start by installing the Linkerd multicluster
extension with gateways disabled:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd multicluster install --gateway<span style=color:#ff7b72;font-weight:700>=</span>false | kubectl apply -f -
</span></span></code></pre></div><p>and then also add <code>--gateway=false</code> when linking clusters, e.g.:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd --context<span style=color:#ff7b72;font-weight:700>=</span>us-west multicluster link <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>        --cluster-name us-west <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>        --gateway<span style=color:#ff7b72;font-weight:700>=</span>false <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    | kubectl --context<span style=color:#ff7b72;font-weight:700>=</span>us-east apply -f -
</span></span></code></pre></div><p>Note that even though the gateways are no longer in play, you&rsquo;ll still see the
Link resources.</p><p>Finally, when you label Services for export across clusters, you&rsquo;ll use</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>mirror.linkerd.io/exported</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>remote-discovery</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>The <code>remote-discovery</code> value for this label triggers Linkerd to not use
gateways, and instead directly communicate between the two clusters&rsquo; control
planes to handle Service mirroring across clusters.</p><p>Of course, there are still points to be aware of. The most critical is also the
most obvious: you must have a flat network in which each cluster has its own
unique CIDR range, and Pods in one cluster can talk directly to Pods in other
clusters. How tricky this is to arrange will depend on your cluster provider,
but it&rsquo;s always possible!</p><p>Additionally - as always with multicluster operations in Linkerd - your clusters
will all need a shared trust anchor. We generally recommend that each cluster
have a distinct identity trust domain (and thus cluster domain), as this can
considerably simplify cross-cluster authorization policy.</p><h3 id=gateway-api-improvements>Gateway API Improvements</h3><p>Starting in Linkerd 2.12, the Gateway API became the central configuration
mechanism for talking about classes of HTTP traffic (including gRPC), including
functionality such as authentication policy (Linkerd 2.12) and dynamic request
routing (Linkerd 2.13). In the long run, Gateway API is expected to replace SMI
and ServicePolicy, though there&rsquo;s no defined timetable for that yet.</p><p>A challenge when implementing Gateway API as a service mesh is that the
conformance tests for Gateway API were originally defined assuming that any
implementation being tested for conformance included a gateway controller that
handled north/south traffic. Since Linkerd relies on external ingress
controllers for north/south traffic rather than bundling its own, there was no
way that Linkerd could be conformant.</p><p>This situation changes in Gateway API v0.8.0, just released on August 29, 2023,
which adds the concept of <em>conformance profiles</em> to Gateway API. These named
profiles define subsets of Gateway API and allow implementations to choose (and
document) the subsets to which they conform. One of the profiles defined by
v0.8.0 is the <code>Mesh</code> profile, which checks only service mesh functionality, and
we&rsquo;re delighted to announce that Linkerd 2.14 is fully conformant with this new
<code>Mesh</code> profile.</p><p>A major component of Gateway API conformance is, of course, the APIGroup used
for Gateway API resources. Since Linkerd 2.13 and earlier could not be
conformant, by definition, they copied the HTTPRoute resource into the
<code>policy.linkerd.io</code> APIGroup. Linkerd 2.14 adds support for the official Gateway
API group, <code>gateway.networking.k8s.io</code>. New installations should generally use
<code>gateway.networking.k8s.io</code> HTTPRoutes (with one notable exception, described
below), but of course support for <code>policy.linkerd.io</code> will remain for the
foreseeable future.</p><h2 id=httproute-timeouts>HTTPRoute Timeouts</h2><p>One more thing that Linkerd 2.14 adds is support for timeouts in HTTPRoutes:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>policy.linkerd.io/v1beta3</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>HTTPRoute</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>timeout-example</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#a5d6ff>...</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>rules</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>backendRefs</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>some-service</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>port</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>8080</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>timeouts</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>request</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>10s</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>backendRequest</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>3s</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>The two types of timeouts have different purposes:</p><ul><li><code>timeouts.request</code> sets the end-to-end timeout for the entire request,
including retries, etc., and</li><li><code>timeouts.backendRequest</code> sets the timeout for just the communications from
the proxies to the workload.</li></ul><p>Either timeout can be set alone, or both can be set together (in which case
<code>timeouts.backendRequest</code> must be less than <code>timeouts.request</code>). To disable a
timeout, set it to <code>0s</code> &ndash; <em>not</em> setting a timeout leaves Linkerd to enforce its
default.</p><p>Both timeouts use the syntax of Go&rsquo;s <code>time.ParseDuration</code>, with the exception
that floating-point numbers are not allowed (so <code>1h30m</code> is legal, but <code>1.5h</code> is
not). The gory details are specified in GEP-2257 and GEP-1742, but it&rsquo;s worth
noting in particular that the zero value for &ldquo;no timeout&rdquo; must be specified as
<code>0s</code>, not simply <code>0</code>.</p><p>There&rsquo;s one final important point about timeouts: Linkerd 2.14 only supports
timeouts in <code>policy.linkerd.io/v1beta3</code> HTTPRoutes, because GEP-1742 didn&rsquo;t
quite make it into Gateway API v0.8.0 (it&rsquo;s slated for inclusion in Gateway API
v1.0.0). This is the one reason you might still need to use <code>policy.linkerd.io</code>
HTTPRoutes instead of switching to <code>gateway.networking.k8s.io</code> HTTPRoutes.</p><h2 id=linkerd-214>Linkerd 2.14</h2><p>Linkerd has a long tradition of easily providing security, reliability, and
observability, while maintaining operational simplicity and performance. Linkerd
2.14 continues this tradition, adding important new capabilities like
flat-network multicluster and enhanced Gateway API functionality in order to
address the needs of users from small startups to huge enterprises.</p><hr><p>If you found this interesting, check out the Service Mesh Academy workshop on
<a href=https://buoyant.io/service-mesh-academy/whats-coming-in-linkerd-2-14/ target=_blank rel=noopener>What&rsquo;s Coming in Linkerd 2.14</a>,
where you can see the hands-on demo of everything I&rsquo;ve talked about here! And,
as always, feedback is always welcome &ndash; you can find me as <code>@flynn</code> on the
<a href=https://slack.linkerd.io target=_blank rel=noopener>Linkerd Slack</a>.</p></div></div><div class=blog-post-related><h2>Suggested Blog Posts</h2><div class=blog-post-related__pages><div class="card card--horz card--center"><div class=card__media><img src=/2024/02/06/linkerd-certificates-with-vault/thumbnail.jpg alt=Thumbnail class="img img--128 img--rounded"></div><div class=card__body><div class=card__header><h4><a href=/2024/02/06/linkerd-certificates-with-vault/>Workshop Recap: Linkerd Certificate Management with Vault</a></h4><div class=blog-post-meta><div class=blog-post-meta__date>Feb 6, 2024 • 15 min read</div></div></div></div></div><div class="card card--horz card--center"><div class=card__media><img src=/2024/08/13/announcing-linkerd-2.16/cover.jpg alt=Cover class="img img--128 img--rounded"></div><div class=card__body><div class=card__header><h4><a href=/2024/08/13/announcing-linkerd-2.16/>Announcing Linkerd 2.16! Metrics, retries, and timeouts for HTTP and gRPC
routes; IPv6 support; policy audit mode; and lots more</a></h4><div class=blog-post-meta><div class=blog-post-meta__date>Aug 13, 2024 • 6 min read</div></div></div></div></div><div class="card card--horz card--center"><div class=card__media><img src=/2024/02/21/announcing-linkerd-2.15/cover.jpg alt=Cover class="img img--128 img--rounded"></div><div class=card__body><div class=card__header><h4><a href=/2024/02/21/announcing-linkerd-2.15/>Announcing Linkerd 2.15 with mesh expansion, native sidecars, and SPIFFE</a></h4><div class=blog-post-meta><div class=blog-post-meta__date>Feb 21, 2024 • 8 min read</div></div></div></div></div></div></div></div></div></main><footer class=main-footer><div class=main-footer__top><div class="main-footer__container container"><div class=main-footer__info><p><img src=/logos/linkerd.png alt=Linkerd></p><p>Linkerd was originally created by <a href=https://buoyant.io/ target=_blank rel=noopener>Buoyant</a></p><p>View <a href=https://github.com/linkerd/linkerd/wiki/Linkerd-code-of-conduct target=_blank rel=noopener>Code of Conduct</a></p></div><div class=main-footer__links><div class=main-footer__community><h4>Community</h4><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener>GitHub</a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Linkerd Forum</a></li></ul></div><div class=main-footer__follow><h4>Follow</h4><ul><li><a href=https://www.linkedin.com/company/linkerd/ target=_blank rel=noopener>Linkedin</a></li><li><a href=https://www.youtube.com/buoyantio target=_blank rel=noopener>YouTube</a></li><li><a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a></li></ul></div></div></div></div><div class=main-footer__bottom><div class="main-footer__container container"><p><a href=https://github.com/linkerd/website/tree/main/linkerd.io/content target=_blank rel=noopener>Edit This Site</a></p><p>Copyright © 2024 Linkerd Authors. All rights reserved.</p></div></div></footer></body></html>