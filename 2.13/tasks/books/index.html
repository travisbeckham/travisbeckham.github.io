<!doctype html><html lang=en><head><meta charset=utf-8><title>Debugging HTTP applications with per-route metrics | Linkerd</title>
<link rel="shortcut icon" href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Follow a long-form example of debugging a failing HTTP application using per-route metrics."><meta property="og:url" content="https://travisbeckham.github.io/2.13/tasks/books/"><meta property="og:site_name" content="Linkerd"><meta property="og:title" content="Debugging HTTP applications with per-route metrics"><meta property="og:description" content="Follow a long-form example of debugging a failing HTTP application using per-route metrics."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="2.13"><meta property="og:image" content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:title content="Debugging HTTP applications with per-route metrics"><meta name=twitter:description content="Follow a long-form example of debugging a failing HTTP application using per-route metrics."><meta name=twitter:site content="@Linkerd"><link rel=canonical href=https://travisbeckham.github.io/2.13/tasks/books/><link rel=stylesheet href=/css/main.css><script src=/js/main.js></script><script async defer src=https://buttons.github.io/buttons.js></script></head><body><header class=main-header><div class=main-header__container><div class=main-header__logo><a href=/><img src=/logos/linkerd.png alt=Linkerd></a></div><input class=main-header__toggle-checkbox type=checkbox id=main-header-toggle>
<label class=main-header__toggle for=main-header-toggle><span class=main-header__toggle-icon><span class=main-header__toggle-icon--open><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3 6H21V8H3V6m0 5H21v2H3V11m0 5H21v2H3V16z"/></svg>
</span><span class=main-header__toggle-icon--close><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span></span></label><div class=main-header__nav><nav class=main-nav><ul class=main-nav__menu><li class=main-nav__menu--selected><a href=/docs>Docs</a></li><li><a href=#>Community<svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6L7.41 8.58z"/></svg></a><ul><li><a href=/community/get-involved/>Get Involved</a></li><li><a href=/community/adopters/>Adopters</a></li><li><a href=/community/ambassadors/>Linkerd Ambassadors</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Buoyant's Linkerd Forum</a></li></ul></li><li><a href=/blog/>Blog</a></li><li><a href=/faq/>FAQ</a></li><li><a href=/enterprise/>Enterprise</a></li></ul><div class=main-nav__search><form action=/search method=get><div class="search-input search-input--sm"><svg class="icon" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5.0 0116 9.5c0 1.61-.59 3.09-1.56 4.23L14.71 14H15.5l5 5L19 20.5l-5-5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5.0 013 9.5 6.5 6.5.0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
<input type=text name=q placeholder=Search></div></form></div><div class=main-nav__github><a class=github-button href=https://github.com/linkerd/linkerd2 data-icon=octicon-star data-size=large data-show-count=true aria-label="Star linkerd/linkerd2 on GitHub">Star</a></div><div class=main-nav__forum><a href=https://linkerd.buoyant.io class="button button--primary button--sm" target=_blank rel=noopener>Join Forum</a></div></nav></div></div></header><div class=main-announcement><strong>Oct 23, 2024</strong> New blog post: Towards a Sustainable Service Mesh.
<a href=/2024/10/23/making-linkerd-sustainable/ class=main-announcement__link>Read the post</a></div><main class=main-content><div class="alert alert--warning alert--condensed alert--center docs__deprecated-alert"><div class=alert__content>You are viewing docs for an older version of Linkerd.
<a href=/2.16/>View the latest docs</a>.</div></div><div class=docs><div class=docs__container><div class=docs__sidebar><div class=docs__nav><div class=docs__versions><select onchange="window.location.href=this.value"><option value=/2-edge/>Linkerd edge</option><option value=/2.16/>Linkerd 2.16</option><option value=/2.15/>Linkerd 2.15</option><option value=/2.14/>Linkerd 2.14</option><option value=/2.13/ selected>Linkerd 2.13</option><option value=/2.12/>Linkerd 2.12</option><option value=/2.11/>Linkerd 2.11</option><option value=/2.10/>Linkerd 2.10</option></select></div><nav><ul><li><a href=/2.13/overview/>Overview</a></li><li><a href=/2.13/getting-started/>Getting Started</a></li><li><a href=/2.13/features/>Features
</a><input class=toggle__input type=checkbox id=toggle-eb69f9fda3cfd87e9a8e70073ecd9ca5>
<label class=toggle__label for=toggle-eb69f9fda3cfd87e9a8e70073ecd9ca5><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.13/features/http-grpc/>HTTP, HTTP/2, and gRPC Proxying</a></li><li><a href=/2.13/features/protocol-detection/>TCP Proxying and Protocol Detection</a></li><li><a href=/2.13/features/retries-and-timeouts/>Retries and Timeouts</a></li><li><a href=/2.13/features/automatic-mtls/>Automatic mTLS</a></li><li><a href=/2.13/features/ingress/>Ingress</a></li><li><a href=/2.13/features/telemetry/>Telemetry and Monitoring</a></li><li><a href=/2.13/features/load-balancing/>Load Balancing</a></li><li><a href=/2.13/features/server-policy/>Authorization Policy</a></li><li><a href=/2.13/features/proxy-injection/>Automatic Proxy Injection</a></li><li><a href=/2.13/features/cni/>CNI Plugin</a></li><li><a href=/2.13/features/dashboard/>Dashboard and on-cluster metrics stack</a></li><li><a href=/2.13/features/distributed-tracing/>Distributed Tracing</a></li><li><a href=/2.13/features/request-routing/>Dynamic Request Routing</a></li><li><a href=/2.13/features/fault-injection/>Fault Injection</a></li><li><a href=/2.13/features/ha/>High Availability</a></li><li><a href=/2.13/features/access-logging/>HTTP Access Logging</a></li><li><a href=/2.13/features/nft/>Iptables-nft Support</a></li><li><a href=/2.13/features/multicluster/>Multi-cluster communication</a></li><li><a href=/2.13/features/service-profiles/>Service Profiles</a></li><li><a href=/2.13/features/traffic-split/>Traffic Split (canaries, blue/green deploys)</a></li></ul></li><li class=docs__nav--selected><a href=/2.13/tasks/>Tasks
</a><input class=toggle__input type=checkbox id=toggle-7a7cef84ddbcc31f1bd5f18df32ee069 checked>
<label class=toggle__label for=toggle-7a7cef84ddbcc31f1bd5f18df32ee069><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.13/tasks/adding-your-service/>Adding your services to Linkerd</a></li><li><a href=/2.13/tasks/automatic-failover/>Automatic Multicluster Failover</a></li><li><a href=/2.13/tasks/automatically-rotating-control-plane-tls-credentials/>Automatically Rotating Control Plane TLS Credentials</a></li><li><a href=/2.13/tasks/automatically-rotating-webhook-tls-credentials/>Automatically Rotating Webhook TLS Credentials</a></li><li><a href=/2.13/tasks/external-prometheus/>Bringing your own Prometheus</a></li><li><a href=/2.13/tasks/circuit-breakers/>Circuit Breakers</a></li><li><a href=/2.13/tasks/configuring-dynamic-request-routing/>Configuring Dynamic Request Routing</a></li><li><a href=/2.13/tasks/configuring-per-route-policy/>Configuring Fine-grained Authorization Policy</a></li><li><a href=/2.13/tasks/configuring-proxy-concurrency/>Configuring Proxy Concurrency</a></li><li><a href=/2.13/tasks/configuring-retries/>Configuring Retries</a></li><li><a href=/2.13/tasks/configuring-timeouts/>Configuring Timeouts</a></li><li><a href=/2.13/tasks/using-debug-endpoints/>Control Plane Debug Endpoints</a></li><li><a href=/2.13/tasks/customize-install/>Customizing Linkerd's Configuration with Kustomize</a></li><li><a href=/2.13/tasks/debugging-502s/>Debugging 502s</a></li><li><a href=/2.13/tasks/debugging-your-service/>Debugging gRPC applications with request tracing</a></li><li class=docs__nav--selected><a href=/2.13/tasks/books/>Debugging HTTP applications with per-route metrics</a></li><li><a href=/2.13/tasks/distributed-tracing/>Distributed tracing with Linkerd</a></li><li><a href=/2.13/tasks/exporting-metrics/>Exporting Metrics</a></li><li><a href=/2.13/tasks/exposing-dashboard/>Exposing the Dashboard</a></li><li><a href=/2.13/tasks/generate-certificates/>Generating your own mTLS root certificates</a></li><li><a href=/2.13/tasks/getting-per-route-metrics/>Getting Per-Route Metrics</a></li><li><a href=/2.13/tasks/linkerd-smi/>Getting started with Linkerd SMI extension</a></li><li><a href=/2.13/tasks/graceful-shutdown/>Graceful Pod Shutdown</a></li><li><a href=/2.13/tasks/grafana/>Grafana</a></li><li><a href=/2.13/tasks/using-ingress/>Handling ingress traffic</a></li><li><a href=/2.13/tasks/fault-injection/>Injecting Faults</a></li><li><a href=/2.13/tasks/install/>Installing Linkerd</a></li><li><a href=/2.13/tasks/install-helm/>Installing Linkerd with Helm</a></li><li><a href=/2.13/tasks/installing-multicluster/>Installing Multi-cluster Components</a></li><li><a href=/2.13/tasks/using-psp/>Linkerd and Pod Security Policies (PSP)</a></li><li><a href=/2.13/tasks/manually-rotating-control-plane-tls-credentials/>Manually Rotating Control Plane TLS Credentials</a></li><li><a href=/2.13/tasks/modifying-proxy-log-level/>Modifying the Proxy Log Level</a></li><li><a href=/2.13/tasks/multicluster/>Multi-cluster communication</a></li><li><a href=/2.13/tasks/multicluster-using-statefulsets/>Multi-cluster communication with StatefulSets</a></li><li><a href=/2.13/tasks/flagger/>Progressive Delivery with Flagger</a></li><li><a href=/2.13/tasks/replacing_expired_certificates/>Replacing expired certificates</a></li><li><a href=/2.13/tasks/restricting-access/>Restricting Access To Services</a></li><li><a href=/2.13/tasks/rotating_webhooks_certificates/>Rotating webhooks certificates</a></li><li><a href=/2.13/tasks/securing-linkerd-tap/>Securing Linkerd Tap</a></li><li><a href=/2.13/tasks/setting-up-service-profiles/>Setting Up Service Profiles</a></li><li><a href=/2.13/tasks/traffic-shifting/>Traffic Shifting</a></li><li><a href=/2.13/tasks/troubleshooting/>Troubleshooting</a></li><li><a href=/2.13/tasks/uninstall/>Uninstalling Linkerd</a></li><li><a href=/2.13/tasks/uninstall-multicluster/>Uninstalling Multicluster</a></li><li><a href=/2.13/tasks/upgrade/>Upgrading Linkerd</a></li><li><a href=/2.13/tasks/using-custom-domain/>Using a Custom Cluster Domain</a></li><li><a href=/2.13/tasks/using-a-private-docker-repository/>Using A Private Docker Repository</a></li><li><a href=/2.13/tasks/extensions/>Using extensions</a></li><li><a href=/2.13/tasks/gitops/>Using GitOps with Linkerd with Argo CD</a></li><li><a href=/2.13/tasks/using-the-debug-container/>Using the Debug Sidecar</a></li><li><a href=/2.13/tasks/validating-your-traffic/>Validating your mTLS traffic</a></li></ul></li><li><a href=/2.13/reference/>Reference
</a><input class=toggle__input type=checkbox id=toggle-0bb183e885edaf2a0044b607cfb98a06>
<label class=toggle__label for=toggle-0bb183e885edaf2a0044b607cfb98a06><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.13/reference/architecture/>Architecture</a></li><li><a href=/2.13/reference/authorization-policy/>Authorization Policy</a></li><li><a href=/2.13/reference/circuit-breaking/>Circuit Breaking</a></li><li><a href=/2.13/reference/cli/>CLI
</a><input class=toggle__input type=checkbox id=toggle-d6775a64e9a2f59c8f4dab50b7c8b796>
<label class=toggle__label for=toggle-d6775a64e9a2f59c8f4dab50b7c8b796><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.13/reference/cli/authz/>authz</a></li><li><a href=/2.13/reference/cli/check/>check</a></li><li><a href=/2.13/reference/cli/completion/>completion</a></li><li><a href=/2.13/reference/cli/diagnostics/>diagnostics</a></li><li><a href=/2.13/reference/cli/identity/>identity</a></li><li><a href=/2.13/reference/cli/inject/>inject</a></li><li><a href=/2.13/reference/cli/install/>install</a></li><li><a href=/2.13/reference/cli/install-cni/>install-cni</a></li><li><a href=/2.13/reference/cli/jaeger/>jaeger</a></li><li><a href=/2.13/reference/cli/multicluster/>multicluster</a></li><li><a href=/2.13/reference/cli/profile/>profile</a></li><li><a href=/2.13/reference/cli/prune/>prune</a></li><li><a href=/2.13/reference/cli/uninject/>uninject</a></li><li><a href=/2.13/reference/cli/uninstall/>uninstall</a></li><li><a href=/2.13/reference/cli/upgrade/>upgrade</a></li><li><a href=/2.13/reference/cli/version/>version</a></li><li><a href=/2.13/reference/cli/viz/>viz</a></li></ul></li><li><a href=/2.13/reference/cluster-configuration/>Cluster Configuration</a></li><li><a href=/2.13/reference/extension-list/>Extensions List</a></li><li><a href=/2.13/reference/helm-chart-version-matrix/>Helm Chart Version Matrix</a></li><li><a href=/2.13/reference/httproute/>HTTPRoute</a></li><li><a href=/2.13/reference/iptables/>IPTables Reference</a></li><li><a href=/2.13/reference/proxy-configuration/>Proxy Configuration</a></li><li><a href=/2.13/reference/proxy-log-level/>Proxy Log Level</a></li><li><a href=/2.13/reference/proxy-metrics/>Proxy Metrics</a></li><li><a href=/2.13/reference/service-profiles/>Service Profiles</a></li></ul></li></ul><ul><li><a href=/what-is-a-service-mesh/>What is a service mesh?</a></li><li><a href=/faq/>Frequently Asked Questions</a></li><li><a href=/releases/>Releases and Versions</a></li><li><a href=/design-principles/>Design Principles</a></li><li><a href=/going-to-production/>Going to Production</a></li><li><a href=/service-mesh-glossary/>Service Mesh Glossary</a></li></ul></nav><div class=docs__community><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener><img src=/logos/github.svg alt=GitHub class=img></a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener><img src=/logos/slack.svg alt=Slack class=img></a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener><img src=/logos/forum.png alt="Linkerd Forum" class=img></a></li></ul></div></div></div><div class=docs__main><div class=docs__body><div class=docs__header><h1>Debugging HTTP applications with per-route metrics</h1></div><div class="docs__content prose"><p>This demo is of a Ruby application that helps you manage your bookshelf. It
consists of multiple microservices and uses JSON over HTTP to communicate with
the other services. There are three services:</p><ul><li><p><a href=https://github.com/BuoyantIO/booksapp/blob/master/webapp.rb target=_blank rel=noopener>webapp</a>: the
frontend</p></li><li><p><a href=https://github.com/BuoyantIO/booksapp/blob/master/authors.rb target=_blank rel=noopener>authors</a>: an
API to manage the authors in the system</p></li><li><p><a href=https://github.com/BuoyantIO/booksapp/blob/master/books.rb target=_blank rel=noopener>books</a>: an API
to manage the books in the system</p></li></ul><p>For demo purposes, the app comes with a simple traffic generator. The overall
topology looks like this:</p><figure><img alt=Topology class="img img--max-fill img--center img--rounded" src=/docs/images/books/topology.png><figcaption>Topology</figcaption></figure><h2 id=prerequisites class=anchor>Prerequisites
<a href=#prerequisites class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>To use this guide, you&rsquo;ll need to have Linkerd and its Viz extension installed
on your cluster. Follow the <a href=../install/>Installing Linkerd Guide</a> if
you haven&rsquo;t already done this.</p><h2 id=install-the-app class=anchor>Install the app
<a href=#install-the-app class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>To get started, let&rsquo;s install the books app onto your cluster. In your local
terminal, run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create ns booksapp <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  curl --proto <span style=color:#a5d6ff>&#39;=https&#39;</span> --tlsv1.2 -sSfL https://run.linkerd.io/booksapp.yml <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  | kubectl -n booksapp apply -f -
</span></span></code></pre></div><p>This command creates a namespace for the demo, downloads its Kubernetes
resource manifest and uses <code>kubectl</code> to apply it to your cluster. The app
comprises the Kubernetes deployments and services that run in the <code>booksapp</code>
namespace.</p><p>Downloading a bunch of containers for the first time takes a little while.
Kubernetes can tell you when all the services are running and ready for
traffic. Wait for that to happen by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n booksapp rollout status deploy webapp
</span></span></code></pre></div><p>You can also take a quick look at all the components that were added to your
cluster by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n booksapp get all
</span></span></code></pre></div><p>Once the rollout has completed successfully, you can access the app itself by
port-forwarding <code>webapp</code> locally:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n booksapp port-forward svc/webapp <span style=color:#a5d6ff>7000</span> &amp;
</span></span></code></pre></div><p>Open <a href=http://localhost:7000/ target=_blank rel=noopener>http://localhost:7000/</a> in your browser to see the
frontend.</p><figure><img alt=Frontend class="img img--max-fill img--center img--rounded" src=/docs/images/books/frontend.png><figcaption>Frontend</figcaption></figure><p>Unfortunately, there is an error in the app: if you click <em>Add Book</em>, it will
fail 50% of the time. This is a classic case of non-obvious, intermittent
failure&mdash;the type that drives service owners mad because it is so difficult to
debug. Kubernetes itself cannot detect or surface this error. From Kubernetes&rsquo;s
perspective, it looks like everything&rsquo;s fine, but you know the application is
returning errors.</p><figure><img alt=Failure class="img img--max-fill img--center img--rounded" src=/docs/images/books/failure.png><figcaption>Failure</figcaption></figure><h2 id=add-linkerd-to-the-service class=anchor>Add Linkerd to the service
<a href=#add-linkerd-to-the-service class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Now we need to add the Linkerd data plane proxies to the service. The easiest
option is to do something like this:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get -n booksapp deploy -o yaml <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  | linkerd inject - <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  | kubectl apply -f -
</span></span></code></pre></div><p>This command retrieves the manifest of all deployments in the <code>booksapp</code>
namespace, runs them through <code>linkerd inject</code>, and then re-applies with
<code>kubectl apply</code>. The <code>linkerd inject</code> command annotates each resource to
specify that they should have the Linkerd data plane proxies added, and
Kubernetes does this when the manifest is reapplied to the cluster. Best of
all, since Kubernetes does a rolling deploy, the application stays running the
entire time. (See <a href=../../features/proxy-injection/>Automatic Proxy Injection</a> for
more details on how this works.)</p><h2 id=debugging class=anchor>Debugging
<a href=#debugging class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Let&rsquo;s use Linkerd to discover the root cause of this app&rsquo;s failures. To check
out the Linkerd dashboard, run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd viz dashboard &amp;
</span></span></code></pre></div><figure><img alt=Dashboard class="img img--max-fill img--center img--rounded" src=/docs/images/books/dashboard.png><figcaption>Dashboard</figcaption></figure><p>Select <code>booksapp</code> from the namespace dropdown and click on the
<a href=http://localhost:50750/namespaces/booksapp/deployments target=_blank rel=noopener>Deployments</a> workload.
You should see all the deployments in the <code>booksapp</code> namespace show up. There
will be success rate, requests per second, and latency percentiles.</p><p>That’s cool, but you’ll notice that the success rate for <code>webapp</code> is not 100%.
This is because the traffic generator is submitting new books. You can do the
same thing yourself and push that success rate even lower. Click on <code>webapp</code> in
the Linkerd dashboard for a live debugging session.</p><p>You should now be looking at the detail view for the <code>webapp</code> service. You’ll
see that <code>webapp</code> is taking traffic from <code>traffic</code> (the load generator), and it
has two outgoing dependencies: <code>authors</code> and <code>book</code>. One is the service for
pulling in author information and the other is the service for pulling in book
information.</p><figure><img alt=Detail class="img img--max-fill img--center img--rounded" src=/docs/images/books/webapp-detail.png><figcaption>Detail</figcaption></figure><p>A failure in a dependent service may be exactly what’s causing the errors that
<code>webapp</code> is returning (and the errors you as a user can see when you click). We
can see that the <code>books</code> service is also failing. Let’s scroll a little further
down the page, we’ll see a live list of all traffic endpoints that <code>webapp</code> is
receiving. This is interesting:</p><figure><img alt=Top class="img img--max-fill img--center img--rounded" src=/docs/images/books/top.png><figcaption>Top</figcaption></figure><p>Aha! We can see that inbound traffic coming from the <code>webapp</code> service going to
the <code>books</code> service is failing a significant percentage of the time. That could
explain why <code>webapp</code> was throwing intermittent failures. Let’s click on the tap
(🔬) icon and then on the Start button to look at the actual request and
response stream.</p><figure><img alt=Tap class="img img--max-fill img--center img--rounded" src=/docs/images/books/tap.png><figcaption>Tap</figcaption></figure><p>Indeed, many of these requests are returning 500’s.</p><p>It was surprisingly easy to diagnose an intermittent issue that affected only a
single route. You now have everything you need to open a detailed bug report
explaining exactly what the root cause is. If the <code>books</code> service was your own,
you know exactly where to look in the code.</p><h2 id=service-profiles class=anchor>Service Profiles
<a href=#service-profiles class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>To understand the root cause, we used live traffic. For some issues this is
great, but what happens if the issue is intermittent and happens in the middle of
the night? <a href=../../features/service-profiles/>Service profiles</a> provide Linkerd
with some additional information about your services. These define the routes
that you&rsquo;re serving and, among other things, allow for the collection of metrics
on a per route basis. With Prometheus storing these metrics, you&rsquo;ll be able to
sleep soundly and look up intermittent issues in the morning.</p><p>One of the easiest ways to get service profiles setup is by using existing
<a href=https://swagger.io/docs/specification/about/ target=_blank rel=noopener>OpenAPI (Swagger)</a> specs. This
demo has published specs for each of its services. You can create a service
profile for <code>webapp</code> by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl --proto <span style=color:#a5d6ff>&#39;=https&#39;</span> --tlsv1.2 -sSfL https://run.linkerd.io/booksapp/webapp.swagger <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  | linkerd -n booksapp profile --open-api - webapp <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  | kubectl -n booksapp apply -f -
</span></span></code></pre></div><p>This command will do three things:</p><ol><li>Fetch the swagger specification for <code>webapp</code>.</li><li>Take the spec and convert it into a service profile by using the <code>profile</code>
command.</li><li>Apply this configuration to the cluster.</li></ol><p>Alongside <code>install</code> and <code>inject</code>, <code>profile</code> is also a pure text operation. Check
out the profile that is generated:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>linkerd.io/v1alpha2</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>ServiceProfile</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>creationTimestamp</span>:<span style=color:#6e7681> </span><span style=color:#79c0ff>null</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>webapp.booksapp.svc.cluster.local</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>booksapp</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>routes</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>condition</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>method</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>GET</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>pathRegex</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>GET /</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>condition</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>method</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>POST</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>pathRegex</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/authors</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>POST /authors</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>condition</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>method</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>GET</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>pathRegex</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/authors/[^/]*</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>GET /authors/{id}</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>condition</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>method</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>POST</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>pathRegex</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/authors/[^/]*/delete</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>POST /authors/{id}/delete</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>condition</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>method</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>POST</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>pathRegex</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/authors/[^/]*/edit</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>POST /authors/{id}/edit</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>condition</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>method</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>POST</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>pathRegex</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/books</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>POST /books</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>condition</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>method</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>GET</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>pathRegex</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/books/[^/]*</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>GET /books/{id}</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>condition</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>method</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>POST</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>pathRegex</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/books/[^/]*/delete</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>POST /books/{id}/delete</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>condition</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>method</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>POST</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>pathRegex</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/books/[^/]*/edit</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>POST /books/{id}/edit</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>The <code>name</code> refers to the FQDN of your Kubernetes service,
<code>webapp.booksapp.svc.cluster.local</code> in this instance. Linkerd uses the <code>Host</code>
header of requests to associate service profiles with requests. When the proxy
sees a <code>Host</code> header of <code>webapp.booksapp.svc.cluster.local</code>, it will use that to
look up the service profile&rsquo;s configuration.</p><p>Routes are simple conditions that contain the method (<code>GET</code> for example) and a
regex to match the path. This allows you to group REST style resources together
instead of seeing a huge list. The names for routes can be whatever you&rsquo;d like.
For this demo, the method is appended to the route regex.</p><p>To get profiles for <code>authors</code> and <code>books</code>, you can run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl --proto <span style=color:#a5d6ff>&#39;=https&#39;</span> --tlsv1.2 -sSfL https://run.linkerd.io/booksapp/authors.swagger <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  | linkerd -n booksapp profile --open-api - authors <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  | kubectl -n booksapp apply -f -
</span></span><span style=display:flex><span>curl --proto <span style=color:#a5d6ff>&#39;=https&#39;</span> --tlsv1.2 -sSfL https://run.linkerd.io/booksapp/books.swagger <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  | linkerd -n booksapp profile --open-api - books <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  | kubectl -n booksapp apply -f -
</span></span></code></pre></div><p>Verifying that this all works is easy when you use <code>linkerd viz tap</code>. Each live
request will show up with what <code>:authority</code> or <code>Host</code> header is being seen as
well as the <code>:path</code> and <code>rt_route</code> being used. Run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd viz tap -n booksapp deploy/webapp -o wide | grep req
</span></span></code></pre></div><p>This will watch all the live requests flowing through <code>webapp</code> and look
something like:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>req <span style=color:#79c0ff>id</span><span style=color:#ff7b72;font-weight:700>=</span>0:1 <span style=color:#79c0ff>proxy</span><span style=color:#ff7b72;font-weight:700>=</span>in  <span style=color:#79c0ff>src</span><span style=color:#ff7b72;font-weight:700>=</span>10.1.3.76:57152 <span style=color:#79c0ff>dst</span><span style=color:#ff7b72;font-weight:700>=</span>10.1.3.74:7000 <span style=color:#79c0ff>tls</span><span style=color:#ff7b72;font-weight:700>=</span>true :method<span style=color:#ff7b72;font-weight:700>=</span>POST :authority<span style=color:#ff7b72;font-weight:700>=</span>webapp.default:7000 :path<span style=color:#ff7b72;font-weight:700>=</span>/books/2878/edit <span style=color:#79c0ff>src_res</span><span style=color:#ff7b72;font-weight:700>=</span>deploy/traffic <span style=color:#79c0ff>src_ns</span><span style=color:#ff7b72;font-weight:700>=</span>booksapp <span style=color:#79c0ff>dst_res</span><span style=color:#ff7b72;font-weight:700>=</span>deploy/webapp <span style=color:#79c0ff>dst_ns</span><span style=color:#ff7b72;font-weight:700>=</span>booksapp <span style=color:#79c0ff>rt_route</span><span style=color:#ff7b72;font-weight:700>=</span>POST /books/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>/edit
</span></span></code></pre></div><p>As you can see:</p><ul><li><code>:authority</code> is the correct host</li><li><code>:path</code> correctly matches</li><li><code>rt_route</code> contains the name of the route</li></ul><p>These metrics are part of the <a href=../../reference/cli/viz/#routes><code>linkerd viz routes</code></a>
command instead of <a href=../../reference/cli/viz/#stat><code>linkerd viz stat</code></a>. To see the
metrics that have accumulated so far, run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd viz -n booksapp routes svc/webapp
</span></span></code></pre></div><p>This will output a table of all the routes observed and their golden metrics.
The <code>[DEFAULT]</code> route is a catch all for anything that does not match the
service profile.</p><p>Profiles can be used to observe <em>outgoing</em> requests as well as <em>incoming</em>
requests. To do that, run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd viz -n booksapp routes deploy/webapp --to svc/books
</span></span></code></pre></div><p>This will show all requests and routes that originate in the <code>webapp</code> deployment
and are destined to the <code>books</code> service. Similarly to using <code>tap</code> and <code>top</code>
views in the <a href=#debugging>debugging</a> section, the root cause of errors in this
demo is immediately apparent:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ROUTE                     SERVICE   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99
</span></span><span style=display:flex><span>DELETE /books/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>.json     books   100.00%   0.5rps          18ms          29ms          30ms
</span></span><span style=display:flex><span>GET /books.json             books   100.00%   1.1rps           7ms          12ms          18ms
</span></span><span style=display:flex><span>GET /books/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>.json        books   100.00%   2.5rps           6ms          10ms          10ms
</span></span><span style=display:flex><span>POST /books.json            books    52.24%   2.2rps          23ms          34ms          39ms
</span></span><span style=display:flex><span>PUT /books/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>.json        books    41.98%   1.4rps          73ms          97ms          99ms
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>DEFAULT<span style=color:#ff7b72;font-weight:700>]</span>                   books         -        -             -             -             -
</span></span></code></pre></div><h2 id=retries class=anchor>Retries
<a href=#retries class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>As it can take a while to update code and roll out a new version, let&rsquo;s
tell Linkerd that it can retry requests to the failing endpoint. This will
increase request latencies, as requests will be retried multiple times, but not
require rolling out a new version.</p><p>In this application, the success rate of requests from the <code>books</code> deployment to
the <code>authors</code> service is poor. To see these metrics, run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd viz -n booksapp routes deploy/books --to svc/authors
</span></span></code></pre></div><p>The output should look like:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ROUTE                       SERVICE   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99
</span></span><span style=display:flex><span>DELETE /authors/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>.json   authors         -        -             -             -             -
</span></span><span style=display:flex><span>GET /authors.json           authors         -        -             -             -             -
</span></span><span style=display:flex><span>GET /authors/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>.json      authors         -        -             -             -             -
</span></span><span style=display:flex><span>HEAD /authors/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>.json     authors    50.85%   3.9rps           5ms          10ms          17ms
</span></span><span style=display:flex><span>POST /authors.json          authors         -        -             -             -             -
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>DEFAULT<span style=color:#ff7b72;font-weight:700>]</span>                   authors         -        -             -             -             -
</span></span></code></pre></div><p>One thing that’s clear is that all requests from books to authors are to the
<code>HEAD /authors/{id}.json</code> route and those requests are failing about 50% of the
time.</p><p>To correct this, let’s edit the authors service profile and make those
requests retryable by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n booksapp edit sp/authors.booksapp.svc.cluster.local
</span></span></code></pre></div><p>You&rsquo;ll want to add <code>isRetryable</code> to a specific route. It should look like:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>routes</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>condition</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>method</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>HEAD</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>pathRegex</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/authors/[^/]*\.json</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>HEAD /authors/{id}.json</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>isRetryable</span>:<span style=color:#6e7681> </span><span style=color:#79c0ff>true</span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic>### ADD THIS LINE ###</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>After editing the service profile, Linkerd will begin to retry requests to
this route automatically. We see a nearly immediate improvement in success rate
by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd viz -n booksapp routes deploy/books --to svc/authors -o wide
</span></span></code></pre></div><p>This should look like:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ROUTE                       SERVICE   EFFECTIVE_SUCCESS   EFFECTIVE_RPS   ACTUAL_SUCCESS   ACTUAL_RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99
</span></span><span style=display:flex><span>DELETE /authors/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>.json   authors                   -               -                -            -             -           0ms
</span></span><span style=display:flex><span>GET /authors.json           authors                   -               -                -            -             -           0ms
</span></span><span style=display:flex><span>GET /authors/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>.json      authors                   -               -                -            -             -           0ms
</span></span><span style=display:flex><span>HEAD /authors/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>.json     authors             100.00%          2.8rps           58.45%       4.7rps           7ms          25ms          37ms
</span></span><span style=display:flex><span>POST /authors.json          authors                   -               -                -            -             -           0ms
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>DEFAULT<span style=color:#ff7b72;font-weight:700>]</span>                   authors                   -               -                -            -             -           0ms
</span></span></code></pre></div><p>You&rsquo;ll notice that the <code>-o wide</code> flag has added some columns to the <code>routes</code>
view. These show the difference between <code>EFFECTIVE_SUCCESS</code> and
<code>ACTUAL_SUCCESS</code>. The difference between these two show how well retries are
working. <code>EFFECTIVE_RPS</code> and <code>ACTUAL_RPS</code> show how many requests are being sent
to the destination service and and how many are being received by the client&rsquo;s
Linkerd proxy.</p><p>With retries automatically happening now, success rate looks great but the p95
and p99 latencies have increased. This is to be expected because doing retries
takes time.</p><h2 id=timeouts class=anchor>Timeouts
<a href=#timeouts class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Linkerd can limit how long to wait before failing outgoing requests to another
service. These timeouts work by adding another key to a service profile&rsquo;s routes
configuration.</p><p>To get started, let&rsquo;s take a look at the current latency for requests from
<code>webapp</code> to the <code>books</code> service:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd viz -n booksapp routes deploy/webapp --to svc/books
</span></span></code></pre></div><p>This should look something like:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ROUTE                     SERVICE   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99
</span></span><span style=display:flex><span>DELETE /books/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>.json     books   100.00%   0.7rps          10ms          27ms          29ms
</span></span><span style=display:flex><span>GET /books.json             books   100.00%   1.3rps           9ms          34ms          39ms
</span></span><span style=display:flex><span>GET /books/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>.json        books   100.00%   2.0rps           9ms          52ms          91ms
</span></span><span style=display:flex><span>POST /books.json            books   100.00%   1.3rps          45ms         140ms         188ms
</span></span><span style=display:flex><span>PUT /books/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>.json        books   100.00%   0.7rps          80ms         170ms         194ms
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>DEFAULT<span style=color:#ff7b72;font-weight:700>]</span>                   books         -        -             -             -             -
</span></span></code></pre></div><p>Requests to the <code>books</code> service&rsquo;s <code>PUT /books/{id}.json</code> route include retries
for when that service calls the <code>authors</code> service as part of serving those
requests, as described in the previous section. This improves success rate, at
the cost of additional latency. For the purposes of this demo, let&rsquo;s set a 25ms
timeout for calls to that route. Your latency numbers will vary depending on the
characteristics of your cluster. To edit the <code>books</code> service profile, run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n booksapp edit sp/books.booksapp.svc.cluster.local
</span></span></code></pre></div><p>Update the <code>PUT /books/{id}.json</code> route to have a timeout:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>routes</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>condition</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>method</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>PUT</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>pathRegex</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/books/[^/]*\.json</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>PUT /books/{id}.json</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>timeout</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>25ms ### ADD THIS LINE</span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic>###</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>Linkerd will now return errors to the <code>webapp</code> REST client when the timeout is
reached. This timeout includes retried requests and is the maximum amount of
time a REST client would wait for a response.</p><p>Run <code>routes</code> to see what has changed:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd viz -n booksapp routes deploy/webapp --to svc/books -o wide
</span></span></code></pre></div><p>With timeouts happening now, the metrics will change:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ROUTE                     SERVICE   EFFECTIVE_SUCCESS   EFFECTIVE_RPS   ACTUAL_SUCCESS   ACTUAL_RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99
</span></span><span style=display:flex><span>DELETE /books/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>.json     books             100.00%          0.7rps          100.00%       0.7rps           8ms          46ms          49ms
</span></span><span style=display:flex><span>GET /books.json             books             100.00%          1.3rps          100.00%       1.3rps           9ms          33ms          39ms
</span></span><span style=display:flex><span>GET /books/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>.json        books             100.00%          2.2rps          100.00%       2.2rps           8ms          19ms          28ms
</span></span><span style=display:flex><span>POST /books.json            books             100.00%          1.3rps          100.00%       1.3rps          27ms          81ms          96ms
</span></span><span style=display:flex><span>PUT /books/<span style=color:#ff7b72;font-weight:700>{</span>id<span style=color:#ff7b72;font-weight:700>}</span>.json        books              86.96%          0.8rps          100.00%       0.7rps          75ms          98ms         100ms
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>DEFAULT<span style=color:#ff7b72;font-weight:700>]</span>                   books                   -               -                -            -             -
</span></span></code></pre></div><p>The latency numbers include time spent in the <code>webapp</code> application itself, so
it&rsquo;s expected that they exceed the 25ms timeout that we set for requests from
<code>webapp</code> to <code>books</code>. We can see that the timeouts are working by observing that
the effective success rate for our route has dropped below 100%.</p><h2 id=clean-up class=anchor>Clean Up
<a href=#clean-up class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>To remove the books app and the booksapp namespace from your cluster, run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl --proto <span style=color:#a5d6ff>&#39;=https&#39;</span> --tlsv1.2 -sSfL https://run.linkerd.io/booksapp.yml <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  | kubectl -n booksapp delete -f - <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> kubectl delete ns booksapp
</span></span></code></pre></div></div></div></div></div></div></main><footer class=main-footer><div class=main-footer__top><div class="main-footer__container container"><div class=main-footer__info><p><img src=/logos/linkerd.png alt=Linkerd></p><p>Linkerd was originally created by <a href=https://buoyant.io/ target=_blank rel=noopener>Buoyant</a></p><p>View <a href=https://github.com/linkerd/linkerd/wiki/Linkerd-code-of-conduct target=_blank rel=noopener>Code of Conduct</a></p></div><div class=main-footer__links><div class=main-footer__community><h4>Community</h4><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener>GitHub</a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Linkerd Forum</a></li></ul></div><div class=main-footer__follow><h4>Follow</h4><ul><li><a href=https://www.linkedin.com/company/linkerd/ target=_blank rel=noopener>Linkedin</a></li><li><a href=https://www.youtube.com/buoyantio target=_blank rel=noopener>YouTube</a></li><li><a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a></li></ul></div></div></div></div><div class=main-footer__bottom><div class="main-footer__container container"><p><a href=https://github.com/linkerd/website/tree/main/linkerd.io/content target=_blank rel=noopener>Edit This Site</a></p><p>Copyright © 2024 Linkerd Authors. All rights reserved.</p></div></div></footer></body></html>