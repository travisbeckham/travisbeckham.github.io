<!doctype html><html lang=en><head><meta charset=utf-8><title>Manually Rotating Control Plane TLS Credentials | Linkerd</title>
<link rel="shortcut icon" href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Update Linkerd's TLS trust anchor and issuer certificate."><meta property="og:url" content="https://travisbeckham.github.io/2.13/tasks/manually-rotating-control-plane-tls-credentials/"><meta property="og:site_name" content="Linkerd"><meta property="og:title" content="Manually Rotating Control Plane TLS Credentials"><meta property="og:description" content="Update Linkerd's TLS trust anchor and issuer certificate."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="2.13"><meta property="og:image" content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:title content="Manually Rotating Control Plane TLS Credentials"><meta name=twitter:description content="Update Linkerd's TLS trust anchor and issuer certificate."><meta name=twitter:site content="@Linkerd"><link rel=canonical href=https://travisbeckham.github.io/2.13/tasks/manually-rotating-control-plane-tls-credentials/><link rel=stylesheet href=/css/main.css><script src=/js/main.js></script><script async defer src=https://buttons.github.io/buttons.js></script></head><body><header class=main-header><div class=main-header__container><div class=main-header__logo><a href=/><img src=/logos/linkerd.png alt=Linkerd></a></div><input class=main-header__toggle-checkbox type=checkbox id=main-header-toggle>
<label class=main-header__toggle for=main-header-toggle><span class=main-header__toggle-icon><span class=main-header__toggle-icon--open><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3 6H21V8H3V6m0 5H21v2H3V11m0 5H21v2H3V16z"/></svg>
</span><span class=main-header__toggle-icon--close><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span></span></label><div class=main-header__nav><nav class=main-nav><ul class=main-nav__menu><li class=main-nav__menu--selected><a href=/docs>Docs</a></li><li><a href=#>Community<svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6L7.41 8.58z"/></svg></a><ul><li><a href=/community/get-involved/>Get Involved</a></li><li><a href=/community/adopters/>Adopters</a></li><li><a href=/community/ambassadors/>Linkerd Ambassadors</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Buoyant's Linkerd Forum</a></li></ul></li><li><a href=/blog/>Blog</a></li><li><a href=/faq/>FAQ</a></li><li><a href=/enterprise/>Enterprise</a></li></ul><div class=main-nav__search><form action=/search method=get><div class="search-input search-input--sm"><svg class="icon" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5.0 0116 9.5c0 1.61-.59 3.09-1.56 4.23L14.71 14H15.5l5 5L19 20.5l-5-5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5.0 013 9.5 6.5 6.5.0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
<input type=text name=q placeholder=Search></div></form></div><div class=main-nav__github><a class=github-button href=https://github.com/linkerd/linkerd2 data-icon=octicon-star data-size=large data-show-count=true aria-label="Star linkerd/linkerd2 on GitHub">Star</a></div><div class=main-nav__forum><a href=https://linkerd.buoyant.io class="button button--primary button--sm" target=_blank rel=noopener>Join Forum</a></div></nav></div></div></header><div class=main-announcement>Service Mesh 101: Get Service Mesh-Certified
<span class=main-announcement__link><a href=https://buoyant.io/courses/service-mesh-101 target=_blank rel=noopener>Enroll now</a></span></div><main class=main-content><div class="alert alert--warning alert--condensed alert--center docs__deprecated-alert"><div class=alert__content>You are viewing docs for an older version of Linkerd.
<a href=/2.16/>View the latest docs</a>.</div></div><div class=docs><div class=docs__container><div class=docs__sidebar><div class=docs__nav><div class=docs__versions><select onchange="window.location.href=this.value"><option value=/2-edge/>Linkerd edge</option><option value=/2.16/>Linkerd 2.16</option><option value=/2.15/>Linkerd 2.15</option><option value=/2.14/>Linkerd 2.14</option><option value=/2.13/ selected>Linkerd 2.13</option><option value=/2.12/>Linkerd 2.12</option><option value=/2.11/>Linkerd 2.11</option><option value=/2.10/>Linkerd 2.10</option></select></div><nav><ul><li><a href=/2.13/overview/>Overview</a></li><li><a href=/2.13/getting-started/>Getting Started</a></li><li><a href=/2.13/features/>Features
</a><input class=toggle__input type=checkbox id=toggle-eb69f9fda3cfd87e9a8e70073ecd9ca5>
<label class=toggle__label for=toggle-eb69f9fda3cfd87e9a8e70073ecd9ca5><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.13/features/http-grpc/>HTTP, HTTP/2, and gRPC Proxying</a></li><li><a href=/2.13/features/protocol-detection/>TCP Proxying and Protocol Detection</a></li><li><a href=/2.13/features/retries-and-timeouts/>Retries and Timeouts</a></li><li><a href=/2.13/features/automatic-mtls/>Automatic mTLS</a></li><li><a href=/2.13/features/ingress/>Ingress</a></li><li><a href=/2.13/features/telemetry/>Telemetry and Monitoring</a></li><li><a href=/2.13/features/load-balancing/>Load Balancing</a></li><li><a href=/2.13/features/server-policy/>Authorization Policy</a></li><li><a href=/2.13/features/proxy-injection/>Automatic Proxy Injection</a></li><li><a href=/2.13/features/cni/>CNI Plugin</a></li><li><a href=/2.13/features/dashboard/>Dashboard and on-cluster metrics stack</a></li><li><a href=/2.13/features/distributed-tracing/>Distributed Tracing</a></li><li><a href=/2.13/features/request-routing/>Dynamic Request Routing</a></li><li><a href=/2.13/features/fault-injection/>Fault Injection</a></li><li><a href=/2.13/features/ha/>High Availability</a></li><li><a href=/2.13/features/access-logging/>HTTP Access Logging</a></li><li><a href=/2.13/features/nft/>Iptables-nft Support</a></li><li><a href=/2.13/features/multicluster/>Multi-cluster communication</a></li><li><a href=/2.13/features/service-profiles/>Service Profiles</a></li><li><a href=/2.13/features/traffic-split/>Traffic Split (canaries, blue/green deploys)</a></li></ul></li><li class=docs__nav--selected><a href=/2.13/tasks/>Tasks
</a><input class=toggle__input type=checkbox id=toggle-7a7cef84ddbcc31f1bd5f18df32ee069 checked>
<label class=toggle__label for=toggle-7a7cef84ddbcc31f1bd5f18df32ee069><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.13/tasks/adding-your-service/>Adding your services to Linkerd</a></li><li><a href=/2.13/tasks/automatic-failover/>Automatic Multicluster Failover</a></li><li><a href=/2.13/tasks/automatically-rotating-control-plane-tls-credentials/>Automatically Rotating Control Plane TLS Credentials</a></li><li><a href=/2.13/tasks/automatically-rotating-webhook-tls-credentials/>Automatically Rotating Webhook TLS Credentials</a></li><li><a href=/2.13/tasks/external-prometheus/>Bringing your own Prometheus</a></li><li><a href=/2.13/tasks/circuit-breakers/>Circuit Breakers</a></li><li><a href=/2.13/tasks/configuring-dynamic-request-routing/>Configuring Dynamic Request Routing</a></li><li><a href=/2.13/tasks/configuring-per-route-policy/>Configuring Fine-grained Authorization Policy</a></li><li><a href=/2.13/tasks/configuring-proxy-concurrency/>Configuring Proxy Concurrency</a></li><li><a href=/2.13/tasks/configuring-retries/>Configuring Retries</a></li><li><a href=/2.13/tasks/configuring-timeouts/>Configuring Timeouts</a></li><li><a href=/2.13/tasks/using-debug-endpoints/>Control Plane Debug Endpoints</a></li><li><a href=/2.13/tasks/customize-install/>Customizing Linkerd's Configuration with Kustomize</a></li><li><a href=/2.13/tasks/debugging-502s/>Debugging 502s</a></li><li><a href=/2.13/tasks/debugging-your-service/>Debugging gRPC applications with request tracing</a></li><li><a href=/2.13/tasks/books/>Debugging HTTP applications with per-route metrics</a></li><li><a href=/2.13/tasks/distributed-tracing/>Distributed tracing with Linkerd</a></li><li><a href=/2.13/tasks/exporting-metrics/>Exporting Metrics</a></li><li><a href=/2.13/tasks/exposing-dashboard/>Exposing the Dashboard</a></li><li><a href=/2.13/tasks/generate-certificates/>Generating your own mTLS root certificates</a></li><li><a href=/2.13/tasks/getting-per-route-metrics/>Getting Per-Route Metrics</a></li><li><a href=/2.13/tasks/linkerd-smi/>Getting started with Linkerd SMI extension</a></li><li><a href=/2.13/tasks/graceful-shutdown/>Graceful Pod Shutdown</a></li><li><a href=/2.13/tasks/grafana/>Grafana</a></li><li><a href=/2.13/tasks/using-ingress/>Handling ingress traffic</a></li><li><a href=/2.13/tasks/fault-injection/>Injecting Faults</a></li><li><a href=/2.13/tasks/install/>Installing Linkerd</a></li><li><a href=/2.13/tasks/install-helm/>Installing Linkerd with Helm</a></li><li><a href=/2.13/tasks/installing-multicluster/>Installing Multi-cluster Components</a></li><li><a href=/2.13/tasks/using-psp/>Linkerd and Pod Security Policies (PSP)</a></li><li class=docs__nav--selected><a href=/2.13/tasks/manually-rotating-control-plane-tls-credentials/>Manually Rotating Control Plane TLS Credentials</a></li><li><a href=/2.13/tasks/modifying-proxy-log-level/>Modifying the Proxy Log Level</a></li><li><a href=/2.13/tasks/multicluster/>Multi-cluster communication</a></li><li><a href=/2.13/tasks/multicluster-using-statefulsets/>Multi-cluster communication with StatefulSets</a></li><li><a href=/2.13/tasks/flagger/>Progressive Delivery with Flagger</a></li><li><a href=/2.13/tasks/replacing_expired_certificates/>Replacing expired certificates</a></li><li><a href=/2.13/tasks/restricting-access/>Restricting Access To Services</a></li><li><a href=/2.13/tasks/rotating_webhooks_certificates/>Rotating webhooks certificates</a></li><li><a href=/2.13/tasks/securing-linkerd-tap/>Securing Linkerd Tap</a></li><li><a href=/2.13/tasks/setting-up-service-profiles/>Setting Up Service Profiles</a></li><li><a href=/2.13/tasks/traffic-shifting/>Traffic Shifting</a></li><li><a href=/2.13/tasks/troubleshooting/>Troubleshooting</a></li><li><a href=/2.13/tasks/uninstall/>Uninstalling Linkerd</a></li><li><a href=/2.13/tasks/uninstall-multicluster/>Uninstalling Multicluster</a></li><li><a href=/2.13/tasks/upgrade/>Upgrading Linkerd</a></li><li><a href=/2.13/tasks/using-custom-domain/>Using a Custom Cluster Domain</a></li><li><a href=/2.13/tasks/using-a-private-docker-repository/>Using A Private Docker Repository</a></li><li><a href=/2.13/tasks/extensions/>Using extensions</a></li><li><a href=/2.13/tasks/gitops/>Using GitOps with Linkerd with Argo CD</a></li><li><a href=/2.13/tasks/using-the-debug-container/>Using the Debug Sidecar</a></li><li><a href=/2.13/tasks/validating-your-traffic/>Validating your mTLS traffic</a></li></ul></li><li><a href=/2.13/reference/>Reference
</a><input class=toggle__input type=checkbox id=toggle-0bb183e885edaf2a0044b607cfb98a06>
<label class=toggle__label for=toggle-0bb183e885edaf2a0044b607cfb98a06><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.13/reference/architecture/>Architecture</a></li><li><a href=/2.13/reference/authorization-policy/>Authorization Policy</a></li><li><a href=/2.13/reference/circuit-breaking/>Circuit Breaking</a></li><li><a href=/2.13/reference/cli/>CLI
</a><input class=toggle__input type=checkbox id=toggle-d6775a64e9a2f59c8f4dab50b7c8b796>
<label class=toggle__label for=toggle-d6775a64e9a2f59c8f4dab50b7c8b796><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.13/reference/cli/authz/>authz</a></li><li><a href=/2.13/reference/cli/check/>check</a></li><li><a href=/2.13/reference/cli/completion/>completion</a></li><li><a href=/2.13/reference/cli/diagnostics/>diagnostics</a></li><li><a href=/2.13/reference/cli/identity/>identity</a></li><li><a href=/2.13/reference/cli/inject/>inject</a></li><li><a href=/2.13/reference/cli/install/>install</a></li><li><a href=/2.13/reference/cli/install-cni/>install-cni</a></li><li><a href=/2.13/reference/cli/jaeger/>jaeger</a></li><li><a href=/2.13/reference/cli/multicluster/>multicluster</a></li><li><a href=/2.13/reference/cli/profile/>profile</a></li><li><a href=/2.13/reference/cli/prune/>prune</a></li><li><a href=/2.13/reference/cli/uninject/>uninject</a></li><li><a href=/2.13/reference/cli/uninstall/>uninstall</a></li><li><a href=/2.13/reference/cli/upgrade/>upgrade</a></li><li><a href=/2.13/reference/cli/version/>version</a></li><li><a href=/2.13/reference/cli/viz/>viz</a></li></ul></li><li><a href=/2.13/reference/cluster-configuration/>Cluster Configuration</a></li><li><a href=/2.13/reference/extension-list/>Extensions List</a></li><li><a href=/2.13/reference/helm-chart-version-matrix/>Helm Chart Version Matrix</a></li><li><a href=/2.13/reference/httproute/>HTTPRoute</a></li><li><a href=/2.13/reference/iptables/>IPTables Reference</a></li><li><a href=/2.13/reference/proxy-configuration/>Proxy Configuration</a></li><li><a href=/2.13/reference/proxy-log-level/>Proxy Log Level</a></li><li><a href=/2.13/reference/proxy-metrics/>Proxy Metrics</a></li><li><a href=/2.13/reference/service-profiles/>Service Profiles</a></li></ul></li></ul><ul><li><a href=/what-is-a-service-mesh/>What is a service mesh?</a></li><li><a href=/faq/>Frequently Asked Questions</a></li><li><a href=/releases/>Releases and Versions</a></li><li><a href=/design-principles/>Design Principles</a></li><li><a href=/going-to-production/>Going to Production</a></li><li><a href=/service-mesh-glossary/>Service Mesh Glossary</a></li></ul></nav><div class=docs__community><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener><img src=/logos/github.svg alt=GitHub class=img></a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener><img src=/logos/slack.svg alt=Slack class=img></a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener><img src=/logos/forum.png alt="Linkerd Forum" class=img></a></li></ul></div></div></div><div class=docs__main><div class=docs__body><div class=docs__header><h1>Manually Rotating Control Plane TLS Credentials</h1></div><div class="docs__content prose"><p>Linkerd&rsquo;s <a href=../../features/automatic-mtls/>automatic mTLS</a> feature uses a set of
TLS credentials to generate TLS certificates for proxies: a trust anchor, and
an issuer certificate and private key. The trust anchor has a limited period of
validity: 365 days if generated by <code>linkerd install</code>, or a customized value if
<a href=../generate-certificates/>generated manually</a>.</p><p>Thus, for clusters that are expected to outlive this lifetime, you must
manually rotate the trust anchor. In this document, we describe how to
accomplish this without downtime.</p><p>Independent of the trust anchor, the issuer certificate and key pair can also
expire (though it is possible to <a href=../automatically-rotating-control-plane-tls-credentials/>use <code>cert-manager</code> to set up automatic
rotation</a>. This
document also covers how to rotate the issuer certificate and key pair without
downtime.</p><h2 id=prerequisites class=anchor>Prerequisites
<a href=#prerequisites class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>These instructions use the following CLI tools:</p><ul><li><a href=https://smallstep.com/cli/ target=_blank rel=noopener><code>step</code></a> to manipulate certificates and keys;</li></ul><h2 id=understanding-the-current-state-of-your-system class=anchor>Understanding the current state of your system
<a href=#understanding-the-current-state-of-your-system class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Begin by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd check --proxy
</span></span></code></pre></div><p>If your configuration is valid and your credentials are not expiring soon, you
should see output similar to:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>linkerd-identity
</span></span><span style=display:flex><span>----------------
</span></span><span style=display:flex><span>âˆš certificate config is valid
</span></span><span style=display:flex><span>âˆš trust roots are using supported crypto algorithm
</span></span><span style=display:flex><span>âˆš trust roots are within their validity period
</span></span><span style=display:flex><span>âˆš trust roots are valid for at least 60 days
</span></span><span style=display:flex><span>âˆš issuer cert is using supported crypto algorithm
</span></span><span style=display:flex><span>âˆš issuer cert is within its validity period
</span></span><span style=display:flex><span>âˆš issuer cert is valid for at least 60 days
</span></span><span style=display:flex><span>âˆš issuer cert is issued by the trust root
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>linkerd-identity-data-plane
</span></span><span style=display:flex><span>---------------------------
</span></span><span style=display:flex><span>âˆš data plane proxies certificate match CA
</span></span></code></pre></div><p>However, if you see a message warning you that your trust anchor (&ldquo;trust root&rdquo;)
or issuer certificates are expiring soon, then you must rotate them.</p><p><strong>Note that this document only applies if the trust anchor is currently valid.</strong>
If your trust anchor has expired, follow the <a href=../replacing_expired_certificates/>Replacing Expired Certificates Guide</a>
instead. (If your issuer certificate has expired but your trust anchor is still
valid, continue on with this document.)</p><p>For example, if your issuer certificate has expired, you will see a message
similar to:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>linkerd-identity
</span></span><span style=display:flex><span>----------------
</span></span><span style=display:flex><span>âˆš certificate config is valid
</span></span><span style=display:flex><span>âˆš trust roots are using supported crypto algorithm
</span></span><span style=display:flex><span>âˆš trust roots are within their validity period
</span></span><span style=display:flex><span>âˆš trust roots are valid for at least 60 days
</span></span><span style=display:flex><span>âˆš issuer cert is using supported crypto algorithm
</span></span><span style=display:flex><span>Ã— issuer cert is within its validity period
</span></span><span style=display:flex><span>issuer certificate is not valid anymore. Expired on 2019-12-19T09:02:01Z
</span></span><span style=display:flex><span>see https://linkerd.io/checks/#l5d-identity-issuer-cert-is-time-valid for hints
</span></span></code></pre></div><p>If your trust anchor has expired, you will see a message similar to:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>linkerd-identity
</span></span><span style=display:flex><span>----------------
</span></span><span style=display:flex><span>âˆš certificate config is valid
</span></span><span style=display:flex><span>âˆš trust roots are using supported crypto algorithm
</span></span><span style=display:flex><span>Ã— trust roots are within their validity period
</span></span><span style=display:flex><span>Invalid roots:
</span></span><span style=display:flex><span>* 79461543992952791393769540277800684467 identity.linkerd.cluster.local not valid anymore. Expired on 2019-12-19T09:11:30Z
</span></span><span style=display:flex><span>see https://linkerd.io/checks/#l5d-identity-roots-are-time-valid  for hints
</span></span></code></pre></div><h2 id=rotating-the-trust-anchor class=anchor>Rotating the trust anchor
<a href=#rotating-the-trust-anchor class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Rotating the trust anchor without downtime is a multi-step process: you must
generate a new trust anchor, bundle it with the old one, rotate the issuer
certificate and key pair, and finally remove the old trust anchor from the
bundle. If you simply need to rotate the issuer certificate and key pair, you
can skip directly to <a href=#rotating-the-identity-issuer-certificate>Rotating the identity issuer
certificate</a> and ignore the trust
anchor rotation steps.</p><h2 id=read-the-current-trust-anchor-certificate-from-the-cluster class=anchor>Read the current trust anchor certificate from the cluster
<a href=#read-the-current-trust-anchor-certificate-from-the-cluster class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>To avoid downtime, you need to bundle the existing trust anchor certificate
with the newly-generated trust anchor certificate into a certificate bundle:
using the bundle allows workloads ultimately signed with either trust anchor
to work properly in the mesh. Since certificates are not sensitive information,
we can simply pull the existing trust anchor certificate directly from the
cluster.</p><p>The following command uses <code>kubectl</code> to fetch the Linkerd config from the
<code>linkerd-identity-trust-roots</code> ConfigMap and save it in <code>original-trust.crt</code>:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n linkerd get cm linkerd-identity-trust-roots -o<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>jsonpath</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;{.data.ca-bundle\.crt}&#39;</span> &gt; original-trust.crt
</span></span></code></pre></div><h2 id=generate-a-new-trust-anchor class=anchor>Generate a new trust anchor
<a href=#generate-a-new-trust-anchor class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>After saving the current trust anchor certificate, generate a new trust anchor
certificate and private key:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>step certificate create root.linkerd.cluster.local ca-new.crt ca-new.key --profile root-ca --no-password --insecure
</span></span></code></pre></div><p>Note that we use <code>--no-password --insecure</code> to avoid encrypting these files
with a passphrase. Store the private key somewhere secure so that it can be
used in the future to <a href=../generate-certificates/>generate new issuer certificates</a>.</p><h2 id=bundle-your-original-trust-anchor-with-the-new-one class=anchor>Bundle your original trust anchor with the new one
<a href=#bundle-your-original-trust-anchor-with-the-new-one class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Next, we need to bundle the trust anchor currently used by Linkerd together with
the new anchor. We use <code>step</code> to combine the two certificates into one bundle:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>step certificate bundle ca-new.crt original-trust.crt bundle.crt
</span></span></code></pre></div><p>If desired, you can <code>rm original-trust.crt</code> too.</p><h2 id=deploying-the-new-bundle-to-linkerd class=anchor>Deploying the new bundle to Linkerd
<a href=#deploying-the-new-bundle-to-linkerd class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>At this point you can use the <code>linkerd upgrade</code> command to instruct Linkerd to
work with the new trust bundle:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd upgrade --identity-trust-anchors-file<span style=color:#ff7b72;font-weight:700>=</span>./bundle.crt | kubectl apply -f -
</span></span></code></pre></div><p>or you can also use the <code>helm upgrade</code> command:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm upgrade linkerd-control-plane --set-file <span style=color:#79c0ff>identityTrustAnchorsPEM</span><span style=color:#ff7b72;font-weight:700>=</span>./bundle.crt
</span></span></code></pre></div><p>Once this is done, you&rsquo;ll need to restart your meshed workloads so that they use
the new trust anchor. For example, doing that for the <code>emojivoto</code> namespace would
look like:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n emojivoto rollout restart deploy
</span></span></code></pre></div><p>Now you can run the <code>check</code> command to ensure that everything is ok:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd check --proxy
</span></span></code></pre></div><p>You might have to wait a few moments until all the pods have been restarted and
are configured with the correct trust anchor. Meanwhile you might observe warnings:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>linkerd-identity
</span></span><span style=display:flex><span>----------------
</span></span><span style=display:flex><span>âˆš certificate config is valid
</span></span><span style=display:flex><span>âˆš trust roots are using supported crypto algorithm
</span></span><span style=display:flex><span>âˆš trust roots are within their validity period
</span></span><span style=display:flex><span>âˆš trust roots are valid for at least 60 days
</span></span><span style=display:flex><span>âˆš issuer cert is using supported crypto algorithm
</span></span><span style=display:flex><span>âˆš issuer cert is within its validity period
</span></span><span style=display:flex><span>â€¼ issuer cert is valid for at least 60 days
</span></span><span style=display:flex><span>    issuer certificate will expire on 2019-12-19T09:51:19Z
</span></span><span style=display:flex><span>    see https://linkerd.io/checks/#l5d-identity-issuer-cert-not-expiring-soon for hints
</span></span><span style=display:flex><span>âˆš issuer cert is issued by the trust root
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>linkerd-identity-data-plane
</span></span><span style=display:flex><span>---------------------------
</span></span><span style=display:flex><span>â€¼ data plane proxies certificate match CA
</span></span><span style=display:flex><span>    Some pods do not have the current trust bundle and must be restarted:
</span></span><span style=display:flex><span>        * emojivoto/emoji-d8d7d9c6b-8qwfx
</span></span><span style=display:flex><span>        * emojivoto/vote-bot-588499c9f6-zpwz6
</span></span><span style=display:flex><span>        * emojivoto/voting-8599548fdc-6v64k
</span></span><span style=display:flex><span>        * emojivoto/web-67c7599f6d-xx98n
</span></span><span style=display:flex><span>        * linkerd/linkerd-sp-validator-75f9d96dc-rch4x
</span></span><span style=display:flex><span>        * linkerd/linkerd-tap-68d8bbf64-mpzgb
</span></span><span style=display:flex><span>        * linkerd/linkerd-web-849f74b7c6-qlhwc
</span></span><span style=display:flex><span>    see https://linkerd.io/checks/#l5d-identity-data-plane-proxies-certs-match-ca for hints
</span></span></code></pre></div><p>When the rollout completes, your <code>check</code> command should stop warning you that
pods need to be restarted. It may still warn you, however, that your issuer
certificate is about to expire soon:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>linkerd-identity
</span></span><span style=display:flex><span>----------------
</span></span><span style=display:flex><span>âˆš certificate config is valid
</span></span><span style=display:flex><span>âˆš trust roots are using supported crypto algorithm
</span></span><span style=display:flex><span>âˆš trust roots are within their validity period
</span></span><span style=display:flex><span>âˆš trust roots are valid for at least 60 days
</span></span><span style=display:flex><span>âˆš issuer cert is using supported crypto algorithm
</span></span><span style=display:flex><span>âˆš issuer cert is within its validity period
</span></span><span style=display:flex><span>â€¼ issuer cert is valid for at least 60 days
</span></span><span style=display:flex><span>    issuer certificate will expire on 2019-12-19T09:51:19Z
</span></span><span style=display:flex><span>    see https://linkerd.io/checks/#l5d-identity-issuer-cert-not-expiring-soon for hints
</span></span><span style=display:flex><span>âˆš issuer cert is issued by the trust root
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>linkerd-identity-data-plane
</span></span><span style=display:flex><span>---------------------------
</span></span><span style=display:flex><span>âˆš data plane proxies certificate match CA
</span></span></code></pre></div><p>At this point, all meshed workloads are ready to accept connections signed
by either the old or new trust anchor, but they&rsquo;re all still using certificates
signed by the old trust anchor. To change that, we&rsquo;ll need to rotate the
issuer certificate.</p><h2 id=rotating-the-identity-issuer-certificate class=anchor>Rotating the identity issuer certificate
<a href=#rotating-the-identity-issuer-certificate class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>To rotate the issuer certificate and key pair, start by generating the new
identity issuer certificate and key:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>step certificate create identity.linkerd.cluster.local issuer-new.crt issuer-new.key <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>--profile intermediate-ca --not-after 8760h --no-password --insecure <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>--ca ca-new.crt --ca-key ca-new.key
</span></span></code></pre></div><p>This new issuer certificate is signed by our new trust anchor, which is why it
was critical to install the new trust anchor bundle (as outlined in the previous
section). Once the new bundle is installed and running <code>linkerd check</code> shows all
green checks and no warnings, you can safely rotate the identity issuer certificate
and key by using the <code>upgrade</code> command again:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd upgrade <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    --identity-issuer-certificate-file<span style=color:#ff7b72;font-weight:700>=</span>./issuer-new.crt <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    --identity-issuer-key-file<span style=color:#ff7b72;font-weight:700>=</span>./issuer-new.key <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    | kubectl apply -f -
</span></span></code></pre></div><p>or</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm upgrade linkerd-control-plane <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --set-file identity.issuer.tls.crtPEM<span style=color:#ff7b72;font-weight:700>=</span>./issuer-new.crt <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --set-file identity.issuer.tls.keyPEM<span style=color:#ff7b72;font-weight:700>=</span>./issuer-new.key
</span></span></code></pre></div><p>At this point you can check for the <code>IssuerUpdated</code> Kubernetes event to be certain
that Linkerd saw the new issuer certificate:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get events --field-selector <span style=color:#79c0ff>reason</span><span style=color:#ff7b72;font-weight:700>=</span>IssuerUpdated -n linkerd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>LAST SEEN   TYPE     REASON          OBJECT                        MESSAGE
</span></span><span style=display:flex><span>9s          Normal   IssuerUpdated   deployment/linkerd-identity   Updated identity issuer
</span></span></code></pre></div><p>Restart the proxy for all injected workloads in your cluster to ensure that
their proxies pick up certificates issued by the new issuer:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n emojivoto rollout restart deploy
</span></span></code></pre></div><p>Run the <code>check</code> command to make sure that everything is going as expected:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd check --proxy
</span></span></code></pre></div><p>You should see output without any certificate expiration warnings (unless an
expired trust anchor still needs to be removed):</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>linkerd-identity
</span></span><span style=display:flex><span>----------------
</span></span><span style=display:flex><span>âˆš certificate config is valid
</span></span><span style=display:flex><span>âˆš trust roots are using supported crypto algorithm
</span></span><span style=display:flex><span>âˆš trust roots are within their validity period
</span></span><span style=display:flex><span>âˆš trust roots are valid for at least 60 days
</span></span><span style=display:flex><span>âˆš issuer cert is using supported crypto algorithm
</span></span><span style=display:flex><span>âˆš issuer cert is within its validity period
</span></span><span style=display:flex><span>âˆš issuer cert is valid for at least 60 days
</span></span><span style=display:flex><span>âˆš issuer cert is issued by the trust root
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>linkerd-identity-data-plane
</span></span><span style=display:flex><span>---------------------------
</span></span><span style=display:flex><span>âˆš data plane proxies certificate match CA
</span></span></code></pre></div><h2 id=removing-the-old-trust-anchor class=anchor>Removing the old trust anchor
<a href=#removing-the-old-trust-anchor class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Since the old trust anchor is now completely unused, we can now switch
Linkerd from the bundle we created for the trust anchor to using only
the new trust anchor certificate:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd upgrade  --identity-trust-anchors-file<span style=color:#ff7b72;font-weight:700>=</span>./ca-new.crt  | kubectl apply -f -
</span></span></code></pre></div><p>or</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm upgrade linkerd2 --set-file --set-file <span style=color:#79c0ff>identityTrustAnchorsPEM</span><span style=color:#ff7b72;font-weight:700>=</span>./ca-new.crt
</span></span></code></pre></div><p>Note that the ./ca-new.crt file is the same trust anchor you created at the start
of this process.</p><p>Once again, explicitly restart your meshed workloads:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n emojivoto rollout restart deploy
</span></span><span style=display:flex><span>linkerd check --proxy
</span></span></code></pre></div><p>And, again, the output of the <code>check</code> command should not produce any warnings or
errors:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>linkerd-identity
</span></span><span style=display:flex><span>----------------
</span></span><span style=display:flex><span>âˆš certificate config is valid
</span></span><span style=display:flex><span>âˆš trust roots are using supported crypto algorithm
</span></span><span style=display:flex><span>âˆš trust roots are within their validity period
</span></span><span style=display:flex><span>âˆš trust roots are valid for at least 60 days
</span></span><span style=display:flex><span>âˆš issuer cert is using supported crypto algorithm
</span></span><span style=display:flex><span>âˆš issuer cert is within its validity period
</span></span><span style=display:flex><span>âˆš issuer cert is valid for at least 60 days
</span></span><span style=display:flex><span>âˆš issuer cert is issued by the trust root
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>linkerd-identity-data-plane
</span></span><span style=display:flex><span>---------------------------
</span></span><span style=display:flex><span>âˆš data plane proxies certificate match CA
</span></span></code></pre></div><p>Congratulations, you have rotated your trust anchor! ðŸŽ‰</p></div></div></div></div></div></main><footer class=main-footer><div class=main-footer__top><div class="main-footer__container container"><div class=main-footer__info><p><img src=/logos/linkerd.png alt=Linkerd></p><p>Linkerd was originally created by <a href=https://buoyant.io/ target=_blank rel=noopener>Buoyant</a></p><p>View <a href=https://github.com/linkerd/linkerd/wiki/Linkerd-code-of-conduct target=_blank rel=noopener>Code of Conduct</a></p></div><div class=main-footer__links><div class=main-footer__community><h4>Community</h4><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener>GitHub</a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Linkerd Forum</a></li></ul></div><div class=main-footer__follow><h4>Follow</h4><ul><li><a href=https://www.linkedin.com/company/linkerd/ target=_blank rel=noopener>Linkedin</a></li><li><a href=https://www.youtube.com/buoyantio target=_blank rel=noopener>YouTube</a></li><li><a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a></li></ul></div></div></div></div><div class=main-footer__bottom><div class="main-footer__container container"><p><a href=https://github.com/linkerd/website/tree/main/linkerd.io/content target=_blank rel=noopener>Edit This Site</a></p><p>Copyright Â© 2024 Linkerd Authors. All rights reserved.</p></div></div></footer></body></html>