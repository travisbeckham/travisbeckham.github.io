<!doctype html><html lang=en><head><meta charset=utf-8><title>Multi-cluster communication with StatefulSets | Linkerd</title>
<link rel="shortcut icon" href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="cross-cluster communication to and from headless services."><meta property="og:url" content="https://travisbeckham.github.io/2.14/tasks/multicluster-using-statefulsets/"><meta property="og:site_name" content="Linkerd"><meta property="og:title" content="Multi-cluster communication with StatefulSets"><meta property="og:description" content="cross-cluster communication to and from headless services."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="2.14"><meta property="og:image" content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:title content="Multi-cluster communication with StatefulSets"><meta name=twitter:description content="cross-cluster communication to and from headless services."><meta name=twitter:site content="@Linkerd"><link rel=canonical href=https://travisbeckham.github.io/2.14/tasks/multicluster-using-statefulsets/><link rel=stylesheet href=/css/main.css><script src=/js/main.js></script><script async defer src=https://buttons.github.io/buttons.js></script></head><body><header class=main-header><div class=main-header__container><div class=main-header__logo><a href=/><img src=/logos/linkerd.png alt=Linkerd></a></div><input class=main-header__toggle-checkbox type=checkbox id=main-header-toggle>
<label class=main-header__toggle for=main-header-toggle><span class=main-header__toggle-icon><span class=main-header__toggle-icon--open><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3 6H21V8H3V6m0 5H21v2H3V11m0 5H21v2H3V16z"/></svg>
</span><span class=main-header__toggle-icon--close><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span></span></label><div class=main-header__nav><nav class=main-nav><ul class=main-nav__menu><li class=main-nav__menu--selected><a href=/docs>Docs</a></li><li><a href=#>Community<svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6L7.41 8.58z"/></svg></a><ul><li><a href=/community/get-involved/>Get Involved</a></li><li><a href=/community/adopters/>Adopters</a></li><li><a href=/community/ambassadors/>Linkerd Ambassadors</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Buoyant's Linkerd Forum</a></li></ul></li><li><a href=/blog/>Blog</a></li><li><a href=/faq/>FAQ</a></li><li><a href=/enterprise/>Enterprise</a></li></ul><div class=main-nav__search><form action=/search method=get><div class="search-input search-input--sm"><svg class="icon" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5.0 0116 9.5c0 1.61-.59 3.09-1.56 4.23L14.71 14H15.5l5 5L19 20.5l-5-5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5.0 013 9.5 6.5 6.5.0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
<input type=text name=q placeholder=Search></div></form></div><div class=main-nav__github><a class=github-button href=https://github.com/linkerd/linkerd2 data-icon=octicon-star data-size=large data-show-count=true aria-label="Star linkerd/linkerd2 on GitHub">Star</a></div><div class=main-nav__forum><a href=https://linkerd.buoyant.io class="button button--primary button--sm" target=_blank rel=noopener>Join Forum</a></div></nav></div></div></header><div class=main-announcement>Service Mesh 101: Get Service Mesh-Certified
<span class=main-announcement__link><a href=https://buoyant.io/courses/service-mesh-101 target=_blank rel=noopener>Enroll now</a></span></div><main class=main-content><div class="alert alert--warning alert--condensed alert--center docs__deprecated-alert"><div class=alert__content>You are viewing docs for an older version of Linkerd.
<a href=/2.16/>View the latest docs</a>.</div></div><div class=docs><div class=docs__container><div class=docs__sidebar><div class=docs__nav><div class=docs__versions><select onchange="window.location.href=this.value"><option value=/2-edge/>Linkerd edge</option><option value=/2.16/>Linkerd 2.16</option><option value=/2.15/>Linkerd 2.15</option><option value=/2.14/ selected>Linkerd 2.14</option><option value=/2.13/>Linkerd 2.13</option><option value=/2.12/>Linkerd 2.12</option><option value=/2.11/>Linkerd 2.11</option><option value=/2.10/>Linkerd 2.10</option></select></div><nav><ul><li><a href=/2.14/overview/>Overview</a></li><li><a href=/2.14/getting-started/>Getting Started</a></li><li><a href=/2.14/features/>Features
</a><input class=toggle__input type=checkbox id=toggle-ea3747e68e61b73d22c1d6ba39092b05>
<label class=toggle__label for=toggle-ea3747e68e61b73d22c1d6ba39092b05><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.14/features/http-grpc/>HTTP, HTTP/2, and gRPC Proxying</a></li><li><a href=/2.14/features/protocol-detection/>TCP Proxying and Protocol Detection</a></li><li><a href=/2.14/features/retries-and-timeouts/>Retries and Timeouts</a></li><li><a href=/2.14/features/automatic-mtls/>Automatic mTLS</a></li><li><a href=/2.14/features/ingress/>Ingress</a></li><li><a href=/2.14/features/telemetry/>Telemetry and Monitoring</a></li><li><a href=/2.14/features/load-balancing/>Load Balancing</a></li><li><a href=/2.14/features/server-policy/>Authorization Policy</a></li><li><a href=/2.14/features/proxy-injection/>Automatic Proxy Injection</a></li><li><a href=/2.14/features/cni/>CNI Plugin</a></li><li><a href=/2.14/features/dashboard/>Dashboard and on-cluster metrics stack</a></li><li><a href=/2.14/features/distributed-tracing/>Distributed Tracing</a></li><li><a href=/2.14/features/request-routing/>Dynamic Request Routing</a></li><li><a href=/2.14/features/fault-injection/>Fault Injection</a></li><li><a href=/2.14/features/ha/>High Availability</a></li><li><a href=/2.14/features/access-logging/>HTTP Access Logging</a></li><li><a href=/2.14/features/httproute/>HTTPRoutes</a></li><li><a href=/2.14/features/nft/>Iptables-nft Support</a></li><li><a href=/2.14/features/multicluster/>Multi-cluster communication</a></li><li><a href=/2.14/features/service-profiles/>Service Profiles</a></li><li><a href=/2.14/features/traffic-split/>Traffic Split (canaries, blue/green deploys)</a></li></ul></li><li class=docs__nav--selected><a href=/2.14/tasks/>Tasks
</a><input class=toggle__input type=checkbox id=toggle-2a72366790e7eb356e6377b5da0dbc49 checked>
<label class=toggle__label for=toggle-2a72366790e7eb356e6377b5da0dbc49><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.14/tasks/adding-your-service/>Adding your services to Linkerd</a></li><li><a href=/2.14/tasks/automatic-failover/>Automatic Multicluster Failover</a></li><li><a href=/2.14/tasks/automatically-rotating-control-plane-tls-credentials/>Automatically Rotating Control Plane TLS Credentials</a></li><li><a href=/2.14/tasks/automatically-rotating-webhook-tls-credentials/>Automatically Rotating Webhook TLS Credentials</a></li><li><a href=/2.14/tasks/external-prometheus/>Bringing your own Prometheus</a></li><li><a href=/2.14/tasks/circuit-breakers/>Circuit Breakers</a></li><li><a href=/2.14/tasks/configuring-dynamic-request-routing/>Configuring Dynamic Request Routing</a></li><li><a href=/2.14/tasks/configuring-per-route-policy/>Configuring Per-Route Authorization Policy</a></li><li><a href=/2.14/tasks/configuring-proxy-concurrency/>Configuring Proxy Concurrency</a></li><li><a href=/2.14/tasks/configuring-proxy-discovery-cache/>Configuring Proxy Discovery Cache</a></li><li><a href=/2.14/tasks/configuring-retries/>Configuring Retries</a></li><li><a href=/2.14/tasks/configuring-timeouts/>Configuring Timeouts</a></li><li><a href=/2.14/tasks/using-debug-endpoints/>Control Plane Debug Endpoints</a></li><li><a href=/2.14/tasks/customize-install/>Customizing Linkerd's Configuration with Kustomize</a></li><li><a href=/2.14/tasks/debugging-502s/>Debugging 502s</a></li><li><a href=/2.14/tasks/debugging-your-service/>Debugging gRPC applications with request tracing</a></li><li><a href=/2.14/tasks/books/>Debugging HTTP applications with per-route metrics</a></li><li><a href=/2.14/tasks/distributed-tracing/>Distributed tracing with Linkerd</a></li><li><a href=/2.14/tasks/exporting-metrics/>Exporting Metrics</a></li><li><a href=/2.14/tasks/exposing-dashboard/>Exposing the Dashboard</a></li><li><a href=/2.14/tasks/generate-certificates/>Generating your own mTLS root certificates</a></li><li><a href=/2.14/tasks/getting-per-route-metrics/>Getting Per-Route Metrics</a></li><li><a href=/2.14/tasks/linkerd-smi/>Getting started with Linkerd SMI extension</a></li><li><a href=/2.14/tasks/graceful-shutdown/>Graceful Pod Shutdown</a></li><li><a href=/2.14/tasks/grafana/>Grafana</a></li><li><a href=/2.14/tasks/using-ingress/>Handling ingress traffic</a></li><li><a href=/2.14/tasks/fault-injection/>Injecting Faults</a></li><li><a href=/2.14/tasks/install/>Installing Linkerd</a></li><li><a href=/2.14/tasks/install-helm/>Installing Linkerd with Helm</a></li><li><a href=/2.14/tasks/installing-multicluster/>Installing Multi-cluster Components</a></li><li><a href=/2.14/tasks/using-psp/>Linkerd and Pod Security Policies (PSP)</a></li><li><a href=/2.14/tasks/manually-rotating-control-plane-tls-credentials/>Manually Rotating Control Plane TLS Credentials</a></li><li><a href=/2.14/tasks/modifying-proxy-log-level/>Modifying the Proxy Log Level</a></li><li><a href=/2.14/tasks/multicluster/>Multi-cluster communication</a></li><li class=docs__nav--selected><a href=/2.14/tasks/multicluster-using-statefulsets/>Multi-cluster communication with StatefulSets</a></li><li><a href=/2.14/tasks/pod-to-pod-multicluster/>Pod-to-Pod Multi-cluster communication</a></li><li><a href=/2.14/tasks/flagger/>Progressive Delivery</a></li><li><a href=/2.14/tasks/replacing_expired_certificates/>Replacing expired certificates</a></li><li><a href=/2.14/tasks/restricting-access/>Restricting Access To Services</a></li><li><a href=/2.14/tasks/rotating_webhooks_certificates/>Rotating webhooks certificates</a></li><li><a href=/2.14/tasks/securing-linkerd-tap/>Securing Linkerd Tap</a></li><li><a href=/2.14/tasks/setting-up-service-profiles/>Setting Up Service Profiles</a></li><li><a href=/2.14/tasks/traffic-shifting/>Traffic Shifting</a></li><li><a href=/2.14/tasks/troubleshooting/>Troubleshooting</a></li><li><a href=/2.14/tasks/uninstall/>Uninstalling Linkerd</a></li><li><a href=/2.14/tasks/uninstall-multicluster/>Uninstalling Multicluster</a></li><li><a href=/2.14/tasks/upgrade/>Upgrading Linkerd</a></li><li><a href=/2.14/tasks/using-custom-domain/>Using a Custom Cluster Domain</a></li><li><a href=/2.14/tasks/using-a-private-docker-repository/>Using A Private Docker Repository</a></li><li><a href=/2.14/tasks/extensions/>Using extensions</a></li><li><a href=/2.14/tasks/gitops/>Using GitOps with Linkerd with Argo CD</a></li><li><a href=/2.14/tasks/using-the-debug-container/>Using the Debug Sidecar</a></li><li><a href=/2.14/tasks/validating-your-traffic/>Validating your mTLS traffic</a></li></ul></li><li><a href=/2.14/reference/>Reference
</a><input class=toggle__input type=checkbox id=toggle-4b6137c2c4851e7b42ef195bf0fca52a>
<label class=toggle__label for=toggle-4b6137c2c4851e7b42ef195bf0fca52a><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.14/reference/architecture/>Architecture</a></li><li><a href=/2.14/reference/authorization-policy/>Authorization Policy</a></li><li><a href=/2.14/reference/circuit-breaking/>Circuit Breaking</a></li><li><a href=/2.14/reference/cli/>CLI
</a><input class=toggle__input type=checkbox id=toggle-d1b1ff7f2e08491aa304402b092e2b75>
<label class=toggle__label for=toggle-d1b1ff7f2e08491aa304402b092e2b75><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.14/reference/cli/authz/>authz</a></li><li><a href=/2.14/reference/cli/check/>check</a></li><li><a href=/2.14/reference/cli/completion/>completion</a></li><li><a href=/2.14/reference/cli/diagnostics/>diagnostics</a></li><li><a href=/2.14/reference/cli/identity/>identity</a></li><li><a href=/2.14/reference/cli/inject/>inject</a></li><li><a href=/2.14/reference/cli/install/>install</a></li><li><a href=/2.14/reference/cli/install-cni/>install-cni</a></li><li><a href=/2.14/reference/cli/jaeger/>jaeger</a></li><li><a href=/2.14/reference/cli/multicluster/>multicluster</a></li><li><a href=/2.14/reference/cli/profile/>profile</a></li><li><a href=/2.14/reference/cli/prune/>prune</a></li><li><a href=/2.14/reference/cli/uninject/>uninject</a></li><li><a href=/2.14/reference/cli/uninstall/>uninstall</a></li><li><a href=/2.14/reference/cli/upgrade/>upgrade</a></li><li><a href=/2.14/reference/cli/version/>version</a></li><li><a href=/2.14/reference/cli/viz/>viz</a></li></ul></li><li><a href=/2.14/reference/cluster-configuration/>Cluster Configuration</a></li><li><a href=/2.14/reference/extension-list/>Extensions List</a></li><li><a href=/2.14/reference/helm-chart-version-matrix/>Helm Chart Version Matrix</a></li><li><a href=/2.14/reference/httproute/>HTTPRoute</a></li><li><a href=/2.14/reference/iptables/>IPTables Reference</a></li><li><a href=/2.14/reference/multicluster/>Multi-cluster communication</a></li><li><a href=/2.14/reference/proxy-configuration/>Proxy Configuration</a></li><li><a href=/2.14/reference/proxy-log-level/>Proxy Log Level</a></li><li><a href=/2.14/reference/proxy-metrics/>Proxy Metrics</a></li><li><a href=/2.14/reference/service-profiles/>Service Profiles</a></li><li><a href=/2.14/reference/k8s-versions/>Supported Kubernetes Versions</a></li></ul></li></ul><ul><li><a href=/what-is-a-service-mesh/>What is a service mesh?</a></li><li><a href=/faq/>Frequently Asked Questions</a></li><li><a href=/releases/>Releases and Versions</a></li><li><a href=/design-principles/>Design Principles</a></li><li><a href=/going-to-production/>Going to Production</a></li><li><a href=/service-mesh-glossary/>Service Mesh Glossary</a></li></ul></nav><div class=docs__community><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener><img src=/logos/github.svg alt=GitHub class=img></a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener><img src=/logos/slack.svg alt=Slack class=img></a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener><img src=/logos/forum.png alt="Linkerd Forum" class=img></a></li></ul></div></div></div><div class=docs__main><div class=docs__body><div class=docs__header><h1>Multi-cluster communication with StatefulSets</h1></div><div class="docs__content prose"><p>Linkerd&rsquo;s multi-cluster extension works by &ldquo;mirroring&rdquo; service information
between clusters. Exported services in a target cluster will be mirrored as
<code>clusterIP</code> replicas. By default, every exported service will be mirrored as
<code>clusterIP</code>. When running workloads that require a headless service, such as
<a href=https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/ target=_blank rel=noopener>StatefulSets</a>,
Linkerd&rsquo;s multi-cluster extension can be configured with support for headless
services to preserve the service type. Exported services that are headless will
be mirrored in a source cluster as headless, preserving functionality such as
DNS record creation and the ability to address an individual pod.</p><p>This guide will walk you through installing and configuring Linkerd and the
multi-cluster extension with support for headless services and will exemplify
how a StatefulSet can be deployed in a target cluster. After deploying, we will
also look at how to communicate with an arbitrary pod from the target cluster&rsquo;s
StatefulSet from a client in the source cluster. For a more detailed overview
on how multi-cluster support for headless services work, check out
<a href=../../features/multicluster/>multi-cluster communication</a>.</p><h2 id=prerequisites class=anchor>Prerequisites
<a href=#prerequisites class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><ul><li>Two Kubernetes clusters. They will be referred to as <code>east</code> and <code>west</code> with
east being the &ldquo;source&rdquo; cluster and &ldquo;west&rdquo; the target cluster respectively.
These can be in any cloud or local environment, this guide will make use of
<a href=https://github.com/rancher/k3d/releases/tag/v4.1.1 target=_blank rel=noopener>k3d</a> to configure two
local clusters.</li><li><a href=https://github.com/smallstep/cli/releases target=_blank rel=noopener><code>smallstep/CLI</code></a> to generate
certificates for Linkerd installation.</li><li><a href=https://github.com/linkerd/linkerd2/releases target=_blank rel=noopener><code>A recent linkerd release</code></a>
(2.11 or older).</li></ul><p>To help with cluster creation and installation, there is a demo repository
available. Throughout the guide, we will be using the scripts from the
repository, but you can follow along without cloning or using the scripts.</p><h2 id=install-linkerd-multi-cluster-with-headless-support class=anchor>Install Linkerd multi-cluster with headless support
<a href=#install-linkerd-multi-cluster-with-headless-support class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>To start our demo and see everything in practice, we will go through a
multi-cluster scenario where a pod in an <code>east</code> cluster will try to communicate
to an arbitrary pod from a <code>west</code> cluster.</p><p>The first step is to clone the demo
repository on your local machine.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#8b949e;font-style:italic># clone example repository</span>
</span></span><span style=display:flex><span>$ git clone git@github.com:mateiidavid/l2d-k3d-statefulset.git
</span></span><span style=display:flex><span>$ cd l2d-k3d-statefulset
</span></span></code></pre></div><p>The second step consists of creating two <code>k3d</code> clusters named <code>east</code> and
<code>west</code>, where the <code>east</code> cluster is the source and the <code>west</code> cluster is the
target. When creating our clusters, we need a shared trust root. Luckily, the
repository you have just cloned includes a handful of scripts that will greatly
simplify everything.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#8b949e;font-style:italic># create k3d clusters</span>
</span></span><span style=display:flex><span>$ ./create.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># list the clusters</span>
</span></span><span style=display:flex><span>$ k3d cluster list
</span></span><span style=display:flex><span>NAME   SERVERS   AGENTS   LOADBALANCER
</span></span><span style=display:flex><span>east   1/1       0/0      true
</span></span><span style=display:flex><span>west   1/1       0/0      true
</span></span></code></pre></div><p>Once our clusters are created, we will install Linkerd and the multi-cluster
extension. Finally, once both are installed, we need to link the two clusters
together so their services may be mirrored. To enable support for headless
services, we will pass an additional <code>--set "enableHeadlessServices=true</code> flag
to <code>linkerd multicluster link</code>. As before, these steps are automated through
the provided scripts, but feel free to have a look!</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Install Linkerd and multicluster, output to check should be a success</span>
</span></span><span style=display:flex><span>$ ./install.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Next, link the two clusters together</span>
</span></span><span style=display:flex><span>$ ./link.sh
</span></span></code></pre></div><p>Perfect! If you&rsquo;ve made it this far with no errors, then it&rsquo;s a good sign. In
the next chapter, we&rsquo;ll deploy some services and look at how communication
works.</p><h2 id=pod-to-pod-from-east-to-west class=anchor>Pod-to-Pod: from east, to west
<a href=#pod-to-pod-from-east-to-west class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>With our install steps out of the way, we can now focus on our pod-to-pod
communication. First, we will deploy our pods and services:</p><ul><li>We will mesh the default namespaces in <code>east</code> and <code>west</code>.</li><li>In <code>west</code>, we will deploy an nginx StatefulSet with its own headless
service, <code>nginx-svc</code>.</li><li>In <code>east</code>, our script will deploy a <code>curl</code> pod that will then be used to
curl the nginx service.</li></ul><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#8b949e;font-style:italic># deploy services and mesh namespaces</span>
</span></span><span style=display:flex><span>$ ./deploy.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># verify both clusters</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># verify east</span>
</span></span><span style=display:flex><span>$ kubectl --context<span style=color:#ff7b72;font-weight:700>=</span>k3d-east get pods
</span></span><span style=display:flex><span>NAME                    READY   STATUS        RESTARTS   AGE
</span></span><span style=display:flex><span>curl-56dc7d945d-96r6p   2/2     Running       <span style=color:#a5d6ff>0</span>          7s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># verify west has headless service</span>
</span></span><span style=display:flex><span>$ kubectl --context<span style=color:#ff7b72;font-weight:700>=</span>k3d-west get services
</span></span><span style=display:flex><span>NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style=color:#ff7b72;font-weight:700>(</span>S<span style=color:#ff7b72;font-weight:700>)</span>   AGE
</span></span><span style=display:flex><span>kubernetes   ClusterIP   10.43.0.1    &lt;none&gt;        443/TCP   10m
</span></span><span style=display:flex><span>nginx-svc    ClusterIP   None         &lt;none&gt;        80/TCP    8s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># verify west has statefulset</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># this may take a while to come up</span>
</span></span><span style=display:flex><span>$ kubectl --context<span style=color:#ff7b72;font-weight:700>=</span>k3d-west get pods
</span></span><span style=display:flex><span>NAME          READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>nginx-set-0   2/2     Running   <span style=color:#a5d6ff>0</span>          53s
</span></span><span style=display:flex><span>nginx-set-1   2/2     Running   <span style=color:#a5d6ff>0</span>          43s
</span></span><span style=display:flex><span>nginx-set-2   2/2     Running   <span style=color:#a5d6ff>0</span>          36s
</span></span></code></pre></div><p>Before we go further, let&rsquo;s have a look at the endpoints object for the
<code>nginx-svc</code>:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl --context<span style=color:#ff7b72;font-weight:700>=</span>k3d-west get endpoints nginx-svc -o yaml
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>subsets:
</span></span><span style=display:flex><span>- addresses:
</span></span><span style=display:flex><span>  - hostname: nginx-set-0
</span></span><span style=display:flex><span>    ip: 10.42.0.31
</span></span><span style=display:flex><span>    nodeName: k3d-west-server-0
</span></span><span style=display:flex><span>    targetRef:
</span></span><span style=display:flex><span>      kind: Pod
</span></span><span style=display:flex><span>      name: nginx-set-0
</span></span><span style=display:flex><span>      namespace: default
</span></span><span style=display:flex><span>      resourceVersion: <span style=color:#a5d6ff>&#34;114743&#34;</span>
</span></span><span style=display:flex><span>      uid: 7049f1c1-55dc-4b7b-a598-27003409d274
</span></span><span style=display:flex><span>  - hostname: nginx-set-1
</span></span><span style=display:flex><span>    ip: 10.42.0.32
</span></span><span style=display:flex><span>    nodeName: k3d-west-server-0
</span></span><span style=display:flex><span>    targetRef:
</span></span><span style=display:flex><span>      kind: Pod
</span></span><span style=display:flex><span>      name: nginx-set-1
</span></span><span style=display:flex><span>      namespace: default
</span></span><span style=display:flex><span>      resourceVersion: <span style=color:#a5d6ff>&#34;114775&#34;</span>
</span></span><span style=display:flex><span>      uid: 60df15fd-9db0-4830-9c8f-e682f3000800
</span></span><span style=display:flex><span>  - hostname: nginx-set-2
</span></span><span style=display:flex><span>    ip: 10.42.0.33
</span></span><span style=display:flex><span>    nodeName: k3d-west-server-0
</span></span><span style=display:flex><span>    targetRef:
</span></span><span style=display:flex><span>      kind: Pod
</span></span><span style=display:flex><span>      name: nginx-set-2
</span></span><span style=display:flex><span>      namespace: default
</span></span><span style=display:flex><span>      resourceVersion: <span style=color:#a5d6ff>&#34;114808&#34;</span>
</span></span><span style=display:flex><span>      uid: 3873bc34-26c4-454d-bd3d-7c783de16304
</span></span></code></pre></div><p>We can see, based on the endpoints object that the service has three endpoints,
with each endpoint having an address (or IP) whose hostname corresponds to a
StatefulSet pod. If we were to do a curl to any of these endpoints directly, we
would get an answer back. We can test this out by applying the curl pod to the
<code>west</code> cluster:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl --context<span style=color:#ff7b72;font-weight:700>=</span>k3d-west apply -f east/curl.yml
</span></span><span style=display:flex><span>$ kubectl --context<span style=color:#ff7b72;font-weight:700>=</span>k3d-west get pods
</span></span><span style=display:flex><span>NAME                    READY   STATUS            RESTARTS   AGE
</span></span><span style=display:flex><span>nginx-set-0             2/2     Running           <span style=color:#a5d6ff>0</span>          5m8s
</span></span><span style=display:flex><span>nginx-set-1             2/2     Running           <span style=color:#a5d6ff>0</span>          4m58s
</span></span><span style=display:flex><span>nginx-set-2             2/2     Running           <span style=color:#a5d6ff>0</span>          4m51s
</span></span><span style=display:flex><span>curl-56dc7d945d-s4n8j   0/2     PodInitializing   <span style=color:#a5d6ff>0</span>          4s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl --context<span style=color:#ff7b72;font-weight:700>=</span>k3d-west exec -it curl-56dc7d945d-s4n8j -c curl -- bin/sh
</span></span><span style=display:flex><span>/$ <span style=color:#8b949e;font-style:italic># prompt for curl pod</span>
</span></span></code></pre></div><p>If we now curl one of these instances, we will get back a response.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#8b949e;font-style:italic># exec&#39;d on the pod</span>
</span></span><span style=display:flex><span>/ $ curl nginx-set-0.nginx-svc.default.svc.west.cluster.local
</span></span><span style=display:flex><span><span style=color:#a5d6ff>&#34;&lt;!DOCTYPE html&gt;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&lt;html&gt;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&lt;head&gt;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&lt;style&gt;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    body {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        width: 35em;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        margin: 0 auto;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        font-family: Tahoma, Verdana, Arial, sans-serif;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    }
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&lt;/style&gt;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&lt;/head&gt;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&lt;body&gt;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>working. Further configuration is required.&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&lt;p&gt;For online documentation and support please refer to
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&lt;a href=&#34;</span>http://nginx.org/<span style=color:#a5d6ff>&#34;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>Commercial support is available at
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&lt;a href=&#34;</span>http://nginx.com/<span style=color:#a5d6ff>&#34;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&lt;/body&gt;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&lt;/html&gt;&#34;</span>
</span></span></code></pre></div><p>Now, let&rsquo;s do the same, but this time from the <code>east</code> cluster. We will first
export the service.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl --context<span style=color:#ff7b72;font-weight:700>=</span>k3d-west label service nginx-svc mirror.linkerd.io/exported<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;true&#34;</span>
</span></span><span style=display:flex><span>service/nginx-svc labeled
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl --context<span style=color:#ff7b72;font-weight:700>=</span>k3d-east get services
</span></span><span style=display:flex><span>NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#ff7b72;font-weight:700>(</span>S<span style=color:#ff7b72;font-weight:700>)</span>   AGE
</span></span><span style=display:flex><span>kubernetes         ClusterIP   10.43.0.1       &lt;none&gt;        443/TCP   20h
</span></span><span style=display:flex><span>nginx-svc-west     ClusterIP   None            &lt;none&gt;        80/TCP    29s
</span></span><span style=display:flex><span>nginx-set-0-west   ClusterIP   10.43.179.60    &lt;none&gt;        80/TCP    29s
</span></span><span style=display:flex><span>nginx-set-1-west   ClusterIP   10.43.218.18    &lt;none&gt;        80/TCP    29s
</span></span><span style=display:flex><span>nginx-set-2-west   ClusterIP   10.43.245.244   &lt;none&gt;        80/TCP    29s
</span></span></code></pre></div><p>If we take a look at the endpoints object, we will notice something odd, the
endpoints for <code>nginx-svc-west</code> will have the same hostnames, but each hostname
will point to one of the services we see above:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl --context<span style=color:#ff7b72;font-weight:700>=</span>k3d-east get endpoints nginx-svc-west -o yaml
</span></span><span style=display:flex><span>subsets:
</span></span><span style=display:flex><span>- addresses:
</span></span><span style=display:flex><span>  - hostname: nginx-set-0
</span></span><span style=display:flex><span>    ip: 10.43.179.60
</span></span><span style=display:flex><span>  - hostname: nginx-set-1
</span></span><span style=display:flex><span>    ip: 10.43.218.18
</span></span><span style=display:flex><span>  - hostname: nginx-set-2
</span></span><span style=display:flex><span>    ip: 10.43.245.244
</span></span></code></pre></div><p>This is what we outlined at the start of the tutorial. Each pod from the target
cluster (<code>west</code>), will be mirrored as a clusterIP service. We will see in a
second why this matters.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl --context<span style=color:#ff7b72;font-weight:700>=</span>k3d-east get pods
</span></span><span style=display:flex><span>NAME                    READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>curl-56dc7d945d-96r6p   2/2     Running   <span style=color:#a5d6ff>0</span>          23m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># exec and curl</span>
</span></span><span style=display:flex><span>$ kubectl --context<span style=color:#ff7b72;font-weight:700>=</span>k3d-east exec pod curl-56dc7d945d-96r6p -it -c curl -- bin/sh
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># we want to curl the same hostname we see in the endpoints object above.</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># however, the service and cluster domain will now be different, since we</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># are in a different cluster.</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#</span>
</span></span><span style=display:flex><span>/ $ curl nginx-set-0.nginx-svc-west.default.svc.east.cluster.local
</span></span><span style=display:flex><span>&lt;!DOCTYPE html&gt;
</span></span><span style=display:flex><span>&lt;html&gt;
</span></span><span style=display:flex><span>&lt;head&gt;
</span></span><span style=display:flex><span>&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span style=display:flex><span>&lt;style&gt;
</span></span><span style=display:flex><span>    body <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        width: 35em;
</span></span><span style=display:flex><span>        margin: <span style=color:#a5d6ff>0</span> auto;
</span></span><span style=display:flex><span>        font-family: Tahoma, Verdana, Arial, sans-serif;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>&lt;/style&gt;
</span></span><span style=display:flex><span>&lt;/head&gt;
</span></span><span style=display:flex><span>&lt;body&gt;
</span></span><span style=display:flex><span>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span style=display:flex><span>&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span style=display:flex><span>working. Further configuration is required.&lt;/p&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;p&gt;For online documentation and support please refer to
</span></span><span style=display:flex><span>&lt;a <span style=color:#79c0ff>href</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span style=display:flex><span>Commercial support is available at
</span></span><span style=display:flex><span>&lt;a <span style=color:#79c0ff>href</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;p&gt;&lt;em&gt;Thank you <span style=color:#ff7b72>for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span style=display:flex><span>&lt;/body&gt;
</span></span><span style=display:flex><span>&lt;/html&gt;
</span></span></code></pre></div><p>As you can see, we get the same response back! But, nginx is in a different
cluster. So, what happened behind the scenes?</p><ol><li>When we mirrored the headless service, we created a clusterIP service for
each pod. Since services create DNS records, naming each endpoint with the
hostname from the target gave us these pod FQDNs
(<code>nginx-set-0.(...).cluster.local</code>).</li><li>Curl resolved the pod DNS name to an IP address. In our case, this IP
would be <code>10.43.179.60</code>.</li><li>Once the request is in-flight, the linkerd2-proxy intercepts it. It looks
at the IP address and associates it with our <code>clusterIP</code> service. The
service itself points to the gateway, so the proxy forwards the request to
the target cluster gateway. This is the usual multi-cluster scenario.</li><li>The gateway in the target cluster looks at the request and looks-up the
original destination address. In our case, since this is an &ldquo;endpoint
mirror&rdquo;, it knows it has to go to <code>nginx-set-0.nginx-svc</code> in the same
cluster.</li><li>The request is again forwarded by the gateway to the pod, and the response
comes back.</li></ol><p>And that&rsquo;s it! You can now send requests to pods across clusters. Querying any
of the 3 StatefulSet pods should have the same results.</p><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>To mirror a headless service as headless, the service&rsquo;s endpoints
must also have at least one named address (e.g a hostname for an IP),
otherwise, there will be no endpoints to mirror so the service will be mirrored
as <code>clusterIP</code>. A headless service may under normal conditions also be created
without exposing a port; the mulit-cluster service-mirror does not support
this, however, since the lack of ports means we cannot create a service that
passes Kubernetes validation.</div></div><h2 id=cleanup class=anchor>Cleanup
<a href=#cleanup class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>To clean-up, you can remove both clusters entirely using the k3d CLI:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ k3d cluster delete east
</span></span><span style=display:flex><span>cluster east deleted
</span></span><span style=display:flex><span>$ k3d cluster delete west
</span></span><span style=display:flex><span>cluster west deleted
</span></span></code></pre></div></div></div></div></div></div></main><footer class=main-footer><div class=main-footer__top><div class="main-footer__container container"><div class=main-footer__info><p><img src=/logos/linkerd.png alt=Linkerd></p><p>Linkerd was originally created by <a href=https://buoyant.io/ target=_blank rel=noopener>Buoyant</a></p><p>View <a href=https://github.com/linkerd/linkerd/wiki/Linkerd-code-of-conduct target=_blank rel=noopener>Code of Conduct</a></p></div><div class=main-footer__links><div class=main-footer__community><h4>Community</h4><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener>GitHub</a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Linkerd Forum</a></li></ul></div><div class=main-footer__follow><h4>Follow</h4><ul><li><a href=https://www.linkedin.com/company/linkerd/ target=_blank rel=noopener>Linkedin</a></li><li><a href=https://www.youtube.com/buoyantio target=_blank rel=noopener>YouTube</a></li><li><a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a></li></ul></div></div></div></div><div class=main-footer__bottom><div class="main-footer__container container"><p><a href=https://github.com/linkerd/website/tree/main/linkerd.io/content target=_blank rel=noopener>Edit This Site</a></p><p>Copyright © 2024 Linkerd Authors. All rights reserved.</p></div></div></footer></body></html>