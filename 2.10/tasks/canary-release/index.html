<!doctype html><html lang=en><head><meta charset=utf-8><title>Automated Canary Releases | Linkerd</title>
<link rel="shortcut icon" href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Reduce deployment risk by combining Linkerd and Flagger to automate canary releases based on service metrics."><meta property="og:url" content="https://travisbeckham.github.io/2.10/tasks/canary-release/"><meta property="og:site_name" content="Linkerd"><meta property="og:title" content="Automated Canary Releases"><meta property="og:description" content="Reduce deployment risk by combining Linkerd and Flagger to automate canary releases based on service metrics."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="2.10"><meta property="og:image" content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:title content="Automated Canary Releases"><meta name=twitter:description content="Reduce deployment risk by combining Linkerd and Flagger to automate canary releases based on service metrics."><meta name=twitter:site content="@Linkerd"><link rel=canonical href=https://travisbeckham.github.io/2.10/tasks/canary-release/><link rel=stylesheet href=/css/main.css><script src=/js/main.js></script><script async defer src=https://buttons.github.io/buttons.js></script></head><body><header class=main-header><div class=main-header__container><div class=main-header__logo><a href=/><img src=/logos/linkerd.png alt=Linkerd></a></div><input class=main-header__toggle-checkbox type=checkbox id=main-header-toggle>
<label class=main-header__toggle for=main-header-toggle><span class=main-header__toggle-icon><span class=main-header__toggle-icon--open><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3 6H21V8H3V6m0 5H21v2H3V11m0 5H21v2H3V16z"/></svg>
</span><span class=main-header__toggle-icon--close><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span></span></label><div class=main-header__nav><nav class=main-nav><ul class=main-nav__menu><li class=main-nav__menu--selected><a href=/docs>Docs</a></li><li><a href=#>Community<svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6L7.41 8.58z"/></svg></a><ul><li><a href=/community/get-involved/>Get Involved</a></li><li><a href=/community/adopters/>Adopters</a></li><li><a href=/community/ambassadors/>Linkerd Ambassadors</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Buoyant's Linkerd Forum</a></li></ul></li><li><a href=/blog/>Blog</a></li><li><a href=/faq/>FAQ</a></li><li><a href=/enterprise/>Enterprise</a></li></ul><div class=main-nav__search><form action=/search method=get><div class="search-input search-input--sm"><svg class="icon" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5.0 0116 9.5c0 1.61-.59 3.09-1.56 4.23L14.71 14H15.5l5 5L19 20.5l-5-5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5.0 013 9.5 6.5 6.5.0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
<input type=text name=q placeholder=Search></div></form></div><div class=main-nav__github><a class=github-button href=https://github.com/linkerd/linkerd2 data-icon=octicon-star data-size=large data-show-count=true aria-label="Star linkerd/linkerd2 on GitHub">Star</a></div><div class=main-nav__forum><a href=https://linkerd.buoyant.io class="button button--primary button--sm" target=_blank rel=noopener>Join Forum</a></div></nav></div></div></header><div class=main-announcement><strong>Oct 23, 2024</strong> New blog post: Towards a Sustainable Service Mesh.
<a href=/2024/10/23/making-linkerd-sustainable/ class=main-announcement__link>Read the post</a></div><main class=main-content><div class="alert alert--warning alert--condensed alert--center docs__deprecated-alert"><div class=alert__content>You are viewing docs for an older version of Linkerd.
<a href=/2.16/>View the latest docs</a>.</div></div><div class=docs><div class=docs__container><div class=docs__sidebar><div class=docs__nav><div class=docs__versions><select onchange="window.location.href=this.value"><option value=/2-edge/>Linkerd edge</option><option value=/2.16/>Linkerd 2.16</option><option value=/2.15/>Linkerd 2.15</option><option value=/2.14/>Linkerd 2.14</option><option value=/2.13/>Linkerd 2.13</option><option value=/2.12/>Linkerd 2.12</option><option value=/2.11/>Linkerd 2.11</option><option value=/2.10/ selected>Linkerd 2.10</option></select></div><nav><ul><li><a href=/2.10/overview/>Overview</a></li><li><a href=/2.10/getting-started/>Getting Started</a></li><li><a href=/2.10/features/>Features
</a><input class=toggle__input type=checkbox id=toggle-d39228324dd9fb5f997235d1002491eb>
<label class=toggle__label for=toggle-d39228324dd9fb5f997235d1002491eb><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.10/features/http-grpc/>HTTP, HTTP/2, and gRPC Proxying</a></li><li><a href=/2.10/features/protocol-detection/>TCP Proxying and Protocol Detection</a></li><li><a href=/2.10/features/retries-and-timeouts/>Retries and Timeouts</a></li><li><a href=/2.10/features/automatic-mtls/>Automatic mTLS</a></li><li><a href=/2.10/features/ingress/>Ingress</a></li><li><a href=/2.10/features/telemetry/>Telemetry and Monitoring</a></li><li><a href=/2.10/features/load-balancing/>Load Balancing</a></li><li><a href=/2.10/features/proxy-injection/>Automatic Proxy Injection</a></li><li><a href=/2.10/features/cni/>CNI Plugin</a></li><li><a href=/2.10/features/distributed-tracing/>Distributed Tracing</a></li><li><a href=/2.10/features/fault-injection/>Fault Injection</a></li><li><a href=/2.10/features/ha/>High Availability</a></li><li><a href=/2.10/features/multicluster/>Multi-cluster communication</a></li><li><a href=/2.10/features/dashboard/>On-cluster metrics stack</a></li><li><a href=/2.10/features/service-profiles/>Service Profiles</a></li><li><a href=/2.10/features/traffic-split/>Traffic Split (canaries, blue/green deploys)</a></li></ul></li><li class=docs__nav--selected><a href=/2.10/tasks/>Tasks
</a><input class=toggle__input type=checkbox id=toggle-485e75bd7ccdcb944fa3b6668d4628ad checked>
<label class=toggle__label for=toggle-485e75bd7ccdcb944fa3b6668d4628ad><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.10/tasks/adding-your-service/>Adding Your Services to Linkerd</a></li><li class=docs__nav--selected><a href=/2.10/tasks/canary-release/>Automated Canary Releases</a></li><li><a href=/2.10/tasks/automatically-rotating-control-plane-tls-credentials/>Automatically Rotating Control Plane TLS Credentials</a></li><li><a href=/2.10/tasks/automatically-rotating-webhook-tls-credentials/>Automatically Rotating Webhook TLS Credentials</a></li><li><a href=/2.10/tasks/external-prometheus/>Bringing your own Prometheus</a></li><li><a href=/2.10/tasks/configuring-proxy-concurrency/>Configuring Proxy Concurrency</a></li><li><a href=/2.10/tasks/configuring-retries/>Configuring Retries</a></li><li><a href=/2.10/tasks/configuring-timeouts/>Configuring Timeouts</a></li><li><a href=/2.10/tasks/using-debug-endpoints/>Control Plane Debug Endpoints</a></li><li><a href=/2.10/tasks/customize-install/>Customizing Linkerd's Configuration with Kustomize</a></li><li><a href=/2.10/tasks/debugging-502s/>Debugging 502s</a></li><li><a href=/2.10/tasks/debugging-your-service/>Debugging gRPC applications with request tracing</a></li><li><a href=/2.10/tasks/books/>Debugging HTTP applications with per-route metrics</a></li><li><a href=/2.10/tasks/distributed-tracing/>Distributed tracing with Linkerd</a></li><li><a href=/2.10/tasks/exporting-metrics/>Exporting Metrics</a></li><li><a href=/2.10/tasks/exposing-dashboard/>Exposing the Dashboard</a></li><li><a href=/2.10/tasks/generate-certificates/>Generating your own mTLS root certificates</a></li><li><a href=/2.10/tasks/getting-per-route-metrics/>Getting Per-Route Metrics</a></li><li><a href=/2.10/tasks/linkerd-smi/>Getting started with Linkerd SMI extension</a></li><li><a href=/2.10/tasks/graceful-shutdown/>Graceful Pod Shutdown</a></li><li><a href=/2.10/tasks/using-ingress/>Ingress traffic</a></li><li><a href=/2.10/tasks/fault-injection/>Injecting Faults</a></li><li><a href=/2.10/tasks/install/>Installing Linkerd</a></li><li><a href=/2.10/tasks/install-helm/>Installing Linkerd with Helm</a></li><li><a href=/2.10/tasks/installing-multicluster/>Installing Multi-cluster Components</a></li><li><a href=/2.10/tasks/using-psp/>Linkerd and Pod Security Policies (PSP)</a></li><li><a href=/2.10/tasks/manually-rotating-control-plane-tls-credentials/>Manually Rotating Control Plane TLS Credentials</a></li><li><a href=/2.10/tasks/modifying-proxy-log-level/>Modifying the Proxy Log Level</a></li><li><a href=/2.10/tasks/multicluster/>Multi-cluster communication</a></li><li><a href=/2.10/tasks/replacing_expired_certificates/>Replacing expired certificates</a></li><li><a href=/2.10/tasks/rotating_webhooks_certificates/>Rotating webhooks certificates</a></li><li><a href=/2.10/tasks/securing-your-cluster/>Securing Your Cluster</a></li><li><a href=/2.10/tasks/setting-up-service-profiles/>Setting Up Service Profiles</a></li><li><a href=/2.10/tasks/troubleshooting/>Troubleshooting</a></li><li><a href=/2.10/tasks/uninstall/>Uninstalling Linkerd</a></li><li><a href=/2.10/tasks/uninstall-multicluster/>Uninstalling Multicluster</a></li><li><a href=/2.10/tasks/upgrade/>Upgrading Linkerd</a></li><li><a href=/2.10/tasks/upgrade-multicluster/>Upgrading Multicluster in Linkerd 2.9</a></li><li><a href=/2.10/tasks/upgrading-2.10-ports-and-protocols/>Upgrading to Linkerd 2.10: ports and protocols</a></li><li><a href=/2.10/tasks/using-custom-domain/>Using a Custom Cluster Domain</a></li><li><a href=/2.10/tasks/using-a-private-docker-repository/>Using A Private Docker Repository</a></li><li><a href=/2.10/tasks/extensions/>Using extensions</a></li><li><a href=/2.10/tasks/gitops/>Using GitOps with Linkerd with Argo CD</a></li><li><a href=/2.10/tasks/using-the-debug-container/>Using the Debug Sidecar</a></li><li><a href=/2.10/tasks/validating-your-traffic/>Validating your mTLS traffic</a></li></ul></li><li><a href=/2.10/reference/>Reference
</a><input class=toggle__input type=checkbox id=toggle-843224a858ef1864ec3ba5006e3903e2>
<label class=toggle__label for=toggle-843224a858ef1864ec3ba5006e3903e2><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.10/reference/architecture/>Architecture</a></li><li><a href=/2.10/reference/cli/>CLI
</a><input class=toggle__input type=checkbox id=toggle-c5de1d33909841f045835c01e9b54f6f>
<label class=toggle__label for=toggle-c5de1d33909841f045835c01e9b54f6f><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.10/reference/cli/check/>check</a></li><li><a href=/2.10/reference/cli/completion/>completion</a></li><li><a href=/2.10/reference/cli/diagnostics/>diagnostics</a></li><li><a href=/2.10/reference/cli/identity/>identity</a></li><li><a href=/2.10/reference/cli/inject/>inject</a></li><li><a href=/2.10/reference/cli/install/>install</a></li><li><a href=/2.10/reference/cli/install-cni/>install-cni</a></li><li><a href=/2.10/reference/cli/jaeger/>jaeger</a></li><li><a href=/2.10/reference/cli/multicluster/>multicluster</a></li><li><a href=/2.10/reference/cli/profile/>profile</a></li><li><a href=/2.10/reference/cli/repair/>repair</a></li><li><a href=/2.10/reference/cli/uninject/>uninject</a></li><li><a href=/2.10/reference/cli/uninstall/>uninstall</a></li><li><a href=/2.10/reference/cli/upgrade/>upgrade</a></li><li><a href=/2.10/reference/cli/version/>version</a></li><li><a href=/2.10/reference/cli/viz/>viz</a></li></ul></li><li><a href=/2.10/reference/cluster-configuration/>Cluster Configuration</a></li><li><a href=/2.10/reference/extension-list/>Extensions List</a></li><li><a href=/2.10/reference/helm-chart-version-matrix/>Helm Chart Version Matrix</a></li><li><a href=/2.10/reference/proxy-configuration/>Proxy Configuration</a></li><li><a href=/2.10/reference/proxy-log-level/>Proxy Log Level</a></li><li><a href=/2.10/reference/proxy-metrics/>Proxy Metrics</a></li><li><a href=/2.10/reference/service-profiles/>Service Profiles</a></li></ul></li></ul><ul><li><a href=/what-is-a-service-mesh/>What is a service mesh?</a></li><li><a href=/faq/>Frequently Asked Questions</a></li><li><a href=/releases/>Releases and Versions</a></li><li><a href=/design-principles/>Design Principles</a></li><li><a href=/going-to-production/>Going to Production</a></li><li><a href=/service-mesh-glossary/>Service Mesh Glossary</a></li></ul></nav><div class=docs__community><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener><img src=/logos/github.svg alt=GitHub class=img></a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener><img src=/logos/slack.svg alt=Slack class=img></a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener><img src=/logos/forum.png alt="Linkerd Forum" class=img></a></li></ul></div></div></div><div class=docs__main><div class=docs__body><div class=docs__header><h1>Automated Canary Releases</h1></div><div class="docs__content prose"><p>Linkerd&rsquo;s <a href=../../features/traffic-split/>traffic split</a> feature allows you to
dynamically shift traffic between services. This can be used to implement
lower-risk deployment strategies like blue-green deploys and canaries.</p><p>But simply shifting traffic from one version of a service to the next is just
the beginning. We can combine traffic splitting with <a href=../../features/telemetry/>Linkerd&rsquo;s automatic
<em>golden metrics</em> telemetry</a> and drive traffic decisions
based on the observed metrics. For example, we can gradually shift traffic from
an old deployment to a new one while continually monitoring its success rate. If
at any point the success rate drops, we can shift traffic back to the original
deployment and back out of the release. Ideally, our users remain happy
throughout, not noticing a thing!</p><p>In this tutorial, we&rsquo;ll walk you through how to combine Linkerd with
<a href=https://flagger.app/ target=_blank rel=noopener>Flagger</a>, a progressive delivery tool that ties
Linkerd&rsquo;s metrics and traffic splitting together in a control loop,
allowing for fully-automated, metrics-aware canary deployments.</p><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Linkerd Production Tip</h4></div><div class=alert__content>This page contains best-effort instructions by the open source community. Production users with mission-critical applications should familiarize themselves with <a href=/going-to-production/>Linkerd production resources</a> and/or connect with a commercial <a href=/support-training/>Linkerd provider</a>.</div></div><h2 id=prerequisites class=anchor>Prerequisites
<a href=#prerequisites class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><ul><li>To use this guide, you&rsquo;ll need to have Linkerd installed on your cluster,
along with its Viz extension.
Follow the <a href=../install/>Installing Linkerd Guide</a> if you haven&rsquo;t
already done this.</li><li>The installation of Flagger depends on <code>kubectl</code> 1.14 or newer.</li></ul><h2 id=install-flagger class=anchor>Install Flagger
<a href=#install-flagger class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>While Linkerd will be managing the actual traffic routing, Flagger automates
the process of creating new Kubernetes resources, watching metrics and
incrementally sending users over to the new version. To add Flagger to your
cluster and have it configured to work with Linkerd, run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -k github.com/fluxcd/flagger/kustomize/linkerd
</span></span></code></pre></div><p>This command adds:</p><ul><li>The canary
<a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/ target=_blank rel=noopener>CRD</a>
that enables configuring how a rollout should occur.</li><li>RBAC which grants Flagger permissions to modify all the resources that it
needs to, such as deployments and services.</li><li>A controller configured to interact with the Linkerd control plane.</li></ul><p>To watch until everything is up and running, you can use <code>kubectl</code>:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n linkerd rollout status deploy/flagger
</span></span></code></pre></div><h2 id=set-up-the-demo class=anchor>Set up the demo
<a href=#set-up-the-demo class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>This demo consists of three components: a load generator, a deployment and a
frontend. The deployment creates a pod that returns some information such as
name. You can use the responses to watch the incremental rollout as Flagger
orchestrates it. A load generator simply makes it easier to execute the rollout
as there needs to be some kind of active traffic to complete the operation.
Together, these components have a topology that looks like:</p><figure><img alt=Topology class="img img--max-fill img--center img--rounded" src=/docs/images/canary/simple-topology.svg><figcaption>Topology</figcaption></figure><p>To add these components to your cluster and include them in the Linkerd
<a href=../../reference/architecture/#data-plane>data plane</a>, run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create ns test <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  kubectl apply -f https://run.linkerd.io/flagger.yml
</span></span></code></pre></div><p>Verify that everything has started up successfully by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n test rollout status deploy podinfo
</span></span></code></pre></div><p>Check it out by forwarding the frontend service locally and opening
<a href=http://localhost:8080 target=_blank rel=noopener>http://localhost:8080</a> locally by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n test port-forward svc/frontend <span style=color:#a5d6ff>8080</span>
</span></span></code></pre></div><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>Traffic shifting occurs on the <em>client</em> side of the connection and not the
server side. Any requests coming from outside the mesh will not be shifted and
will always be directed to the primary backend. A service of type <code>LoadBalancer</code>
will exhibit this behavior as the source is not part of the mesh. To shift
external traffic, add your ingress controller to the mesh.</div></div><h2 id=configure-the-release class=anchor>Configure the release
<a href=#configure-the-release class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Before changing anything, you need to configure how a release should be rolled
out on the cluster. The configuration is contained in a
<a href=https://docs.flagger.app/tutorials/linkerd-progressive-delivery target=_blank rel=noopener>Canary</a>
definition. To apply to your cluster, run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#a5d6ff>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: flagger.app/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: Canary
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: podinfo
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: test
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    name: podinfo
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  service:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    port: 9898
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  analysis:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    interval: 10s
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    threshold: 5
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    stepWeight: 10
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    maxWeight: 100
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    metrics:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    - name: request-success-rate
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      thresholdRange:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        min: 99
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      interval: 1m
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    - name: request-duration
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      thresholdRange:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        max: 500
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      interval: 1m
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span></code></pre></div><p>The Flagger controller is watching these definitions and will create some new
resources on your cluster. To watch as this happens, run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n test get ev --watch
</span></span></code></pre></div><p>A new deployment named <code>podinfo-primary</code> will be created with the same number of
replicas that <code>podinfo</code> has. Once the new pods are ready, the original
deployment is scaled down to zero. This provides a deployment that is managed by
Flagger as an implementation detail and maintains your original configuration
files and workflows. Once you see the following line, everything is setup:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>0s          Normal    Synced                   canary/podinfo                          Initialization <span style=color:#ff7b72>done</span>! podinfo.test
</span></span></code></pre></div><p>In addition to a managed deployment, there are also services created to
orchestrate routing traffic between the new and old versions of your
application. These can be viewed with <code>kubectl -n test get svc</code> and should look
like:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span style=color:#ff7b72;font-weight:700>(</span>S<span style=color:#ff7b72;font-weight:700>)</span>    AGE
</span></span><span style=display:flex><span>frontend             ClusterIP   10.7.251.33   &lt;none&gt;        8080/TCP   96m
</span></span><span style=display:flex><span>podinfo              ClusterIP   10.7.252.86   &lt;none&gt;        9898/TCP   96m
</span></span><span style=display:flex><span>podinfo-canary       ClusterIP   10.7.245.17   &lt;none&gt;        9898/TCP   23m
</span></span><span style=display:flex><span>podinfo-primary      ClusterIP   10.7.249.63   &lt;none&gt;        9898/TCP   23m
</span></span></code></pre></div><p>At this point, the topology looks a little like:</p><figure><img alt=Initialized class="img img--max-fill img--center img--rounded" src=/docs/images/canary/initialized.svg><figcaption>Initialized</figcaption></figure><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>This guide barely touches all the functionality provided by Flagger. Make sure
to read the <a href=https://docs.flagger.app/ target=_blank rel=noopener>documentation</a> if you&rsquo;re interested in
combining canary releases with HPA, working off custom metrics or doing other
types of releases such as A/B testing.</div></div><h2 id=start-the-rollout class=anchor>Start the rollout
<a href=#start-the-rollout class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>As a system, Kubernetes resources have two major sections: the spec and status.
When a controller sees a spec, it tries as hard as it can to make the status of
the current system match the spec. With a deployment, if any of the pod spec
configuration is changed, a controller will kick off a rollout. By default, the
deployment controller will orchestrate a <a href=https://kubernetes.io/docs/tutorials/kubernetes-basics/update/update-intro/ target=_blank rel=noopener>rolling
update</a>.</p><p>In this example, Flagger will notice that a deployment&rsquo;s spec changed and start
orchestrating the canary rollout. To kick this process off, you can update the
image to a new version by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n test set image deployment/podinfo <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  <span style=color:#79c0ff>podinfod</span><span style=color:#ff7b72;font-weight:700>=</span>quay.io/stefanprodan/podinfo:1.7.1
</span></span></code></pre></div><p>Any kind of modification to the pod&rsquo;s spec such as updating an environment
variable or annotation would result in the same behavior as updating the image.</p><p>On update, the canary deployment (<code>podinfo</code>) will be scaled up. Once ready,
Flagger will begin to update the <a href=../../features/traffic-split/>TrafficSplit CRD</a>
incrementally. With a configured stepWeight of 10, each increment will increase
the weight of <code>podinfo</code> by 10. For each period, the success rate will be
observed and as long as it is over the threshold of 99%, Flagger will continue
the rollout. To watch this entire process, run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n test get ev --watch
</span></span></code></pre></div><p>While an update is occurring, the resources and traffic will look like this at a
high level:</p><figure><img alt=Ongoing class="img img--max-fill img--center img--rounded" src=/docs/images/canary/ongoing.svg><figcaption>Ongoing</figcaption></figure><p>After the update is complete, this picture will go back to looking just like the
figure from the previous section.</p><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>You can toggle the image tag between <code>1.7.1</code> and <code>1.7.0</code> to start the rollout
again.</div></div><h3 id=resource class=anchor>Resource
<a href=#resource class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>The canary resource updates with the current status and progress. You can watch
by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>watch kubectl -n test get canary
</span></span></code></pre></div><p>Behind the scenes, Flagger is splitting traffic between the primary and canary
backends by updating the traffic split resource. To watch how this configuration
changes over the rollout, run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n test get trafficsplit podinfo -o yaml
</span></span></code></pre></div><p>Each increment will increase the weight of <code>podinfo-canary</code> and decrease the
weight of <code>podinfo-primary</code>. Once the rollout is successful, the weight of
<code>podinfo-primary</code> will be set back to 100 and the underlying canary deployment
(<code>podinfo</code>) will be scaled down.</p><h3 id=metrics class=anchor>Metrics
<a href=#metrics class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>As traffic shifts from the primary deployment to the canary one, Linkerd
provides visibility into what is happening to the destination of requests. The
metrics show the backends receiving traffic in real time and measure the success
rate, latencies and throughput. From the CLI, you can watch this by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>watch linkerd viz -n test stat deploy --from deploy/load
</span></span></code></pre></div><p>For something a little more visual, you can use the dashboard. Start it by
running <code>linkerd viz dashboard</code> and then look at the detail page for the
<a href=http://localhost:50750/namespaces/test/trafficsplits/podinfo target=_blank rel=noopener>podinfo traffic
split</a>.</p><figure><img alt=Dashboard class="img img--max-fill img--center img--rounded" src=/docs/images/canary/traffic-split.png><figcaption>Dashboard</figcaption></figure><h3 id=browser class=anchor>Browser
<a href=#browser class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>Visit again <a href=http://localhost:8080 target=_blank rel=noopener>http://localhost:8080</a>. Refreshing the page
will show toggling between the new version and a different header color.
Alternatively, running <code>curl http://localhost:8080</code> will return a JSON response
that looks something like:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;hostname&#34;</span>: <span style=color:#a5d6ff>&#34;podinfo-primary-74459c7db8-lbtxf&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;version&#34;</span>: <span style=color:#a5d6ff>&#34;1.7.0&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;revision&#34;</span>: <span style=color:#a5d6ff>&#34;4fc593f42c7cd2e7319c83f6bfd3743c05523883&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;color&#34;</span>: <span style=color:#a5d6ff>&#34;blue&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;message&#34;</span>: <span style=color:#a5d6ff>&#34;greetings from podinfo v1.7.0&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;goos&#34;</span>: <span style=color:#a5d6ff>&#34;linux&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;goarch&#34;</span>: <span style=color:#a5d6ff>&#34;amd64&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;runtime&#34;</span>: <span style=color:#a5d6ff>&#34;go1.11.2&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;num_goroutine&#34;</span>: <span style=color:#a5d6ff>&#34;6&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;num_cpu&#34;</span>: <span style=color:#a5d6ff>&#34;8&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>This response will slowly change as the rollout continues.</p><h2 id=cleanup class=anchor>Cleanup
<a href=#cleanup class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>To cleanup, remove the Flagger controller from your cluster and delete the
<code>test</code> namespace by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete -k github.com/fluxcd/flagger/kustomize/linkerd <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  kubectl delete ns test
</span></span></code></pre></div></div></div></div></div></div></main><footer class=main-footer><div class=main-footer__top><div class="main-footer__container container"><div class=main-footer__info><p><img src=/logos/linkerd.png alt=Linkerd></p><p>Linkerd was originally created by <a href=https://buoyant.io/ target=_blank rel=noopener>Buoyant</a></p><p>View <a href=https://github.com/linkerd/linkerd/wiki/Linkerd-code-of-conduct target=_blank rel=noopener>Code of Conduct</a></p></div><div class=main-footer__links><div class=main-footer__community><h4>Community</h4><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener>GitHub</a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Linkerd Forum</a></li></ul></div><div class=main-footer__follow><h4>Follow</h4><ul><li><a href=https://www.linkedin.com/company/linkerd/ target=_blank rel=noopener>Linkedin</a></li><li><a href=https://www.youtube.com/buoyantio target=_blank rel=noopener>YouTube</a></li><li><a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a></li></ul></div></div></div></div><div class=main-footer__bottom><div class="main-footer__container container"><p><a href=https://github.com/linkerd/website/tree/main/linkerd.io/content target=_blank rel=noopener>Edit This Site</a></p><p>Copyright © 2024 Linkerd Authors. All rights reserved.</p></div></div></footer></body></html>