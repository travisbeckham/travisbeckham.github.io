<!doctype html><html lang=en><head><meta charset=utf-8><title>Graceful Pod Shutdown | Linkerd</title>
<link rel="shortcut icon" href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Gracefully handle pod shutdown signal."><meta property="og:url" content="https://travisbeckham.github.io/2.10/tasks/graceful-shutdown/"><meta property="og:site_name" content="Linkerd"><meta property="og:title" content="Graceful Pod Shutdown"><meta property="og:description" content="Gracefully handle pod shutdown signal."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="2.10"><meta property="og:image" content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:title content="Graceful Pod Shutdown"><meta name=twitter:description content="Gracefully handle pod shutdown signal."><meta name=twitter:site content="@Linkerd"><link rel=canonical href=https://travisbeckham.github.io/2.10/tasks/graceful-shutdown/><link rel=stylesheet href=/css/main.css><script src=/js/main.js></script><script async defer src=https://buttons.github.io/buttons.js></script></head><body><header class=main-header><div class=main-header__container><div class=main-header__logo><a href=/><img src=/logos/linkerd.png alt=Linkerd></a></div><input class=main-header__toggle-checkbox type=checkbox id=main-header-toggle>
<label class=main-header__toggle for=main-header-toggle><span class=main-header__toggle-icon><span class=main-header__toggle-icon--open><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3 6H21V8H3V6m0 5H21v2H3V11m0 5H21v2H3V16z"/></svg>
</span><span class=main-header__toggle-icon--close><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span></span></label><div class=main-header__nav><nav class=main-nav><ul class=main-nav__menu><li class=main-nav__menu--selected><a href=/docs>Docs</a></li><li><a href=#>Community<svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6L7.41 8.58z"/></svg></a><ul><li><a href=/community/get-involved/>Get Involved</a></li><li><a href=/community/adopters/>Adopters</a></li><li><a href=/community/ambassadors/>Linkerd Ambassadors</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Buoyant's Linkerd Forum</a></li></ul></li><li><a href=/blog/>Blog</a></li><li><a href=/faq/>FAQ</a></li><li><a href=/enterprise/>Enterprise</a></li></ul><div class=main-nav__search><form action=/search method=get><div class="search-input search-input--sm"><svg class="icon" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5.0 0116 9.5c0 1.61-.59 3.09-1.56 4.23L14.71 14H15.5l5 5L19 20.5l-5-5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5.0 013 9.5 6.5 6.5.0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
<input type=text name=q placeholder=Search></div></form></div><div class=main-nav__github><a class=github-button href=https://github.com/linkerd/linkerd2 data-icon=octicon-star data-size=large data-show-count=true aria-label="Star linkerd/linkerd2 on GitHub">Star</a></div><div class=main-nav__forum><a href=https://linkerd.buoyant.io class="button button--primary button--sm" target=_blank rel=noopener>Join Forum</a></div></nav></div></div></header><div class=main-announcement><strong>Oct 23, 2024</strong> New blog post: Towards a Sustainable Service Mesh.
<a href=/2024/10/23/making-linkerd-sustainable/ class=main-announcement__link>Read the post</a></div><main class=main-content><div class="alert alert--warning alert--condensed alert--center docs__deprecated-alert"><div class=alert__content>You are viewing docs for an older version of Linkerd.
<a href=/2.16/>View the latest docs</a>.</div></div><div class=docs><div class=docs__container><div class=docs__sidebar><div class=docs__nav><div class=docs__versions><select onchange="window.location.href=this.value"><option value=/2-edge/>Linkerd edge</option><option value=/2.16/>Linkerd 2.16</option><option value=/2.15/>Linkerd 2.15</option><option value=/2.14/>Linkerd 2.14</option><option value=/2.13/>Linkerd 2.13</option><option value=/2.12/>Linkerd 2.12</option><option value=/2.11/>Linkerd 2.11</option><option value=/2.10/ selected>Linkerd 2.10</option></select></div><nav><ul><li><a href=/2.10/overview/>Overview</a></li><li><a href=/2.10/getting-started/>Getting Started</a></li><li><a href=/2.10/features/>Features
</a><input class=toggle__input type=checkbox id=toggle-d39228324dd9fb5f997235d1002491eb>
<label class=toggle__label for=toggle-d39228324dd9fb5f997235d1002491eb><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.10/features/http-grpc/>HTTP, HTTP/2, and gRPC Proxying</a></li><li><a href=/2.10/features/protocol-detection/>TCP Proxying and Protocol Detection</a></li><li><a href=/2.10/features/retries-and-timeouts/>Retries and Timeouts</a></li><li><a href=/2.10/features/automatic-mtls/>Automatic mTLS</a></li><li><a href=/2.10/features/ingress/>Ingress</a></li><li><a href=/2.10/features/telemetry/>Telemetry and Monitoring</a></li><li><a href=/2.10/features/load-balancing/>Load Balancing</a></li><li><a href=/2.10/features/proxy-injection/>Automatic Proxy Injection</a></li><li><a href=/2.10/features/cni/>CNI Plugin</a></li><li><a href=/2.10/features/distributed-tracing/>Distributed Tracing</a></li><li><a href=/2.10/features/fault-injection/>Fault Injection</a></li><li><a href=/2.10/features/ha/>High Availability</a></li><li><a href=/2.10/features/multicluster/>Multi-cluster communication</a></li><li><a href=/2.10/features/dashboard/>On-cluster metrics stack</a></li><li><a href=/2.10/features/service-profiles/>Service Profiles</a></li><li><a href=/2.10/features/traffic-split/>Traffic Split (canaries, blue/green deploys)</a></li></ul></li><li class=docs__nav--selected><a href=/2.10/tasks/>Tasks
</a><input class=toggle__input type=checkbox id=toggle-485e75bd7ccdcb944fa3b6668d4628ad checked>
<label class=toggle__label for=toggle-485e75bd7ccdcb944fa3b6668d4628ad><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.10/tasks/adding-your-service/>Adding Your Services to Linkerd</a></li><li><a href=/2.10/tasks/canary-release/>Automated Canary Releases</a></li><li><a href=/2.10/tasks/automatically-rotating-control-plane-tls-credentials/>Automatically Rotating Control Plane TLS Credentials</a></li><li><a href=/2.10/tasks/automatically-rotating-webhook-tls-credentials/>Automatically Rotating Webhook TLS Credentials</a></li><li><a href=/2.10/tasks/external-prometheus/>Bringing your own Prometheus</a></li><li><a href=/2.10/tasks/configuring-proxy-concurrency/>Configuring Proxy Concurrency</a></li><li><a href=/2.10/tasks/configuring-retries/>Configuring Retries</a></li><li><a href=/2.10/tasks/configuring-timeouts/>Configuring Timeouts</a></li><li><a href=/2.10/tasks/using-debug-endpoints/>Control Plane Debug Endpoints</a></li><li><a href=/2.10/tasks/customize-install/>Customizing Linkerd's Configuration with Kustomize</a></li><li><a href=/2.10/tasks/debugging-502s/>Debugging 502s</a></li><li><a href=/2.10/tasks/debugging-your-service/>Debugging gRPC applications with request tracing</a></li><li><a href=/2.10/tasks/books/>Debugging HTTP applications with per-route metrics</a></li><li><a href=/2.10/tasks/distributed-tracing/>Distributed tracing with Linkerd</a></li><li><a href=/2.10/tasks/exporting-metrics/>Exporting Metrics</a></li><li><a href=/2.10/tasks/exposing-dashboard/>Exposing the Dashboard</a></li><li><a href=/2.10/tasks/generate-certificates/>Generating your own mTLS root certificates</a></li><li><a href=/2.10/tasks/getting-per-route-metrics/>Getting Per-Route Metrics</a></li><li><a href=/2.10/tasks/linkerd-smi/>Getting started with Linkerd SMI extension</a></li><li class=docs__nav--selected><a href=/2.10/tasks/graceful-shutdown/>Graceful Pod Shutdown</a></li><li><a href=/2.10/tasks/using-ingress/>Ingress traffic</a></li><li><a href=/2.10/tasks/fault-injection/>Injecting Faults</a></li><li><a href=/2.10/tasks/install/>Installing Linkerd</a></li><li><a href=/2.10/tasks/install-helm/>Installing Linkerd with Helm</a></li><li><a href=/2.10/tasks/installing-multicluster/>Installing Multi-cluster Components</a></li><li><a href=/2.10/tasks/using-psp/>Linkerd and Pod Security Policies (PSP)</a></li><li><a href=/2.10/tasks/manually-rotating-control-plane-tls-credentials/>Manually Rotating Control Plane TLS Credentials</a></li><li><a href=/2.10/tasks/modifying-proxy-log-level/>Modifying the Proxy Log Level</a></li><li><a href=/2.10/tasks/multicluster/>Multi-cluster communication</a></li><li><a href=/2.10/tasks/replacing_expired_certificates/>Replacing expired certificates</a></li><li><a href=/2.10/tasks/rotating_webhooks_certificates/>Rotating webhooks certificates</a></li><li><a href=/2.10/tasks/securing-your-cluster/>Securing Your Cluster</a></li><li><a href=/2.10/tasks/setting-up-service-profiles/>Setting Up Service Profiles</a></li><li><a href=/2.10/tasks/troubleshooting/>Troubleshooting</a></li><li><a href=/2.10/tasks/uninstall/>Uninstalling Linkerd</a></li><li><a href=/2.10/tasks/uninstall-multicluster/>Uninstalling Multicluster</a></li><li><a href=/2.10/tasks/upgrade/>Upgrading Linkerd</a></li><li><a href=/2.10/tasks/upgrade-multicluster/>Upgrading Multicluster in Linkerd 2.9</a></li><li><a href=/2.10/tasks/upgrading-2.10-ports-and-protocols/>Upgrading to Linkerd 2.10: ports and protocols</a></li><li><a href=/2.10/tasks/using-custom-domain/>Using a Custom Cluster Domain</a></li><li><a href=/2.10/tasks/using-a-private-docker-repository/>Using A Private Docker Repository</a></li><li><a href=/2.10/tasks/extensions/>Using extensions</a></li><li><a href=/2.10/tasks/gitops/>Using GitOps with Linkerd with Argo CD</a></li><li><a href=/2.10/tasks/using-the-debug-container/>Using the Debug Sidecar</a></li><li><a href=/2.10/tasks/validating-your-traffic/>Validating your mTLS traffic</a></li></ul></li><li><a href=/2.10/reference/>Reference
</a><input class=toggle__input type=checkbox id=toggle-843224a858ef1864ec3ba5006e3903e2>
<label class=toggle__label for=toggle-843224a858ef1864ec3ba5006e3903e2><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.10/reference/architecture/>Architecture</a></li><li><a href=/2.10/reference/cli/>CLI
</a><input class=toggle__input type=checkbox id=toggle-c5de1d33909841f045835c01e9b54f6f>
<label class=toggle__label for=toggle-c5de1d33909841f045835c01e9b54f6f><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.10/reference/cli/check/>check</a></li><li><a href=/2.10/reference/cli/completion/>completion</a></li><li><a href=/2.10/reference/cli/diagnostics/>diagnostics</a></li><li><a href=/2.10/reference/cli/identity/>identity</a></li><li><a href=/2.10/reference/cli/inject/>inject</a></li><li><a href=/2.10/reference/cli/install/>install</a></li><li><a href=/2.10/reference/cli/install-cni/>install-cni</a></li><li><a href=/2.10/reference/cli/jaeger/>jaeger</a></li><li><a href=/2.10/reference/cli/multicluster/>multicluster</a></li><li><a href=/2.10/reference/cli/profile/>profile</a></li><li><a href=/2.10/reference/cli/repair/>repair</a></li><li><a href=/2.10/reference/cli/uninject/>uninject</a></li><li><a href=/2.10/reference/cli/uninstall/>uninstall</a></li><li><a href=/2.10/reference/cli/upgrade/>upgrade</a></li><li><a href=/2.10/reference/cli/version/>version</a></li><li><a href=/2.10/reference/cli/viz/>viz</a></li></ul></li><li><a href=/2.10/reference/cluster-configuration/>Cluster Configuration</a></li><li><a href=/2.10/reference/extension-list/>Extensions List</a></li><li><a href=/2.10/reference/helm-chart-version-matrix/>Helm Chart Version Matrix</a></li><li><a href=/2.10/reference/proxy-configuration/>Proxy Configuration</a></li><li><a href=/2.10/reference/proxy-log-level/>Proxy Log Level</a></li><li><a href=/2.10/reference/proxy-metrics/>Proxy Metrics</a></li><li><a href=/2.10/reference/service-profiles/>Service Profiles</a></li></ul></li></ul><ul><li><a href=/what-is-a-service-mesh/>What is a service mesh?</a></li><li><a href=/faq/>Frequently Asked Questions</a></li><li><a href=/releases/>Releases and Versions</a></li><li><a href=/design-principles/>Design Principles</a></li><li><a href=/going-to-production/>Going to Production</a></li><li><a href=/service-mesh-glossary/>Service Mesh Glossary</a></li></ul></nav><div class=docs__community><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener><img src=/logos/github.svg alt=GitHub class=img></a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener><img src=/logos/slack.svg alt=Slack class=img></a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener><img src=/logos/forum.png alt="Linkerd Forum" class=img></a></li></ul></div></div></div><div class=docs__main><div class=docs__body><div class=docs__header><h1>Graceful Pod Shutdown</h1></div><div class="docs__content prose"><p>When Kubernetes begins to terminate a pod, it starts by sending all containers
in that pod a TERM signal. When the Linkerd proxy sidecar receives this signal,
it will immediately begin a graceful shutdown where it refuses all new requests
and allows existing requests to complete before shutting down.</p><p>This means that if the pod&rsquo;s main container attempts to make any new network
calls after the proxy has received the TERM signal, those network calls will
fail. This also has implications for clients of the terminating pod and for
job resources.</p><h2 id=slow-updating-clients class=anchor>Slow Updating Clients
<a href=#slow-updating-clients class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Before Kubernetes terminates a pod, it first removes that pod from the endpoints
resource of any services that pod is a member of. This means that clients of
that service should stop sending traffic to the pod before it is terminated.
However, certain clients can be slow to receive the endpoints update and may
attempt to send requests to the terminating pod after that pod&rsquo;s proxy has
already received the TERM signal and begun graceful shutdown. Those requests
will fail.</p><p>To mitigate this, use the <code>--wait-before-exit-seconds</code> flag with
<code>linkerd inject</code> to delay the Linkerd proxy&rsquo;s handling of the TERM signal for
a given number of seconds using a <code>preStop</code> hook. This delay gives slow clients
additional time to receive the endpoints update before beginning graceful
shutdown. To achieve max benefit from the option, the main container should have
its own <code>preStop</code> hook with the sleep command inside which has a smaller period
than is set for the proxy sidecar. And none of them must be bigger than
<code>terminationGracePeriodSeconds</code> configured for the entire pod.</p><p>For example,</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#6e7681>       </span><span style=color:#8b949e;font-style:italic># application container</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>lifecycle</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>preStop</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>exec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>command</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#a5d6ff>/bin/bash</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- -<span style=color:#a5d6ff>c</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>- <span style=color:#a5d6ff>sleep 20</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#8b949e;font-style:italic># for entire pod</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>terminationGracePeriodSeconds</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>160</span><span style=color:#6e7681>
</span></span></span></code></pre></div><h2 id=graceful-shutdown-of-job-and-cronjob-resources class=anchor>Graceful shutdown of Job and Cronjob Resources
<a href=#graceful-shutdown-of-job-and-cronjob-resources class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Pods which are part of Job or Cronjob resources will run until all of the
containers in the pod complete. However, the Linkerd proxy container runs
continuously until it receives a TERM signal. Since Kubernetes does not give the
proxy a means to know when the Cronjob has completed, by default, Job and
Cronjob pods which have been meshed will continue to run even once the main
container has completed.</p><p>To address this, you can issue a POST to the <code>/shutdown</code> endpoint on the proxy
once the application completes (e.g. via <code>curl -X POST http://localhost:4191/shutdown</code>). This will terminate the proxy gracefully and
allow the Job or Cronjob to complete. These shutdown requests must come on the
loopback interface, i.e. from within the same Kubernetes pod.</p><p>One convenient way to call this endpoint is to wrap your application with the
<a href=https://github.com/linkerd/linkerd-await target=_blank rel=noopener>linkerd-await</a> utility. An
application that is called this way (e.g. via <code>linkerd-await -S $MYAPP</code>) will
automatically call the proxy&rsquo;s <code>/shutdown</code> endpoint when it completes.</p><p>In the future, Kubernetes will hopefully support more container lifecycle hooks
that will allow Linkerd to handle these situations automatically.</p></div></div></div></div></div></main><footer class=main-footer><div class=main-footer__top><div class="main-footer__container container"><div class=main-footer__info><p><img src=/logos/linkerd.png alt=Linkerd></p><p>Linkerd was originally created by <a href=https://buoyant.io/ target=_blank rel=noopener>Buoyant</a></p><p>View <a href=https://github.com/linkerd/linkerd/wiki/Linkerd-code-of-conduct target=_blank rel=noopener>Code of Conduct</a></p></div><div class=main-footer__links><div class=main-footer__community><h4>Community</h4><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener>GitHub</a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Linkerd Forum</a></li></ul></div><div class=main-footer__follow><h4>Follow</h4><ul><li><a href=https://www.linkedin.com/company/linkerd/ target=_blank rel=noopener>Linkedin</a></li><li><a href=https://www.youtube.com/buoyantio target=_blank rel=noopener>YouTube</a></li><li><a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a></li></ul></div></div></div></div><div class=main-footer__bottom><div class="main-footer__container container"><p><a href=https://github.com/linkerd/website/tree/main/linkerd.io/content target=_blank rel=noopener>Edit This Site</a></p><p>Copyright © 2024 Linkerd Authors. All rights reserved.</p></div></div></footer></body></html>