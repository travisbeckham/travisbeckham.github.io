<!doctype html><html lang=en><head><meta charset=utf-8><title>Using GitOps with Linkerd with Argo CD | Linkerd</title>
<link rel="shortcut icon" href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Use Argo CD to manage Linkerd installation and upgrade lifecycle."><meta property="og:url" content="https://travisbeckham.github.io/2.16/tasks/gitops/"><meta property="og:site_name" content="Linkerd"><meta property="og:title" content="Using GitOps with Linkerd with Argo CD"><meta property="og:description" content="Use Argo CD to manage Linkerd installation and upgrade lifecycle."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="2.16"><meta property="og:image" content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:title content="Using GitOps with Linkerd with Argo CD"><meta name=twitter:description content="Use Argo CD to manage Linkerd installation and upgrade lifecycle."><meta name=twitter:site content="@Linkerd"><link rel=canonical href=https://travisbeckham.github.io/2.16/tasks/gitops/><link rel=stylesheet href=/css/main.css><script src=/js/main.js></script><script async defer src=https://buttons.github.io/buttons.js></script></head><body><header class=main-header><div class=main-header__container><div class=main-header__logo><a href=/><img src=/logos/linkerd.png alt=Linkerd></a></div><input class=main-header__toggle-checkbox type=checkbox id=main-header-toggle>
<label class=main-header__toggle for=main-header-toggle><span class=main-header__toggle-icon><span class=main-header__toggle-icon--open><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3 6H21V8H3V6m0 5H21v2H3V11m0 5H21v2H3V16z"/></svg>
</span><span class=main-header__toggle-icon--close><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span></span></label><div class=main-header__nav><nav class=main-nav><ul class=main-nav__menu><li class=main-nav__menu--selected><a href=/docs>Docs</a></li><li><a href>Community<svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6L7.41 8.58z"/></svg></a><ul><li><a href=/community/get-involved/>Get Involved</a></li><li><a href=/community/adopters/>Adopters</a></li><li><a href=/community/ambassadors/>Linkerd Ambassadors</a></li><li><a href=/community/heroes/>Linkerd Heroes</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Buoyant's Linkerd Forum</a></li></ul></li><li><a href=/blog/>Blog</a></li><li><a href=/faq/>FAQ</a></li><li><a href=/enterprise/>Enterprise</a></li></ul><div class=main-nav__search><form action=/search method=get><div class="search-input search-input--sm"><svg class="icon" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5.0 0116 9.5c0 1.61-.59 3.09-1.56 4.23L14.71 14H15.5l5 5L19 20.5l-5-5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5.0 013 9.5 6.5 6.5.0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
<input type=text name=q placeholder=Search></div></form></div><div class=main-nav__github><a class=github-button href=https://github.com/linkerd/linkerd2 data-icon=octicon-star data-size=large data-show-count=true aria-label="Star linkerd/linkerd2 on GitHub">Star</a></div><div class=main-nav__forum><a href=https://linkerd.buoyant.io class="button button--primary button--sm" target=_blank rel=noopener>Join Forum</a></div></nav></div></div></header><div class=main-announcement>Service Mesh 101: Get Service Mesh-Certified
<span class=main-announcement__link><a href=https://buoyant.io/courses/service-mesh-101 target=_blank rel=noopener>Enroll now</a></span></div><main class=main-content><div class=docs><div class=docs__container><div class=docs__sidebar><div class=docs__nav><div class=docs__versions><select onchange="window.location.href=this.value"><option value=/2-edge/>Linkerd edge</option><option value=/2.16/ selected>Linkerd 2.16</option><option value=/2.15/>Linkerd 2.15</option><option value=/2.14/>Linkerd 2.14</option><option value=/2.13/>Linkerd 2.13</option><option value=/2.12/>Linkerd 2.12</option><option value=/2.11/>Linkerd 2.11</option><option value=/2.10/>Linkerd 2.10</option><option value=/2.9/>Linkerd 2.9</option></select></div><nav><ul><li><a href=/2.16/overview/>Overview</a></li><li><a href=/2.16/getting-started/>Getting Started</a></li><li><a href=/2.16/features/>Features
</a><input class=toggle__input type=checkbox id=toggle-8f2b3864989abf5fcedb56a3ffaa68dd>
<label class=toggle__label for=toggle-8f2b3864989abf5fcedb56a3ffaa68dd><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.16/features/http-grpc/>HTTP, HTTP/2, and gRPC Proxying</a></li><li><a href=/2.16/features/protocol-detection/>TCP Proxying and Protocol Detection</a></li><li><a href=/2.16/features/retries-and-timeouts/>Retries and Timeouts</a></li><li><a href=/2.16/features/automatic-mtls/>Automatic mTLS</a></li><li><a href=/2.16/features/ingress/>Ingress</a></li><li><a href=/2.16/features/telemetry/>Telemetry and Monitoring</a></li><li><a href=/2.16/features/load-balancing/>Load Balancing</a></li><li><a href=/2.16/features/server-policy/>Authorization Policy</a></li><li><a href=/2.16/features/proxy-injection/>Automatic Proxy Injection</a></li><li><a href=/2.16/features/cni/>CNI Plugin</a></li><li><a href=/2.16/features/dashboard/>Dashboard and on-cluster metrics stack</a></li><li><a href=/2.16/features/distributed-tracing/>Distributed Tracing</a></li><li><a href=/2.16/features/request-routing/>Dynamic Request Routing</a></li><li><a href=/2.16/features/fault-injection/>Fault Injection</a></li><li><a href=/2.16/features/ha/>High Availability</a></li><li><a href=/2.16/features/access-logging/>HTTP Access Logging</a></li><li><a href=/2.16/features/httproute/>HTTPRoutes</a></li><li><a href=/2.16/features/nft/>Iptables-nft Support</a></li><li><a href=/2.16/features/ipv6/>IPv6 Support</a></li><li><a href=/2.16/features/multicluster/>Multi-cluster communication</a></li><li><a href=/2.16/features/non-kubernetes-workloads/>Non-Kubernetes workloads (mesh expansion)</a></li><li><a href=/2.16/features/service-profiles/>Service Profiles</a></li><li><a href=/2.16/features/traffic-split/>Traffic Split (canaries, blue/green deploys)</a></li></ul></li><li class=docs__nav--selected><a href=/2.16/tasks/>Tasks
</a><input class=toggle__input type=checkbox id=toggle-6dd1ab63beb6e01f692b7628aa14c0a7 checked>
<label class=toggle__label for=toggle-6dd1ab63beb6e01f692b7628aa14c0a7><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.16/tasks/adding-non-kubernetes-workloads/>Adding non-Kubernetes workloads to your mesh</a></li><li><a href=/2.16/tasks/adding-your-service/>Adding your services to Linkerd</a></li><li><a href=/2.16/tasks/automatic-failover/>Automatic Multicluster Failover</a></li><li><a href=/2.16/tasks/automatically-rotating-control-plane-tls-credentials/>Automatically Rotating Control Plane TLS Credentials</a></li><li><a href=/2.16/tasks/automatically-rotating-webhook-tls-credentials/>Automatically Rotating Webhook TLS Credentials</a></li><li><a href=/2.16/tasks/external-prometheus/>Bringing your own Prometheus</a></li><li><a href=/2.16/tasks/circuit-breakers/>Circuit Breakers</a></li><li><a href=/2.16/tasks/configuring-dynamic-request-routing/>Configuring Dynamic Request Routing</a></li><li><a href=/2.16/tasks/configuring-per-route-policy/>Configuring Per-Route Authorization Policy</a></li><li><a href=/2.16/tasks/configuring-proxy-concurrency/>Configuring Proxy Concurrency</a></li><li><a href=/2.16/tasks/configuring-proxy-discovery-cache/>Configuring Proxy Discovery Cache</a></li><li><a href=/2.16/tasks/configuring-retries/>Configuring Retries</a></li><li><a href=/2.16/tasks/configuring-timeouts/>Configuring Timeouts</a></li><li><a href=/2.16/tasks/using-debug-endpoints/>Control Plane Debug Endpoints</a></li><li><a href=/2.16/tasks/customize-install/>Customizing Linkerd's Configuration with Kustomize</a></li><li><a href=/2.16/tasks/debugging-502s/>Debugging 502s</a></li><li><a href=/2.16/tasks/debugging-your-service/>Debugging gRPC applications with request tracing</a></li><li><a href=/2.16/tasks/books/>Debugging HTTP applications with per-route metrics</a></li><li><a href=/2.16/tasks/distributed-tracing/>Distributed tracing with Linkerd</a></li><li><a href=/2.16/tasks/exporting-metrics/>Exporting Metrics</a></li><li><a href=/2.16/tasks/exposing-dashboard/>Exposing the Dashboard</a></li><li><a href=/2.16/tasks/generate-certificates/>Generating your own mTLS root certificates</a></li><li><a href=/2.16/tasks/getting-per-route-metrics/>Getting Per-Route Metrics</a></li><li><a href=/2.16/tasks/linkerd-smi/>Getting started with Linkerd SMI extension</a></li><li><a href=/2.16/tasks/graceful-shutdown/>Graceful Pod Shutdown</a></li><li><a href=/2.16/tasks/grafana/>Grafana</a></li><li><a href=/2.16/tasks/using-ingress/>Handling ingress traffic</a></li><li><a href=/2.16/tasks/fault-injection/>Injecting Faults</a></li><li><a href=/2.16/tasks/install/>Installing Linkerd</a></li><li><a href=/2.16/tasks/install-helm/>Installing Linkerd with Helm</a></li><li><a href=/2.16/tasks/installing-multicluster/>Installing Multi-cluster Components</a></li><li><a href=/2.16/tasks/using-psp/>Linkerd and Pod Security Policies (PSP)</a></li><li><a href=/2.16/tasks/manually-rotating-control-plane-tls-credentials/>Manually Rotating Control Plane TLS Credentials</a></li><li><a href=/2.16/tasks/modifying-proxy-log-level/>Modifying the Proxy Log Level</a></li><li><a href=/2.16/tasks/multicluster/>Multi-cluster communication</a></li><li><a href=/2.16/tasks/multicluster-using-statefulsets/>Multi-cluster communication with StatefulSets</a></li><li><a href=/2.16/tasks/per-request-policy/>Per-Request Policy</a></li><li><a href=/2.16/tasks/pod-to-pod-multicluster/>Pod-to-Pod Multi-cluster communication</a></li><li><a href=/2.16/tasks/flagger/>Progressive Delivery</a></li><li><a href=/2.16/tasks/replacing_expired_certificates/>Replacing expired certificates</a></li><li><a href=/2.16/tasks/restricting-access/>Restricting Access To Services</a></li><li><a href=/2.16/tasks/rotating_webhooks_certificates/>Rotating webhooks certificates</a></li><li><a href=/2.16/tasks/securing-linkerd-tap/>Securing Linkerd Tap</a></li><li><a href=/2.16/tasks/setting-up-service-profiles/>Setting Up Service Profiles</a></li><li><a href=/2.16/tasks/traffic-shifting/>Traffic Shifting</a></li><li><a href=/2.16/tasks/troubleshooting/>Troubleshooting</a></li><li><a href=/2.16/tasks/uninstall/>Uninstalling Linkerd</a></li><li><a href=/2.16/tasks/uninstall-multicluster/>Uninstalling Multicluster</a></li><li><a href=/2.16/tasks/upgrade/>Upgrading Linkerd</a></li><li><a href=/2.16/tasks/using-custom-domain/>Using a Custom Cluster Domain</a></li><li><a href=/2.16/tasks/extensions/>Using extensions</a></li><li class=docs__nav--selected><a href=/2.16/tasks/gitops/>Using GitOps with Linkerd with Argo CD</a></li><li><a href=/2.16/tasks/using-the-debug-container/>Using the Debug Sidecar</a></li><li><a href=/2.16/tasks/validating-your-traffic/>Validating your mTLS traffic</a></li></ul></li><li><a href=/2.16/reference/>Reference
</a><input class=toggle__input type=checkbox id=toggle-f7bbb952d9a479cfe82f5debb0fbc89c>
<label class=toggle__label for=toggle-f7bbb952d9a479cfe82f5debb0fbc89c><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.16/reference/architecture/>Architecture</a></li><li><a href=/2.16/reference/authorization-policy/>Authorization Policy</a></li><li><a href=/2.16/reference/circuit-breaking/>Circuit Breaking</a></li><li><a href=/2.16/reference/cli/>CLI
</a><input class=toggle__input type=checkbox id=toggle-16e73a448bb99ac0d4654e9aeb3859cd>
<label class=toggle__label for=toggle-16e73a448bb99ac0d4654e9aeb3859cd><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.16/reference/cli/authz/>authz</a></li><li><a href=/2.16/reference/cli/check/>check</a></li><li><a href=/2.16/reference/cli/completion/>completion</a></li><li><a href=/2.16/reference/cli/diagnostics/>diagnostics</a></li><li><a href=/2.16/reference/cli/identity/>identity</a></li><li><a href=/2.16/reference/cli/inject/>inject</a></li><li><a href=/2.16/reference/cli/install/>install</a></li><li><a href=/2.16/reference/cli/install-cni/>install-cni</a></li><li><a href=/2.16/reference/cli/jaeger/>jaeger</a></li><li><a href=/2.16/reference/cli/multicluster/>multicluster</a></li><li><a href=/2.16/reference/cli/profile/>profile</a></li><li><a href=/2.16/reference/cli/prune/>prune</a></li><li><a href=/2.16/reference/cli/uninject/>uninject</a></li><li><a href=/2.16/reference/cli/uninstall/>uninstall</a></li><li><a href=/2.16/reference/cli/upgrade/>upgrade</a></li><li><a href=/2.16/reference/cli/version/>version</a></li><li><a href=/2.16/reference/cli/viz/>viz</a></li></ul></li><li><a href=/2.16/reference/cluster-configuration/>Cluster Configuration</a></li><li><a href=/2.16/reference/extension-list/>Extensions List</a></li><li><a href=/2.16/reference/external-workload/>ExternalWorkload</a></li><li><a href=/2.16/reference/httproute/>HTTPRoute</a></li><li><a href=/2.16/reference/iptables/>IPTables Reference</a></li><li><a href=/2.16/reference/multicluster/>Multi-cluster communication</a></li><li><a href=/2.16/reference/proxy-configuration/>Proxy Configuration</a></li><li><a href=/2.16/reference/proxy-log-level/>Proxy Log Level</a></li><li><a href=/2.16/reference/proxy-metrics/>Proxy Metrics</a></li><li><a href=/2.16/reference/retries/>Retries</a></li><li><a href=/2.16/reference/service-profiles/>Service Profiles</a></li><li><a href=/2.16/reference/k8s-versions/>Supported Kubernetes Versions</a></li><li><a href=/2.16/reference/timeouts/>Timeouts</a></li></ul></li><li><a href=/2.16/common-errors/>Common Errors
</a><input class=toggle__input type=checkbox id=toggle-1dfe2f36d6b5e88e61f40a60319ec82c>
<label class=toggle__label for=toggle-1dfe2f36d6b5e88e61f40a60319ec82c><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.16/common-errors/failfast/>Failfast</a></li><li><a href=/2.16/common-errors/http-502/>HTTP 502 Errors</a></li><li><a href=/2.16/common-errors/http-503-504/>HTTP 503 and 504 Errors</a></li><li><a href=/2.16/common-errors/protocol-detection/>Protocol Detection Errors</a></li></ul></li></ul><ul><li><a href=/what-is-a-service-mesh/>What is a service mesh?</a></li><li><a href=/faq/>Frequently Asked Questions</a></li><li><a href=/releases/>Releases and Versions</a></li><li><a href=/design-principles/>Design Principles</a></li><li><a href=/going-to-production/>Going to Production</a></li><li><a href=/service-mesh-glossary/>Service Mesh Glossary</a></li></ul></nav><div class=docs__community><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener><img src=/logos/github.svg alt=GitHub class=img></a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener><img src=/logos/slack.svg alt=Slack class=img></a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener><img src=/logos/forum.png alt="Linkerd Forum" class=img></a></li></ul></div></div></div><div class=docs__main><div class=docs__body><div class=docs__header><h1>Using GitOps with Linkerd with Argo CD</h1></div><div class="docs__content prose"><p>GitOps is an approach to automate the management and delivery of your Kubernetes
infrastructure and applications using Git as a single source of truth. It
usually utilizes some software agents to detect and reconcile any divergence
between version-controlled artifacts in Git with what&rsquo;s running in a cluster.</p><p>This guide will show you how to set up
<a href=https://argoproj.github.io/argo-cd/ target=_blank rel=noopener>Argo CD</a> to manage the installation and
upgrade of Linkerd using a GitOps workflow.</p><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Linkerd Production Tip</h4></div><div class=alert__content>This page contains best-effort instructions by the open source community. Production users with mission-critical applications should familiarize themselves with <a href=/going-to-production/>Linkerd production resources</a> and/or connect with a commercial <a href=/support-training/>Linkerd provider</a>.</div></div><p>Specifically, this guide provides instructions on how to securely generate and
manage Linkerd&rsquo;s mTLS private keys and certificates using
<a href=https://github.com/bitnami-labs/sealed-secrets target=_blank rel=noopener>Sealed Secrets</a> and
<a href=https://cert-manager.io target=_blank rel=noopener>cert-manager</a>. It will also show you how to integrate
the <a href=../../features/proxy-injection/>auto proxy injection</a> feature into your
workflow. Finally, this guide conclude with steps to upgrade Linkerd to a newer
version following a GitOps workflow.</p><figure><img alt="Linkerd GitOps workflow" class="img img--max-fill img--center img--rounded" src=/images/gitops/architecture.png><figcaption>Linkerd GitOps workflow</figcaption></figure><p>The software and tools used in this guide are selected for demonstration
purposes only. Feel free to choose others that are most suited for your
requirements.</p><p>You will need to clone this
<a href=https://github.com/linkerd/linkerd-examples target=_blank rel=noopener>example repository</a> to your local
machine and replicate it in your Kubernetes cluster following the steps defined
in the next section.</p><p>This guide uses the <a href=https://smallstep.com/cli/ target=_blank rel=noopener>step cli</a> to create certificates
used by the Linkerd clusters to enforce mTLS, so make sure you have installed
step for your environment.</p><h2 id=set-up-the-repositories class=anchor>Set up the repositories
<a href=#set-up-the-repositories class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Clone the example repository to your local machine:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone https://github.com/linkerd/linkerd-examples.git
</span></span></code></pre></div><p>This repository will be used to demonstrate Git operations like <code>add</code>, <code>commit</code>
and <code>push</code> later in this guide.</p><p>Add a new remote endpoint to the repository to point to the in-cluster Git
server, which will be set up in the next section:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cd linkerd-examples
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git remote add git-server git://localhost/linkerd-examples.git
</span></span></code></pre></div><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>To simplify the steps in this guide, we will be interacting with the in-cluster
Git server via port-forwarding. Hence, the remote endpoint that we just created
targets your localhost.</div></div><p>Deploy the Git server to the <code>scm</code> namespace in your cluster:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f gitops/resources/git-server.yaml
</span></span></code></pre></div><p>Later in this guide, Argo CD will be configured to watch the repositories hosted
by this Git server.</p><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>This Git server is configured to run as a
<a href=https://git-scm.com/book/en/v2/Git-on-the-Server-Git-Daemon target=_blank rel=noopener>daemon</a> over the
<code>git</code> protocol, with unauthenticated access to the Git data. This setup is not
recommended for production use.</div></div><p>Confirm that the Git server is healthy:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl -n scm rollout status deploy/git-server
</span></span></code></pre></div><p>Clone the example repository to your in-cluster Git server:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#79c0ff>git_server</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>`</span>kubectl -n scm get po -l <span style=color:#79c0ff>app</span><span style=color:#ff7b72;font-weight:700>=</span>git-server -oname | awk -F/ <span style=color:#a5d6ff>&#39;{ print $2 }&#39;</span><span style=color:#a5d6ff>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl -n scm exec <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>git_server</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span> -- <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  git clone --bare https://github.com/linkerd/linkerd-examples.git
</span></span></code></pre></div><p>Confirm that the remote repository is successfully cloned:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl -n scm exec <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>git_server</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span> -- ls -al /git/linkerd-examples.git
</span></span></code></pre></div><p>Confirm that you can push from the local repository to the remote repository
via port-forwarding:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl -n scm port-forward <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>git_server</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span> <span style=color:#a5d6ff>9418</span>  &amp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git push git-server master
</span></span></code></pre></div><h2 id=install-the-argo-cd-cli class=anchor>Install the Argo CD CLI
<a href=#install-the-argo-cd-cli class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Before proceeding, install the Argo CD CLI in your local machine by following
the <a href=https://argo-cd.readthedocs.io/en/stable/cli_installation/ target=_blank rel=noopener>instructions</a>
relevant to your OS.</p><h2 id=deploy-argo-cd class=anchor>Deploy Argo CD
<a href=#deploy-argo-cd class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Install Argo CD:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl create ns argocd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl -n argocd apply -f <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
</span></span></code></pre></div><p>Confirm that all the pods are ready:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#ff7b72>for</span> deploy in <span style=color:#a5d6ff>&#34;dex-server&#34;</span> <span style=color:#a5d6ff>&#34;redis&#34;</span> <span style=color:#a5d6ff>&#34;repo-server&#34;</span> <span style=color:#a5d6ff>&#34;server&#34;</span>; <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  <span style=color:#ff7b72>do</span> kubectl -n argocd rollout status deploy/argocd-<span style=color:#a5d6ff>${</span><span style=color:#79c0ff>deploy</span><span style=color:#a5d6ff>}</span>; <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span><span style=color:#ff7b72>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl -n argocd rollout status statefulset/argocd-application-controller
</span></span></code></pre></div><p>Use port-forward to access the Argo CD dashboard:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl -n argocd port-forward svc/argocd-server 8080:443  <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  &gt; /dev/null 2&gt;&amp;<span style=color:#a5d6ff>1</span> &amp;
</span></span></code></pre></div><p>The Argo CD dashboard is now accessible at
<a href=https://localhost:8080/ target=_blank rel=noopener>https://localhost:8080</a>, using the default <code>admin</code>
username and
<a href=https://argoproj.github.io/argo-cd/getting_started/#4-login-using-the-cli target=_blank rel=noopener>password</a>.</p><p>Authenticate the Argo CD CLI:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#79c0ff>password</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>`</span>kubectl -n argocd get secret argocd-initial-admin-secret -o <span style=color:#79c0ff>jsonpath</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;{.data.password}&#34;</span> | base64 -d<span style=color:#a5d6ff>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>argocd login 127.0.0.1:8080 <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --username<span style=color:#ff7b72;font-weight:700>=</span>admin <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --password<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>password</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span> <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --insecure
</span></span></code></pre></div><h2 id=configure-project-access-and-permissions class=anchor>Configure project access and permissions
<a href=#configure-project-access-and-permissions class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Set up the <code>demo</code>
<a href=https://argoproj.github.io/argo-cd/user-guide/projects/ target=_blank rel=noopener>project</a> to group our
<a href=https://argoproj.github.io/argo-cd/operator-manual/declarative-setup/#applications target=_blank rel=noopener>applications</a>:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f gitops/project.yaml
</span></span></code></pre></div><p>This project defines the list of permitted resource kinds and target clusters
that our applications can work with.</p><p>Confirm that the project is deployed correctly:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>argocd proj get demo
</span></span></code></pre></div><p>On the dashboard:</p><figure><img alt="New project in Argo CD dashboard" class="img img--max-fill img--center img--rounded" src=/images/gitops/dashboard-project.png><figcaption>New project in Argo CD dashboard</figcaption></figure><h3 id=deploy-the-applications class=anchor>Deploy the applications
<a href=#deploy-the-applications class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>Deploy the <code>main</code> application which serves as the &ldquo;parent&rdquo; for all the other
applications:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f gitops/main.yaml
</span></span></code></pre></div><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content>The &ldquo;app of apps&rdquo; pattern is commonly used in Argo CD workflows to bootstrap
applications. See the Argo CD documentation for more
<a href=https://argoproj.github.io/argo-cd/operator-manual/cluster-bootstrapping/#app-of-apps-pattern target=_blank rel=noopener>information</a>.</div></div><p>Confirm that the <code>main</code> application is deployed successfully:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>argocd app get main
</span></span></code></pre></div><p>Sync the <code>main</code> application:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>argocd app sync main
</span></span></code></pre></div><figure><img alt="Synchronize the main application" class="img img--max-fill img--center img--rounded" src=/images/gitops/dashboard-applications-main-sync.png><figcaption>Synchronize the main application</figcaption></figure><p>Notice that only the <code>main</code> application is synchronized.</p><p>Next, we will synchronize the remaining applications individually.</p><h3 id=deploy-cert-manager class=anchor>Deploy cert-manager
<a href=#deploy-cert-manager class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>Synchronize the <code>cert-manager</code> application:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>argocd app sync cert-manager
</span></span></code></pre></div><p>Confirm that cert-manager is running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#ff7b72>for</span> deploy in <span style=color:#a5d6ff>&#34;cert-manager&#34;</span> <span style=color:#a5d6ff>&#34;cert-manager-cainjector&#34;</span> <span style=color:#a5d6ff>&#34;cert-manager-webhook&#34;</span>; <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  <span style=color:#ff7b72>do</span> kubectl -n cert-manager rollout status deploy/<span style=color:#a5d6ff>${</span><span style=color:#79c0ff>deploy</span><span style=color:#a5d6ff>}</span>; <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span><span style=color:#ff7b72>done</span>
</span></span></code></pre></div><figure><img alt="Synchronize the cert-manager application" class="img img--max-fill img--center img--rounded" src=/images/gitops/dashboard-cert-manager-sync.png><figcaption>Synchronize the cert-manager application</figcaption></figure><h3 id=deploy-sealed-secrets class=anchor>Deploy Sealed Secrets
<a href=#deploy-sealed-secrets class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>Synchronize the <code>sealed-secrets</code> application:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>argocd app sync sealed-secrets
</span></span></code></pre></div><p>Confirm that sealed-secrets is running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl -n kube-system rollout status deploy/sealed-secrets
</span></span></code></pre></div><figure><img alt="Synchronize the sealed-secrets application" class="img img--max-fill img--center img--rounded" src=/images/gitops/dashboard-sealed-secrets-sync.png><figcaption>Synchronize the sealed-secrets application</figcaption></figure><h3 id=create-mtls-trust-anchor class=anchor>Create mTLS trust anchor
<a href=#create-mtls-trust-anchor class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>Before proceeding with deploying Linkerd, we will need to create the mTLS trust
anchor. Then we will also set up the <code>linkerd-bootstrap</code> application to manage
the trust anchor certificate.</p><p>Create a new mTLS trust anchor private key and certificate:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>step certificate create root.linkerd.cluster.local sample-trust.crt sample-trust.key <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --profile root-ca <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --no-password <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --not-after 43800h <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --insecure
</span></span></code></pre></div><p>Confirm the details (encryption algorithm, expiry date, SAN etc.) of the new
trust anchor:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>step certificate inspect sample-trust.crt
</span></span></code></pre></div><p>Before creating the <code>SealedSecret</code>, make sure you have installed the <code>kubeseal</code>
utility, as instructed
<a href=https://github.com/bitnami-labs/sealed-secrets/releases target=_blank rel=noopener>here</a></p><p>Now create the <code>SealedSecret</code> resource to store the encrypted trust anchor:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl create ns linkerd
</span></span><span style=display:flex><span>kubectl -n linkerd create secret tls linkerd-trust-anchor <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --cert sample-trust.crt <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --key sample-trust.key <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --dry-run<span style=color:#ff7b72;font-weight:700>=</span>client -oyaml | <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>kubeseal --controller-name<span style=color:#ff7b72;font-weight:700>=</span>sealed-secrets -oyaml - | <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>kubectl patch -f - <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  -p <span style=color:#a5d6ff>&#39;{&#34;spec&#34;: {&#34;template&#34;: {&#34;type&#34;:&#34;kubernetes.io/tls&#34;, &#34;metadata&#34;: {&#34;labels&#34;: {&#34;linkerd.io/control-plane-component&#34;:&#34;identity&#34;, &#34;linkerd.io/control-plane-ns&#34;:&#34;linkerd&#34;}, &#34;annotations&#34;: {&#34;linkerd.io/created-by&#34;:&#34;linkerd/cli stable-2.12.0&#34;}}}}}&#39;</span> <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --dry-run<span style=color:#ff7b72;font-weight:700>=</span>client <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --type<span style=color:#ff7b72;font-weight:700>=</span>merge <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --local -oyaml &gt; gitops/resources/linkerd/trust-anchor.yaml
</span></span></code></pre></div><p>This will overwrite the existing <code>SealedSecret</code> resource in your local
<code>gitops/resources/linkerd/trust-anchor.yaml</code> file. We will push this change to
the in-cluster Git server.</p><p>Confirm that only the <code>spec.encryptedData</code> is changed:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git diff gitops/resources/linkerd/trust-anchor.yaml
</span></span></code></pre></div><p>Commit and push the new trust anchor secret to your in-cluster Git server:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git add gitops/resources/linkerd/trust-anchor.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git commit -m <span style=color:#a5d6ff>&#34;update encrypted trust anchor&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git push git-server master
</span></span></code></pre></div><p>Confirm the commit is successfully pushed:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl -n scm exec <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>git_server</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span> -- git --git-dir linkerd-examples.git log -1
</span></span></code></pre></div><h2 id=deploy-linkerd-bootstrap class=anchor>Deploy linkerd-bootstrap
<a href=#deploy-linkerd-bootstrap class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Synchronize the <code>linkerd-bootstrap</code> application:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>argocd app sync linkerd-bootstrap
</span></span></code></pre></div><div class="alert alert--info alert--callout"><div class=alert__title><svg class="icon icon--current" viewBox="0 0 24 24"><path d="M13 9H11V7h2m0 10H11V11h2M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2z"/></svg><h4>Note</h4></div><div class=alert__content><p>If the issuer and certificate resources appear in a degraded state, it&rsquo;s likely
that the SealedSecrets controller failed to decrypt the sealed
<code>linkerd-trust-anchor</code> secret. Check the SealedSecrets controller for error logs.</p><p>For debugging purposes, the sealed resource can be retrieved using the
<code>kubectl -n linkerd get sealedsecrets linkerd-trust-anchor -oyaml</code> command.
Ensure that this resource matches the
<code>gitops/resources/linkerd/trust-anchor.yaml</code> file you pushed to the in-cluster
Git server earlier.</p></div></div><figure><img alt="Synchronize the linkerd-bootstrap application" class="img img--max-fill img--center img--rounded" src=/images/gitops/dashboard-linkerd-bootstrap-sync.png><figcaption>Synchronize the linkerd-bootstrap application</figcaption></figure><p>SealedSecrets should have created a secret containing the decrypted trust
anchor. Retrieve the decrypted trust anchor from the secret:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#79c0ff>trust_anchor</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>`</span>kubectl -n linkerd get secret linkerd-trust-anchor -ojsonpath<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;{.data[&#39;tls\.crt&#39;]}&#34;</span> | base64 -d -w <span style=color:#a5d6ff>0</span> -<span style=color:#a5d6ff>`</span>
</span></span></code></pre></div><p>Confirm that it matches the decrypted trust anchor certificate you created
earlier in your local <code>sample-trust.crt</code> file:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>diff -b <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  &lt;<span style=color:#ff7b72;font-weight:700>(</span>echo <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>trust_anchor</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span> | step certificate inspect -<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  &lt;<span style=color:#ff7b72;font-weight:700>(</span>step certificate inspect sample-trust.crt<span style=color:#ff7b72;font-weight:700>)</span>
</span></span></code></pre></div><h3 id=deploy-linkerd class=anchor>Deploy Linkerd
<a href=#deploy-linkerd class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>Now we are ready to install Linkerd. The decrypted trust anchor we just
retrieved will be passed to the installation process using the
<code>identityTrustAnchorsPEM</code> parameter.</p><p>Prior to installing Linkerd, note that the <code>identityTrustAnchorsPEM</code> parameter
is set to an &ldquo;empty&rdquo; certificate string:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>argocd app get linkerd-control-plane -ojson | <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  jq -r <span style=color:#a5d6ff>&#39;.spec.source.helm.parameters[] | select(.name == &#34;identityTrustAnchorsPEM&#34;) | .value&#39;</span>
</span></span></code></pre></div><figure><img alt="Empty default trust anchor" class="img img--max-fill img--center img--rounded" src=/images/gitops/dashboard-trust-anchor-empty.png><figcaption>Empty default trust anchor</figcaption></figure><p>We will override this parameter in the <code>linkerd</code> application with the value of
<code>${trust_anchor}</code>.</p><p>Locate the <code>identityTrustAnchorsPEM</code> variable in your local
<code>gitops/argo-apps/linkerd-control-plane.yaml</code> file, and set its <code>value</code> to that
of <code>${trust_anchor}</code>.</p><p>Ensure that the multi-line string is indented correctly. E.g.,</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>source</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>chart</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>linkerd-control-plane</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>repoURL</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>https://helm.linkerd.io/stable</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>targetRevision</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>1.9.0</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>helm</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>parameters</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>identityTrustAnchorsPEM</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681> </span>|<span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          -----BEGIN CERTIFICATE-----
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          MIIBlTCCATygAwIBAgIRAKQr9ASqULvXDeyWpY1LJUQwCgYIKoZIzj0EAwIwKTEn
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          MCUGA1UEAxMeaWRlbnRpdHkubGlua2VyZC5jbHVzdGVyLmxvY2FsMB4XDTIwMDkx
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          ODIwMTAxMFoXDTI1MDkxNzIwMTAxMFowKTEnMCUGA1UEAxMeaWRlbnRpdHkubGlu
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          a2VyZC5jbHVzdGVyLmxvY2FsMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE+PUp
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          IR74PsU+geheoyseycyquYyes5eeksIb5FDm8ptOXQ2xPcBpvesZkj6uIyS3k4qV
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          E0S9VtMmHNeycL7446NFMEMwDgYDVR0PAQH/BAQDAgEGMBIGA1UdEwEB/wQIMAYB
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          Af8CAQEwHQYDVR0OBBYEFHypCh7hiSLNxsKhMylQgqD9t7NNMAoGCCqGSM49BAMC
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          A0cAMEQCIEWhI86bXWEd4wKTnG07hBfBuVCT0bxopaYnn3wRFx7UAiAwXyh5uaVg
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          MwCC5xL+PM+bm3PRqtrmI6TocWH07GbMxg==
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>          -----END CERTIFICATE-----</span><span style=color:#6e7681>          
</span></span></span></code></pre></div><p>Confirm that only one <code>spec.source.helm.parameters.value</code> field is changed:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git diff gitops/argo-apps/linkerd-control-plane.yaml
</span></span></code></pre></div><p>Commit and push the changes to the Git server:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git add gitops/argo-apps/linkerd-control-plane.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git commit -m <span style=color:#a5d6ff>&#34;set identityTrustAnchorsPEM parameter&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git push git-server master
</span></span></code></pre></div><p>Synchronize the <code>main</code> application:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>argocd app sync main
</span></span></code></pre></div><p>Confirm that the new trust anchor is picked up by the <code>linkerd</code> application:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>argocd app get linkerd-control-plane -ojson | <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  jq -r <span style=color:#a5d6ff>&#39;.spec.source.helm.parameters[] | select(.name == &#34;identityTrustAnchorsPEM&#34;) | .value&#39;</span>
</span></span></code></pre></div><figure><img alt="Override mTLS trust anchor" class="img img--max-fill img--center img--rounded" src=/images/gitops/dashboard-trust-anchor-override.png><figcaption>Override mTLS trust anchor</figcaption></figure><p>Synchronize the <code>linkerd-crds</code> and <code>linkerd-control-plane</code> applications:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>argocd app sync linkerd-crds
</span></span><span style=display:flex><span>argocd app sync linkerd-control-plane
</span></span></code></pre></div><p>Check that Linkerd is ready:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>linkerd check
</span></span></code></pre></div><figure><img alt="Synchronize Linkerd" class="img img--max-fill img--center img--rounded" src=/images/gitops/dashboard-linkerd-sync.png><figcaption>Synchronize Linkerd</figcaption></figure><h3 id=test-with-emojivoto class=anchor>Test with emojivoto
<a href=#test-with-emojivoto class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>Deploy emojivoto to test auto proxy injection:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>argocd app sync emojivoto
</span></span></code></pre></div><p>Check that the applications are healthy:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#ff7b72>for</span> deploy in <span style=color:#a5d6ff>&#34;emoji&#34;</span> <span style=color:#a5d6ff>&#34;vote-bot&#34;</span> <span style=color:#a5d6ff>&#34;voting&#34;</span> <span style=color:#a5d6ff>&#34;web&#34;</span> ; <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  <span style=color:#ff7b72>do</span> kubectl -n emojivoto rollout status deploy/<span style=color:#a5d6ff>${</span><span style=color:#79c0ff>deploy</span><span style=color:#a5d6ff>}</span>; <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span><span style=color:#ff7b72>done</span>
</span></span></code></pre></div><figure><img alt="Synchronize emojivoto" class="img img--max-fill img--center img--rounded" src=/images/gitops/dashboard-emojivoto-sync.png><figcaption>Synchronize emojivoto</figcaption></figure><h3 id=upgrade-linkerd-to-2121 class=anchor>Upgrade Linkerd to 2.12.1
<a href=#upgrade-linkerd-to-2121 class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>(Assuming 2.12.1 has already been released ;-) )</p><p>Use your editor to change the <code>spec.source.targetRevision</code> field to <code>1.9.3</code>
(that&rsquo;s the Helm chart version corresponding to linkerd stable-2.12.1) in the
<code>gitops/argo-apps/linkerd-control-plane.yaml</code> file:</p><p>Confirm that only the <code>targetRevision</code> field is changed:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git diff gitops/argo-apps/linkerd-control-plane.yaml
</span></span></code></pre></div><p>Commit and push this change to the Git server:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git add gitops/argo-apps/linkerd-control-plane.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git commit -m <span style=color:#a5d6ff>&#34;upgrade Linkerd to 2.12.1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git push git-server master
</span></span></code></pre></div><p>Synchronize the <code>main</code> application:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>argocd app sync main
</span></span></code></pre></div><p>Synchronize the <code>linkerd-control-plane</code> application:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>argocd app sync linkerd-control-plane
</span></span></code></pre></div><p>Confirm that the upgrade completed successfully:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>linkerd check
</span></span></code></pre></div><p>Confirm the new version of the control plane:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>linkerd version
</span></span></code></pre></div><h3 id=clean-up class=anchor>Clean up
<a href=#clean-up class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>All the applications can be removed by removing the <code>main</code> application:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>argocd app delete main --cascade<span style=color:#ff7b72;font-weight:700>=</span>true
</span></span></code></pre></div></div></div></div></div></div></main><footer class=main-footer><div class=main-footer__top><div class="main-footer__container container"><div class=main-footer__info><p><img src=/logos/linkerd.png alt=Linkerd></p><p>Linkerd was originally created by <a href=https://buoyant.io/ target=_blank rel=noopener>Buoyant</a></p><p>View <a href=https://github.com/linkerd/linkerd/wiki/Linkerd-code-of-conduct target=_blank rel=noopener>Code of Conduct</a></p></div><div class=main-footer__links><div class=main-footer__community><h4>Community</h4><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener>GitHub</a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Linkerd Forum</a></li></ul></div><div class=main-footer__follow><h4>Follow</h4><ul><li><a href=https://www.linkedin.com/company/linkerd/ target=_blank rel=noopener>Linkedin</a></li><li><a href=https://www.youtube.com/buoyantio target=_blank rel=noopener>YouTube</a></li><li><a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a></li></ul></div></div></div></div><div class=main-footer__bottom><div class="main-footer__container container"><p><a href=https://github.com/linkerd/website/tree/main/linkerd.io/content target=_blank rel=noopener>Edit This Site</a></p><p>Copyright © 2024 Linkerd Authors. All rights reserved.</p></div></div></footer></body></html>