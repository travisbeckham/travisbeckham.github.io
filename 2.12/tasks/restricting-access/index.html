<!doctype html><html lang=en><head><meta charset=utf-8><title>Restricting Access To Services | Linkerd</title>
<link rel="shortcut icon" href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Use Linkerd policy to restrict access to a service."><meta property="og:url" content="https://travisbeckham.github.io/2.12/tasks/restricting-access/"><meta property="og:site_name" content="Linkerd"><meta property="og:title" content="Restricting Access To Services"><meta property="og:description" content="Use Linkerd policy to restrict access to a service."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="2.12"><meta property="og:image" content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:title content="Restricting Access To Services"><meta name=twitter:description content="Use Linkerd policy to restrict access to a service."><meta name=twitter:site content="@Linkerd"><link rel=canonical href=https://travisbeckham.github.io/2.12/tasks/restricting-access/><link rel=stylesheet href=/css/main.css><script src=/js/main.js></script><script async defer src=https://buttons.github.io/buttons.js></script></head><body><header class=main-header><div class=main-header__container><div class=main-header__logo><a href=/><img src=/logos/linkerd.png alt=Linkerd></a></div><input class=main-header__toggle-checkbox type=checkbox id=main-header-toggle>
<label class=main-header__toggle for=main-header-toggle><span class=main-header__toggle-icon><span class=main-header__toggle-icon--open><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3 6H21V8H3V6m0 5H21v2H3V11m0 5H21v2H3V16z"/></svg>
</span><span class=main-header__toggle-icon--close><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span></span></label><div class=main-header__nav><nav class=main-nav><ul class=main-nav__menu><li class=main-nav__menu--selected><a href=/docs>Docs</a></li><li><a href>Community<svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6L7.41 8.58z"/></svg></a><ul><li><a href=/community/get-involved/>Get Involved</a></li><li><a href=/community/adopters/>Adopters</a></li><li><a href=/community/ambassadors/>Linkerd Ambassadors</a></li><li><a href=/community/heroes/>Linkerd Heroes</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Buoyant's Linkerd Forum</a></li></ul></li><li><a href=/blog/>Blog</a></li><li><a href=/faq/>FAQ</a></li><li><a href=/enterprise/>Enterprise</a></li></ul><div class=main-nav__search><form action=/search method=get><div class="search-input search-input--sm"><svg class="icon" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5.0 0116 9.5c0 1.61-.59 3.09-1.56 4.23L14.71 14H15.5l5 5L19 20.5l-5-5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5.0 013 9.5 6.5 6.5.0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
<input type=text name=q placeholder=Search></div></form></div><div class=main-nav__github><a class=github-button href=https://github.com/linkerd/linkerd2 data-icon=octicon-star data-size=large data-show-count=true aria-label="Star linkerd/linkerd2 on GitHub">Star</a></div><div class=main-nav__forum><a href=https://linkerd.buoyant.io class="button button--primary button--sm" target=_blank rel=noopener>Join Forum</a></div></nav></div></div></header><div class=main-announcement>Service Mesh 101: Get Service Mesh-Certified
<span class=main-announcement__link><a href=https://buoyant.io/courses/service-mesh-101 target=_blank rel=noopener>Enroll now</a></span></div><main class=main-content><div class="alert alert--warning alert--condensed alert--center docs__deprecated-alert"><div class=alert__content>You are viewing docs for an older version of Linkerd.
<a href=/2.16/>View the latest docs</a>.</div></div><div class=docs><div class=docs__container><div class=docs__sidebar><div class=docs__nav><div class=docs__versions><select onchange="window.location.href=this.value"><option value=/2-edge/>Linkerd edge</option><option value=/2.16/>Linkerd 2.16</option><option value=/2.15/>Linkerd 2.15</option><option value=/2.14/>Linkerd 2.14</option><option value=/2.13/>Linkerd 2.13</option><option value=/2.12/ selected>Linkerd 2.12</option><option value=/2.11/>Linkerd 2.11</option><option value=/2.10/>Linkerd 2.10</option><option value=/2.9/>Linkerd 2.9</option></select></div><nav><ul><li><a href=/2.12/overview/>Overview</a></li><li><a href=/2.12/getting-started/>Getting Started</a></li><li><a href=/2.12/features/>Features
</a><input class=toggle__input type=checkbox id=toggle-451debf55674ca42b496c251f32b1e24>
<label class=toggle__label for=toggle-451debf55674ca42b496c251f32b1e24><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.12/features/http-grpc/>HTTP, HTTP/2, and gRPC Proxying</a></li><li><a href=/2.12/features/protocol-detection/>TCP Proxying and Protocol Detection</a></li><li><a href=/2.12/features/retries-and-timeouts/>Retries and Timeouts</a></li><li><a href=/2.12/features/automatic-mtls/>Automatic mTLS</a></li><li><a href=/2.12/features/ingress/>Ingress</a></li><li><a href=/2.12/features/telemetry/>Telemetry and Monitoring</a></li><li><a href=/2.12/features/load-balancing/>Load Balancing</a></li><li><a href=/2.12/features/server-policy/>Authorization Policy</a></li><li><a href=/2.12/features/proxy-injection/>Automatic Proxy Injection</a></li><li><a href=/2.12/features/cni/>CNI Plugin</a></li><li><a href=/2.12/features/dashboard/>Dashboard and on-cluster metrics stack</a></li><li><a href=/2.12/features/distributed-tracing/>Distributed Tracing</a></li><li><a href=/2.12/features/fault-injection/>Fault Injection</a></li><li><a href=/2.12/features/ha/>High Availability</a></li><li><a href=/2.12/features/access-logging/>HTTP Access Logging</a></li><li><a href=/2.12/features/multicluster/>Multi-cluster communication</a></li><li><a href=/2.12/features/nft/>Proxy Init Iptables Modes</a></li><li><a href=/2.12/features/service-profiles/>Service Profiles</a></li><li><a href=/2.12/features/traffic-split/>Traffic Split (canaries, blue/green deploys)</a></li></ul></li><li class=docs__nav--selected><a href=/2.12/tasks/>Tasks
</a><input class=toggle__input type=checkbox id=toggle-bd74b9215cf78dd6fa457943dd02a886 checked>
<label class=toggle__label for=toggle-bd74b9215cf78dd6fa457943dd02a886><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.12/tasks/adding-your-service/>Adding your services to Linkerd</a></li><li><a href=/2.12/tasks/canary-release/>Automated Canary Releases</a></li><li><a href=/2.12/tasks/automatic-failover/>Automatic Multicluster Failover</a></li><li><a href=/2.12/tasks/automatically-rotating-control-plane-tls-credentials/>Automatically Rotating Control Plane TLS Credentials</a></li><li><a href=/2.12/tasks/automatically-rotating-webhook-tls-credentials/>Automatically Rotating Webhook TLS Credentials</a></li><li><a href=/2.12/tasks/external-prometheus/>Bringing your own Prometheus</a></li><li><a href=/2.12/tasks/configuring-per-route-policy/>Configuring Per-Route Policy</a></li><li><a href=/2.12/tasks/configuring-proxy-concurrency/>Configuring Proxy Concurrency</a></li><li><a href=/2.12/tasks/configuring-retries/>Configuring Retries</a></li><li><a href=/2.12/tasks/configuring-timeouts/>Configuring Timeouts</a></li><li><a href=/2.12/tasks/using-debug-endpoints/>Control Plane Debug Endpoints</a></li><li><a href=/2.12/tasks/customize-install/>Customizing Linkerd's Configuration with Kustomize</a></li><li><a href=/2.12/tasks/debugging-502s/>Debugging 502s</a></li><li><a href=/2.12/tasks/debugging-your-service/>Debugging gRPC applications with request tracing</a></li><li><a href=/2.12/tasks/books/>Debugging HTTP applications with per-route metrics</a></li><li><a href=/2.12/tasks/distributed-tracing/>Distributed tracing with Linkerd</a></li><li><a href=/2.12/tasks/exporting-metrics/>Exporting Metrics</a></li><li><a href=/2.12/tasks/exposing-dashboard/>Exposing the Dashboard</a></li><li><a href=/2.12/tasks/generate-certificates/>Generating your own mTLS root certificates</a></li><li><a href=/2.12/tasks/getting-per-route-metrics/>Getting Per-Route Metrics</a></li><li><a href=/2.12/tasks/linkerd-smi/>Getting started with Linkerd SMI extension</a></li><li><a href=/2.12/tasks/graceful-shutdown/>Graceful Pod Shutdown</a></li><li><a href=/2.12/tasks/grafana/>Grafana</a></li><li><a href=/2.12/tasks/using-ingress/>Ingress traffic</a></li><li><a href=/2.12/tasks/fault-injection/>Injecting Faults</a></li><li><a href=/2.12/tasks/install/>Installing Linkerd</a></li><li><a href=/2.12/tasks/install-helm/>Installing Linkerd with Helm</a></li><li><a href=/2.12/tasks/installing-multicluster/>Installing Multi-cluster Components</a></li><li><a href=/2.12/tasks/using-psp/>Linkerd and Pod Security Policies (PSP)</a></li><li><a href=/2.12/tasks/manually-rotating-control-plane-tls-credentials/>Manually Rotating Control Plane TLS Credentials</a></li><li><a href=/2.12/tasks/modifying-proxy-log-level/>Modifying the Proxy Log Level</a></li><li><a href=/2.12/tasks/multicluster/>Multi-cluster communication</a></li><li><a href=/2.12/tasks/multicluster-using-statefulsets/>Multi-cluster communication with StatefulSets</a></li><li><a href=/2.12/tasks/replacing_expired_certificates/>Replacing expired certificates</a></li><li class=docs__nav--selected><a href=/2.12/tasks/restricting-access/>Restricting Access To Services</a></li><li><a href=/2.12/tasks/rotating_webhooks_certificates/>Rotating webhooks certificates</a></li><li><a href=/2.12/tasks/securing-linkerd-tap/>Securing Linkerd Tap</a></li><li><a href=/2.12/tasks/setting-up-service-profiles/>Setting Up Service Profiles</a></li><li><a href=/2.12/tasks/troubleshooting/>Troubleshooting</a></li><li><a href=/2.12/tasks/uninstall/>Uninstalling Linkerd</a></li><li><a href=/2.12/tasks/uninstall-multicluster/>Uninstalling Multicluster</a></li><li><a href=/2.12/tasks/upgrade/>Upgrading Linkerd</a></li><li><a href=/2.12/tasks/using-custom-domain/>Using a Custom Cluster Domain</a></li><li><a href=/2.12/tasks/using-a-private-docker-repository/>Using A Private Docker Repository</a></li><li><a href=/2.12/tasks/extensions/>Using extensions</a></li><li><a href=/2.12/tasks/gitops/>Using GitOps with Linkerd with Argo CD</a></li><li><a href=/2.12/tasks/using-the-debug-container/>Using the Debug Sidecar</a></li><li><a href=/2.12/tasks/validating-your-traffic/>Validating your mTLS traffic</a></li></ul></li><li><a href=/2.12/reference/>Reference
</a><input class=toggle__input type=checkbox id=toggle-b8c7e85e215b478062e7a8ddd5fba4c9>
<label class=toggle__label for=toggle-b8c7e85e215b478062e7a8ddd5fba4c9><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.12/reference/architecture/>Architecture</a></li><li><a href=/2.12/reference/authorization-policy/>Authorization Policy</a></li><li><a href=/2.12/reference/cli/>CLI
</a><input class=toggle__input type=checkbox id=toggle-54b83bb178e9cf628a47c1558b11db07>
<label class=toggle__label for=toggle-54b83bb178e9cf628a47c1558b11db07><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.12/reference/cli/authz/>authz</a></li><li><a href=/2.12/reference/cli/check/>check</a></li><li><a href=/2.12/reference/cli/completion/>completion</a></li><li><a href=/2.12/reference/cli/diagnostics/>diagnostics</a></li><li><a href=/2.12/reference/cli/identity/>identity</a></li><li><a href=/2.12/reference/cli/inject/>inject</a></li><li><a href=/2.12/reference/cli/install/>install</a></li><li><a href=/2.12/reference/cli/install-cni/>install-cni</a></li><li><a href=/2.12/reference/cli/jaeger/>jaeger</a></li><li><a href=/2.12/reference/cli/multicluster/>multicluster</a></li><li><a href=/2.12/reference/cli/profile/>profile</a></li><li><a href=/2.12/reference/cli/uninject/>uninject</a></li><li><a href=/2.12/reference/cli/uninstall/>uninstall</a></li><li><a href=/2.12/reference/cli/upgrade/>upgrade</a></li><li><a href=/2.12/reference/cli/version/>version</a></li><li><a href=/2.12/reference/cli/viz/>viz</a></li></ul></li><li><a href=/2.12/reference/cluster-configuration/>Cluster Configuration</a></li><li><a href=/2.12/reference/extension-list/>Extensions List</a></li><li><a href=/2.12/reference/helm-chart-version-matrix/>Helm Chart Version Matrix</a></li><li><a href=/2.12/reference/iptables/>IPTables Reference</a></li><li><a href=/2.12/reference/proxy-configuration/>Proxy Configuration</a></li><li><a href=/2.12/reference/proxy-log-level/>Proxy Log Level</a></li><li><a href=/2.12/reference/proxy-metrics/>Proxy Metrics</a></li><li><a href=/2.12/reference/service-profiles/>Service Profiles</a></li></ul></li></ul><ul><li><a href=/what-is-a-service-mesh/>What is a service mesh?</a></li><li><a href=/faq/>Frequently Asked Questions</a></li><li><a href=/releases/>Releases and Versions</a></li><li><a href=/design-principles/>Design Principles</a></li><li><a href=/going-to-production/>Going to Production</a></li><li><a href=/service-mesh-glossary/>Service Mesh Glossary</a></li></ul></nav><div class=docs__community><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener><img src=/logos/github.svg alt=GitHub class=img></a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener><img src=/logos/slack.svg alt=Slack class=img></a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener><img src=/logos/forum.png alt="Linkerd Forum" class=img></a></li></ul></div></div></div><div class=docs__main><div class=docs__body><div class=docs__header><h1>Restricting Access To Services</h1></div><div class="docs__content prose"><p>Linkerd policy resources can be used to restrict which clients may access a
service. In this example, we&rsquo;ll use Emojivoto to show how to restrict access
to the Voting service so that it may only be called from the Web service.</p><p>For a more comprehensive description of the policy resources, see the
<a href=../../reference/authorization-policy/>Policy reference docs</a>.</p><h2 id=prerequisites class=anchor>Prerequisites
<a href=#prerequisites class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>To use this guide, you&rsquo;ll need to have Linkerd installed on your cluster, along
with its Viz extension. Follow the <a href=../install/>Installing Linkerd Guide</a>
if you haven&rsquo;t already done this.</p><h2 id=setup class=anchor>Setup
<a href=#setup class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Inject and install the Emojivoto application:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ linkerd inject https://run.linkerd.io/emojivoto.yml | kubectl apply -f -
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>$ linkerd check -n emojivoto --proxy -o short
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=creating-a-server-resource class=anchor>Creating a Server resource
<a href=#creating-a-server-resource class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>We start by creating a <code>Server</code> resource for the Voting service. A <code>Server</code>
is a Linkerd custom resource which describes a specific port of a workload.
Once the <code>Server</code> resource has been created, only clients which have been
authorized may access it (we&rsquo;ll see how to authorize clients in a moment).</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f - <span style=color:#a5d6ff>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: policy.linkerd.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: Server
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: emojivoto
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: voting-grpc
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  labels:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    app: voting-svc
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  podSelector:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      app: voting-svc
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  port: grpc
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  proxyProtocol: gRPC
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span></code></pre></div><p>We see that this <code>Server</code> uses a <code>podSelector</code> to select the pods that it
describes: in this case the voting service pods. It also specifies the named
port (grpc) that it applies to. Finally, it specifies the protocol that is
served on this port. This ensures that the proxy treats traffic correctly and
allows it skip protocol detection.</p><p>At this point, no clients have been authorized to access this service and you
will likely see a drop in success rate as requests from the Web service to
Voting start to get rejected.</p><p>We can use the <code>linkerd viz authz</code> command to look at the authorization status
of requests coming to the voting service and see that all incoming requests
to the voting-grpc server are currently unauthorized:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; linkerd viz authz -n emojivoto deploy/voting
</span></span><span style=display:flex><span>ROUTE    SERVER                       AUTHORIZATION                UNAUTHORIZED  SUCCESS     RPS  LATENCY_P50  LATENCY_P95  LATENCY_P99
</span></span><span style=display:flex><span>default  default:all-unauthenticated  default/all-unauthenticated        0.0rps  100.00%  0.1rps          1ms          1ms          1ms
</span></span><span style=display:flex><span>probe    default:all-unauthenticated  default/probe                      0.0rps  100.00%  0.2rps          1ms          1ms          1ms
</span></span><span style=display:flex><span>default  voting-grpc                                                     1.0rps    0.00%  0.0rps          0ms          0ms          0ms
</span></span></code></pre></div><h2 id=creating-a-serverauthorization-resource class=anchor>Creating a ServerAuthorization resource
<a href=#creating-a-serverauthorization-resource class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>A <code>ServerAuthorization</code> grants a set of clients access to a set of <code>Servers</code>.
Here we will create a <code>ServerAuthorization</code> which grants the Web service access
to the Voting <code>Server</code> we created above. Note that meshed mTLS uses
<code>ServiceAccounts</code> as the basis for identity, thus our authorization will also
be based on <code>ServiceAccounts</code>.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f - <span style=color:#a5d6ff>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>---
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>apiVersion: policy.linkerd.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>kind: ServerAuthorization
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  namespace: emojivoto
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  name: voting-grpc
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  labels:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    app.kubernetes.io/part-of: emojivoto
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    app.kubernetes.io/name: voting
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    app.kubernetes.io/version: v11
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  server:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    name: voting-grpc
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  # The voting service only allows requests from the web service.
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  client:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    meshTLS:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      serviceAccounts:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        - name: web
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span></code></pre></div><p>With this in place, we can now see that all of the requests to the Voting
service are authorized by the <code>voting-grpc</code> ServerAuthorization. Note that since
the <code>linkerd viz auth</code> command queries over a time-window, you may see some
UNAUTHORIZED requests displayed for a short amount of time.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; linkerd viz authz -n emojivoto deploy/voting
</span></span><span style=display:flex><span>ROUTE    SERVER                       AUTHORIZATION                    UNAUTHORIZED  SUCCESS     RPS  LATENCY_P50  LATENCY_P95  LATENCY_P99
</span></span><span style=display:flex><span>default  default:all-unauthenticated  default/all-unauthenticated            0.0rps  100.00%  0.1rps          1ms          1ms          1ms
</span></span><span style=display:flex><span>probe    default:all-unauthenticated  default/probe                          0.0rps  100.00%  0.2rps          1ms          1ms          1ms
</span></span><span style=display:flex><span>default  voting-grpc                  serverauthorization/voting-grpc        0.0rps   83.87%  1.0rps          1ms          1ms          1ms
</span></span></code></pre></div><p>We can also test that request from other pods will be rejected by creating a
<code>grpcurl</code> pod and attempting to access the Voting service from it:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; kubectl run grpcurl --rm -it --image<span style=color:#ff7b72;font-weight:700>=</span>networld/grpcurl --restart<span style=color:#ff7b72;font-weight:700>=</span>Never --command -- ./grpcurl -plaintext voting-svc.emojivoto:8080 emojivoto.v1.VotingService/VoteDog
</span></span><span style=display:flex><span>Error invoking method <span style=color:#a5d6ff>&#34;emojivoto.v1.VotingService/VoteDog&#34;</span>: failed to query <span style=color:#ff7b72>for</span> service descriptor <span style=color:#a5d6ff>&#34;emojivoto.v1.VotingService&#34;</span>: rpc error: <span style=color:#79c0ff>code</span> <span style=color:#ff7b72;font-weight:700>=</span> PermissionDenied <span style=color:#79c0ff>desc</span> <span style=color:#ff7b72;font-weight:700>=</span>
</span></span><span style=display:flex><span>pod <span style=color:#a5d6ff>&#34;grpcurl&#34;</span> deleted
</span></span><span style=display:flex><span>pod default/grpcurl terminated <span style=color:#ff7b72;font-weight:700>(</span>Error<span style=color:#ff7b72;font-weight:700>)</span>
</span></span></code></pre></div><p>Because this client has not been authorized, this request gets rejected with a
<code>PermissionDenied</code> error.</p><p>You can create as many <code>ServerAuthorization</code> resources as you like to authorize
many different clients. You can also specify whether to authorize
unauthenticated (i.e. unmeshed) client, any authenticated client, or only
authenticated clients with a particular identity. For more details, please see
the <a href=../../reference/authorization-policy/>Policy reference docs</a>.</p><h2 id=setting-a-default-policy class=anchor>Setting a Default Policy
<a href=#setting-a-default-policy class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>To further lock down a cluster, you can set a default policy which will apply
to all ports which do not have a Server resource defined. Linkerd uses the
following logic when deciding whether to allow a request:</p><ul><li>If the port has a Server resource and the client matches a ServerAuthorization
resource for it: ALLOW</li><li>If the port has a Server resource but the client does not match any
ServerAuthorizations for it: DENY</li><li>If the port does not have a Server resource: use the default policy</li></ul><p>We can set the default policy to <code>deny</code> using the <code>linkerd upgrade</code> command:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; linkerd upgrade --default-inbound-policy deny | kubectl apply -f -
</span></span></code></pre></div><p>Alternatively, default policies can be set on individual workloads or namespaces
by setting the <code>config.linkerd.io/default-inbound-policy</code> annotation. See the
<a href=../../reference/authorization-policy/>Policy reference docs</a> for more details.</p><p>If a port does not have a Server defined, Linkerd will automatically use a
default Server which allows readiness and liveness probes. However, if you
create a Server resource for a port which handles probes, you will need to
explicitly create an authorization to allow those probe requests. For more
information about adding route-scoped authorizations, see
<a href=../configuring-per-route-policy/>Configuring Per-Route Policy</a>.</p><h2 id=further-considerations class=anchor>Further Considerations
<a href=#further-considerations class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>You may have noticed that there was a period of time after we created the
<code>Server</code> resource but before we created the <code>ServerAuthorization</code> where all
requests were being rejected. To avoid this situation in live systems, we
recommend you either create the policy resources before deploying your services
or to create the <code>ServiceAuthorizations</code> BEFORE creating the <code>Server</code> so that
clients will be authorized immediately.</p><h2 id=per-route-policy class=anchor>Per-Route Policy
<a href=#per-route-policy class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>In addition to service-level authorization policy, authorization policy can also
be configured for individual HTTP routes. To learn more about per-route policy,
see the documentation on <a href=../configuring-per-route-policy/>configuring per-route
policy</a>.</p></div></div></div></div></div></main><footer class=main-footer><div class=main-footer__top><div class="main-footer__container container"><div class=main-footer__info><p><img src=/logos/linkerd.png alt=Linkerd></p><p>Linkerd was originally created by <a href=https://buoyant.io/ target=_blank rel=noopener>Buoyant</a></p><p>View <a href=https://github.com/linkerd/linkerd/wiki/Linkerd-code-of-conduct target=_blank rel=noopener>Code of Conduct</a></p></div><div class=main-footer__links><div class=main-footer__community><h4>Community</h4><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener>GitHub</a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Linkerd Forum</a></li></ul></div><div class=main-footer__follow><h4>Follow</h4><ul><li><a href=https://www.linkedin.com/company/linkerd/ target=_blank rel=noopener>Linkedin</a></li><li><a href=https://www.youtube.com/buoyantio target=_blank rel=noopener>YouTube</a></li><li><a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a></li></ul></div></div></div></div><div class=main-footer__bottom><div class="main-footer__container container"><p><a href=https://github.com/linkerd/website/tree/main/linkerd.io/content target=_blank rel=noopener>Edit This Site</a></p><p>Copyright © 2024 Linkerd Authors. All rights reserved.</p></div></div></footer></body></html>