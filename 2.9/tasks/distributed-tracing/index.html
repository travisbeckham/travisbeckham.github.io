<!doctype html><html lang=en><head><meta charset=utf-8><title>Distributed tracing with Linkerd | Linkerd</title>
<link rel="shortcut icon" href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Use Linkerd to help instrument your application with distributed tracing."><meta property="og:url" content="https://travisbeckham.github.io/2.9/tasks/distributed-tracing/"><meta property="og:site_name" content="Linkerd"><meta property="og:title" content="Distributed tracing with Linkerd"><meta property="og:description" content="Use Linkerd to help instrument your application with distributed tracing."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="2.9"><meta property="og:image" content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://travisbeckham.github.io/logos/linkerd.png"><meta name=twitter:title content="Distributed tracing with Linkerd"><meta name=twitter:description content="Use Linkerd to help instrument your application with distributed tracing."><meta name=twitter:site content="@Linkerd"><link rel=canonical href=https://travisbeckham.github.io/2.9/tasks/distributed-tracing/><link rel=stylesheet href=/css/main.css><script src=/js/main.js></script><script async defer src=https://buttons.github.io/buttons.js></script></head><body><header class=main-header><div class=main-header__container><div class=main-header__logo><a href=/><img src=/logos/linkerd.png alt=Linkerd></a></div><input class=main-header__toggle-checkbox type=checkbox id=main-header-toggle>
<label class=main-header__toggle for=main-header-toggle><span class=main-header__toggle-icon><span class=main-header__toggle-icon--open><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3 6H21V8H3V6m0 5H21v2H3V11m0 5H21v2H3V16z"/></svg>
</span><span class=main-header__toggle-icon--close><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span></span></label><div class=main-header__nav><nav class=main-nav><ul class=main-nav__menu><li class=main-nav__menu--selected><a href=/docs>Docs</a></li><li><a href>Community<svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6L7.41 8.58z"/></svg></a><ul><li><a href=/community/get-involved/>Get Involved</a></li><li><a href=/community/adopters/>Adopters</a></li><li><a href=/community/ambassadors/>Linkerd Ambassadors</a></li><li><a href=/community/heroes/>Linkerd Heroes</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Buoyant's Linkerd Forum</a></li></ul></li><li><a href=/blog/>Blog</a></li><li><a href=/faq/>FAQ</a></li><li><a href=/enterprise/>Enterprise</a></li></ul><div class=main-nav__search><form action=/search method=get><div class="search-input search-input--sm"><svg class="icon" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5.0 0116 9.5c0 1.61-.59 3.09-1.56 4.23L14.71 14H15.5l5 5L19 20.5l-5-5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5.0 013 9.5 6.5 6.5.0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
<input type=text name=q placeholder=Search></div></form></div><div class=main-nav__github><a class=github-button href=https://github.com/linkerd/linkerd2 data-icon=octicon-star data-size=large data-show-count=true aria-label="Star linkerd/linkerd2 on GitHub">Star</a></div><div class=main-nav__forum><a href=https://linkerd.buoyant.io class="button button--primary button--sm" target=_blank rel=noopener>Join Forum</a></div></nav></div></div></header><div class=main-announcement>Service Mesh 101: Get Service Mesh-Certified
<span class=main-announcement__link><a href=https://buoyant.io/courses/service-mesh-101 target=_blank rel=noopener>Enroll now</a></span></div><main class=main-content><div class="alert alert--warning alert--condensed alert--center docs__deprecated-alert"><div class=alert__content>You are viewing docs for an older version of Linkerd.
<a href=/2.16/>View the latest docs</a>.</div></div><div class=docs><div class=docs__container><div class=docs__sidebar><div class=docs__nav><div class=docs__versions><select onchange="window.location.href=this.value"><option value=/2-edge/>Linkerd edge</option><option value=/2.16/>Linkerd 2.16</option><option value=/2.15/>Linkerd 2.15</option><option value=/2.14/>Linkerd 2.14</option><option value=/2.13/>Linkerd 2.13</option><option value=/2.12/>Linkerd 2.12</option><option value=/2.11/>Linkerd 2.11</option><option value=/2.10/>Linkerd 2.10</option><option value=/2.9/ selected>Linkerd 2.9</option></select></div><nav><ul><li><a href=/2.9/overview/>Overview</a></li><li><a href=/2.9/getting-started/>Getting Started</a></li><li><a href=/2.9/features/>Features
</a><input class=toggle__input type=checkbox id=toggle-e4cde74e0b82591bbb113b641faed73d>
<label class=toggle__label for=toggle-e4cde74e0b82591bbb113b641faed73d><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.9/features/http-grpc/>HTTP, HTTP/2, and gRPC Proxying</a></li><li><a href=/2.9/features/protocol-detection/>TCP Proxying and Protocol Detection</a></li><li><a href=/2.9/features/retries-and-timeouts/>Retries and Timeouts</a></li><li><a href=/2.9/features/automatic-mtls/>Automatic mTLS</a></li><li><a href=/2.9/features/ingress/>Ingress</a></li><li><a href=/2.9/features/telemetry/>Telemetry and Monitoring</a></li><li><a href=/2.9/features/load-balancing/>Load Balancing</a></li><li><a href=/2.9/features/proxy-injection/>Automatic Proxy Injection</a></li><li><a href=/2.9/features/cni/>CNI Plugin</a></li><li><a href=/2.9/features/dashboard/>Dashboard and Grafana</a></li><li><a href=/2.9/features/distributed-tracing/>Distributed Tracing</a></li><li><a href=/2.9/features/fault-injection/>Fault Injection</a></li><li><a href=/2.9/features/ha/>High Availability</a></li><li><a href=/2.9/features/multicluster/>Multi-cluster communication</a></li><li><a href=/2.9/features/service-profiles/>Service Profiles</a></li><li><a href=/2.9/features/traffic-split/>Traffic Split (canaries, blue/green deploys)</a></li></ul></li><li class=docs__nav--selected><a href=/2.9/tasks/>Tasks
</a><input class=toggle__input type=checkbox id=toggle-5e629638c4c6eed35a2c9c4890c08f16 checked>
<label class=toggle__label for=toggle-5e629638c4c6eed35a2c9c4890c08f16><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.9/tasks/adding-your-service/>Adding Your Services to Linkerd</a></li><li><a href=/2.9/tasks/canary-release/>Automated Canary Releases</a></li><li><a href=/2.9/tasks/automatically-rotating-control-plane-tls-credentials/>Automatically Rotating Control Plane TLS Credentials</a></li><li><a href=/2.9/tasks/automatically-rotating-webhook-tls-credentials/>Automatically Rotating Webhook TLS Credentials</a></li><li><a href=/2.9/tasks/external-prometheus/>Bringing your own Prometheus</a></li><li><a href=/2.9/tasks/configuring-proxy-concurrency/>Configuring Proxy Concurrency</a></li><li><a href=/2.9/tasks/configuring-retries/>Configuring Retries</a></li><li><a href=/2.9/tasks/configuring-timeouts/>Configuring Timeouts</a></li><li><a href=/2.9/tasks/using-debug-endpoints/>Control Plane Debug Endpoints</a></li><li><a href=/2.9/tasks/customize-install/>Customizing Linkerd's Configuration with Kustomize</a></li><li><a href=/2.9/tasks/debugging-502s/>Debugging 502s</a></li><li><a href=/2.9/tasks/debugging-your-service/>Debugging gRPC applications with request tracing</a></li><li><a href=/2.9/tasks/books/>Debugging HTTP applications with per-route metrics</a></li><li class=docs__nav--selected><a href=/2.9/tasks/distributed-tracing/>Distributed tracing with Linkerd</a></li><li><a href=/2.9/tasks/enabling-addons/>Enabling Add-ons</a></li><li><a href=/2.9/tasks/exporting-metrics/>Exporting Metrics</a></li><li><a href=/2.9/tasks/exposing-dashboard/>Exposing the Dashboard</a></li><li><a href=/2.9/tasks/generate-certificates/>Generating your own mTLS root certificates</a></li><li><a href=/2.9/tasks/getting-per-route-metrics/>Getting Per-Route Metrics</a></li><li><a href=/2.9/tasks/graceful-shutdown/>Graceful Pod Shutdown</a></li><li><a href=/2.9/tasks/using-ingress/>Ingress traffic</a></li><li><a href=/2.9/tasks/fault-injection/>Injecting Faults</a></li><li><a href=/2.9/tasks/install/>Installing Linkerd</a></li><li><a href=/2.9/tasks/install-helm/>Installing Linkerd with Helm</a></li><li><a href=/2.9/tasks/installing-multicluster/>Installing Multi-cluster Components</a></li><li><a href=/2.9/tasks/using-psp/>Linkerd and Pod Security Policies (PSP)</a></li><li><a href=/2.9/tasks/manually-rotating-control-plane-tls-credentials/>Manually Rotating Control Plane TLS Credentials</a></li><li><a href=/2.9/tasks/modifying-proxy-log-level/>Modifying the Proxy Log Level</a></li><li><a href=/2.9/tasks/multicluster/>Multi-cluster communication</a></li><li><a href=/2.9/tasks/replacing_expired_certificates/>Replacing expired certificates</a></li><li><a href=/2.9/tasks/rotating_webhooks_certificates/>Rotating webhooks certificates</a></li><li><a href=/2.9/tasks/securing-your-service/>Securing Your Application with mTLS</a></li><li><a href=/2.9/tasks/securing-your-cluster/>Securing Your Cluster</a></li><li><a href=/2.9/tasks/setting-up-service-profiles/>Setting Up Service Profiles</a></li><li><a href=/2.9/tasks/troubleshooting/>Troubleshooting</a></li><li><a href=/2.9/tasks/uninstall/>Uninstalling Linkerd</a></li><li><a href=/2.9/tasks/uninstall-multicluster/>Uninstalling Multicluster</a></li><li><a href=/2.9/tasks/upgrade/>Upgrading Linkerd</a></li><li><a href=/2.9/tasks/upgrade-multicluster/>Upgrading Multicluster in Linkerd 2.9</a></li><li><a href=/2.9/tasks/using-custom-domain/>Using a Custom Cluster Domain</a></li><li><a href=/2.9/tasks/using-a-private-docker-repository/>Using A Private Docker Repository</a></li><li><a href=/2.9/tasks/gitops/>Using GitOps with Linkerd with Argo CD</a></li><li><a href=/2.9/tasks/using-the-debug-container/>Using the Debug Sidecar</a></li></ul></li><li><a href=/2.9/reference/>Reference
</a><input class=toggle__input type=checkbox id=toggle-a8d66111bc52c02f61a2a68c4bc0d794>
<label class=toggle__label for=toggle-a8d66111bc52c02f61a2a68c4bc0d794><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.9/reference/architecture/>Architecture</a></li><li><a href=/2.9/reference/cli/>CLI
</a><input class=toggle__input type=checkbox id=toggle-3f11a82cff203cfd1d728e9564196222>
<label class=toggle__label for=toggle-3f11a82cff203cfd1d728e9564196222><svg class="icon icon--secondary" viewBox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg></label><ul class=toggle__target><li><a href=/2.9/reference/cli/check/>check</a></li><li><a href=/2.9/reference/cli/completion/>completion</a></li><li><a href=/2.9/reference/cli/dashboard/>dashboard</a></li><li><a href=/2.9/reference/cli/edges/>edges</a></li><li><a href=/2.9/reference/cli/endpoints/>endpoints</a></li><li><a href=/2.9/reference/cli/get/>get</a></li><li><a href=/2.9/reference/cli/inject/>inject</a></li><li><a href=/2.9/reference/cli/install/>install</a></li><li><a href=/2.9/reference/cli/install-cni/>install-cni</a></li><li><a href=/2.9/reference/cli/install-sp/>install-sp</a></li><li><a href=/2.9/reference/cli/logs/>logs</a></li><li><a href=/2.9/reference/cli/metrics/>metrics</a></li><li><a href=/2.9/reference/cli/profile/>profile</a></li><li><a href=/2.9/reference/cli/routes/>routes</a></li><li><a href=/2.9/reference/cli/stat/>stat</a></li><li><a href=/2.9/reference/cli/tap/>tap</a></li><li><a href=/2.9/reference/cli/top/>top</a></li><li><a href=/2.9/reference/cli/uninject/>uninject</a></li><li><a href=/2.9/reference/cli/upgrade/>upgrade</a></li><li><a href=/2.9/reference/cli/version/>version</a></li></ul></li><li><a href=/2.9/reference/cluster-configuration/>Cluster Configuration</a></li><li><a href=/2.9/reference/proxy-configuration/>Proxy Configuration</a></li><li><a href=/2.9/reference/proxy-log-level/>Proxy Log Level</a></li><li><a href=/2.9/reference/proxy-metrics/>Proxy Metrics</a></li><li><a href=/2.9/reference/service-profiles/>Service Profiles</a></li></ul></li></ul><ul><li><a href=/what-is-a-service-mesh/>What is a service mesh?</a></li><li><a href=/faq/>Frequently Asked Questions</a></li><li><a href=/releases/>Releases and Versions</a></li><li><a href=/design-principles/>Design Principles</a></li><li><a href=/going-to-production/>Going to Production</a></li><li><a href=/service-mesh-glossary/>Service Mesh Glossary</a></li></ul></nav><div class=docs__community><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener><img src=/logos/github.svg alt=GitHub class=img></a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener><img src=/logos/slack.svg alt=Slack class=img></a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener><img src=/logos/forum.png alt="Linkerd Forum" class=img></a></li></ul></div></div></div><div class=docs__main><div class=docs__body><div class=docs__header><h1>Distributed tracing with Linkerd</h1></div><div class="docs__content prose"><p>Using distributed tracing in practice can be complex, for a high level
explanation of what you get and how it is done, we&rsquo;ve assembled a <a href=https://linkerd.io/2019/08/09/service-mesh-distributed-tracing-myths/ target=_blank rel=noopener>list of
myths</a>.</p><p>This guide will walk you through configuring and enabling tracing for
<a href=../../getting-started/#step-5-install-the-demo-app>emojivoto</a>. Jump to the end
for some recommendations on the best way to make use of distributed tracing with
Linkerd.</p><p>To use distributed tracing, you&rsquo;ll need to:</p><ul><li>Add a collector which receives spans from your application and Linkerd.</li><li>Add a tracing backend to explore traces.</li><li>Modify your application to emit spans.</li><li>Configure Linkerd&rsquo;s proxies to emit spans.</li></ul><p>In the case of emojivoto, once all these steps are complete there will be a
topology that looks like:</p><figure><img alt=Topology class="img img--max-fill img--center img--rounded" src=/images/tracing/tracing-topology.svg><figcaption>Topology</figcaption></figure><h2 id=prerequisites class=anchor>Prerequisites
<a href=#prerequisites class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><ul><li>To use this guide, you&rsquo;ll need to have Linkerd installed on your cluster.
Follow the <a href=../install/>Installing Linkerd Guide</a> if you haven&rsquo;t
already done this.</li></ul><h2 id=install-trace-collector--jaeger class=anchor>Install Trace Collector & Jaeger
<a href=#install-trace-collector--jaeger class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>The first step of getting distributed tracing setup is installing a collector
onto your cluster. This component consists of &ldquo;receivers&rdquo; that consume spans
emitted from the mesh and your applications as well as &ldquo;exporters&rdquo; that convert
spans and forward them to a backend.</p><p>Next, we will need <a href=https://www.jaegertracing.io/ target=_blank rel=noopener>Jaeger</a> in your cluster.
The <a href=https://www.jaegertracing.io/docs/1.8/getting-started/#all-in-one target=_blank rel=noopener>all inone</a>
configuration will store the traces, make them searchable and provide
visualization of all the data being emitted.</p><p>Linkerd now has add-ons which enables users to install extra components that
integrate well with Linkerd. Tracing is such one add-on which includes <a href=https://opencensus.io/service/components/collector/ target=_blank rel=noopener>OpenCensus
Collector</a> and
<a href=https://www.jaegertracing.io/ target=_blank rel=noopener>Jaeger</a></p><p>To add the Tracing Add-On to your cluster,
run:</p><p>First, we would need a configuration file where we enable the Tracing Add-On.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt;&gt; config.yaml <span style=color:#a5d6ff>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>tracing:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  enabled: true
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span></code></pre></div><p>This configuration file can also be used to apply Add-On configuration
(not just specific to tracing Add-On). More information on the configuration
fields allowed, can be found <a href=https://github.com/linkerd/linkerd2/tree/main/charts/linkerd2#add-ons-configuration target=_blank rel=noopener>here</a></p><p>Now, the above configuration can be applied using the <code>--config</code> file
with CLI or through <code>values.yaml</code> with Helm.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd upgrade --config config.yaml | kubectl apply -f -
</span></span></code></pre></div><p>You will now have a <code>linker-collector</code> and <code>linkerd-jaeger</code>
deployments in the linkerd namespace that are running as part of the mesh.
Collector has been configured to:</p><ul><li>Receive spans from OpenCensus clients</li><li>Export spans to a Jaeger backend</li></ul><p>The collector is extremely configurable and can use the
<a href=https://opencensus.io/service/receivers/ target=_blank rel=noopener>receiver</a> or
<a href=https://opencensus.io/service/exporters/ target=_blank rel=noopener>exporter</a> of your choice.</p><p>Jaeger itself is made up of many
<a href=https://www.jaegertracing.io/docs/1.14/architecture/#components target=_blank rel=noopener>components</a>.
The all-in-one image bundles all these components into a single container to
make demos and showing tracing off a little bit easier.</p><p>Before moving onto the next step, make sure everything is up and running with
<code>kubectl</code>:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n linkerd rollout status deploy/linkerd-collector
</span></span><span style=display:flex><span>kubectl -n linkerd rollout status deploy/linkerd-jaeger
</span></span></code></pre></div><h2 id=install-emojivoto class=anchor>Install Emojivoto
<a href=#install-emojivoto class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Add emojivoto to your cluster with:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f https://run.linkerd.io/emojivoto.yml
</span></span></code></pre></div><p>It is possible to use <code>linkerd inject</code> to add the proxy to emojivoto as outlined
in <a href=../../getting-started/>getting started</a>. Alternatively, annotations can do the
same thing. You can patch these onto the running application with:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n emojivoto patch -f https://run.linkerd.io/emojivoto.yml -p <span style=color:#a5d6ff>&#39;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>spec:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  template:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>      annotations:
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        linkerd.io/inject: enabled
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        config.linkerd.io/trace-collector: linkerd-collector.linkerd:55678
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        config.alpha.linkerd.io/trace-collector-service-account: linkerd-collector
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&#39;</span>
</span></span></code></pre></div><p>Before moving onto the next step, make sure everything is up and running with
<code>kubectl</code>:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n emojivoto rollout status deploy/web
</span></span></code></pre></div><h2 id=modify-the-application class=anchor>Modify the application
<a href=#modify-the-application class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Unlike most features of a service mesh, distributed tracing requires modifying
the source of your application. Tracing needs some way to tie incoming requests
to your application together with outgoing requests to dependent services. To do
this, some headers are added to each request that contain a unique ID for the
trace. Linkerd uses the <a href=https://github.com/openzipkin/b3-propagation target=_blank rel=noopener>b3
propagation</a> format to tie these
things together.</p><p>We&rsquo;ve already modified emojivoto to instrument its requests with this
information, this
<a href=https://github.com/BuoyantIO/emojivoto/commit/47a026c2e4085f4e536c2735f3ff3788b0870072 target=_blank rel=noopener>commit</a>
shows how this was done. For most programming languages, it simply requires the
addition of a client library to take care of this. Emojivoto uses the OpenCensus
client, but others can be used.</p><p>To enable tracing in emojivoto, run:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n emojivoto set env --all deploy <span style=color:#79c0ff>OC_AGENT_HOST</span><span style=color:#ff7b72;font-weight:700>=</span>linkerd-collector.linkerd:55678
</span></span></code></pre></div><p>This command will add an environment variable that enables the applications to
propagate context and emit spans.</p><h2 id=explore-jaeger class=anchor>Explore Jaeger
<a href=#explore-jaeger class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>With <code>vote-bot</code> starting traces for every request, spans should now be showing
up in Jaeger. To get to the UI, start a port forward and send your browser to
<a href=http://localhost:16686/ target=_blank rel=noopener>http://localhost:16686</a>.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n linkerd port-forward svc/linkerd-jaeger <span style=color:#a5d6ff>16686</span>
</span></span></code></pre></div><figure><img alt=Jaeger class="img img--max-fill img--center img--rounded" src=/images/tracing/jaeger-empty.png><figcaption>Jaeger</figcaption></figure><p>You can search for any service in the dropdown and click Find Traces. <code>vote-bot</code>
is a great way to get started.</p><figure><img alt=Search class="img img--max-fill img--center img--rounded" src=/images/tracing/jaeger-search.png><figcaption>Search</figcaption></figure><p>Clicking on a specific trace will provide all the details, you&rsquo;ll be able to see
the spans for every proxy!</p><figure><img alt=Search class="img img--max-fill img--center img--rounded" src=/images/tracing/example-trace.png><figcaption>Search</figcaption></figure><p>There sure are a lot of <code>linkerd-proxy</code> spans in that output. Internally, the
proxy has a server and client side. When a request goes through the proxy, it is
received by the server and then issued by the client. For a single request that
goes between two meshed pods, there will be a total of 4 spans. Two will be on
the source side as the request traverses that proxy and two will be on the
destination side as the request is received by the remote proxy.</p><p>Additionally, As the proxy adds application meta-data as trace attributes, Users
can directly jump into related resources traces directly from the linkerd-web
dashboard by clicking the Jaeger icon in the Metrics Table, as shown below</p><figure><img alt=Linkerd-Jaeger class="img img--max-fill img--center img--rounded" src=/images/tracing/linkerd-jaeger-ui.png><figcaption>Linkerd-Jaeger</figcaption></figure><h2 id=cleanup class=anchor>Cleanup
<a href=#cleanup class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>To cleanup, remove the tracing components along with emojivoto by running:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete ns tracing emojivoto
</span></span></code></pre></div><h2 id=troubleshooting class=anchor>Troubleshooting
<a href=#troubleshooting class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><h3 id=i-dont-see-any-spans-for-the-proxies class=anchor>I don&rsquo;t see any spans for the proxies
<a href=#i-dont-see-any-spans-for-the-proxies class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>The Linkerd proxy uses the <a href=https://github.com/openzipkin/b3-propagation target=_blank rel=noopener>b3
propagation</a> format. Some client
libraries, such as Jaeger, use different formats by default. You&rsquo;ll want to
configure your client library to use the b3 format to have the proxies
participate in traces.</p><h3 id=i-dont-see-any-traces class=anchor>I don&rsquo;t see any traces
<a href=#i-dont-see-any-traces class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>Instead of requiring complex client configuration to ensure spans are encrypted
in transit, Linkerd relies on its mTLS implementation. This means that it is
<em>required</em> the collector is part of the mesh. If you are using a service account
other than <code>default</code> for the collector, the proxies must be configured to use
this as well with the <code>config.alpha.linkerd.io/trace-collector-service-account</code>
annotation.</p><h2 id=recommendations class=anchor>Recommendations
<a href=#recommendations class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><h3 id=ingress class=anchor>Ingress
<a href=#ingress class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>The ingress is an especially important component for distributed tracing because
it creates the root span of each trace and is responsible for deciding if that
trace should be sampled or not. Having the ingress make all sampling decisions
ensures that either an entire trace is sampled or none of it is, and avoids
creating &ldquo;partial traces&rdquo;.</p><p>Distributed tracing systems all rely on services to propagate metadata about the
current trace from requests that they receive to requests that they send. This
metadata, called the trace context, is usually encoded in one or more request
headers. There are many different trace context header formats and while we hope
that the ecosystem will eventually converge on open standards like <a href=https://www.w3.org/TR/trace-context/ target=_blank rel=noopener>W3C
tracecontext</a>, we only use the <a href=https://github.com/openzipkin/b3-propagation target=_blank rel=noopener>b3
format</a> today. Being one of the
earliest widely used formats, it has the widest support, especially among
ingresses like Nginx.</p><p>This reference architecture includes a simple Nginx config that samples 50% of
traces and emits trace data to the collector (using the Zipkin protocol). Any
ingress controller can be used here in place of Nginx as long as it:</p><ul><li>Supports probabilistic sampling</li><li>Encodes trace context in the b3 format</li><li>Emits spans in a protocol supported by the OpenCensus collector</li></ul><p>If using helm to install ingress-nginx, you can configure tracing by using:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>controller</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>config</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>enable-opentracing</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;true&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>zipkin-collector-host</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>linkerd-collector.linkerd</span><span style=color:#6e7681>
</span></span></span></code></pre></div><h3 id=client-library class=anchor>Client Library
<a href=#client-library class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h3><p>While it is possible for services to manually propagate trace propagation
headers, it&rsquo;s usually much easier to use a library which does three things:</p><ul><li>Propagates the trace context from incoming request headers to outgoing request
headers</li><li>Modifies the trace context (i.e. starts a new span)</li><li>Transmits this data to a trace collector</li></ul><p>We recommend using OpenCensus in your service and configuring it with:</p><ul><li><a href=https://github.com/openzipkin/b3-propagation target=_blank rel=noopener>b3 propagation</a> (this is the
default)</li><li><a href=https://opencensus.io/exporters/supported-exporters/go/ocagent/ target=_blank rel=noopener>the OpenCensus agent
exporter</a></li></ul><p>The OpenCensus agent exporter will export trace data to the OpenCensus collector
over a gRPC API. The details of how to configure OpenCensus will vary language
by language, but there are <a href=https://opencensus.io/quickstart/ target=_blank rel=noopener>guides for many popular
languages</a>. You can also see an end-to-end
example of this in Go with our example application,
<a href=https://github.com/adleong/emojivoto target=_blank rel=noopener>Emojivoto</a>.</p><p>You may notice that the OpenCensus project is in maintenance mode and will
become part of <a href=https://opentelemetry.io/ target=_blank rel=noopener>OpenTelemetry</a>. Unfortunately,
OpenTelemetry is not yet production ready and so OpenCensus remains our
recommendation for the moment.</p><p>It is possible to use many other tracing client libraries as well. Just make
sure the b3 propagation format is being used and the client library can export
its spans in a format the collector has been configured to receive.</p><h2 id=collector-opencensus class=anchor>Collector: OpenCensus
<a href=#collector-opencensus class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>The OpenCensus collector receives trace data from the OpenCensus agent exporter
and potentially does translation and filtering before sending that data to
Jaeger. Having the OpenCensus exporter send to the OpenCensus collector gives us
a lot of flexibility: we can switch to any backend that OpenCensus supports
without needing to interrupt the application.</p><h2 id=backend-jaeger class=anchor>Backend: Jaeger
<a href=#backend-jaeger class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>Jaeger is one of the most widely used tracing backends and for good reason: it
is easy to use and does a great job of visualizing traces. However, <a href=https://opencensus.io/service/exporters/ target=_blank rel=noopener>any backend
supported by OpenCensus</a> can be used
instead.</p><h2 id=linkerd class=anchor>Linkerd
<a href=#linkerd class=anchor__link><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7A5 5 0 002 12a5 5 0 005 5h4V15.1H7c-1.71.0-3.1-1.39-3.1-3.1M8 13h8V11H8v2m9-6H13V8.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4a5 5 0 005-5A5 5 0 0017 7z"/></svg></a></h2><p>If your application is injected with Linkerd, the Linkerd proxy will participate
in the traces and will also emit trace data to the OpenCensus collector. This
enriches the trace data and allows you to see exactly how much time requests are
spending in the proxy and on the wire. To enable Linkerd&rsquo;s participation:</p><ul><li>Set the <code>config.linkerd.io/trace-collector</code> annotation on the namespace or pod
specs that you want to participate in traces. This should be set to the
address of the OpenCensus collector service.</li><li>Set the <code>config.alpha.linkerd.io/trace-collector-service-account</code> annotation
on the namespace of pod specs that you want to participate in traces. This
should be set to the name of the service account of the collector and is used
to ensure secure communication between the proxy and the collector. This can
be omitted if the collector is running as the default service account.</li><li>Ensure the OpenCensus collector is injected with the Linkerd proxy.</li></ul><p>While Linkerd can only actively participate in traces that use the b3
propagation format, Linkerd will always forward unknown request headers
transparently, which means it will never interfere with traces that use other
propagation formats.</p></div></div></div></div></div></main><footer class=main-footer><div class=main-footer__top><div class="main-footer__container container"><div class=main-footer__info><p><img src=/logos/linkerd.png alt=Linkerd></p><p>Linkerd was originally created by <a href=https://buoyant.io/ target=_blank rel=noopener>Buoyant</a></p><p>View <a href=https://github.com/linkerd/linkerd/wiki/Linkerd-code-of-conduct target=_blank rel=noopener>Code of Conduct</a></p></div><div class=main-footer__links><div class=main-footer__community><h4>Community</h4><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener>GitHub</a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Linkerd Forum</a></li></ul></div><div class=main-footer__follow><h4>Follow</h4><ul><li><a href=https://www.linkedin.com/company/linkerd/ target=_blank rel=noopener>Linkedin</a></li><li><a href=https://www.youtube.com/buoyantio target=_blank rel=noopener>YouTube</a></li><li><a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a></li></ul></div></div></div></div><div class=main-footer__bottom><div class="main-footer__container container"><p><a href=https://github.com/linkerd/website/tree/main/linkerd.io/content target=_blank rel=noopener>Edit This Site</a></p><p>Copyright © 2024 Linkerd Authors. All rights reserved.</p></div></div></footer></body></html>