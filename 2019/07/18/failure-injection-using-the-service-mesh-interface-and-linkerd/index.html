<!doctype html><html lang=en><head><meta charset=utf-8><title>Failure Injection using the Service Mesh Interface and Linkerd | Linkerd</title>
<link rel="shortcut icon" href=/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Application failure injection is a form of chaos engineering where we
artificially increase the error rate of certain services in a microservice
application to see what impact that has on the system as a whole. Traditionally,
you would need to add some kind of failure injection library into your service
code in order to do application failure injection. Thankfully, the service mesh
gives us a way to inject application failures without needing to modify or
rebuild our services at all."><meta property="og:url" content="https://travisbeckham.github.io/2019/07/18/failure-injection-using-the-service-mesh-interface-and-linkerd/"><meta property="og:site_name" content="Linkerd"><meta property="og:title" content="Failure Injection using the Service Mesh Interface and Linkerd"><meta property="og:description" content="Application failure injection is a form of chaos engineering where we artificially increase the error rate of certain services in a microservice application to see what impact that has on the system as a whole. Traditionally, you would need to add some kind of failure injection library into your service code in order to do application failure injection. Thankfully, the service mesh gives us a way to inject application failures without needing to modify or rebuild our services at all."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2019-07-18T00:00:00+00:00"><meta property="article:modified_time" content="2019-07-18T00:00:00+00:00"><meta property="og:image" content="https://travisbeckham.github.io/2019/07/18/failure-injection-using-the-service-mesh-interface-and-linkerd/cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://travisbeckham.github.io/2019/07/18/failure-injection-using-the-service-mesh-interface-and-linkerd/cover.png"><meta name=twitter:title content="Failure Injection using the Service Mesh Interface and Linkerd"><meta name=twitter:description content="Application failure injection is a form of chaos engineering where we artificially increase the error rate of certain services in a microservice application to see what impact that has on the system as a whole. Traditionally, you would need to add some kind of failure injection library into your service code in order to do application failure injection. Thankfully, the service mesh gives us a way to inject application failures without needing to modify or rebuild our services at all."><meta name=twitter:site content="@Linkerd"><link rel=canonical href=https://travisbeckham.github.io/2019/07/18/failure-injection-using-the-service-mesh-interface-and-linkerd/><link rel=stylesheet href=/css/main.css><script src=/js/main.js></script><script async defer src=https://buttons.github.io/buttons.js></script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","author":"Alex Leong","datePublished":"2019-07-18T00:00:00Z","dateModified":"2019-07-18T00:00:00Z","headline":"Failure Injection using the Service Mesh Interface and Linkerd","image":"https://travisbeckham.github.io/2019/07/18/failure-injection-using-the-service-mesh-interface-and-linkerd/cover.png","publisher":{"@type":"Organization","name":"linkerd.io","logo":{"@type":"ImageObject","url":"https://travisbeckham.github.io/logos/linkerd.png","width":472,"height":100}}}</script></head><body><header class=main-header><div class=main-header__container><div class=main-header__logo><a href=/><img src=/logos/linkerd.png alt=Linkerd></a></div><input class=main-header__toggle-checkbox type=checkbox id=main-header-toggle>
<label class=main-header__toggle for=main-header-toggle><span class=main-header__toggle-icon><span class=main-header__toggle-icon--open><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M3 6H21V8H3V6m0 5H21v2H3V11m0 5H21v2H3V16z"/></svg>
</span><span class=main-header__toggle-icon--close><svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span></span></label><div class=main-header__nav><nav class=main-nav><ul class=main-nav__menu><li><a href=/docs>Docs</a></li><li><a href>Community<svg class="icon icon--primary" viewBox="0 0 24 24"><path d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6L7.41 8.58z"/></svg></a><ul><li><a href=/community/get-involved/>Get Involved</a></li><li><a href=/community/adopters/>Adopters</a></li><li><a href=/community/ambassadors/>Linkerd Ambassadors</a></li><li><a href=/community/heroes/>Linkerd Heroes</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Buoyant's Linkerd Forum</a></li></ul></li><li class=main-nav__menu--selected><a href=/blog/>Blog</a></li><li><a href=/faq/>FAQ</a></li><li><a href=/enterprise/>Enterprise</a></li></ul><div class=main-nav__search><form action=/search method=get><div class="search-input search-input--sm"><svg class="icon" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5.0 0116 9.5c0 1.61-.59 3.09-1.56 4.23L14.71 14H15.5l5 5L19 20.5l-5-5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5.0 013 9.5 6.5 6.5.0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
<input type=text name=q placeholder=Search></div></form></div><div class=main-nav__github><a class=github-button href=https://github.com/linkerd/linkerd2 data-icon=octicon-star data-size=large data-show-count=true aria-label="Star linkerd/linkerd2 on GitHub">Star</a></div><div class=main-nav__forum><a href=https://linkerd.buoyant.io class="button button--primary button--sm" target=_blank rel=noopener>Join Forum</a></div></nav></div></div></header><div class=main-announcement>Service Mesh 101: Get Service Mesh-Certified
<span class=main-announcement__link><a href=https://buoyant.io/courses/service-mesh-101 target=_blank rel=noopener>Enroll now</a></span></div><main class=main-content><div class="blog blog--single"><div class="blog__container container"><div class=blog-post><div class=blog-post__header><h1>Failure Injection using the Service Mesh Interface and Linkerd</h1><div class=blog-post-meta><div class=blog-post-meta__media><img src=/authors/alex-leong.jpg alt="Alex Leong" class="img img--48 img--round"></div><div class=blog-post-meta__body><div class=blog-post-meta__name>Alex Leong</div><div class=blog-post-meta__date>Jul 18, 2019 • 5 min read</div></div></div></div><div class=blog-post__cover></div><div class="blog-post__content prose"><p>Application failure injection is a form of chaos engineering where we
artificially increase the error rate of certain services in a microservice
application to see what impact that has on the system as a whole. Traditionally,
you would need to add some kind of failure injection library into your service
code in order to do application failure injection. Thankfully, the service mesh
gives us a way to inject application failures without needing to modify or
rebuild our services at all.</p><p>One hallmark of a well structured microservice application is that it can
tolerate failures of individual services gracefully. When these failures are in
the form of services crashing, Kubernetes does a fantastic job of healing these
failures by creating new pods to replace the ones which have crashed. However,
failures can also be more subtle, causing services to return an elevated rate of
errors. These types of failures cannot be automatically healed by Kubernetes but
can still cause a loss of functionality.</p><h2 id=using-the-traffic-split-smi-api-to-inject-errors>Using the Traffic Split SMI API to inject errors</h2><p>We can easily inject application failures by using the <a href=https://github.com/deislabs/smi-spec/blob/master/traffic-split.md target=_blank rel=noopener>Traffic Split
API</a> of the
<a href=https://smi-spec.io/ target=_blank rel=noopener>Service Mesh Interface</a>. This allows us to do failure
injection in a way that is implementation agnostic and works across service
meshes.</p><p>We do this by first deploying a new service that returns only errors. This can
be as simple as an NGINX service that is configured to return HTTP 500 responses
or can be a more complex service which returns errors specifically crafted to
exercise certain conditions you wish to test. We then create a Traffic Split
resource which directs the service mesh to send a percentage of a target
service&rsquo;s traffic to the error service instead. For example, by sending 10% of a
service&rsquo;s traffic to the error service, we have injected an artificial 10% error
rate into that service.</p><p>Let&rsquo;s see an example of this in action using Linkerd as the service mesh
implementation.</p><h2 id=example>Example</h2><p>We&rsquo;ll start by installing the Linkerd CLI and deploying it on our Kubernetes
cluster:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; curl --proto <span style=color:#a5d6ff>&#39;=https&#39;</span> --tlsv1.2 -sSfL https://run.linkerd.io/install | sh
</span></span><span style=display:flex><span>&gt; export <span style=color:#79c0ff>PATH</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>$PATH</span>:<span style=color:#79c0ff>$HOME</span>/.linkerd2/bin
</span></span><span style=display:flex><span>&gt; linkerd install | kubectl apply -f -
</span></span><span style=display:flex><span>&gt; linkerd check
</span></span></code></pre></div><p>Now we&rsquo;ll install the booksapp sample application:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; linkerd inject https://run.linkerd.io/booksapp.yml | kubectl apply -f -
</span></span></code></pre></div><p>One of services in this application has been configured with an error rate. The
whole point of this demo is to show that we can inject errors without needing
any support for this in the application, so let&rsquo;s remove that configured error
rate:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; kubectl edit deploy/authors
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Find and remove these lines:</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#        - name: FAILURE_RATE</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#          value: &#34;0.5&#34;</span>
</span></span></code></pre></div><p>We should now see that the application is healthy:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; linkerd stat deploy
</span></span><span style=display:flex><span>NAME             MESHED   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99   TCP_CONN
</span></span><span style=display:flex><span>authors             1/1   100.00%   6.6rps           3ms          58ms          92ms          <span style=color:#a5d6ff>6</span>
</span></span><span style=display:flex><span>books               1/1   100.00%   8.0rps           4ms          81ms         119ms          <span style=color:#a5d6ff>6</span>
</span></span><span style=display:flex><span>traffic             1/1         -        -             -             -             -          -
</span></span><span style=display:flex><span>webapp              3/3   100.00%   7.7rps          24ms          91ms         117ms          <span style=color:#a5d6ff>9</span>
</span></span></code></pre></div><p>Now we can create our error service. Here I will use NGINX configured to respond
only with HTTP status code 500. Create a file called <code>error-injector.yaml</code>:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>apps/v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Deployment</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>error-injector</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>error-injector</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>selector</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>matchLabels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>error-injector</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>replicas</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>template</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>error-injector</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>containers</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>nginx</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>image</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>nginx:alpine</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>ports</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span>- <span style=color:#7ee787>containerPort</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>80</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>nginx</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>protocol</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>TCP</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>volumeMounts</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>nginx-config</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>mountPath</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/etc/nginx/nginx.conf</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span><span style=color:#7ee787>subPath</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>nginx.conf</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>volumes</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>nginx-config</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>configMap</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>error-injector-config</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>---</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Service</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>error-injector</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>error-injector</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>clusterIP</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>None</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>ports</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>service</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>port</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>7002</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>protocol</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>TCP</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>targetPort</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>nginx</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>selector</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>error-injector</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>type</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>ClusterIP</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>---</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>data</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681> </span><span style=color:#7ee787>nginx.conf</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>|2</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#a5d6ff>events {</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#a5d6ff>worker_connections  1024;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#a5d6ff>http {</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#a5d6ff>server {</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#a5d6ff>location / {</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span><span style=color:#a5d6ff>return 500;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>ConfigMap</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>error-injector-config</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>And deploy it:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; kubectl apply -f error-injector.yaml
</span></span></code></pre></div><p>Now we can create a traffic split resource which will direct 10% of the books
service to the error service. Create a file called <code>error-split.yaml</code>:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>split.smi-spec.io/v1alpha1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>TrafficSplit</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>error-split</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>service</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>books</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>backends</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>service</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>books</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>weight</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>900m</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>service</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>error-injector</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>weight</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>100m</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>And deploy it:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; kubectl apply -f error-split.yaml
</span></span></code></pre></div><p>We can now see a 10% error rate for calls from webapp to books:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; linkerd routes deploy/webapp --to service/books
</span></span><span style=display:flex><span>ROUTE       SERVICE   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>DEFAULT<span style=color:#ff7b72;font-weight:700>]</span>     books    90.66%   6.6rps           5ms          80ms          96ms
</span></span></code></pre></div><p>We can also see how gracefully the application handles these failures:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; kubectl port-forward deploy/webapp <span style=color:#a5d6ff>7000</span> &amp;
</span></span><span style=display:flex><span>&gt; open http://localhost:7000
</span></span></code></pre></div><p>Not very well, it seems! If we refresh the page a few times, we will sometimes
see an internal server error page.</p><figure><img alt="Webpage displaying internal server error" class="img img--max-fill img--center img--rounded" src=/2019/07/18/failure-injection-using-the-service-mesh-interface-and-linkerd/cover.png></figure><p>We&rsquo;ve learned something valuable about how our application behaves in the face
of service errors so let&rsquo;s restore our application by simply deleting the
traffic split resource:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; kubectl delete trafficsplit/error-split
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>In this post, we demonstrated a quick and easy way to do failure injection at
the service level, by using the SMI APIs (as powered by Linkerd) to dynamically
redirect a portion of traffic to service to a simple &ldquo;always fail&rdquo; destination.
The beauty of this approach is that we are able to accomplish it purely through
SMI APIs, and without changing any application code.</p><p>Of course, failure injection is a broad topic, and there are many more
sophisticated approaches to injecting failure, including failing certain routes,
failing only requests that match a certain conditions, or propagating a single
&ldquo;poison pill&rdquo; request through an entire application topology. These types of
failure injection will require more machinery than what is covered in this post.</p><p>Linkerd is a community project and is hosted by the <a href=https://cncf.io/ target=_blank rel=noopener>Cloud Native Computing
Foundation</a>. If you have feature requests, questions, or
comments, we’d love to have you join our rapidly-growing community! Linkerd is
hosted on <a href=https://github.com/linkerd/ target=_blank rel=noopener>GitHub</a>, and we have a thriving
community on <a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a>,
<a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a>, and the <a href=https://linkerd.io/2/get-involved/ target=_blank rel=noopener>mailing
lists</a>. Come and join the fun!</p></div></div><div class=blog-post-related><h2>Suggested Blog Posts</h2><div class=blog-post-related__pages><div class="card card--horz card--center"><div class=card__media><img src=/2024/10/15/linkerd-edge-release-roundup/thumbnail.png alt=Thumbnail class="img img--128 img--rounded"></div><div class=card__body><div class=card__header><h4><a href=/2024/10/15/linkerd-edge-release-roundup/>Linkerd Edge Release Roundup: October 2024</a></h4><div class=blog-post-meta><div class=blog-post-meta__date>Oct 15, 2024 • 4 min read</div></div></div></div></div><div class="card card--horz card--center"><div class=card__media><img src=/2024/09/06/linkerd-edge-release-roundup/thumbnail.png alt=Thumbnail class="img img--128 img--rounded"></div><div class=card__body><div class=card__header><h4><a href=/2024/09/06/linkerd-edge-release-roundup/>Linkerd Edge Release Roundup: September 2024</a></h4><div class=blog-post-meta><div class=blog-post-meta__date>Sep 6, 2024 • 3 min read</div></div></div></div></div><div class="card card--horz card--center"><div class=card__media><img src=/2024/08/13/announcing-linkerd-2.16/cover.jpg alt=Cover class="img img--128 img--rounded"></div><div class=card__body><div class=card__header><h4><a href=/2024/08/13/announcing-linkerd-2.16/>Announcing Linkerd 2.16! Metrics, retries, and timeouts for HTTP and gRPC
routes; IPv6 support; policy audit mode; and lots more</a></h4><div class=blog-post-meta><div class=blog-post-meta__date>Aug 13, 2024 • 6 min read</div></div></div></div></div></div></div></div></div></main><footer class=main-footer><div class=main-footer__top><div class="main-footer__container container"><div class=main-footer__info><p><img src=/logos/linkerd.png alt=Linkerd></p><p>Linkerd was originally created by <a href=https://buoyant.io/ target=_blank rel=noopener>Buoyant</a></p><p>View <a href=https://github.com/linkerd/linkerd/wiki/Linkerd-code-of-conduct target=_blank rel=noopener>Code of Conduct</a></p></div><div class=main-footer__links><div class=main-footer__community><h4>Community</h4><ul><li><a href=https://github.com/linkerd/linkerd2 target=_blank rel=noopener>GitHub</a></li><li><a href=https://slack.linkerd.io target=_blank rel=noopener>Slack</a></li><li><a href=https://linkerd.buoyant.io target=_blank rel=noopener>Linkerd Forum</a></li></ul></div><div class=main-footer__follow><h4>Follow</h4><ul><li><a href=https://www.linkedin.com/company/linkerd/ target=_blank rel=noopener>Linkedin</a></li><li><a href=https://www.youtube.com/buoyantio target=_blank rel=noopener>YouTube</a></li><li><a href=https://twitter.com/linkerd target=_blank rel=noopener>Twitter</a></li></ul></div></div></div></div><div class=main-footer__bottom><div class="main-footer__container container"><p><a href=https://github.com/linkerd/website/tree/main/linkerd.io/content target=_blank rel=noopener>Edit This Site</a></p><p>Copyright © 2024 Linkerd Authors. All rights reserved.</p></div></div></footer></body></html>